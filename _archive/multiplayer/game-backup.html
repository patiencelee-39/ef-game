<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>éŠæˆ²ä¸­ - åŸ·è¡ŒåŠŸèƒ½éŠæˆ²</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        overflow: hidden;
        user-select: none;
      }

      .game-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        padding: 20px;
      }

      /* é ‚éƒ¨è³‡è¨Šæ¬„ */
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 15px 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .sound-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s;
        z-index: 1000;
      }

      .sound-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .sound-toggle.muted {
        background: rgba(255, 100, 100, 0.95);
      }

      .stage-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .stage-icon {
        font-size: 2rem;
      }

      .stage-details h2 {
        font-size: 1.2rem;
        color: #2d3436;
        margin-bottom: 3px;
      }

      .stage-progress {
        font-size: 0.9rem;
        color: #636e72;
      }

      .score-display {
        text-align: right;
      }

      .score-label {
        font-size: 0.85rem;
        color: #636e72;
        margin-bottom: 3px;
      }

      .score-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #667eea;
      }

      /* ä¸»éŠæˆ²å€åŸŸ */
      .game-area {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .stimulus-display {
        background: white;
        border-radius: 30px;
        width: 400px;
        height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
        position: relative;
      }

      .stimulus-display.day-context {
        background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
      }

      .stimulus-display.night-context {
        background: linear-gradient(135deg, #2d3436 0%, #0984e3 100%);
      }

      .stimulus-display.correct {
        animation: correct 0.5s;
      }

      .stimulus-display.wrong {
        animation: wrong 0.5s;
      }

      @keyframes correct {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
          box-shadow: 0 0 50px rgba(85, 239, 196, 0.8);
        }
      }

      @keyframes wrong {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-20px);
        }
        75% {
          transform: translateX(20px);
        }
      }

      .context-indicator {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 3rem;
        opacity: 0.3;
      }

      /* åº•éƒ¨æ§åˆ¶å€ */
      .bottom-bar {
        display: flex;
        justify-content: center;
        gap: 30px;
        padding: 20px;
      }

      .control-hint {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px 40px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .control-hint.active {
        background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        color: white;
        transform: scale(1.05);
      }

      .key-display {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .key-label {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      /* è¨ˆæ™‚å™¨ */
      .timer {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .timer.warning {
        color: #ff7675;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      /* åé¥‹è¨Šæ¯ */
      .feedback {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        font-weight: bold;
        opacity: 0;
        pointer-events: none;
        text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .feedback.show {
        animation: feedbackShow 0.8s;
      }

      @keyframes feedbackShow {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.5);
        }
        50% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.2);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      /* è®€ç§’æº–å‚™ */
      .countdown-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .countdown-number {
        font-size: 15rem;
        font-weight: bold;
        color: white;
        animation: countdownPulse 1s ease-in-out;
      }

      @keyframes countdownPulse {
        0% {
          transform: scale(0);
          opacity: 0;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* è¼‰å…¥ä¸­ */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        color: white;
      }

      /* è§€æˆ°æ¨¡å¼ */
      .spectator-mode {
        display: none;
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .spectator-header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .spectator-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .spectator-header .room-info {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .players-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .player-status-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .player-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .player-status-name {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2d3436;
      }

      .player-status-score {
        font-size: 1.8rem;
        font-weight: bold;
        color: #667eea;
      }

      .player-status-progress {
        margin-bottom: 15px;
      }

      .progress-label {
        font-size: 0.9rem;
        color: #636e72;
        margin-bottom: 5px;
      }

      .progress-bar {
        width: 100%;
        height: 25px;
        background: #f0f0f0;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.85rem;
        font-weight: bold;
      }

      .player-status-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .stat-item {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-label {
        font-size: 0.8rem;
        color: #636e72;
        margin-bottom: 3px;
      }

      .stat-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #2d3436;
      }

      .player-offline {
        opacity: 0.5;
        position: relative;
      }

      .player-offline::after {
        content: "âš ï¸ é›¢ç·š";
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 107, 107, 0.9);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.9rem;
      }

      .loading-spinner {
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top: 5px solid white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .stimulus-display {
          width: 280px;
          height: 280px;
          font-size: 8rem;
        }

        .top-bar {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .control-hint {
          padding: 15px 25px;
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <!-- éŸ³æ•ˆé–‹é—œ -->
      <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">
        ğŸ”Š
      </button>
      <!-- é ‚éƒ¨è³‡è¨Š -->
      <div class="top-bar">
        <div class="stage-info">
          <div class="stage-icon" id="stageIcon">ğŸ§€</div>
          <div class="stage-details">
            <h2 id="stageName">å ´åœ°Aï¼šèµ·å¸æ£®æ—</h2>
            <div class="stage-progress">
              é¡Œç›® <span id="currentQuestion">1</span> /
              <span id="totalQuestions">10</span>
            </div>
          </div>
        </div>
        <div class="score-display">
          <div class="score-label">ç›®å‰åˆ†æ•¸</div>
          <div class="score-value" id="scoreValue">0</div>
        </div>
      </div>

      <!-- ä¸»éŠæˆ²å€ -->
      <div class="game-area">
        <div class="timer" id="timer">3.0</div>
        <div class="stimulus-display" id="stimulusDisplay">
          <div class="context-indicator" id="contextIndicator"></div>
          <div id="stimulusEmoji">ğŸ§€</div>
        </div>
        <div class="feedback" id="feedback">âœ“</div>
      </div>

      <!-- åº•éƒ¨æ§åˆ¶æç¤º -->
      <div class="bottom-bar">
        <div class="control-hint" id="spaceHint">
          <div class="key-display">ç©ºç™½éµ</div>
          <div class="key-label">æŒ‰ä¸‹</div>
        </div>
        <div class="control-hint">
          <div class="key-display">ä¸æŒ‰</div>
          <div class="key-label">ç­‰å¾…æ™‚é–“çµæŸ</div>
        </div>
      </div>
    </div>

    <!-- è®€ç§’æº–å‚™ -->
    <div class="countdown-overlay" id="countdownOverlay" style="display: none">
      <div class="countdown-number" id="countdownNumber">3</div>
    </div>

    <!-- è¼‰å…¥ä¸­ -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div>è¼‰å…¥éŠæˆ²ä¸­...</div>
    </div>

    <!-- è§€æˆ°æ¨¡å¼ -->
    <div class="spectator-mode" id="spectatorMode">
      <div class="spectator-header">
        <h1>ğŸ‘ï¸ æˆ¿ä¸»è§€æˆ°æ¨¡å¼</h1>
        <div class="room-info">
          æˆ¿é–“ä»£ç¢¼ï¼š<span id="spectatorRoomCode"></span> | ç©å®¶æ•¸ï¼š<span
            id="spectatorPlayerCount"
            >0</span
          >
        </div>
      </div>
      <div class="players-status-grid" id="playersStatusGrid">
        <!-- ç©å®¶ç‹€æ…‹å¡ç‰‡å°‡å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>

    <!-- èªéŸ³ -->
    <audio id="audioPlayer"></audio>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="../js/firebase-config.js"></script>

    <script>
      // éŠæˆ²ç‹€æ…‹
      let gameState = {
        currentStageIndex: 0,
        currentQuestionIndex: 0,
        stages: [],
        score: 0,
        answers: [],
        startTime: null,
        roomCode: null,
        playerId: null,
      };

      let questionTimer = null;
      let questionStartTime = null;
      const QUESTION_TIME_LIMIT = 3000; // 3ç§’

      // éŸ³æ•ˆé–‹é—œç‹€æ…‹ï¼ˆé è¨­é–‹å•Ÿï¼‰
      let isSoundEnabled = true;

      // åˆå§‹åŒ–
      window.addEventListener("DOMContentLoaded", () => {
        initializeGame();
      });

      async function initializeGame() {
        // å¾ localStorage ç²å–éŠæˆ²è³‡è¨Š
        const roomData = localStorage.getItem("currentRoom");
        const playerData = localStorage.getItem("currentPlayer");

        if (!roomData || !playerData) {
          alert("æœªæ‰¾åˆ°éŠæˆ²è³‡è¨Š");
          window.location.href = "../index.html";
          return;
        }

        const room = JSON.parse(roomData);
        const player = JSON.parse(playerData);

        console.log("ğŸ“Š æˆ¿é–“è³‡æ–™:", room);
        console.log("ğŸ‘¤ ç©å®¶è³‡æ–™:", player);

        gameState.roomCode = room.code;
        gameState.playerId = player.id;

        // æª¢æŸ¥æ˜¯å¦ç‚ºè§€æˆ°æ¨¡å¼ï¼ˆæˆ¿ä¸»ä¸åƒèˆ‡éŠæˆ²ï¼‰
        const isSpectator =
          player.isSpectator === true || player.isSpectator === "true";

        console.log("ğŸ‘ï¸ isSpectator å€¼:", player.isSpectator);
        console.log("ğŸ‘ï¸ æ˜¯å¦ç‚ºè§€æˆ°æ¨¡å¼:", isSpectator);

        if (isSpectator) {
          console.log("âœ… å•Ÿå‹•è§€æˆ°æ¨¡å¼");
          await initializeSpectatorMode();
          return;
        }

        console.log("ğŸ® å•Ÿå‹•éŠæˆ²æ¨¡å¼");

        // å¾ Firebase ç²å–éŠæˆ²é¡Œç›®
        const roomRef = firebase.database().ref(`rooms/${room.code}`);
        const snapshot = await roomRef.once("value");
        const roomGameData = snapshot.val();

        if (!roomGameData || !roomGameData.gameStages) {
          alert("éŠæˆ²æ•¸æ“šè¼‰å…¥å¤±æ•—");
          window.location.href = "../index.html";
          return;
        }

        gameState.stages = roomGameData.gameStages;
        gameState.startTime = Date.now();

        // éš±è—è¼‰å…¥ç•«é¢ï¼Œé–‹å§‹è®€ç§’
        document.getElementById("loadingOverlay").style.display = "none";
        startCountdown();
      }

      // é–‹å§‹è®€ç§’
      function startCountdown() {
        const overlay = document.getElementById("countdownOverlay");
        const number = document.getElementById("countdownNumber");
        overlay.style.display = "flex";

        let count = 3;
        number.textContent = count;

        const interval = setInterval(() => {
          count--;
          if (count > 0) {
            number.textContent = count;
            number.style.animation = "none";
            setTimeout(() => {
              number.style.animation = "countdownPulse 1s ease-in-out";
            }, 10);
          } else {
            clearInterval(interval);
            overlay.style.display = "none";
            startStage();
          }
        }, 1000);
      }

      // é–‹å§‹å ´åœ°
      function startStage() {
        const stage = gameState.stages[gameState.currentStageIndex];
        if (!stage) {
          endGame();
          return;
        }

        // æ›´æ–°å ´åœ°è³‡è¨Š
        document.getElementById("stageIcon").textContent = stage.icon;
        document.getElementById("stageName").textContent = stage.name;
        document.getElementById("totalQuestions").textContent =
          stage.questions.length;

        // æ’­æ”¾å ´åœ°èªéŸ³ï¼ˆå¦‚æœéœ€è¦ï¼‰
        playStageIntroVoice(stage);

        // çŸ­æš«å»¶é²å¾Œé–‹å§‹ç¬¬ä¸€é¡Œ
        setTimeout(() => {
          gameState.currentQuestionIndex = 0;
          showQuestion();
        }, 2000);
      }

      // é¡¯ç¤ºé¡Œç›®
      function showQuestion() {
        const stage = gameState.stages[gameState.currentStageIndex];
        const question = stage.questions[gameState.currentQuestionIndex];

        if (!question) {
          nextStage();
          return;
        }

        // æ›´æ–°é¡Œç›®é€²åº¦
        document.getElementById("currentQuestion").textContent =
          gameState.currentQuestionIndex + 1;

        // æ›´æ–°åˆºæ¿€ç‰©
        const display = document.getElementById("stimulusDisplay");
        document.getElementById("stimulusEmoji").textContent = question.emoji;

        // è™•ç†æ™å¤œèƒŒæ™¯
        display.classList.remove("day-context", "night-context");
        const contextIndicator = document.getElementById("contextIndicator");

        if (question.dayNight === "day") {
          display.classList.add("day-context");
          contextIndicator.textContent = "â˜€ï¸";
        } else if (question.dayNight === "night") {
          display.classList.add("night-context");
          contextIndicator.textContent = "ğŸŒ™";
        } else {
          contextIndicator.textContent = "";
        }

        // é–‹å§‹è¨ˆæ™‚
        questionStartTime = Date.now();
        startQuestionTimer();
      }

      // é¡Œç›®è¨ˆæ™‚å™¨
      function startQuestionTimer() {
        const timerDisplay = document.getElementById("timer");
        let timeLeft = QUESTION_TIME_LIMIT;

        questionTimer = setInterval(() => {
          timeLeft = QUESTION_TIME_LIMIT - (Date.now() - questionStartTime);

          if (timeLeft <= 0) {
            clearInterval(questionTimer);
            handleAnswer("nopress");
          } else {
            timerDisplay.textContent = (timeLeft / 1000).toFixed(1);
            if (timeLeft < 1000) {
              timerDisplay.classList.add("warning");
            } else {
              timerDisplay.classList.remove("warning");
            }
          }
        }, 50);
      }

      // è™•ç†ç­”æ¡ˆ
      function handleAnswer(action) {
        if (!questionTimer) return; // å·²ç¶“å›ç­”é

        clearInterval(questionTimer);
        questionTimer = null;

        const stage = gameState.stages[gameState.currentStageIndex];
        const question = stage.questions[gameState.currentQuestionIndex];
        const reactionTime = Date.now() - questionStartTime;
        const isCorrect = action === question.correctAction;

        // è¨˜éŒ„ç­”æ¡ˆ
        gameState.answers.push({
          stageId: stage.stageId,
          questionId: question.id,
          stimulusType: question.stimulusType,
          correctAction: question.correctAction,
          userAction: action,
          isCorrect: isCorrect,
          reactionTime: reactionTime,
        });

        // æ›´æ–°åˆ†æ•¸
        if (isCorrect) {
          const timeBonus = Math.max(
            0,
            Math.floor((QUESTION_TIME_LIMIT - reactionTime) / 100),
          );
          gameState.score += 10 + timeBonus;
        }

        document.getElementById("scoreValue").textContent = gameState.score;

        // é¡¯ç¤ºåé¥‹
        showFeedback(isCorrect);

        // å‹•ç•«æ•ˆæœ
        const display = document.getElementById("stimulusDisplay");
        display.classList.add(isCorrect ? "correct" : "wrong");
        setTimeout(() => {
          display.classList.remove("correct", "wrong");
        }, 500);

        // ä¸‹ä¸€é¡Œ
        setTimeout(() => {
          gameState.currentQuestionIndex++;
          showQuestion();
        }, 1000);
      }

      // é¡¯ç¤ºåé¥‹
      function showFeedback(isCorrect) {
        const feedback = document.getElementById("feedback");
        feedback.textContent = isCorrect ? "âœ“" : "âœ—";
        feedback.style.color = isCorrect ? "#00b894" : "#ff7675";
        feedback.classList.add("show");

        setTimeout(() => {
          feedback.classList.remove("show");
        }, 800);

        // æ’­æ”¾åé¥‹éŸ³æ•ˆ
        playFeedbackSound(isCorrect);
      }

      // ä¸‹ä¸€å€‹å ´åœ°
      function nextStage() {
        gameState.currentStageIndex++;

        if (gameState.currentStageIndex < gameState.stages.length) {
          // å ´åœ°é–“ä¼‘æ¯
          setTimeout(() => {
            startStage();
          }, 2000);
        } else {
          endGame();
        }
      }

      // çµæŸéŠæˆ²
      async function endGame() {
        const endTime = Date.now();
        const totalTime = endTime - gameState.startTime;

        // è¨ˆç®—çµ±è¨ˆ
        const totalQuestions = gameState.answers.length;
        const correctAnswers = gameState.answers.filter(
          (a) => a.isCorrect,
        ).length;
        const accuracy = ((correctAnswers / totalQuestions) * 100).toFixed(1);

        // å„²å­˜çµæœåˆ° Firebase
        const resultData = {
          playerId: gameState.playerId,
          score: gameState.score,
          accuracy: parseFloat(accuracy),
          totalQuestions: totalQuestions,
          correctAnswers: correctAnswers,
          totalTime: totalTime,
          answers: gameState.answers,
          completedAt: Date.now(),
        };

        const roomRef = firebase.database().ref(`rooms/${gameState.roomCode}`);
        await roomRef.child(`results/${gameState.playerId}`).set(resultData);

        // å„²å­˜åˆ° localStorage
        localStorage.setItem("gameResult", JSON.stringify(resultData));

        // è·³è½‰åˆ°çµæœé é¢
        window.location.href = "result.html";
      }

      // è§€æˆ°æ¨¡å¼åˆå§‹åŒ–
      async function initializeSpectatorMode() {
        console.log("ğŸ‘ï¸ è§€æˆ°æ¨¡å¼åˆå§‹åŒ–é–‹å§‹...");

        const roomRef = firebase.database().ref(`rooms/${gameState.roomCode}`);

        // éš±è—éŠæˆ²ç•Œé¢ï¼Œé¡¯ç¤ºè§€æˆ°ç•Œé¢
        const gameContainer = document.querySelector(".game-container");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const spectatorMode = document.getElementById("spectatorMode");

        console.log("ğŸ“‘ éŠæˆ²å®¹å™¨:", gameContainer);
        console.log("ğŸ“‘ è¼‰å…¥ç•«é¢:", loadingOverlay);
        console.log("ğŸ“‘ è§€æˆ°æ¨¡å¼:", spectatorMode);

        if (gameContainer) gameContainer.style.display = "none";
        if (loadingOverlay) loadingOverlay.style.display = "none";
        if (spectatorMode) {
          spectatorMode.style.display = "block";
          console.log("âœ… è§€æˆ°ç•Œé¢å·²é¡¯ç¤º");
        } else {
          console.error("âŒ æ‰¾ä¸åˆ°è§€æˆ°æ¨¡å¼å…ƒç´ ");
        }

        document.getElementById("spectatorRoomCode").textContent =
          gameState.roomCode;

        // ç›£è½æˆ¿é–“è³‡æ–™è®ŠåŒ–
        roomRef.on("value", (snapshot) => {
          const roomData = snapshot.val();
          if (!roomData) {
            alert("æˆ¿é–“å·²é—œé–‰");
            window.location.href = "../index.html";
            return;
          }

          updateSpectatorView(roomData);
        });
      }

      // æ›´æ–°è§€æˆ°è¦–åœ–
      function updateSpectatorView(roomData) {
        const players = roomData.players || {};
        const playersList = Object.entries(players).map(([id, data]) => ({
          id,
          ...data,
        }));

        document.getElementById("spectatorPlayerCount").textContent =
          playersList.length;

        const grid = document.getElementById("playersStatusGrid");
        grid.innerHTML = "";

        if (playersList.length === 0) {
          grid.innerHTML =
            '<div style="color: white; text-align: center; font-size: 1.5rem; grid-column: 1/-1;">ç­‰å¾…ç©å®¶åŠ å…¥...</div>';
          return;
        }

        playersList.forEach((player, index) => {
          const totalQuestions =
            roomData.gameStages?.reduce(
              (sum, stage) => sum + (stage.questions?.length || 0),
              0,
            ) || 0;
          const currentQuestion =
            (player.currentStageIndex || 0) * 10 +
            (player.currentQuestion || 0);
          const progress =
            totalQuestions > 0
              ? Math.round((currentQuestion / totalQuestions) * 100)
              : 0;

          const avatarEmojis = ["ğŸ±", "ğŸ¶", "ğŸ¼", "ğŸ¦Š", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®"];
          const emoji = avatarEmojis[index % avatarEmojis.length];

          const card = document.createElement("div");
          card.className = `player-status-card ${!player.online ? "player-offline" : ""}`;

          card.innerHTML = `
            <div class="player-status-header">
              <div>
                <div style="font-size: 2rem; margin-bottom: 5px;">${emoji}</div>
                <div class="player-status-name">${player.nickname || "æœªå‘½åç©å®¶"}</div>
              </div>
              <div class="player-status-score">${player.totalScore || 0}</div>
            </div>
            
            <div class="player-status-progress">
              <div class="progress-label">éŠæˆ²é€²åº¦</div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%">
                  ${progress}%
                </div>
              </div>
            </div>
            
            <div class="player-status-stats">
              <div class="stat-item">
                <div class="stat-label">ç•¶å‰å ´åœ°</div>
                <div class="stat-value">${(player.currentStageIndex || 0) + 1}/${roomData.gameStages?.length || 0}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">ç•¶å‰é¡Œç›®</div>
                <div class="stat-value">${(player.currentQuestion || 0) + 1}/10</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">æ­£ç¢ºç‡</div>
                <div class="stat-value">${player.accuracy ? player.accuracy.toFixed(0) : 0}%</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">æ˜Ÿæ˜Ÿ</div>
                <div class="stat-value">${player.totalStars || 0} â­</div>
              </div>
            </div>
          `;

          grid.appendChild(card);
        });
      }

      // åˆ‡æ›éŸ³æ•ˆ
      function toggleSound() {
        isSoundEnabled = !isSoundEnabled;
        const btn = document.getElementById("soundToggle");

        if (isSoundEnabled) {
          btn.textContent = "ğŸ”Š";
          btn.classList.remove("muted");
        } else {
          btn.textContent = "ğŸ”‡";
          btn.classList.add("muted");
          // é—œé–‰æ™‚åœæ­¢ç•¶å‰æ’­æ”¾
          const audio = document.getElementById("audioPlayer");
          audio.pause();
          audio.currentTime = 0;
        }
      }

      // æ’­æ”¾èªéŸ³
      function playStageIntroVoice(stage) {
        if (!isSoundEnabled) return; // éŸ³æ•ˆé—œé–‰æ™‚ä¸æ’­æ”¾

        // æ ¹æ“šå ´åœ°é¡å‹æ’­æ”¾å°æ‡‰èªéŸ³
        const voiceMap = {
          cheese_cat: "../audio/voice/voice-rule-cheese.wav",
          person_cheese_cat: "../audio/voice/voice-rule-person.wav",
          fish_shark: "../audio/voice/voice-rule-fish.wav",
          day_night: "../audio/voice/voice-rule-switch.wav",
        };

        const voicePath = voiceMap[stage.type];
        if (voicePath) {
          const audio = document.getElementById("audioPlayer");
          audio.src = voicePath;
          audio.play();
        }
      }

      function playFeedbackSound(isCorrect) {
        if (!isSoundEnabled) return; // éŸ³æ•ˆé—œé–‰æ™‚ä¸æ’­æ”¾

        const audio = document.getElementById("audioPlayer");
        if (isCorrect) {
          const correctSounds = [
            "../audio/voice/voice-feedback-correct-01.wav",
            "../audio/voice/voice-feedback-correct-02.wav",
            "../audio/voice/voice-feedback-correct-03.wav",
          ];
          audio.src =
            correctSounds[Math.floor(Math.random() * correctSounds.length)];
        } else {
          const wrongSounds = [
            "../audio/voice/voice-feedback-wrong-01.wav",
            "../audio/voice/voice-feedback-wrong-02.wav",
          ];
          audio.src =
            wrongSounds[Math.floor(Math.random() * wrongSounds.length)];
        }
        audio.play();
      }

      // éµç›¤äº‹ä»¶
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space" && questionTimer) {
          e.preventDefault();
          document.getElementById("spaceHint").classList.add("active");
          handleAnswer("press");
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.code === "Space") {
          document.getElementById("spaceHint").classList.remove("active");
        }
      });

      // é˜²æ­¢æ„å¤–é›¢é–‹
      window.addEventListener("beforeunload", (e) => {
        if (questionTimer) {
          e.preventDefault();
          e.returnValue = "";
        }
      });
    </script>
  </body>
</html>
