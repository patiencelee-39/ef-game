<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÈÅäÊà≤‰∏≠ - Âü∑Ë°åÂäüËÉΩÈÅäÊà≤</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        overflow: hidden;
        user-select: none;
      }

      .game-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        padding: 20px;
      }

      /* È†ÇÈÉ®Ë≥áË®äÊ¨Ñ */
      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 15px 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .stage-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .stage-icon {
        font-size: 2rem;
      }

      .stage-details h2 {
        font-size: 1.2rem;
        color: #2d3436;
        margin-bottom: 3px;
      }

      .stage-progress {
        font-size: 0.9rem;
        color: #636e72;
      }

      .score-display {
        text-align: right;
      }

      .score-label {
        font-size: 0.85rem;
        color: #636e72;
        margin-bottom: 3px;
      }

      .score-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #667eea;
      }

      /* ‰∏ªÈÅäÊà≤ÂçÄÂüü */
      .game-area {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .stimulus-display {
        background: white;
        border-radius: 30px;
        width: 400px;
        height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
        position: relative;
      }

      .stimulus-display.day-context {
        background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
      }

      .stimulus-display.night-context {
        background: linear-gradient(135deg, #2d3436 0%, #0984e3 100%);
      }

      .stimulus-display.correct {
        animation: correct 0.5s;
      }

      .stimulus-display.wrong {
        animation: wrong 0.5s;
      }

      @keyframes correct {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
          box-shadow: 0 0 50px rgba(85, 239, 196, 0.8);
        }
      }

      @keyframes wrong {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-20px);
        }
        75% {
          transform: translateX(20px);
        }
      }

      .context-indicator {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 3rem;
        opacity: 0.3;
      }

      /* Ë®àÊôÇÂô® */
      .timer {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 50%;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .timer.warning {
        color: #ff7675;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      /* ÂèçÈ•ãË®äÊÅØ */
      .feedback {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        font-weight: bold;
        opacity: 0;
        pointer-events: none;
        text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .feedback.show {
        animation: feedbackShow 0.8s;
      }

      @keyframes feedbackShow {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.5);
        }
        50% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.2);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      /* Â∫ïÈÉ®ÊéßÂà∂ÂçÄ */
      .bottom-bar {
        display: flex;
        justify-content: center;
        gap: 30px;
        padding: 20px;
      }

      .control-hint {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px 40px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .control-hint.active {
        background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        color: white;
        transform: scale(1.05);
      }

      .key-display {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .key-label {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      /* ËÆÄÁßíÊ∫ñÂÇô */
      .countdown-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .countdown-number {
        font-size: 15rem;
        font-weight: bold;
        color: white;
        animation: countdownPulse 1s ease-in-out;
      }

      @keyframes countdownPulse {
        0% {
          transform: scale(0);
          opacity: 0;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* ËºâÂÖ•‰∏≠ */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        color: white;
      }

      .loading-spinner {
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top: 5px solid white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .stimulus-display {
          width: 280px;
          height: 280px;
          font-size: 8rem;
        }

        .top-bar {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .control-hint {
          padding: 15px 25px;
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <!-- È†ÇÈÉ®Ë≥áË®ä -->
      <div class="top-bar">
        <div class="stage-info">
          <div class="stage-icon" id="stageIcon">üßÄ</div>
          <div class="stage-details">
            <h2 id="stageName">Â†¥Âú∞AÔºöËµ∑Âè∏Ê£ÆÊûó</h2>
            <div class="stage-progress">
              È°åÁõÆ <span id="currentQuestion">1</span> /
              <span id="totalQuestions">10</span>
            </div>
          </div>
        </div>
        <div class="score-display">
          <div class="score-label">ÁõÆÂâçÂàÜÊï∏</div>
          <div class="score-value" id="scoreValue">0</div>
        </div>
      </div>

      <!-- ‰∏ªÈÅäÊà≤ÂçÄ -->
      <div class="game-area">
        <div class="timer" id="timer">3.0</div>
        <div class="stimulus-display" id="stimulusDisplay">
          <div class="context-indicator" id="contextIndicator"></div>
          <div id="stimulusEmoji">üßÄ</div>
        </div>
        <div class="feedback" id="feedback">‚úì</div>
      </div>

      <!-- Â∫ïÈÉ®ÊéßÂà∂ÊèêÁ§∫ -->
      <div class="bottom-bar">
        <div class="control-hint" id="spaceHint">
          <div class="key-display">Á©∫ÁôΩÈçµ</div>
          <div class="key-label">Êåâ‰∏ã</div>
        </div>
        <div class="control-hint">
          <div class="key-display">‰∏çÊåâ</div>
          <div class="key-label">Á≠âÂæÖÊôÇÈñìÁµêÊùü</div>
        </div>
      </div>
    </div>

    <!-- ËÆÄÁßíÊ∫ñÂÇô -->
    <div class="countdown-overlay" id="countdownOverlay" style="display: none">
      <div class="countdown-number" id="countdownNumber">3</div>
    </div>

    <!-- ËºâÂÖ•‰∏≠ -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div>ËºâÂÖ•ÈÅäÊà≤‰∏≠...</div>
    </div>

    <!-- Ë™ûÈü≥ -->
    <audio id="audioPlayer"></audio>

    <!-- ËºâÂÖ•ÈÅäÊà≤ÈÇèËºØ -->
    <script src="../js/utils/question-generator.js"></script>

    <script>
      // ÈÅäÊà≤ÁãÄÊÖã
      let gameState = {
        stage: null,
        currentQuestionIndex: 0,
        questions: [],
        score: 0,
        answers: [],
        startTime: null,
      };

      let questionTimer = null;
      let questionStartTime = null;
      const QUESTION_TIME_LIMIT = 3000; // 3Áßí

      // ÂàùÂßãÂåñ
      window.addEventListener("DOMContentLoaded", () => {
        initializeGame();
      });

      function initializeGame() {
        // Âæû localStorage Áç≤ÂèñÈÅ∏ÊìáÁöÑÈóúÂç°
        const savedStage = localStorage.getItem("selectedStage");
        if (!savedStage) {
          alert("Êú™ÊâæÂà∞ÈóúÂç°Ë≥áË®ä");
          window.location.href = "stage-select.html";
          return;
        }

        gameState.stage = JSON.parse(savedStage);
        gameState.startTime = Date.now();

        // ÁîüÊàêÈ°åÁõÆ
        const stageId = gameState.stage.id;
        gameState.questions = window.QuestionGenerator.generateStageQuestions(
          stageId,
          10,
        );

        // Êõ¥Êñ∞Â†¥Âú∞Ë≥áË®ä
        document.getElementById("stageIcon").textContent = gameState.stage.icon;
        document.getElementById("stageName").textContent = gameState.stage.name;
        document.getElementById("totalQuestions").textContent =
          gameState.questions.length;

        // Èö±ËóèËºâÂÖ•Áï´Èù¢ÔºåÈñãÂßãËÆÄÁßí
        document.getElementById("loadingOverlay").style.display = "none";
        startCountdown();
      }

      // ÈñãÂßãËÆÄÁßí
      function startCountdown() {
        const overlay = document.getElementById("countdownOverlay");
        const number = document.getElementById("countdownNumber");
        overlay.style.display = "flex";

        let count = 3;
        number.textContent = count;

        const interval = setInterval(() => {
          count--;
          if (count > 0) {
            number.textContent = count;
            number.style.animation = "none";
            setTimeout(() => {
              number.style.animation = "countdownPulse 1s ease-in-out";
            }, 10);
          } else {
            clearInterval(interval);
            overlay.style.display = "none";
            showQuestion();
          }
        }, 1000);
      }

      // È°ØÁ§∫È°åÁõÆ
      function showQuestion() {
        const question = gameState.questions[gameState.currentQuestionIndex];

        if (!question) {
          endGame();
          return;
        }

        // Êõ¥Êñ∞È°åÁõÆÈÄ≤Â∫¶
        document.getElementById("currentQuestion").textContent =
          gameState.currentQuestionIndex + 1;

        // Êõ¥Êñ∞Âà∫ÊøÄÁâ©
        const display = document.getElementById("stimulusDisplay");
        document.getElementById("stimulusEmoji").textContent = question.emoji;

        // ËôïÁêÜÊôùÂ§úËÉåÊôØ
        display.classList.remove("day-context", "night-context");
        const contextIndicator = document.getElementById("contextIndicator");

        if (question.dayNight === "day") {
          display.classList.add("day-context");
          contextIndicator.textContent = "‚òÄÔ∏è";
        } else if (question.dayNight === "night") {
          display.classList.add("night-context");
          contextIndicator.textContent = "üåô";
        } else {
          contextIndicator.textContent = "";
        }

        // ÈñãÂßãË®àÊôÇ
        questionStartTime = Date.now();
        startQuestionTimer();
      }

      // È°åÁõÆË®àÊôÇÂô®
      function startQuestionTimer() {
        const timerDisplay = document.getElementById("timer");
        let timeLeft = QUESTION_TIME_LIMIT;

        questionTimer = setInterval(() => {
          timeLeft = QUESTION_TIME_LIMIT - (Date.now() - questionStartTime);

          if (timeLeft <= 0) {
            clearInterval(questionTimer);
            handleAnswer("nopress");
          } else {
            timerDisplay.textContent = (timeLeft / 1000).toFixed(1);
            if (timeLeft < 1000) {
              timerDisplay.classList.add("warning");
            } else {
              timerDisplay.classList.remove("warning");
            }
          }
        }, 50);
      }

      // ËôïÁêÜÁ≠îÊ°à
      function handleAnswer(action) {
        if (!questionTimer) return; // Â∑≤Á∂ìÂõûÁ≠îÈÅé

        clearInterval(questionTimer);
        questionTimer = null;

        const question = gameState.questions[gameState.currentQuestionIndex];
        const reactionTime = Date.now() - questionStartTime;
        const isCorrect = action === question.correctAction;

        // Ë®òÈåÑÁ≠îÊ°à
        gameState.answers.push({
          questionId: question.id,
          stimulusType: question.stimulusType,
          correctAction: question.correctAction,
          userAction: action,
          isCorrect: isCorrect,
          reactionTime: reactionTime,
        });

        // Êõ¥Êñ∞ÂàÜÊï∏
        if (isCorrect) {
          const timeBonus = Math.max(
            0,
            Math.floor((QUESTION_TIME_LIMIT - reactionTime) / 100),
          );
          gameState.score += 10 + timeBonus;
        }

        document.getElementById("scoreValue").textContent = gameState.score;

        // È°ØÁ§∫ÂèçÈ•ã
        showFeedback(isCorrect);

        // ÂãïÁï´ÊïàÊûú
        const display = document.getElementById("stimulusDisplay");
        display.classList.add(isCorrect ? "correct" : "wrong");
        setTimeout(() => {
          display.classList.remove("correct", "wrong");
        }, 500);

        // ‰∏ã‰∏ÄÈ°å
        setTimeout(() => {
          gameState.currentQuestionIndex++;
          showQuestion();
        }, 1000);
      }

      // È°ØÁ§∫ÂèçÈ•ã
      function showFeedback(isCorrect) {
        const feedback = document.getElementById("feedback");
        feedback.textContent = isCorrect ? "‚úì" : "‚úó";
        feedback.style.color = isCorrect ? "#00b894" : "#ff7675";
        feedback.classList.add("show");

        setTimeout(() => {
          feedback.classList.remove("show");
        }, 800);

        // Êí≠ÊîæÂèçÈ•ãÈü≥Êïà
        playFeedbackSound(isCorrect);
      }

      // ÁµêÊùüÈÅäÊà≤
      function endGame() {
        const endTime = Date.now();
        const totalTime = endTime - gameState.startTime;

        // Ë®àÁÆóÁµ±Ë®à
        const totalQuestions = gameState.answers.length;
        const correctAnswers = gameState.answers.filter(
          (a) => a.isCorrect,
        ).length;
        const accuracy = ((correctAnswers / totalQuestions) * 100).toFixed(1);

        // ÂÑ≤Â≠òÁµêÊûú
        const resultData = {
          stage: gameState.stage,
          score: gameState.score,
          accuracy: parseFloat(accuracy),
          totalQuestions: totalQuestions,
          correctAnswers: correctAnswers,
          totalTime: totalTime,
          answers: gameState.answers,
          completedAt: Date.now(),
        };

        localStorage.setItem("singleplayerResult", JSON.stringify(resultData));

        // Ë∑≥ËΩâÂà∞ÁµêÊûúÈ†ÅÈù¢
        window.location.href = "result.html";
      }

      // Êí≠ÊîæË™ûÈü≥
      function playFeedbackSound(isCorrect) {
        const audio = document.getElementById("audioPlayer");
        if (isCorrect) {
          const correctSounds = [
            "../audio/voice/voice-feedback-correct-01.wav",
            "../audio/voice/voice-feedback-correct-02.wav",
            "../audio/voice/voice-feedback-correct-03.wav",
          ];
          audio.src =
            correctSounds[Math.floor(Math.random() * correctSounds.length)];
        } else {
          const wrongSounds = [
            "../audio/voice/voice-feedback-wrong-01.wav",
            "../audio/voice/voice-feedback-wrong-02.wav",
          ];
          audio.src =
            wrongSounds[Math.floor(Math.random() * wrongSounds.length)];
        }
        audio.play().catch((e) => console.log("Èü≥ÊïàÊí≠ÊîæÂ§±Êïó:", e));
      }

      // ÈçµÁõ§‰∫ã‰ª∂
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space" && questionTimer) {
          e.preventDefault();
          document.getElementById("spaceHint").classList.add("active");
          handleAnswer("press");
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.code === "Space") {
          document.getElementById("spaceHint").classList.remove("active");
        }
      });

      // Èò≤Ê≠¢ÊÑèÂ§ñÈõ¢Èñã
      window.addEventListener("beforeunload", (e) => {
        if (questionTimer) {
          e.preventDefault();
          e.returnValue = "";
        }
      });
    </script>
  </body>
</html>
