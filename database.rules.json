{
  "rules": {
    "rooms": {
      ".read": "auth != null",

      "$roomCode": {
        ".read": "auth != null",
        ".write": "auth != null && (!data.exists() || data.child('hostId').val() === auth.uid || (data.child('expiresAt').exists() && data.child('expiresAt').val() < now))",
        ".indexOn": ["createdAt", "status", "expiresAt"],

        // --- 房間基本資訊（房主可寫全部，其他人有限寫入）---
        "roomCode": {
          ".write": "auth != null && (!data.exists() || data.parent().child('hostId').val() === auth.uid)"
        },
        "roomName": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid",
          ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 50"
        },
        "hostId": {
          ".write": "auth != null && (!data.exists() || data.parent().child('hostId').val() === auth.uid || data.parent().child('players').child(data.val()).child('online').val() === false)"
        },
        "hasPassword": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },
        "passwordHash": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },
        "hostJoinedGame": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },
        "createdAt": { ".write": "auth != null && !data.exists()" },
        "expiresAt": {
          ".write": "auth != null && (!data.exists() || data.parent().child('hostId').val() === auth.uid)"
        },
        "status": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid",
          ".validate": "newData.isString() && (newData.val() === 'waiting' || newData.val() === 'playing' || newData.val() === 'finished')"
        },
        "gameStarted": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },
        "countdownSeconds": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },

        // --- 遊戲設定（僅房主）---
        "gameSettings": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },
        "gameCombos": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },
        "displaySettings": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },

        // --- 遊戲狀態（僅房主可寫）---
        "gameState": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },

        // --- 遊戲場地順序（僅房主可寫）---
        "stageOrder": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },
        "gameStages": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },
        "startTime": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },
        "isGameStarted": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid"
        },

        // --- 玩家答題記錄（各自只能寫自己的）---
        "answers": {
          "$uid": {
            ".read": "auth != null",
            ".write": "auth != null && ($uid === auth.uid || data.parent().parent().child('hostId').val() === auth.uid)"
          }
        },

        // --- 場地完成通知（各自只能寫自己的，獨立於 players 避免快照風暴）---
        "notifications": {
          ".read": "auth != null",
          "$uid": {
            ".read": "auth != null",
            ".write": "auth != null && ($uid === auth.uid || data.parent().parent().child('hostId').val() === auth.uid)"
          }
        },

        // --- 玩家成績（各自只能寫自己的）---
        "scores": {
          "$uid": {
            ".read": "auth != null",
            ".write": "auth != null && ($uid === auth.uid || data.parent().parent().child('hostId').val() === auth.uid)",
            ".validate": "newData.hasChildren(['totalScore']) && newData.child('totalScore').isNumber() && newData.child('totalScore').val() >= 0 && newData.child('totalScore').val() <= 99999"
          }
        },

        // --- 遊戲結果（各自只能寫自己的）---
        "results": {
          "$uid": {
            ".read": "auth != null",
            ".write": "auth != null && ($uid === auth.uid || data.parent().parent().child('hostId').val() === auth.uid)"
          }
        },

        // --- 玩家資料（各自只能改自己的）---
        "players": {
          "$uid": {
            ".read": "auth != null",
            ".write": "auth != null && ($uid === auth.uid || data.parent().parent().child('hostId').val() === auth.uid)",
            ".validate": "newData.hasChildren(['nickname']) && newData.child('nickname').isString() && newData.child('nickname').val().length <= 30"
          }
        },

        // --- 接力賽遊戲模式 ---
        "gameMode": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid",
          ".validate": "newData.isString() && (newData.val() === 'individual' || newData.val() === 'relay' || newData.val() === 'team')"
        },
        "teamCount": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() >= 2 && newData.val() <= 10"
        },
        "teamAssignment": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid",
          ".validate": "newData.isString() && (newData.val() === 'random' || newData.val() === 'manual' || newData.val() === 'selfSelect')"
        },
        "captainSelection": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid",
          ".validate": "newData.isString() && (newData.val() === 'hostAssign' || newData.val() === 'random')"
        },
        "maxPlayers": {
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid",
          ".validate": "newData.isNumber() && newData.val() >= 2 && newData.val() <= 20"
        },

        // --- 隊伍資料（房主可設定全部；selfSelect 模式玩家可寫自己的成員資料）---
        "teams": {
          ".read": "auth != null",
          ".write": "auth != null && data.parent().child('hostId').val() === auth.uid",
          "$teamId": {
            "members": {
              "$uid": {
                ".write": "auth != null && $uid === auth.uid && data.parent().parent().parent().parent().child('teamAssignment').val() === 'selfSelect'"
              }
            },
            "order": {
              ".write": "auth != null && data.parent().parent().parent().child('teamAssignment').val() === 'selfSelect' && data.parent().parent().parent().child('players').child(auth.uid).exists()"
            },
            "captainId": {
              ".write": "auth != null && data.parent().parent().parent().child('players').child(auth.uid).exists()"
            }
          }
        },

        // --- 接力賽即時狀態（房主可設定，且當前棒次玩家可推進）---
        "relayState": {
          ".read": "auth != null",
          ".write": "auth != null && (data.parent().child('hostId').val() === auth.uid || data.parent().child('players').child(auth.uid).exists())"
        }
      }
    }
  }
}
