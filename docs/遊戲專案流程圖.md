# 🗺️ 執行功能訓練遊戲 — 完整流程圖集

> **對應文件**：[完整需求文件 v4.5](完整需求文件v4.5.md)（2026/02/18）  
> **流程圖語法**：Mermaid  
> **總數**：30 個流程圖 + 3 個開發路線圖，分 6 大類  
> **v4.3 變更**：探險地圖取代遊戲場+標準模式、自由選擇取代自由模式、WM≥83%通過、全員完成廣播+觀看總結果按鈕鎖定解鎖、房主變更通知區分新房主/其他玩家  
> **v4.4 變更**：§1.3 流程圖索引完整交叉連結（30 流程圖↔需求章節雙向導航）、新增開發路線圖章節（Phase 依賴圖 + 甘特圖 + 決策時間線）  
> **v4.5 變更**：Phase 5 多人重構完成、檔案結構完整重寫（66 JS + 23 HTML）、遊戲設定範圍更新、即時排行榜代碼制（2分鐘生命週期）、班級排行榜匯入匯出完整化

---

## 📑 目錄

### 📍 開發路線圖（Development Roadmap）

0-1. [Phase 依賴圖](#roadmap-1-phase-依賴圖)
0-2. [開發時程甘特圖](#roadmap-2-開發時程甘特圖)
0-3. [設計決策時間線](#roadmap-3-設計決策時間線)

### A. 使用者流程（User Flows）

1. [系統總覽流程圖](#flow-1-系統總覽流程圖)
2. [多人模式完整流程](#flow-2-多人模式完整流程)
3. [單人探險地圖模式流程](#flow-3-單人探險地圖模式流程)
4. [單人自由選擇模式流程](#flow-4-單人自由選擇模式流程)
5. [探險地圖單一探險點流程](#flow-5-探險地圖單一探險點流程)
6. [多人房間建立與加入流程](#flow-6-多人房間建立與加入流程)
7. [暫停與退出流程](#flow-7-暫停與退出流程)
8. [房主斷線轉移流程](#flow-8-房主斷線轉移流程)

### B. 遊戲邏輯（Game Logic Flows）

9. [單一試驗時間軸流程](#flow-9-單一試驗trial時間軸流程)
10. [Go/No-Go 規則判定引擎](#flow-10-gono-go-規則判定引擎)
11. [計分系統流程（單一規則）](#flow-11-計分系統流程單一規則)
12. [WM 計分系統流程](#flow-12-wm-計分系統流程)
13. [WM 測驗遊戲流程](#flow-13-wm-測驗遊戲流程)
14. [題目生成流程](#flow-14-題目生成流程)
15. [刺激物語音性別判定流程](#flow-15-刺激物語音性別判定流程)

### C. 資料流程（Data Flows）

16. [資料儲存層次與同步流程](#flow-16-資料儲存層次與同步流程)
17. [多人模式 Firebase 即時同步流程](#flow-17-多人模式-firebase-即時同步流程)
18. [成績輸出流程（截圖＋CSV）](#flow-18-成績輸出流程截圖csv)
19. [排行榜雙軌制資料流](#flow-19-排行榜雙軌制資料流)
20. [Fallback 降級機制流程](#flow-20-fallback-降級機制流程)

### D. 狀態機（State Machines）

21. [關卡解鎖狀態機](#flow-21-關卡解鎖狀態機)
22. [星星與等級狀態機](#flow-22-星星與等級狀態機)
23. [徽章判定狀態機](#flow-23-徽章判定狀態機)
24. [多人房間狀態機](#flow-24-多人房間狀態機)
25. [單一組合玩家狀態機](#flow-25-單一組合combo玩家狀態機)

### E. 決策流程（Decision Flows）

26. [通過／失敗判定與後續處理流程](#flow-26-通過失敗判定與後續處理流程)
27. [不屈勇士徽章觸發流程](#flow-27-不屈勇士徽章觸發流程)
28. [反應時間（RT）計算流程](#flow-28-反應時間rt計算流程)
29. [聲音系統播放決策流程](#flow-29-聲音系統播放決策流程)
30. [配色主題與刺激物 Config 載入流程](#flow-30-配色主題與刺激物-config-載入流程)

---

# 📍 開發路線圖（Development Roadmap）

> **用途**：開發導航——知道「現在該做什麼」「下一步是什麼」「什麼時候討論什麼」  
> **對應文件**：[完整需求文件 v4.4 §7](完整需求文件v4.4.md#七開發時程與路線圖-)（完整版含各 Phase 產出物清單、決策分級與 checklist）

---

## Roadmap-1: Phase 依賴圖

> **說明**：8 個開發階段的先後依賴關係。實線 = 強依賴，虛線 = 可平行。Phase 4（單人）→ 5（多人）接續式開發。

```mermaid
graph TD
    P0["✅ Phase 0<br/>開發前清理"]
    P1["Phase 1<br/>🏗️ 基礎建設<br/><i>Config + CSS + 目錄骨架</i>"]
    P2["Phase 2<br/>🎮 遊戲核心引擎<br/><i>規則 + 渲染 + 計分</i>"]
    P3["Phase 3<br/>🧩 共用元件<br/><i>倒數 + 回饋 + WM + 過場</i>"]
    P4["Phase 4<br/>�️ 單人模式<br/><i>探險地圖 + 自由選擇</i>"]
    P5["Phase 5<br/>👥 多人模式<br/><i>房間 + 同步 + 結算</i>"]
    P6["Phase 6<br/>🏆 排行榜 + 設定 + 輸出"]
    P7["Phase 7<br/>🎨 整合測試 + 美化"]

    P0 --> P1
    P1 --> P2
    P2 --> P3
    P3 --> P4
    P4 --> P5
    P5 --> P6
    P6 --> P7

    PA["🔊 聲音/媒體製作<br/><i>可平行進行</i>"]
    P1 -.->|config 結構定好即可開始| PA
    PA -.-> P7

    style P0 fill:#2d6a4f,color:#fff
    style P1 fill:#e76f51,color:#fff,stroke:#e76f51,stroke-width:3px
    style PA fill:#457b9d,color:#fff,stroke-dasharray: 5 5
```

**閱讀方式**：

- **實線箭頭** = 強依賴（必須完成前一個）
- **虛線箭頭** = 弱依賴（可平行進行）
- Phase 4 → 5 **接續式開發**：先用單人模式驗證核心引擎，再加上多人同步層
- 🔊 聲音/媒體製作隨時可進行，不卡主線

| Phase              | 內容                         |         預估天數          |   風險    |
| ------------------ | ---------------------------- | :-----------------------: | :-------: |
| 0 開發前清理       | Firebase rules / config 修正 |            0.5            | ✅ 已完成 |
| 1 基礎建設         | Config + CSS 主題 + 目錄骨架 |            3-4            |   🟢 低   |
| 2 遊戲核心引擎     | 規則判定 + 渲染 + 計分       |            4-5            |   🟡 中   |
| 3 共用元件         | 倒數 + 回饋 + WM + 過場      |            4-5            |   🟡 中   |
| 4 單人模式         | 探險地圖 + 自由選擇          |            5-7            |   🟡 中   |
| 5 多人模式         | 房間 + 即時同步 + 結算       |            5-7            |   🔴 高   |
| 6 排行榜+設定+輸出 | 三種排行榜 + CSV + 設定      |            4-5            |   🟢 低   |
| 7 整合測試+美化    | 跨瀏覽器 + 響應式 + 效能     |            3-5            |   🟡 中   |
| **合計**           |                              | **29-39 天（約 5-7 週）** |           |

---

## Roadmap-2: 開發時程甘特圖

> **說明**：各 Phase 時程預估與平行作業視覺化。Phase 4（單人）→ 5（多人）接續開發。

```mermaid
gantt
    title 開發時程預估（共 5-7 週）
    dateFormat  YYYY-MM-DD
    axisFormat  %m/%d

    section 🏗️ 基礎
    Phase 0 開發前清理          :done, p0, 2026-02-13, 1d
    Phase 1 Config + CSS        :active, p1, after p0, 4d

    section 🎮 核心
    Phase 2 遊戲核心引擎        :p2, after p1, 5d
    Phase 3 共用元件            :p3, after p2, 5d

    section 📱 功能
    Phase 4 單人模式            :p4, after p3, 7d
    Phase 5 多人模式            :p5, after p4, 7d

    section 🏆 支援
    Phase 6 排行榜+設定+輸出    :p6, after p5, 5d
    Phase 7 整合測試+美化       :p7, after p6, 5d

    section 🔊 平行
    聲音/媒體素材製作           :pa, after p1, 20d
```

---

## Roadmap-3: 設計決策時間線

> **說明**：「什麼時候該討論什麼設計」— 越早定的項目，後續改動成本越高。

```mermaid
graph LR
    subgraph "🔴 Phase 1 就要定"
        A1["🎨 配色主題色碼"]
        A2["📐 字體大小階層"]
        A3["🔘 按鈕觸控尺寸"]
        A4["📱 響應式斷點"]
        A5["📁 CSS 變數命名"]
    end

    subgraph "🟡 Phase 2-3 定"
        B1["✨ 動畫風格基調"]
        B2["🧠 WM 介面排版"]
        B3["💚 回饋動畫微調"]
        B4["🔄 過場轉場風格"]
    end

    subgraph "🟢 Phase 4-5 定"
        C1["🗺️ 探險地圖美術"]
        C2["👥 等待室 UI"]
        C3["📊 房主儀表板"]
        C4["🏅 徽章展示設計"]
    end

    subgraph "⚪ Phase 6-7 再定"
        D1["📊 排行榜樣式"]
        D2["⚙️ 設定頁 layout"]
        D3["📋 CSV 格式微調"]
    end

    A1 --> B1 --> C1 --> D1
```

**判斷原則**：

| 等級 | 什麼時候決定               | 為什麼                       |   改動成本    |
| :--: | -------------------------- | ---------------------------- | :-----------: |
|  🔴  | **開始寫第一行 CSS/JS 前** | 這些是地基，所有頁面都會引用 |  💀 全站返工  |
|  🟡  | **開發共用元件時**         | 多人/單人共用，定一次用到底  | 😰 多頁面修改 |
|  🟢  | **開發各模式時**           | 僅影響該頁面，不擴散         |  😐 單頁修改  |
|  ⚪  | **最後收尾時**             | 純呈現層，隨時可改           |  😊 微調即可  |

---

# A. 使用者流程（User Flows）

---

## Flow-1: 系統總覽流程圖

> **說明**：從首頁入口到所有功能終點的全局導覽。  
> **對應章節**：§1.3 系統流程圖、§6 檔案結構

```mermaid
flowchart TB
    START([🏠 首頁]) --> INFO[📖 說明頁面]

    INFO --> SINGLE[🎮 單人冒險]
    INFO --> MULTI[👥 多人競賽]
    INFO --> LEADERBOARD[🏆 排行榜]

    %% === 導覽列（下方選項列）===
    NAV[📋 導覽列]
    NAV --> NAV_ADV[🐭 冒險]
    NAV --> NAV_COMP[👥 競賽]
    NAV --> NAV_RANK[🏆 排行]
    NAV --> NAV_FARM[🐔 養雞場]
    NAV --> NAV_SHOP[🛍️ 商店]
    NAV --> NAV_SETTING[⚙️ 設定]

    %% === 設定選單 ===
    NAV_SETTING --> THEME[🎨 配色主題]
    NAV_SETTING --> SOUND[🔊 聲音設定<br/>音效 ON/OFF、語音 ON/OFF]
    NAV_SETTING --> STIMULI[🖼️ 刺激物設定<br/>預設包 / 自訂包]

    %% === 單人冒險分支 ===
    SINGLE --> MOUSE[🐭 小老鼠冒險]
    SINGLE --> FISH[🐟 釣魚冒險]
    SINGLE --> FREE_SELECT[🆓 自由選擇 解鎖<br/>=多人房主同等自由度<br/>→ 詳見 Flow-4]

    MOUSE --> SP_GAME[🎮 單人遊戲進行<br/>→ 詳見 Flow-9]
    FISH --> SP_GAME
    FREE_SELECT --> SP_GAME

    SP_GAME --> SP_RESULT
    SP_RESULT[🎉 成績結算<br/>星星 / 徽章 / 等級 / CSV]
    SP_RESULT --> SP_REPORT[📊 分析報告]
    SP_RESULT --> SP_CLASS_RANK[📤 上傳至班級排行榜]
    SP_RESULT --> SP_WORLD_RANK[🌍 上傳至世界排行榜]

    SP_CLASS_RANK --> SP_ENTER_CODE[輸入班級代碼]
    SP_ENTER_CODE --> SP_UPLOAD_DONE[📤 上傳 Firestore<br/>成功上傳後即刪除 / 2分鐘後自動刪除 / 看板刪除後刪除]

    %% === 多人競賽分支 ===
    MULTI --> MP_MENU[👥 多人選單]
    MP_MENU -->|🏠 建立房間| CREATE[🏠 房間設定<br/>遊戲場×規則×WM×題數×排序<br/>+ 房主是否加入遊戲]
    MP_MENU -->|🔑 加入房間| JOIN[🔑 輸入代碼 / 掃 QR / 短網址<br/>（QR 與短網址直接進入房間）]
    CREATE --> WAITING[📋 等待室<br/>玩家「準備好了」<br/>房主「開始遊戲」]
    JOIN --> VERIFY{密碼驗證?}
    VERIFY -->|✅ 通過| WAITING
    VERIFY -->|❌ 錯誤| JOIN

    WAITING --> MP_GAME[👥 多人遊戲進行<br/>6 階段流程<br/>→ 詳見 Flow-2]
    MP_GAME --> MP_RESULT[🏆 多人最終排名<br/>截圖 / CSV 匯出]
    MP_RESULT --> SP_REPORT
    MP_RESULT --> SP_CLASS_RANK
    MP_RESULT --> SP_WORLD_RANK

    %% === 排行榜分支 ===
    LEADERBOARD --> LOCAL_LB[📊 班級排行榜<br/>localStorage]
    LEADERBOARD --> GLOBAL_LB[🌐 全球排行榜<br/>Firestore]
    LEADERBOARD --> LIVE_LB[⚡ 即時排行榜]

    %% === 班級排行榜子功能 ===
    LOCAL_LB --> LIVE_MODE[⚡ 即時模式]
    LOCAL_LB --> CSV_MODE[📥 CSV匯入模式]

    LIVE_MODE --> CREATED_LB[📋 已建立看板名單]
    CREATED_LB --> LIVE_MODE

    CSV_MODE --> IMPORT_CSV[📥 匯入學生 CSV<br/>多檔匯入→匿名排序]
    IMPORT_CSV --> EXPORT_CSV[📤 匯出合併 CSV<br/>同匯入格式，可再匯入]
    EXPORT_CSV --> LOCAL_LB
    LOCAL_LB --> LEADERBOARD

    %% === 即時排行榜 ===
    LIVE_LB --> LIVE_TEACHER{身份?}
    LIVE_TEACHER -->|👩‍🏫 老師| LIVE_CREATE[產生代碼<br/>等待學生上傳]
    LIVE_TEACHER -->|👦 學生| LIVE_JOIN[輸入代碼<br/>查看即時排名]
    LIVE_CREATE --> LIVE_BOARD[⚡ 即時排行看板<br/>sessionStorage<br/>關閉分頁才清空]
    LIVE_JOIN --> LIVE_BOARD
    LIVE_BOARD --> LEADERBOARD

    GLOBAL_LB --> LEADERBOARD

    %% === 樣式 ===
    style START fill:#4CAF50,color:#fff
    style INFO fill:#2196F3,color:#fff
    style SINGLE fill:#FF6B6B,color:#fff
    style MULTI fill:#9C27B0,color:#fff
    style LEADERBOARD fill:#FFA500,color:#fff
    style SETTINGS fill:#607D8B,color:#fff
    style MP_RESULT fill:#FF9800,color:#fff
    style SP_RESULT fill:#FF9800,color:#fff
    style ADVENTURE fill:#FF9800,color:#fff
    style LOCK_MSG fill:#9E9E9E,color:#fff
```

### 📌 關鍵設計點

- **首頁兩大入口**：📱 單人 / 👥 多人，簡潔分流
- **⚙️ 設定 = 全局浮動**：右上角齒輪 icon，任何頁面都能進入（不佔首頁入口）
- **單人主流程 = 探險地圖**：新手唯一入口，12 個探險點逐步解鎖 🆕v4.3
- **自由選擇 = 解鎖後開放**：探險地圖全通過後解鎖，= 多人房主同等自由度 🆕v4.3
- **遊戲場模式已取消**：由探險地圖取代 🆕v4.3
- **通過門檻**：全局 ≥83%（≈5/6 題），依文獻設定
- **排行榜三種**：📊 班級（本地）+ 🌐 全球（Firestore 逐項勾選）+ ⚡ 即時（代碼制，2分鐘生命週期）🆕v4.3
- **CSV 統一格式**：個人 CSV = 班級排行榜 CSV（第一區 14 欄摘要 + 第二區逐題明細），班級匯入只讀第一區 🆕v4.3
- **座號欄位**：學生在設定頁填寫，CSV 第一欄，班級排行榜以座號匿名顯示 🆕v4.3
- **班級排行榜**：匯入多位學生 CSV → 匿名（座號）排序，可選擇排行欄位（最多顯示 5 個）🆕v4.3
- **即時排行榜**：上傳「本次成績」（非累計），重複上傳覆蓋前一筆，看板存 sessionStorage 🆕v4.3
- **多人密碼可選**：房間可設密碼，也可開放加入
- **房主可選擇是否加入遊戲**：不加入則顯示即時狀態儀表板 🆕v4.3
- **QR Code 與短網址直接進入房間**：無須手動輸入代碼，掃描 / 點連結即進入 🔄v4.3

---

## Flow-2: 多人模式完整流程

> **說明**：從房主建立房間到最終排名的 6 階段完整生命週期。  
> **對應章節**：§2.5–§2.8 遊戲流程完整版

```mermaid
flowchart TB
    subgraph 階段1["階段 1：同步開始"]
        S1_HOST[房主按「開始遊戲」] --> S1_JOIN_CHECK{房主是否<br/>加入遊戲?}
        S1_JOIN_CHECK -->|✅ 加入| S1_COUNT[📢 所有玩家一起倒數<br/>3…2…1…開始！]
        S1_JOIN_CHECK -->|❌ 不加入| S1_DASHBOARD[📊 房主進入儀表板<br/>即時查看所有玩家狀態]
        S1_COUNT --> S1_START[組合 1 開始]
        S1_DASHBOARD --> S1_START
    end

    subgraph 階段2["階段 2：組合內答題"]
        S1_START --> S2_PLAY[各自答題<br/>題目順序相同、進度獨立<br/>答完立即切下一題（0 秒切換）]
        S2_PLAY --> S2_DONE{玩家答完<br/>本組合所有題目?}
        S2_DONE -->|否| S2_PLAY
        S2_DONE -->|是| S2_WM_CHECK{本組合<br/>有 WM?}
    end

    subgraph 階段2_5["階段 2.5：WM 測驗"]
        S2_WM_CHECK -->|有| S2_WM[🧠 WM 測驗<br/>順/逆向 + n 個位置<br/>無時間限制]
        S2_WM_CHECK -->|無| S3_WAIT
        S2_WM --> S3_WAIT
    end

    subgraph 階段3["階段 3：等待同步"]
        S3_WAIT[⏳ 等待其他玩家完成<br/>通知「○○ 完成了 🐭規則一！」3秒<br/>本組合最後一人「🎉 全員完成本組合！」]
        S3_WAIT --> S3_ALL{所有玩家<br/>都完成?}
        S3_ALL -->|否| S3_WAIT
        S3_ALL -->|是| S4_CHECK
    end

    subgraph 階段4["階段 4：組合切換"]
        S4_CHECK{還有<br/>下個組合?}
        S4_CHECK -->|是| S4_NEXT[📋 過場畫面<br/>「準備進入組合 2」<br/>各自按「開始」→ 各自倒數]
        S4_CHECK -->|否| S5_WAIT
        S4_NEXT --> S2_PLAY
    end

    subgraph 階段5["階段 5：等待所有玩家完成"]
        S5_WAIT[⏳ 已完成所有組合<br/>畫面顯示「觀看遊戲總結果」<br/>🔒 按鈕鎖定（灰色不可點）]
        S5_WAIT --> S5_ALL{所有玩家<br/>都完成?}
        S5_ALL -->|否| S5_WAIT
        S5_ALL -->|是| S5_BROADCAST[📢 廣播所有玩家<br/>「🎉 所有玩家已完成！」]
        S5_BROADCAST --> S5_UNLOCK[🔓 按鈕解鎖<br/>「觀看遊戲總結果」可點擊]
        S5_UNLOCK --> S5_CLICK[玩家點擊按鈕<br/>進入總結果畫面]
    end

    S5_CLICK --> S6_END

    subgraph 階段6["階段 6：遊戲結束"]
        S6_END[🏆 最終排名畫面<br/>🥇🥈🥉 + 分數 + ⭐]
        S6_END --> S6_OUT{輸出選項}
        S6_OUT --> SCREENSHOT[📸 下載截圖]
        S6_OUT --> CSV[📊 匯出 CSV]
        S6_OUT --> HOME[🏠 回到首頁]
    end

    style S1_HOST fill:#4CAF50,color:#fff
    style S6_END fill:#FF9800,color:#fff
```

### 📌 關鍵設計點

- **階段 1 唯一同步**：只有最開始需所有人一起倒數
- **房主可選擇不加入遊戲**：不加入則顯示即時狀態儀表板（所有玩家的答題進度、組合完成狀態、分數等） 🆕v4.3
- **階段 4 各自節奏**：組合切換時各自按開始、各自倒數
- **0 秒題目切換**：多人模式答題後立即顯示下一題（無停留）
- **3 秒完成通知**：顯示具體組合名稱（如「🐭規則一+WM」）；全部完成時額外通知「🎉 全部完成！」
- **階段 5 按鈕鎖定機制**：玩家完成所有組合後看到「觀看遊戲總結果」按鈕（🔒 鎖定），等所有玩家都完成後廣播「🎉 所有玩家已完成！」→ 按鈕解鎖（🔓），玩家自行點擊進入總結果畫面 🆕v4.3
- **截圖與 CSV 在總結果畫面**：進入階段 6 最終排名畫面後才能下載截圖與匯出 CSV
- **成績不寫入個人紀錄**：多人成績存 RTDB，房主離開遊戲 / 關閉分頁即清空刪除

---

## Flow-3: 單人探險地圖模式流程

> **說明**：單人主流程，2 張探險地圖各 6 個探險點，逐步解鎖，全通過解鎖自由選擇。  
> **對應章節**：§3.2 探險地圖模式 🆕v4.3

```mermaid
flowchart TB
    START([🗟a️ 探險地圖]) --> MAP_SELECT{當前地圖}

    MAP_SELECT -->|🐭 小老鼠冒險| MAP1[🗟a️ 地圖 1：小老鼠冒險<br/>6 個探險點]
    MAP_SELECT -->|🐟 釣魚冒險 🔒| MAP2[🗟a️ 地圖 2：釣魚冒險<br/>6 個探險點<br/>🔒 地圖 1 全通過後解鎖]

    MAP1 --> HUB1[🗟a️ 地圖畫面<br/>⬜ 未解鎖（灰色+🔒）<br/>🟡 當前可玩（發光）<br/>⭐ 已通過（星星）]

    HUB1 --> PICK1{選擇探險點}
    PICK1 -->|① 🐭R1| P1[規則一 n 題]
    PICK1 -->|② 🐭R1+WM| P2[規則一 n 題 + 🧠WM]
    PICK1 -->|③ 🐭R2| P3[規則二 n 題]
    PICK1 -->|④ 🐭R2+WM| P4[規則二 n 題 + 🧠WM]
    PICK1 -->|⑤ 🐭混合| P5[混合 n×2 題]
    PICK1 -->|⑥ 🐭混合+WM| P6[混合 n×2 題 + 🧠WM]

    P1 --> PLAY[→ 詳見 Flow-5<br/>單一探險點流程]
    P2 --> PLAY
    P3 --> PLAY
    P4 --> PLAY
    P5 --> PLAY
    P6 --> PLAY

    PLAY --> RESULT[探險點結算<br/>通過/未通過 + 星星]

    RESULT --> BACK_MAP{3 狀態更新}
    BACK_MAP -->|✅ 通過| UNLOCK_NEXT[解鎖下一探險點<br/>回到地圖畫面]
    BACK_MAP -->|❌ 未通過| RETRY[可重玩 / 回地圖]

    UNLOCK_NEXT --> MAP1_DONE{6 點全通過?}
    RETRY --> HUB1

    MAP1_DONE -->|❌| HUB1
    MAP1_DONE -->|✅| MAP1_CLEAR[🎉 地圖 1 完成！<br/>解鎖地圖 2]

    MAP1_CLEAR --> MAP2
    MAP2 --> HUB2[🗟a️ 釣魚地圖畫面<br/>同樣 6 個探險點]
    HUB2 --> PLAY

    HUB2 --> MAP2_DONE{6 點全通過?}
    MAP2_DONE -->|❌| HUB2
    MAP2_DONE -->|✅| ALL_CLEAR[🎉🎉 全部通關！<br/>慶祝動畫<br/>解鎖「🆓 自由選擇」]

    ALL_CLEAR --> HOME([🏠 回單人選單])

    style START fill:#4CAF50,color:#fff
    style MAP1_CLEAR fill:#FF9800,color:#fff
    style ALL_CLEAR fill:#FFD700,color:#333
    style HUB1 fill:#E3F2FD
    style HUB2 fill:#E3F2FD
```

### 📌 關鍵設計點

- **單人唯一起始流程**：探險地圖取代遊戲場模式 + 標準模式 🆕v4.3
- **2 張地圖，各 6 探險點**：①R1 → ②R1+WM → ③R2 → ④R2+WM → ⑤混合 → ⑥混合+WM
- **強制逐步解鎖**：通過①才能玩②，依此類推
- **可分次遊玩**：今天玩到③，明天繼續④（進度 localStorage 儲存）
- **探險點 3 狀態**：⬜ 未解鎖 / 🟡 當前可玩 / ⭐ 已通過
- **已通過可重玩**：星星無限累計，不影響解鎖進度
- **Config 可調順序**：ADVENTURE_MAPS 陣列可彈性調整探險點排列
- **地圖 1 全通過 → 解鎖地圖 2**；**12 點全通過 → 解鎖自由選擇**

---

## Flow-4: 單人自由選擇模式流程

> **說明**：探險地圖全通過後解鎖，= 多人房主同等自由度，共用 game-session-builder 模組。  
> **對應章節**：§3.2 自由選擇模式 🆕v4.3

```mermaid
flowchart TB
    START([🆓 自由選擇<br/>🔒 探險地圖 12 點全通過後解鎖]) --> BUILDER

    subgraph BUILDER["game-session-builder 模組<br/>（= 多人房主同模組）"]
        B1[✅ 選擇遊戲場<br/>🐭 / 🐟 / 兩者]
        B1 --> B2[✅ 選擇規則<br/>規則一 / 規則二 / 混合<br/>可複選]
        B2 --> B3[✅ WM 開關<br/>逐組勾選 + 全選按鈕]
        B3 --> B4[✅ 題數設定<br/>每組 6-30 題，預設 6]
        B4 --> B5[✅ 排列順序<br/>拖曳排序遊戲組合]
        B5 --> GO[▶️ 開始遊戲]
    end

    GO --> TRANSITION_1[📋 過場畫面<br/>顯示組合 1 規則說明<br/>🔊 播放規則語音]
    TRANSITION_1 --> READY_1[玩家按「開始」<br/>→ 3-2-1 倒數]
    READY_1 --> PLAY[逐題作答<br/>→ 詳見 Flow-9]
    PLAY --> COMBO_SCORE[組合小結算<br/>→ 詳見 Flow-11/12]

    COMBO_SCORE --> MORE{還有<br/>下個組合?}
    MORE -->|是| TRANSITION_N[📋 過場畫面<br/>「準備進入組合 N」<br/>規則說明 + 🔊 語音<br/>按「開始」→ 倒數]
    TRANSITION_N --> PLAY
    MORE -->|否| RESULT

    RESULT[🎉 全部完成！<br/>成績大結算 + CSV 匯出]
    RESULT --> RETRY{重新挑戰?}
    RETRY -->|是| BUILDER
    RETRY -->|否| HOME([🏠 回單人選單])

    style START fill:#4CAF50,color:#fff
    style RESULT fill:#FF9800,color:#fff
    style BUILDER fill:#E8F5E9
```

### 📌 關鍵設計點

- **探險地圖 12 點全通過後解鎖** 🆕v4.3
- **= 多人房主同等自由度**：共用 game-session-builder 模組
- **組合切換與多人一致**：過場畫面 → 規則說明語音 → 按開始 → 倒數 → 開始 🆕v4.3
- **共用 shared/combo-transition.html**：多人/自由選擇同頁面 🆕v4.3
- **可複選遊戲場×規則**：任意排列組合
- **拖曳排序**：自訂遊戲順序
- **WM 逐組勾選**：每組獨立決定 + 全選/全取消
- **教師覆寫**：`?unlock=all` 可跳過所有鎖定

---

## Flow-5: 探險地圖單一探險點流程

> **說明**：探險地圖上點擊一個探險點後的完整遊玩流程（純規則 or 規則+WM）。  
> **對應章節**：§3.2 探險地圖模式 🆕v4.3

```mermaid
flowchart TB
    START([🗺️ 探險點開始<br/>例：② 🐭R1+WM]) --> TYPE{探險點類型}

    TYPE -->|純規則（①③⑤）| RULE_ONLY[規則 n 題<br/>混合：n×2 題]
    TYPE -->|規則+WM（②④⑥）| RULE_WM[規則 n 題 + 🧠 WM<br/>同一 session 綁定]

    RULE_ONLY --> PLAY[逐題作答<br/>→ 詳見 Flow-9]
    RULE_WM --> PLAY

    PLAY --> SCORE[計分結算<br/>→ 詳見 Flow-11]

    SCORE --> RULE_CHECK{規則答對率<br/>≥ 83%?}

    RULE_CHECK -->|✅ 通過| RULE_PASS[⭐ +1 星星（規則）]
    RULE_CHECK -->|❌ 未通過| RULE_FAIL[❌ 不得星星]

    RULE_PASS --> HAS_WM{本探險點<br/>含 WM?}
    RULE_FAIL --> HAS_WM

    HAS_WM -->|無 WM| FINAL_CHECK
    HAS_WM -->|有 WM| WM[🧠 WM 測驗<br/>→ 詳見 Flow-13]

    WM --> WM_SCORE[WM 計分<br/>→ 詳見 Flow-12]
    WM_SCORE --> WM_CHECK{WM ≥83%?}

    WM_CHECK -->|✅| WM_PASS[⭐ +1 WM 星星<br/>+ 全對 Bonus ⭐]
    WM_CHECK -->|❌| WM_FAIL[❌ 不得 WM 星星]

    WM_PASS --> FINAL_CHECK
    WM_FAIL --> FINAL_CHECK

    FINAL_CHECK{探險點通過?}

    FINAL_CHECK -->|純規則：規則≥83%| PASSED
    FINAL_CHECK -->|規則+WM：兩者皆≥83%| PASSED
    FINAL_CHECK -->|任一未通過| FAILED

    PASSED[✅ 探險點通過！<br/>解鎖下一探險點]
    FAILED[❌ 可重玩]

    PASSED --> BACK[回到探險地圖<br/>更新狀態 ⭐]
    FAILED --> BACK_F[回到探險地圖<br/>狀態不變 🟡]

    BACK --> MAP([🗺️ 探險地圖])
    BACK_F --> MAP

    style START fill:#4CAF50,color:#fff
    style PASSED fill:#FFD700,color:#333
    style FAILED fill:#F44336,color:#fff
    style WM_PASS fill:#4CAF50,color:#fff
```

### 📌 關鍵設計點

- **兩種探險點**：純規則（①③⑤）vs 規則+WM（②④⑥）
- **規則+WM 綁定**：同一 session 連續完成，WM 回憶「剛才」的刺激物
- **通過條件**：純規則 = 規則≥83%；規則+WM = 兩者皆≥83% 🆕v4.3
- **星星無限累計**：規則通過 +1⭐，WM 通過 +1⭐，WM 全對 Bonus ⭐（每次重玩都可累計）
- **WM Bonus 星星**：逆向全對 n≥2 → +(n-1)⭐；順向全對 2-6 → +1⭐，7-9 → +2⭐，n≥10 → +(n-7)⭐
- **未通過不解鎖**：可重玩此探險點，不影響其他進度

---

## Flow-6: 多人房間建立與加入流程

> **說明**：房主設定房間 + 玩家加入 + 等待室流程。  
> **對應章節**：§2.2 房間系統、§2.9 邀請功能

```mermaid
flowchart TB
    ENTRY([👥 多人模式]) --> ROLE{角色?}

    ROLE -->|房主| CREATE
    ROLE -->|玩家| JOIN_METHOD

    subgraph 建立房間["🏠 房主建立房間"]
        CREATE[設定房間] --> ROOM_NAME[📝 房間名稱]
        ROOM_NAME --> PWD[🔑 密碼（可選）]
        PWD --> FIELD

        subgraph GSB["game-session-builder<br/>（= 自由選擇共用模組）"]
            FIELD[✅ 遊戲場複選<br/>🐭 / 🐟 / 全選]
            FIELD --> RULE[✅ 規則複選<br/>規則一 / 規則二 / 混合 / 全選]
            RULE --> WM_SET[✅ WM 逐組勾選<br/>+ 全選/全取消]
            WM_SET --> QNUM[✅ 題數每組設定<br/>6-30 題，預設 6，混合×2]
            QNUM --> ORDER[✅ 拖曳排序]
        end

        ORDER --> COUNTDOWN[⏱️ 倒數秒數 2-5 秒]
        COUNTDOWN --> GEN[產生房間代碼<br/>（未填→自動生成 5 位；有填→依房主內容）<br/>+ 題目序列]
    end

    GEN --> WAITING

    subgraph 加入房間["🔑 玩家加入"]
        JOIN_METHOD{加入方式}
        JOIN_METHOD -->|輸入代碼| CODE[📝 輸入 5 位代碼]
        JOIN_METHOD -->|掃 QR Code| QR[📷 掃描 QR → 直接進入房間]
        JOIN_METHOD -->|短網址| URL[🔗 game.web.app/r/H7K2M<br/>→ 直接進入房間]
        CODE --> VALIDATE{代碼有效?}
        QR --> PWD_CHECK
        URL --> PWD_CHECK
        VALIDATE -->|❌ 無效| CODE
        VALIDATE -->|✅ 有效| PWD_CHECK{需要密碼?}
        PWD_CHECK -->|否| ENTER
        PWD_CHECK -->|是| PWD_INPUT[🔑 輸入密碼]
        PWD_INPUT --> PWD_VERIFY{密碼正確?}
        PWD_VERIFY -->|❌| PWD_INPUT
        PWD_VERIFY -->|✅| ENTER
    end

    ENTER[✅ 進入房間] --> WAITING

    subgraph 等待室["📋 等待室"]
        WAITING[等待室<br/>顯示所有玩家<br/>分享代碼 / QR]
        WAITING --> HOST_JOIN{房主是否<br/>加入遊戲?}
        HOST_JOIN -->|✅ 加入| HOST_PLAY[房主也是玩家]
        HOST_JOIN -->|❌ 不加入| HOST_OBSERVE[房主儀表板模式<br/>📊 即時查看所有玩家狀態]
        HOST_PLAY --> HOST_START{房主按<br/>「開始遊戲」?}
        HOST_OBSERVE --> HOST_START
        HOST_START -->|等待中| WAITING
        HOST_START -->|✅ 開始| GAME([🎮 進入遊戲<br/>→ 詳見 Flow-2])
    end

    style ENTRY fill:#4CAF50,color:#fff
    style GAME fill:#FF9800,color:#fff
```

### 📌 關鍵設計點

- **game-session-builder 共用模組**：遊戲場複選 → 規則複選 → WM 逐組勾選 → 題數每組設定 → 拖曳排序（= 自由選擇完全一致）
- **多人額外設定**：房間名稱、密碼、倒數秒數（在 builder 外）
- **房主可選擇是否加入遊戲**：加入則同時是玩家；不加入則顯示即時狀態儀表板（所有玩家的答題進度、組合完成、分數等） 🆕v4.3
- **3 種加入方式**：代碼（手動輸入）、QR Code（掃描即進）、短網址（點連結即進） 🔄v4.3
- **QR 與短網址直接進入房間**：無須手動輸入代碼，僅密碼房需額外輸入密碼 🔄v4.3
- **密碼可選**：房主可自由決定是否設密碼
- **不允許中途加入**：遊戲開始後不可加入
- **題數 6-30**：全模式統一範圍，預設 6 題，每組獨立設定

---

## Flow-7: 暫停與退出流程

> **說明**：單人暫停/退出 vs 多人退出/斷線處理。  
> **對應章節**：§3.1b 暫停/中斷功能

```mermaid
flowchart TB
    PLAYING([🎮 遊戲進行中]) --> MODE{遊戲模式?}

    MODE -->|📱 單人模式| SP_ACTION{玩家動作}
    MODE -->|👥 多人模式| MP_ACTION{玩家動作}

    %% === 單人 ===
    SP_ACTION -->|Escape 鍵<br/>⏸ 按鈕| PAUSE[⏸️ 暫停畫面<br/>全版面暫停符號<br/>opacity ~0.3 防偷看]
    SP_ACTION -->|退出按鈕| SP_EXIT[結算已完成題目<br/>未完成不計分]

    PAUSE --> RESUME_ACTION{恢復方式}
    RESUME_ACTION -->|按空白鍵| RESUME[▶️ 繼續遊戲<br/>恢復計時]
    RESUME_ACTION -->|退出| SP_EXIT

    RESUME --> PLAYING
    SP_EXIT --> SP_RESULT([📊 成績結算])

    %% === 多人 ===
    MP_ACTION -->|退出按鈕| MP_EXIT[結算該玩家總分<br/>其他玩家不受影響]
    MP_ACTION -->|網路斷線| DISCONNECT[⚠️ 嘗試重連<br/>每 5 秒一次]
    DISCONNECT --> RETRY{重連成功?}
    RETRY -->|✅ 成功| PLAYING
    RETRY -->|❌ 失敗<br/>已嘗試 6 次| MP_EXIT

    MP_EXIT --> MP_RESULT([📊 多人結算])

    style PLAYING fill:#4CAF50,color:#fff
    style PAUSE fill:#FFC107,color:#333
    style SP_RESULT fill:#FF9800,color:#fff
    style MP_RESULT fill:#FF9800,color:#fff
```

### 📌 關鍵設計點

- **暫停觸發**：Escape 鍵或右上角 ⏸ 按鈕
- **空白鍵恢復**：按空白鍵以繼續遊戲 🔄v4.3
- **暫停不計時**：反應時間凍結
- **多人無暫停**：僅可退出
- **多人斷線重連**：每 5 秒嘗試一次 × 最多 6 次 = 30 秒，仍失敗即結算總分 🔄v4.3

---

## Flow-8: 房主斷線轉移流程

> **說明**：房主離線時按 joinOrder 自動轉移房主權限。  
> **對應章節**：§2.8 房主斷線處理

```mermaid
flowchart TB
    DETECT[🔌 系統偵測房主斷線<br/>Firebase onDisconnect] --> CHECK{還有其他<br/>在線玩家?}

    CHECK -->|❌ 無人| CLOSE[🚫 房間自動關閉]

    CHECK -->|✅ 有人| FIND[按 joinOrder 排序<br/>找最小 joinOrder<br/>且仍在線的玩家]

    FIND --> TRANSFER[🔄 轉移房主<br/>更新 hostId]
    TRANSFER --> NOTIFY_NEW[📢 通知新房主<br/>「房主斷線，你現在是房主」]
    TRANSFER --> NOTIFY_OTHERS[📢 通知其他玩家<br/>「房主已變更為 ○○」]

    NOTIFY_NEW --> STATE{當前狀態?}
    NOTIFY_OTHERS --> STATE
    STATE -->|等待中| NEW_HOST_WAIT[新房主可按「開始遊戲」]
    STATE -->|遊戲中| CONTINUE[遊戲繼續進行<br/>不受影響]
    STATE -->|已結束| FINISHED_KEEP[結果畫面不受影響<br/>仍可截圖/匯出CSV]

    %% 原房主的成績
    DETECT --> OLD_HOST[舊房主成績即結算<br/>視為退出]

    style DETECT fill:#F44336,color:#fff
    style TRANSFER fill:#4CAF50,color:#fff
    style CLOSE fill:#9E9E9E,color:#fff
```

### 📌 關鍵設計點

- **joinOrder 排序**：房主=0，第一個加入=1，依此類推
- **自動無感轉移**：不中斷遊戲進行
- **通知區分**：新房主看到「房主斷線，你現在是房主」；其他玩家看到「房主已變更為 ○○」 🆕v4.3
- **3 種狀態都處理**：等待中（新房主可開始遊戲）、遊戲中（繼續進行）、已結束（結果畫面不受影響） 🆕v4.3
- **斷線者即結算**：離線玩家的已答題目照常計分

---

# B. 遊戲邏輯（Game Logic Flows）

---

## Flow-9: 單一試驗（Trial）時間軸流程

> **說明**：一題從刺激物出現到下一題的完整時間線。  
> **對應章節**：§3.1b 遊戲進行時間機制

```mermaid
flowchart TB
    START([▶️ 試驗開始 t=0ms]) --> SHOW[🖼️ 刺激物出現<br/>🧀/😺/🐟/🦈]
    SHOW --> VOICE[🔊 同時播放刺激物語音<br/>（單獨規則=女聲；混合 → 詳見 Flow-15）]

    VOICE --> WINDOW[⏱️ 回應窗口<br/>2000ms 內<br/>空白鍵 / 點擊螢幕]

    WINDOW --> RESPONSE{玩家是否<br/>在 2000ms 內<br/>按下?}

    RESPONSE -->|✅ 按了<br/>t < 2000ms| JUDGE_PRESS{Go 題<br/>or No-Go 題?}
    RESPONSE -->|❌ 沒按<br/>t = 2000ms| JUDGE_NOPRESS{Go 題<br/>or No-Go 題?}

    %% 按了的判定
    JUDGE_PRESS -->|Go 題| HIT[✅ Hit<br/>RT = 按鍵時間 - 出現時間<br/>計入 avgRT]
    JUDGE_PRESS -->|No-Go 題| FA[❌ FA 誤按<br/>RT 不計入 avgRT]

    %% 沒按的判定
    JUDGE_NOPRESS -->|Go 題| MISS[❌ Miss 漏按<br/>RT = 0<br/>不計入 avgRT]
    JUDGE_NOPRESS -->|No-Go 題| CR[✅ CR 正確抑制<br/>RT = 0<br/>不計入 avgRT]

    %% 回饋
    HIT --> FEEDBACK
    FA --> FEEDBACK
    MISS --> FEEDBACK
    CR --> FEEDBACK

    FEEDBACK[回饋動畫 800ms<br/>├ 答對：pulse-green 0.3s + 靜止 0.5s<br/>├ 答錯：shake-red 0.2s + 靜止 0.6s<br/>└ 刺激物：pulse-correct 0.5s / shake-error 0.4s]

    FEEDBACK --> ISI[等待 ISI<br/>隨機 800~1200ms]

    ISI --> NEXT{還有下一題?}
    NEXT -->|是| START
    NEXT -->|否| DONE([📊 規則結束<br/>進入計分])

    style START fill:#4CAF50,color:#fff
    style DONE fill:#FF9800,color:#fff
    style HIT fill:#4CAF50,color:#fff
    style CR fill:#4CAF50,color:#fff
    style FA fill:#F44336,color:#fff
    style MISS fill:#F44336,color:#fff
```

### 📌 關鍵設計點

- **2000ms 回應窗口**：超時即判定為「沒按」
- **4 種結果**：Hit（Go 正確）、CR（No-Go 正確）、Miss（Go 漏按）、FA（No-Go 誤按）
- **avgRT 只計 Hit**：僅 Go 正確答對的 RT 計入平均
- **雙層動畫**：容器動畫（0.3s/0.2s）+ 刺激物動畫（0.5s/0.4s）同時播放
- **800ms 總停留**：CSS 動畫 + 靜止，整體 800ms 後消退

---

## Flow-10: Go/No-Go 規則判定引擎

> **說明**：根據遊戲場 × 規則 × 情境判定正確動作。  
> **對應章節**：§2.3 規則詳細說明

```mermaid
flowchart TB
    INPUT([輸入：遊戲場 + 規則 + 刺激物 + 情境]) --> FIELD{遊戲場?}

    FIELD -->|🐭 小老鼠| MOUSE_RULE{規則?}
    FIELD -->|🐟 釣魚| FISH_RULE{規則?}

    %% === 小老鼠 ===
    MOUSE_RULE -->|規則一| M_R1{刺激物?}
    M_R1 -->|🧀 起司| M_R1_GO[✅ Go → 按]
    M_R1 -->|😺 貓| M_R1_NOGO[🚫 No-Go → 不按]

    MOUSE_RULE -->|規則二| M_R2{刺激物?}
    M_R2 -->|🧀 起司| M_R2_NOGO[🚫 No-Go → 不按]
    M_R2 -->|😺 貓| M_R2_GO[✅ Go → 按]

    MOUSE_RULE -->|混合| M_MIX{情境?}
    M_MIX -->|👤 沒人<br/>套用規則A| M_R1
    M_MIX -->|👤 有人<br/>套用規則B| M_R2

    %% === 釣魚 ===
    FISH_RULE -->|規則一| F_R1{刺激物?}
    F_R1 -->|🐟 魚| F_R1_GO[✅ Go → 按]
    F_R1 -->|🦈 鯊魚| F_R1_NOGO[🚫 No-Go → 不按]

    FISH_RULE -->|規則二| F_R2{刺激物?}
    F_R2 -->|🐟 魚| F_R2_NOGO[🚫 No-Go → 不按]
    F_R2 -->|🦈 鯊魚| F_R2_GO[✅ Go → 按]

    FISH_RULE -->|混合| F_MIX{情境?}
    F_MIX -->|☀️ 白天<br/>套用規則A| F_R1
    F_MIX -->|🌙 晚上<br/>套用規則B| F_R2

    style INPUT fill:#2196F3,color:#fff
    style M_R1_GO fill:#4CAF50,color:#fff
    style M_R2_GO fill:#4CAF50,color:#fff
    style F_R1_GO fill:#4CAF50,color:#fff
    style F_R2_GO fill:#4CAF50,color:#fff
    style M_R1_NOGO fill:#FF9800,color:#fff
    style M_R2_NOGO fill:#FF9800,color:#fff
    style F_R1_NOGO fill:#FF9800,color:#fff
    style F_R2_NOGO fill:#FF9800,color:#fff
```

### 📌 關鍵設計點

- **混合規則 = 情境切換**：先看情境（有人/白天 vs 沒人/晚上），再套用對應規則
- **規則一 ↔ 規則二完全相反**：Go 與 No-Go 刺激物互換
- **80:20 比例**：混合規則中 80% 套用規則A、20% 套用規則B
- **視覺提示**：混合時畫面會有明顯的情境視覺提示（人物/邊框色/背景色）

---

## Flow-11: 計分系統流程（單一規則）

> **說明**：一個規則完成後的完整計分流程，含 4 種額外獎勵。  
> **對應章節**：§3.3 計分系統

```mermaid
flowchart TB
    INPUT([📝 規則結束<br/>答對/答錯紀錄]) --> MODE{遊戲模式?}

    MODE -->|單人（探險地圖/自由選擇）| BASE_SP[1️⃣ 基礎分<br/>= 答對題數 × 1]
    MODE -->|多人| BASE_MP[1️⃣ 基礎分<br/>= 答對題數 × 1]

    %% ===== 單人：完整 4 種獎勵 =====
    BASE_SP --> PERFECT{2️⃣ 🏆 全對?<br/>答對率 = 100%?}
    PERFECT -->|✅| PERFECT_Y[+1 分]
    PERFECT -->|❌| PERFECT_N[+0]

    PERFECT_Y --> SPEED
    PERFECT_N --> SPEED

    SPEED{3️⃣ ⚡ 最佳速度?<br/>avgRT < bestAvgRT?<br/>或 bestAvgRT=null?}
    SPEED -->|✅ 更快 or 首次| SPEED_Y[+1 分<br/>更新 bestAvgRT]
    SPEED -->|❌ 沒更快| SPEED_N[+0]

    SPEED_Y --> FIRST
    SPEED_N --> FIRST

    FIRST{4️⃣ 🌟 首次通關?<br/>首次通過此<br/>遊戲場×規則?}
    FIRST -->|✅ 首次| FIRST_Y[+1 分<br/>標記 firstClear=false]
    FIRST -->|❌ 非首次| FIRST_N[+0]

    FIRST_Y --> SUBTOTAL
    FIRST_N --> SUBTOTAL

    SUBTOTAL[暫時總分<br/>= 基礎 + 全對 + 速度 + 首次]

    SUBTOTAL --> PROGRESS{5️⃣ 📈 進步獎勵?<br/>暫時總分 ><br/>歷史最佳紀錄?}
    PROGRESS -->|✅ 超越| PROGRESS_Y[+1 分<br/>更新 bestScore]
    PROGRESS -->|❌| PROGRESS_N[+0]

    PROGRESS_Y --> FINAL_SP
    PROGRESS_N --> FINAL_SP

    FINAL_SP[🎯 單人最終得分<br/>= 暫時總分 + 進步獎勵]

    %% ===== 多人：僅全對 + 速度（無進步/首次）=====
    BASE_MP --> MP_PERFECT{2️⃣ 🏆 全對?<br/>答對率 = 100%?}
    MP_PERFECT -->|✅| MP_PERFECT_Y[+1 分]
    MP_PERFECT -->|❌| MP_PERFECT_N[+0]

    MP_PERFECT_Y --> MP_SPEED
    MP_PERFECT_N --> MP_SPEED

    MP_SPEED{3️⃣ ⚡ 最佳速度?<br/>avgRT < bestAvgRT?}
    MP_SPEED -->|✅| MP_SPEED_Y[+1 分]
    MP_SPEED -->|❌| MP_SPEED_N[+0]

    MP_SPEED_Y --> FINAL_MP
    MP_SPEED_N --> FINAL_MP

    FINAL_MP[🎯 多人最終得分<br/>= 基礎 + 全對 + 速度<br/>❌ 無進步/首次獎勵]

    style INPUT fill:#2196F3,color:#fff
    style FINAL_SP fill:#FF9800,color:#fff
    style FINAL_MP fill:#FF9800,color:#fff
    style PERFECT_Y fill:#4CAF50,color:#fff
    style SPEED_Y fill:#4CAF50,color:#fff
    style FIRST_Y fill:#4CAF50,color:#fff
    style PROGRESS_Y fill:#4CAF50,color:#fff
    style MP_PERFECT_Y fill:#4CAF50,color:#fff
    style MP_SPEED_Y fill:#4CAF50,color:#fff
    style MODE fill:#9C27B0,color:#fff
```

### 📌 關鍵設計點

- **🟣 模式分支**：入口即區分單人（4 種獎勵）vs 多人（2 種獎勵）🆕v4.3
- **計算順序很重要**：進步獎勵最後判定，避免循環
- **首次遊玩 bestAvgRT=null → 自動 +1**：邊界條件已處理
- **多人模式簡化**：僅保留全對 + 最佳速度，無進步/首次（成績不記錄歷史）
- **每項各 +1**：不使用乘法加權，簡單明確

---

## Flow-12: WM 計分系統流程

> **說明**：WM 測驗的完整計分流程，含順向/逆向不同公式。  
> **對應章節**：§3.4 工作記憶計分系統

```mermaid
flowchart TB
    INPUT([🧠 WM 測驗完成<br/>方向 + n 個位置 + 答對數]) --> BASE[1️⃣ 基礎分<br/>= 答對位置數 × 1]

    BASE --> PASS_CHECK{WM 答對率<br/>≥ 83%?}

    PASS_CHECK -->|❌ 未通過| NO_STAR[❌ 不獲得 WM 星星<br/>僅基礎分]
    PASS_CHECK -->|✅ 通過| WM_STAR[⭐ +1 WM 星星]

    WM_STAR --> ALL_CORRECT{全對?<br/>答對數 = n?}

    ALL_CORRECT -->|❌ 未全對| NO_BONUS[全對 Bonus = 0]
    ALL_CORRECT -->|✅ 全對| DIRECTION{方向?}

    DIRECTION -->|逆向 Reverse| REV_CHECK{n ≥ 2?}
    REV_CHECK -->|n = 1| REV_1[全對 Bonus = 0]
    REV_CHECK -->|n ≥ 2| REV_BONUS[全對 Bonus = n - 1 ⭐<br/>例：n=4 → +3⭐]

    DIRECTION -->|順向 Forward| FWD_CHECK{n 在哪個區間?}
    FWD_CHECK -->|n = 1| FWD_1[全對 Bonus = 0]
    FWD_CHECK -->|n = 2~6| FWD_26[全對 Bonus = +1⭐]
    FWD_CHECK -->|n = 7~9| FWD_79[全對 Bonus = +2⭐]
    FWD_CHECK -->|n ≥ 10| FWD_10[全對 Bonus = n - 7 ⭐<br/>例：n=11 → +4⭐]

    %% 匯流
    NO_STAR --> SPEED
    NO_BONUS --> SPEED
    REV_1 --> SPEED
    REV_BONUS --> SPEED
    FWD_1 --> SPEED
    FWD_26 --> SPEED
    FWD_79 --> SPEED
    FWD_10 --> SPEED

    SPEED{⚡ 最佳速度?<br/>完成時間 <<br/>歷史最快?}
    SPEED -->|✅| SPEED_Y[+1 分]
    SPEED -->|❌| SPEED_N[+0]

    SPEED_Y --> FINAL
    SPEED_N --> FINAL

    FINAL[🎯 WM 最終得分<br/>= 基礎 + 全對獎勵 + 速度]

    style INPUT fill:#2196F3,color:#fff
    style FINAL fill:#FF9800,color:#fff
    style SPEED_Y fill:#4CAF50,color:#fff
    style NO_BONUS fill:#9E9E9E,color:#fff
```

### 📌 關鍵設計點

- **WM 通過門檻 ≥83%**：答對率 ≥83% → +1⭐ WM 星星 🆕v4.3
- **全對才有 Bonus⭐**：通過後若全對 → 額外 Bonus 星星（依公式）
- **逆向獎勵更高**：逆向 n=4 全對 → +3⭐；順向 n=4 全對 → +1⭐
- **無時間限制**：但系統記錄完成時間，用於速度獎勵比較

---

## Flow-13: WM 測驗遊戲流程

> **說明**：WM 測驗從系統展示到玩家作答的完整互動流程。  
> **對應章節**：§3.4 遊戲機制、WM 顯示介面

```mermaid
flowchart TB
    START([🧠 WM 測驗開始]) --> RANDOM[系統隨機決定<br/>1. 方向：順向 or 逆向<br/>2. 位置數量 n：1 ~ 該輪題數]

    RANDOM --> EXTRACT[從 questions 最後 N 題<br/>動態擷取刺激物序列<br/>📌 非預先生成]

    EXTRACT --> VOICE[🔊 語音播報規則<br/>「請照順序點選！」<br/>或「請倒著點選！」]

    VOICE --> SHOW[🖼️ 系統依序展示<br/>n 個位置按鈕依序亮起<br/>①→②→③→④...]

    SHOW --> ANSWER[👆 玩家作答<br/>點擊位置按鈕循環切換<br/>🐭: ❓→🧀→🐈‍⬛→❓<br/>🐟: ❓→🐟→🦈→❓]

    ANSWER --> CONFIRM[按「確認」提交答案]

    CONFIRM --> COMPARE[比對答案<br/>順向：照原序列<br/>逆向：照反轉序列]

    COMPARE --> SCORE[📊 WM 計分<br/>→ 詳見 Flow-12]

    SCORE --> DISPLAY[🎉 顯示結果<br/>答對位置：n/n<br/>完成速度：x.x 秒<br/>WM 得分：xx 分]

    DISPLAY --> NEXT([➡️ 繼續下一規則<br/>或遊戲結束])

    style START fill:#9C27B0,color:#fff
    style NEXT fill:#FF9800,color:#fff
```

### 📌 關鍵設計點

- **動態擷取序列**：WM 序列由該規則 questions 最後 N 題擷取（方案 C）
- **Toggle 按鈕**：點擊循環 ❓→刺激物A→刺激物B→❓
- **無時間限制**：不限作答時間，但記錄完成速度
- **支援觸控**：所有位置按鈕支援觸控點擊

---

## Flow-14: 題目生成流程

> **說明**：系統生成題目序列的完整邏輯。  
> **對應章節**：§2.4 題目生成流程

```mermaid
flowchart TB
    INPUT([🎲 題目生成<br/>遊戲場 + 規則 + 題數 n]) --> RULE_TYPE{規則類型?}

    RULE_TYPE -->|規則一 / 規則二| SIMPLE[隨機排列 Go/No-Go 刺激物<br/>🐭 Go 75% / 🐟 Go 80%<br/>保證兩種都出現]
    RULE_TYPE -->|混合規則| MIXED

    subgraph 混合規則生成["混合規則題目生成"]
        MIXED[題數 = n × 2] --> RATIO[分配情境比例<br/>80% 規則A情境<br/>20% 規則B情境]
        RATIO --> GUARANTEE[📌 保證規則B情境<br/>至少出現 1 次]
        GUARANTEE --> PSEUDO[偽隨機排列<br/>確保比例接近 80:20]
        PSEUDO --> CONTEXT[為每題生成：<br/>① context（情境）<br/>② stimulus（刺激物）<br/>③ correctAction（由①②推導）]
    end

    SIMPLE --> OUTPUT
    CONTEXT --> OUTPUT

    OUTPUT[questions 陣列生成完成]

    OUTPUT --> WM_CHECK{該組合<br/>啟用 WM?}
    WM_CHECK -->|否| DONE
    WM_CHECK -->|是| WM_GEN[WM 參數生成<br/>方向：隨機順/逆<br/>數量：隨機 1~n<br/>序列：由 questions 最後 N 題動態擷取]

    WM_GEN --> DONE

    DONE([📦 儲存到 Firebase<br/>gameCombos.questions<br/>gameCombos.workingMemoryTest])

    style INPUT fill:#2196F3,color:#fff
    style DONE fill:#FF9800,color:#fff
```

### 📌 關鍵設計點

- **混合規則雙層結構**：每題同時包含 context（情境）+ stimulus（刺激物）
- **80:20 偽隨機**：保證比例接近且規則二至少出現 1 次
- **Go 比例**：🐭 小老鼠 Go:No-Go = 75:25、🐟 釣魚 Go:No-Go = 80:20 🆕
- **混合規則刺激物比例**：每個情境內沿用遊戲場 Go:No-Go 比例（🐭 75:25 / 🐟 80:20）🆕v4.3
- **WM 序列動態擷取**：不預先生成序列，由答題紀錄的最後 N 題提取

---

## Flow-15: 刺激物語音性別判定流程

> **說明**：刺激物出現時決定播放男聲或女聲。  
> **對應章節**：§4.2.1 刺激物語音系統

```mermaid
flowchart TB
    INPUT([🔊 刺激物出現<br/>需要播放語音]) --> VOICE_ON{🗣️ 語音開關<br/>ON?}

    VOICE_ON -->|OFF| SILENT[🔇 不播放語音]
    VOICE_ON -->|ON| RULE{當前規則?}

    RULE -->|規則一（單獨）| FEMALE[👩 女聲<br/>播放刺激物名稱]
    RULE -->|規則二（單獨）| FEMALE
    RULE -->|混合規則| CONTEXT{當前情境?}

    CONTEXT -->|規則A情境<br/>🐭沒人 / 🐟白天| FEMALE
    CONTEXT -->|規則B情境<br/>🐭有人 / 🐟晚上| MALE[👨 男聲<br/>播放刺激物名稱]

    style INPUT fill:#2196F3,color:#fff
    style FEMALE fill:#E91E63,color:#fff
    style MALE fill:#2196F3,color:#fff
    style SILENT fill:#9E9E9E,color:#fff
```

### 📌 關鍵設計點

- **聲音性別 = 規則提示**：混合規則中，男/女聲幫助孩子辨識當前套用的規則（A or B）
- **規則一/二單獨時統一女聲**：因為不需要聲音區分
- **語音開關獨立**：關閉語音不影響遊戲可玩性

---

# C. 資料流程（Data Flows）

---

## Flow-16: 資料儲存層次與同步流程

> **說明**：4 層儲存架構的讀寫流向。  
> **對應章節**：§5.3 資料儲存層次

```mermaid
flowchart LR
    subgraph 前端["🖥️ 前端（瀏覽器）"]
        UI[遊戲介面]
    end

    subgraph L1["Layer 1：localStorage（離線優先）"]
        PROFILE[playerProfile<br/>暱稱/星星/等級/徽章/設定]
        PROGRESS[adventureProgress<br/>解鎖/分數/bestRT/星星]
        CLASS_DATA[classData<br/>班級排行榜]
    end

    subgraph L2["Layer 2：Realtime Database（即時）"]
        ROOMS[rooms/{code}<br/>房間資料/玩家/成績]
        NOTE_L2[⏰ 房主離開 / 關閉分頁即清空刪除]
    end

    subgraph L3["Layer 3：Firestore（選擇性）"]
        GLOBAL_LB[全球排行榜<br/>使用者主動上傳]
    end

    subgraph L4["Layer 4：Firebase Storage"]
        CUSTOM[自訂音效/刺激物 SVG 檔<br/>研究者上傳（僅限 SVG）]
    end

    UI -->|單人成績/設定/進度| PROFILE
    UI -->|單人成績/設定/進度| PROGRESS
    UI -->|班級榜| CLASS_DATA
    UI <-->|多人即時同步| ROOMS
    UI -->|開啟上傳開關| GLOBAL_LB
    UI <--|載入自訂包| CUSTOM

    style L1 fill:#E3F2FD
    style L2 fill:#FFF3E0
    style L3 fill:#E8F5E9
    style L4 fill:#F3E5F5
```

### 📌 關鍵設計點

- **localStorage 優先**：單人模式完全離線可玩
- **RTDB 只給多人**：多人成績不寫入個人紀錄，房主離開 / 關閉分頁即清空刪除
- **Firestore 可選**：排行榜上傳需使用者主動開啟
- **4 層互不依賴**：任一層故障不影響其他層

---

## Flow-17: 多人模式 Firebase 即時同步流程

> **說明**：多人遊戲中前端與 Realtime Database 的資料同步時機。  
> **對應章節**：§2.11 Firebase 資料結構

```mermaid
sequenceDiagram
    participant 房主
    participant RTDB as Firebase RTDB
    participant 玩家A
    participant 玩家B

    Note over 房主,RTDB: === 建立階段 ===
    房主->>RTDB: 寫入 rooms/{code}<br/>gameCombos[], gameSettings
    RTDB-->>玩家A: 監聽 rooms/{code}
    RTDB-->>玩家B: 監聽 rooms/{code}

    Note over 房主,玩家B: === 加入階段 ===
    玩家A->>RTDB: 寫入 players/{uid}<br/>joinOrder=1
    玩家B->>RTDB: 寫入 players/{uid}<br/>joinOrder=2
    RTDB-->>房主: 玩家列表更新

    Note over 房主,玩家B: === 遊戲開始 ===
    房主->>房主: 選擇是否加入遊戲<br/>加入 → 同時是玩家；不加入 → 儀表板
    房主->>房主: 按「開始遊戲」
    房主->>RTDB: status: "playing"
    RTDB-->>玩家A: 開始倒數
    RTDB-->>玩家B: 開始倒數

    Note over 房主,玩家B: === 答題階段 ===
    玩家A->>RTDB: answers[] 更新<br/>currentQuestion++
    玩家B->>RTDB: answers[] 更新<br/>currentQuestion++

    Note over 房主,玩家B: === 組合完成 ===
    玩家A->>RTDB: justCompleted: "🐭規則一+WM"
    RTDB-->>玩家B: 📢「玩家A 完成了 🐭規則一+WM！」
    Note right of RTDB: 3 秒後 justCompleted: false

    Note over 房主,玩家B: === WM 結果 ===
    玩家A->>RTDB: workingMemoryResult: {...}

    Note over 房主,玩家B: === 全部完成 ===
    玩家A->>RTDB: allCompleted: true
    RTDB-->>玩家B: 📢「🎉 玩家A 全部完成！」
    Note right of 玩家A: 顯示「觀看遊戲總結果」🔒 鎖定

    Note over 房主,玩家B: === 所有玩家完成 ===
    玩家B->>RTDB: allCompleted: true
    RTDB->>RTDB: 檢查所有玩家 allCompleted
    RTDB-->>房主: 📢「🎉 所有玩家已完成！」
    RTDB-->>玩家A: 📢「🎉 所有玩家已完成！」
    RTDB-->>玩家B: 📢「🎉 所有玩家已完成！」
    Note right of RTDB: status → "finished"
    Note right of 玩家A: 「觀看遊戲總結果」🔓 解鎖
    Note right of 玩家B: 「觀看遊戲總結果」🔓 解鎖
    Note right of 玩家A: 點擊按鈕 → 進入最終排名畫面（截圖 + CSV）

    Note over 房主,玩家B: === 斷線處理 ===
    房主--xRTDB: onDisconnect 觸發
    RTDB->>RTDB: hostId 轉移<br/>→ joinOrder 最小在線者
    RTDB-->>玩家A: 📢「房主已變更為 ○○」
    Note right of 玩家A: 若玩家A是新房主：<br/>「房主斷線，你現在是房主」
```

### 📌 關鍵設計點

- **onDisconnect 預設**：房主連上時即設定斷線後的轉移邏輯
- **房主可選擇不加入遊戲**：不加入則進入儀表板模式，即時查看所有玩家狀態 🆕v4.3
- **justCompleted 通知**：完成組合時設為具體組合名 → 3 秒後 false；allCompleted 用於全部完成通知
- **全員完成 broadcast**：當所有玩家 allCompleted: true → 廣播「🎉 所有玩家已完成！」+ status → "finished" + 解鎖「觀看遊戲總結果」按鈕 🆕v4.3
- **房主變更通知區分**：新房主收到「房主斷線，你現在是房主」；其他玩家收到「房主已變更為 ○○」 🆕v4.3
- **各自節奏**：answers[] 各自寫入，不需等待同步

---

## Flow-18: 成績輸出流程（截圖＋CSV）

> **說明**：遊戲結束後的成績匯出流程。  
> **對應章節**：§2.10 成績處理、§5.4b 單人 CSV

```mermaid
flowchart TB
    GAME_END([🎉 遊戲結束]) --> MODE{遊戲模式?}

    MODE -->|👥 多人| MP_OUT
    MODE -->|📱 單人| SP_OUT

    subgraph MP_OUT["👥 多人輸出"]
        MP_SCREEN[📸 截圖<br/>html2canvas → PNG<br/>內容：排名+分數+星星]
        MP_CSV[📊 CSV<br/>UTF-8 BOM<br/>欄位：排名/暱稱/總分/<br/>各組合分/WM分/獎勵/avgRT]
    end

    subgraph SP_OUT["📱 單人輸出"]
        SP_CSV[📊 CSV（14 欄摘要 + 11 欄逐題）<br/>UTF-8 BOM<br/>欄位：試驗序號/規則/刺激物/<br/>正確反應/實際反應/正確性/<br/>RT(ms)/結果/遊戲場/情境/時間戳]
        SP_RESULT[結果類型：<br/>Hit / CR / Miss / FA]
    end

    MP_SCREEN --> DOWNLOAD[💾 下載檔案]
    MP_CSV --> DOWNLOAD
    SP_CSV --> DOWNLOAD

    DOWNLOAD --> HOME([🏠 回首頁 / 重新挑戰])

    style GAME_END fill:#4CAF50,color:#fff
    style DOWNLOAD fill:#FF9800,color:#fff
```

### 📌 關鍵設計點

- **UTF-8 BOM**：確保 Excel 能正確開啟中文
- **單人 11 欄**：每個試驗一行，詳細記錄 RT 和結果類型
- **多人匯總**：按玩家匯總，各組合分數分開欄位

---

## Flow-19: 排行榜雙軌制資料流

> **說明**：本地班級榜 vs 全球榜的資料流動。  
> **對應章節**：§3.6 排行榜系統

```mermaid
flowchart TB
    SCORE([📊 遊戲結算]) --> LOCAL[📥 寫入 localStorage<br/>classData 班級排行榜]

    LOCAL --> UPLOAD_CHECK{全球排行榜<br/>上傳開關 ON?}

    UPLOAD_CHECK -->|OFF| LOCAL_ONLY[僅本地<br/>教師可匯出 JSON/CSV]
    UPLOAD_CHECK -->|ON| FIRESTORE[📤 上傳 Firestore<br/>僅暱稱 + 分數<br/>不含個人資料]

    FIRESTORE --> GLOBAL_VIEW[🌐 全球排行榜<br/>所有人可見]

    LOCAL --> LOCAL_VIEW[📊 班級排行榜<br/>僅本機可見]

    subgraph 教師功能["👨‍🏫 教師功能"]
        LOCAL_VIEW --> EXPORT[📤 匯出 JSON/CSV]
        IMPORT[📥 匯入 JSON] --> LOCAL_VIEW
    end

    style SCORE fill:#4CAF50,color:#fff
    style GLOBAL_VIEW fill:#2196F3,color:#fff
    style LOCAL_VIEW fill:#FF9800,color:#fff
```

### 📌 關鍵設計點

- **預設不上傳**：全球榜需使用者主動開啟
- **隱私保護**：上傳僅暱稱+分數，不含真實身份
- **教師匯出入**：班級資料支援 JSON/CSV 匯出與匯入還原

---

## Flow-20: Fallback 降級機制流程

> **說明**：音效/圖檔/網路缺失時的降級處理。  
> **對應章節**：§5.4c Fallback

```mermaid
flowchart TB
    LOAD([📦 載入資源]) --> TYPE{資源類型?}

    TYPE -->|🔊 音效| SFX_CHECK{自訂音效<br/>檔案存在?}
    TYPE -->|🖼️ 刺激物圖| IMG_CHECK{SVG 檔案<br/>存在?}
    TYPE -->|🌐 網路| NET_CHECK{網路連線?}

    %% 音效 Fallback
    SFX_CHECK -->|✅| SFX_OK[播放自訂音效]
    SFX_CHECK -->|❌| SFX_DEFAULT{預設音效<br/>存在?}
    SFX_DEFAULT -->|✅| SFX_FALLBACK[播放預設音效]
    SFX_DEFAULT -->|❌ 404| SFX_SILENT[🔇 靜默跳過<br/>console.warn 記錄<br/>不彈錯誤訊息]

    %% 圖檔 Fallback
    IMG_CHECK -->|✅| IMG_OK[顯示 SVG]
    IMG_CHECK -->|❌| IMG_EMOJI[顯示 Emoji 替代<br/>🧀😺🐟🦈]

    %% 網路 Fallback
    NET_CHECK -->|✅ 在線| NET_OK[正常運作]
    NET_CHECK -->|❌ 離線| NET_MODE{遊戲模式?}
    NET_MODE -->|📱 單人| OFFLINE_OK[✅ 完全離線可玩<br/>localStorage 運作]
    NET_MODE -->|👥 多人等待中| NET_WARN[⚠️ 顯示連線提示]
    NET_MODE -->|👥 多人遊戲中| NET_RETRY{嘗試重連}
    NET_RETRY -->|< 30s| NET_RECONNECT[🔄 自動重連]
    NET_RETRY -->|≥ 30s| NET_EXIT[視為退出<br/>結算成績]

    style LOAD fill:#2196F3,color:#fff
    style SFX_SILENT fill:#9E9E9E,color:#fff
    style IMG_EMOJI fill:#FFC107,color:#333
    style OFFLINE_OK fill:#4CAF50,color:#fff
    style NET_EXIT fill:#F44336,color:#fff
```

### 📌 關鍵設計點

- **三級降級**：自訂包 → 預設包 → 靜默/Emoji
- **不打擾使用者**：降級時只 console.warn，不彈錯誤框
- **單人離線無憂**：完全靠 localStorage，無需網路

---

# D. 狀態機（State Machines）

---

## Flow-21: 關卡解鎖狀態機

> **說明**：探險地圖 12 個探險點的逐步解鎖狀態機。  
> **對應章節**：§3.9 關卡解鎖系統 🆕v4.3

```mermaid
stateDiagram-v2
    [*] --> 地圖1_探險點1

    state 地圖1_小老鼠冒險 {
        地圖1_探險點1: ① 🐭R1 🟡（初始可玩）
        地圖1_探險點2: ② 🐭R1+WM 🔒
        地圖1_探險點3: ③ 🐭R2 🔒
        地圖1_探險點4: ④ 🐭R2+WM 🔒
        地圖1_探險點5: ⑤ 🐭混合 🔒
        地圖1_探險點6: ⑥ 🐭混合+WM 🔒

        地圖1_探險點1 --> 地圖1_探險點2: ①通過\n規則≥83%
        地圖1_探險點2 --> 地圖1_探險點3: ②通過\n規則≥83% AND WM≥83%
        地圖1_探險點3 --> 地圖1_探險點4: ③通過\n規則≥83%
        地圖1_探險點4 --> 地圖1_探險點5: ④通過\n規則≥83% AND WM≥83%
        地圖1_探險點5 --> 地圖1_探險點6: ⑤通過\n規則≥83%
    }

    地圖1_探險點6 --> 地圖2_探險點1: ⑥通過\n規則≥83% AND WM≥83%\n🎉 地圖 1 完成！

    state 地圖2_釣魚冒險 {
        地圖2_探險點1: ⑦ 🐟R1 🟡
        地圖2_探險點2: ⑧ 🐟R1+WM 🔒
        地圖2_探險點3: ⑨ 🐟R2 🔒
        地圖2_探險點4: ⑩ 🐟R2+WM 🔒
        地圖2_探險點5: ⑪ 🐟混合 🔒
        地圖2_探險點6: ⑫ 🐟混合+WM 🔒

        地圖2_探險點1 --> 地圖2_探險點2: ⑦通過\n規則≥83%
        地圖2_探險點2 --> 地圖2_探險點3: ⑧通過\n規則≥83% AND WM≥83%
        地圖2_探險點3 --> 地圖2_探險點4: ⑨通過\n規則≥83%
        地圖2_探險點4 --> 地圖2_探險點5: ⑩通過\n規則≥83% AND WM≥83%
        地圖2_探險點5 --> 地圖2_探險點6: ⑪通過\n規則≥83%
    }

    地圖2_探險點6 --> 自由選擇: ⑫通過\n規則≥83% AND WM≥83%\n🎉🎉 全部通關！

    自由選擇: 🆓 自由選擇 解鎖！\n= 多人房主同等自由度

    note right of 地圖1_小老鼠冒險
        探險點 3 狀態：
        ⬜ 未解鎖（灰色+🔒）
        🟡 當前可玩（發光）
        ⭐ 已通過（顯示星星）
        已通過可重玩，星星無限累計
    end note

    note right of 地圖2_釣魚冒險
        通過條件：
        純規則點（奇數）：規則 ≥83%
        規則+WM 點（偶數）：兩者皆 ≥83%
        教師覆寫：?unlock=all
    end note
```

### 📌 關鍵設計點

- **唯一解鎖路徑**：探險地圖 → 逐步解鎖（取消雙路線） 🆕v4.3
- **12 個探險點**：2 地圖 × 6 點 = ①~⑫，強制依序
- **通過條件**：純規則≥83%；規則+WM 兩者皆≥83% 🆕v4.3
- **跨 session 保存**：進度存 localStorage，今天玩到③，明天繼續④
- **已通過可重玩**：星星無限累計，不影響解鎖進度
- **教師覆寫**：`?unlock=all` 跳過所有鎖定
- **Config 可調**：ADVENTURE_MAPS 陣列可彈性調整探險點排列
- **不再有 UNLOCK_START_MODE**：已取消雙路線切換 🆕v4.3

---

## Flow-22: 星星與等級狀態機

> **說明**：星星累積 → 等級升級的狀態轉換。  
> **對應章節**：§3.8 等級系統

```mermaid
stateDiagram-v2
    [*] --> 蛋寶寶

    蛋寶寶: 🥚 蛋寶寶\n0-10 ⭐
    破殼雞: 🐣 破殼雞\n11-20 ⭐
    小雞仔: 🐥 小雞仔\n21-40 ⭐
    雞大王: 🐓 雞大王\n41-60 ⭐
    金鷹王者: 🦅 金鷹王者\n61+ ⭐

    蛋寶寶 --> 破殼雞: 累積 11 ⭐\n🔊 語音播報升級
    破殼雞 --> 小雞仔: 累積 21 ⭐\n🔊 語音播報升級
    小雞仔 --> 雞大王: 累積 41 ⭐\n🔊 語音播報升級
    雞大王 --> 金鷹王者: 累積 61 ⭐\n🔊 語音播報升級

    note right of 蛋寶寶
        星星來源（探險地圖 🆕v4.3）：
        ✅ 規則通過 ≥83% → +1⭐（每次重玩都累計）
        ✅ WM 通過 ≥83% → +1⭐（每次重玩都累計）
        ✅ WM 全對 Bonus → 額外⭐（依公式）
        單次探險點最多：1⭐規則 + 1⭐WM + Bonus⭐
        累積無上限
    end note
```

### 📌 關鍵設計點

- **星星可重複**：同探險點重複通過每次都累計⭐
- **WM 通過門檻 ≥83%**：WM ≥83% → +1⭐；全對另有 Bonus⭐ 🆕v4.3
- **WM Bonus 公式**：逆向 n≥2 → +(n-1)⭐；順向 2-6 → +1⭐，7-9 → +2⭐，n≥10 → +(n-7)⭐
- **等級只升不降**：星星只增不減
- **升級語音**：升級時語音播報新等級名稱

---

## Flow-23: 徽章判定狀態機

> **說明**：18 個徽章的觸發條件決策樹。  
> **對應章節**：§3.7 徽章系統

```mermaid
flowchart TB
    TRIGGER([🎯 遊戲結算<br/>觸發徽章判定]) --> B_GROUP{徽章類別}

    B_GROUP --> BASIC
    B_GROUP --> ADVANCED
    B_GROUP --> SPECIAL

    subgraph BASIC["🏅 基礎徽章（5 個）"]
        B1{🐭 小老鼠<br/>3 規則都 ≥83%?}
        B1 -->|✅| B1_Y[🐭🏆 小老鼠冒險家]
        B2{🐟 釣魚<br/>3 規則都 ≥83%?}
        B2 -->|✅| B2_Y[🐟🏆 釣魚大冒險家]
        B3{任一遊戲場<br/>規則二 ≥83%?}
        B3 -->|✅| B3_Y[🔄⭐ 規則轉換大師]
        B4{任一遊戲場<br/>混合 ≥83%?}
        B4 -->|✅| B4_Y[🎯✨ 混合高手]
        B5{WM 完成<br/>≥ 5 次?}
        B5 -->|✅| B5_Y[🧠💫 記憶達人]
    end

    subgraph ADVANCED["🥇 進階徽章（5 個）"]
        A1{avgRT < 2 秒?}
        A1 -->|✅| A1_Y[⚡👑 速度之王]
        A2{任一規則<br/>100% 答對?}
        A2 -->|✅| A2_Y[💯🏅 完美主義者]
        A3{總分 ><br/>歷史最佳?}
        A3 -->|✅| A3_Y[📈🚀 進步之星]
        A4{WM 任一次<br/>全對?}
        A4 -->|✅| A4_Y[🧠⭐ 記憶之星]
        A5{所有遊戲場<br/>所有規則 ≥83%?}
        A5 -->|✅| A5_Y[🏅🎊 全制霸]
    end

    subgraph SPECIAL["🏅 特殊徽章（8 個）"]
        H2{已獲得<br/>≥ 7 不同徽章?}
        H2 -->|✅| H2_Y[🌟🌈 七彩收藏家]
        H3{未達標 → 重試<br/>→ 達標 ≥83%<br/>同 session?}
        H3 -->|✅| H3_Y[🦸‍♂️⚔️ 不屈勇士]
        H4{時間 < 8:00?}
        H4 -->|✅| H4_Y[🌅☀️ 早起鳥兒]
        H4b{時間 ≥ 22:00<br/>OR < 8:00?}
        H4b -->|✅| H4b_Y[🌙💪 懸梁刺骨]
        H5{累積遊玩<br/>≥ 10 次?}
        H5 -->|✅| H5_Y[🎮🕹️ 遊戲達人]
        S1{集滿基礎<br/>5 個?}
        S1 -->|✅| S1_Y[🏅🔰 徽章強者]
        S2{集滿進階<br/>5 個?}
        S2 -->|✅| S2_Y[🏅🎖️ 徽章專家]
        S3{集滿基礎+進階<br/>+不屈勇士+早起鳥兒<br/>+懸梁刺骨+遊戲達人?}
        S3 -->|✅| S3_Y[🏅👑 徽章職人大師]
    end

    style TRIGGER fill:#2196F3,color:#fff
```

### 📌 關鍵設計點

- **3 類 18 個**：基礎 5 + 進階 5 + 特殊 8
- **獲得時語音播報**：「獲得小老鼠冒險家！」
- **不屈勇士**：未通過（<83%）→ 同 session 重試 → 通過（≥83%）即觸發
- **特殊徽章含提示**：部分特殊徽章有提示文字引導但不明示條件
- **懸梁刺骨**：晚上 22:00 ～ 早上 8:00 之間遊玩即觸發
- **集滿類徽章**：徽章強者（集滿基礎）、徽章專家（集滿進階）、徽章職人大師（集滿全部指定徽章）

---

## Flow-24: 多人房間狀態機

> **說明**：房間的生命週期狀態轉換。  
> **對應章節**：§2.11 Firebase 資料結構 status 欄位

```mermaid
stateDiagram-v2
    [*] --> waiting: 房主建立房間

    waiting: 📋 waiting\n等待中（玩家可加入）
    playing: 🎮 playing\n遊戲進行中
    finished: 🏆 finished\n遊戲結束

    waiting --> playing: 房主按「開始遊戲」
    playing --> finished: 所有玩家完成所有組合

    finished --> [*]: 房主離開 / 關閉分頁\n即清空刪除房間資料

    note right of waiting
        等待中可以：
        ✅ 玩家加入/離開
        ✅ 分享邀請碼
        ✅ 房主選擇是否加入遊戲
    end note

    note right of playing
        遊戲中：
        ✅ 各自答題
        ✅ 斷線→退出或轉移
        ❌ 不可暫停
    end note

    note right of finished
        遊戲結束：
        ✅ 廣播「所有玩家已完成」
        ✅ 「觀看遊戲總結果」按鈕解鎖
        ✅ 截圖 / CSV 匯出
        ✅ 房主變更不影響結果畫面
    end note
```

### 📌 關鍵設計點

- **3 個狀態**：waiting → playing → finished
- **playing → finished 觸發**：所有玩家的 allCompleted 都為 true → 廣播「🎉 所有玩家已完成！」→ 解鎖「觀看遊戲總結果」按鈕 🆕v4.3
- **房主可選擇是否加入遊戲**：不加入則顯示即時狀態儀表板 🆕v4.3
- **房主變更通知**：新房主「房主斷線，你現在是房主」；其他玩家「房主已變更為 ○○」 🆕v4.3
- **房主離開即清**：房主離開遊戲 / 關閉分頁即刪除 RTDB 資料（onDisconnect + beforeunload）
- **不可逆**：進入 playing 後不可回到 waiting

---

## Flow-25: 單一組合（Combo）玩家狀態機

> **說明**：多人模式中每位玩家在一個組合內的狀態進展。  
> **對應章節**：§2.11 comboStatus

```mermaid
stateDiagram-v2
    [*] --> 未開始

    未開始: 📋 未開始\nstarted: false
    答題中: ✏️ 答題中\ncurrentQuestion++
    答題完成: ✅ 答題完成
    WM測驗中: 🧠 WM 測驗中
    WM完成: 🧠 WM 完成
    組合完成: 🎉 組合完成\njustCompleted: "組合名"
    等待中: ⏳ 等待其他玩家

    未開始 --> 答題中: 玩家按「開始」\n→ 各自倒數
    答題中 --> 答題中: 答完一題\ncurrentQuestion++
    答題中 --> 答題完成: 所有題目答完

    答題完成 --> WM測驗中: 本組合有 WM
    答題完成 --> 組合完成: 本組合無 WM

    WM測驗中 --> WM完成: 提交 WM 答案
    WM完成 --> 組合完成: WM 計分完成

    組合完成 --> 等待中: 3 秒後\njustCompleted → false
    等待中 --> [*]: 所有玩家完成\n→ 進入下一組合
```

### 📌 關鍵設計點

- **justCompleted 通知**：完成時設為具體組合名（如 "🐭規則一+WM"）觸發通知，3 秒後設 false
- **allCompleted 通知**：全部組合完成時設 true，額外觸發「🎉 全部完成！」
- **WM 可選**：視組合設定決定是否進入 WM
- **各自節奏**：每人獨立推進，完成後等待他人

---

# E. 決策流程（Decision Flows）

---

## Flow-26: 通過／失敗判定與後續處理流程

> **說明**：探險地圖探險點完成後的通過判定 + 連鎖效果。  
> **對應章節**：§3.8–§3.9 星星/解鎖系統 🆕v4.3

```mermaid
flowchart TB
    FINISH([📝 規則完成<br/>答對率計算完畢]) --> PASS{答對率<br/>≥ 83%<br/>（≈5/6 題）?}

    PASS -->|✅ 通過| SUCCESS
    PASS -->|❌ 未通過| FAIL

    subgraph SUCCESS["✅ 通過效果"]
        S1[⭐ +1 星星（規則）]
        S2[📊 計入探險地圖<br/>通過進度]
        S3[🔊 語音播報通過]
        S5{首次通過?}
        S5 -->|是| S5_Y[🌟 首次通關 +1 分<br/>標記 firstClear=false]
        S5 -->|否| S5_N[無額外]
        S6[🏅 觸發徽章判定<br/>→ 詳見 Flow-23]
        S7[📊 更新 localStorage<br/>bestScore / starsEarned]
    end

    subgraph FAIL["❌ 未通過效果"]
        F1[❌ 不得星星]
        F2[❌ 不計入通過進度]
        F3[可重新遊玩]
        F4{同 session<br/>重試後通過?}
        F4 -->|是| F4_Y[🦸‍♂️ 不屈勇士徽章<br/>→ 詳見 Flow-27]
    end

    SUCCESS --> WM_CHECK
    FAIL --> WM_CHECK

    WM_CHECK{本探險點<br/>含 WM?}
    WM_CHECK -->|有 WM| WM[🧠 WM 測驗<br/>→ 詳見 Flow-13]
    WM_CHECK -->|無 WM| UNLOCK_CHECK

    WM --> WM_PASS{WM ≥83%?}
    WM_PASS -->|✅| WM_STAR[⭐ +1 WM 星星<br/>+ 全對 Bonus ⭐]
    WM_PASS -->|❌| WM_NO[僅基礎分<br/>❌ 無 WM 星星]

    WM_STAR --> UNLOCK_CHECK
    WM_NO --> UNLOCK_CHECK

    UNLOCK_CHECK{探險點通過判定}
    UNLOCK_CHECK -->|純規則：規則≥83%| UNLOCK[🔓 解鎖下一探險點]
    UNLOCK_CHECK -->|規則+WM：兩者皆≥83%| UNLOCK
    UNLOCK_CHECK -->|任一未達標| NO_UNLOCK[❌ 未解鎖<br/>可重玩此探險點]

    UNLOCK --> MAP_CHECK{最後一點?}
    MAP_CHECK -->|地圖1第6點| MAP2_UNLOCK[🎉 解鎖地圖 2]
    MAP_CHECK -->|地圖2第6點| FREE_UNLOCK[🎉🎉 解鎖自由選擇！<br/>慶祝動畫]
    MAP_CHECK -->|其他| NEXT[➡️ 回到探險地圖]

    NO_UNLOCK --> NEXT
    MAP2_UNLOCK --> NEXT
    FREE_UNLOCK --> NEXT

    style FINISH fill:#2196F3,color:#fff
    style SUCCESS fill:#E8F5E9
    style FAIL fill:#FFEBEE
    style FREE_UNLOCK fill:#FFD700,color:#333
```

### 📌 關鍵設計點

- **通過 = 得星**：規則≥83% 獲得 1⭐
- **WM 通過門檻 ≥83%**：WM ≥83% → +1⭐ + 全對 Bonus⭐ 🆕v4.3
- **探險點通過判定**：純規則只看規則；規則+WM 兩者皆需≥83% 🆕v4.3
- **解鎖連鎖**：通過→解鎖下一探險點→地圖完成→解鎖下一地圖→全通關→解鎖自由選擇
- **不屈勇士**：未通過 → 同 session 重試 → 通過 → 觸發特殊徽章
- **WM 星星獨立**：規則未通過仍可嘗試 WM（但探險點不算通過）

---

## Flow-27: 不屈勇士徽章觸發流程

> **說明**：特殊徽章「不屈勇士」的精確觸發條件。  
> **對應章節**：§3.7 特殊徽章

```mermaid
flowchart TB
    FINISH([📝 規則結束]) --> ACC{答對率?}

    ACC -->|≥ 83%| NO_TRIGGER[不觸發<br/>（本身就達標了）]
    ACC -->|< 83%| UNDER[📌 標記為「未達標」<br/>記錄 session ID]

    UNDER --> ACTION{玩家動作?}
    ACTION -->|🏠 離開網站| CANCEL[❌ 重置標記<br/>離開不算重試]
    ACTION -->|🔄 按「重新挑戰」| RETRY[🔄 開始重試<br/>同一 session]

    RETRY --> RETRY_FINISH[📝 重試完成]
    RETRY_FINISH --> RETRY_ACC{重試答對率?}

    RETRY_ACC -->|≥ 83%| BADGE[🦸‍♂️⚔️ 獲得「不屈勇士」！<br/>🔊 語音播報徽章名稱]
    RETRY_ACC -->|< 83%| NO_BADGE[❌ 未達標<br/>可再次重試]

    NO_BADGE --> ACTION

    style FINISH fill:#2196F3,color:#fff
    style BADGE fill:#FFD700,color:#333
    style CANCEL fill:#9E9E9E,color:#fff
```

### 📌 關鍵設計點

- **83% 門檻**（≈5/6）：與系統級通過門檻一致，即「失敗後重試並通過」
- **同 session 限定**：離開網站後重置，不算「立刻重試」
- **可多次嘗試**：未達標可持續重試直到達標
- **用「達標/未達標」**：避免與系統「通過/失敗」混淆

---

## Flow-28: 反應時間（RT）計算流程

> **說明**：各種情境下 RT 的計算規則與 avgRT 判定。  
> **對應章節**：§3.1b 反應時間計算方式

```mermaid
flowchart TB
    TRIAL([⏱️ 試驗完成]) --> TYPE{試題類型 +<br/>玩家反應}

    TYPE -->|Go 題 + 按了 ✅| HIT_RT[RT = 按鍵時間 - 出現時間<br/>✅ 計入 avgRT]
    TYPE -->|Go 題 + 沒按 ❌| MISS_RT[RT = 0<br/>Omission Error<br/>❌ 不計入 avgRT]
    TYPE -->|No-Go 題 + 沒按 ✅| CR_RT[RT = 0<br/>Correct Rejection<br/>❌ 不計入 avgRT]
    TYPE -->|No-Go 題 + 按了 ❌| FA_RT[RT = 按鍵時間<br/>False Alarm<br/>❌ 不計入 avgRT]

    HIT_RT --> COLLECT[收集所有 Hit 的 RT]
    MISS_RT --> SKIP[排除]
    CR_RT --> SKIP
    FA_RT --> SKIP

    COLLECT --> AVG[計算 avgRT<br/>= 所有 Hit RT 的平均值]

    AVG --> COMPARE{與歷史比較}
    COMPARE --> BEST_CHECK{bestAvgRT<br/>= null?}
    BEST_CHECK -->|null（首次）| AUTO_AWARD[✅ 自動獲得速度 +1<br/>設 bestAvgRT = 當前 avgRT]
    BEST_CHECK -->|有紀錄| FASTER{avgRT <<br/>bestAvgRT?}
    FASTER -->|✅ 更快| SPEED_AWARD[✅ 速度獎勵 +1<br/>更新 bestAvgRT]
    FASTER -->|❌ 沒更快| NO_AWARD[❌ 無速度獎勵]

    style TRIAL fill:#2196F3,color:#fff
    style HIT_RT fill:#4CAF50,color:#fff
    style MISS_RT fill:#F44336,color:#fff
    style CR_RT fill:#4CAF50,color:#fff
    style FA_RT fill:#F44336,color:#fff
    style AUTO_AWARD fill:#FFD700,color:#333
    style SPEED_AWARD fill:#FFD700,color:#333
```

### 📌 關鍵設計點

- **只計 Hit**：avgRT 只包含 Go 正確按鍵的反應時間
- **首次自動 +1**：bestAvgRT=null 時直接獲得速度獎勵
- **No-Go 不計 RT**：抑制反應無法測量反應時間

---

## Flow-29: 聲音系統播放決策流程

> **說明**：遊戲事件觸發聲音時的開關判定與 fallback。  
> **對應章節**：§4.2–§4.3 聲音分類與控制

```mermaid
flowchart TB
    EVENT([🎯 遊戲事件觸發]) --> CLASSIFY{事件分類}

    CLASSIFY -->|音效類| SFX_CHECK{🔊 音效開關<br/>ON?}
    CLASSIFY -->|語音類| VOICE_CHECK{🗣️ 語音開關<br/>ON?}

    SFX_CHECK -->|OFF| SILENT_SFX[🔇 不播放]
    SFX_CHECK -->|ON| SFX_PLAY

    VOICE_CHECK -->|OFF| SILENT_VOICE[🔇 不播放]
    VOICE_CHECK -->|ON| VOICE_PLAY

    subgraph SFX_PLAY["🔊 音效播放"]
        SFX_LIST[音效事件：<br/>✅ 答對叮 / 答錯噗<br/>✅ 倒數嗶<br/>✅ WM 位置亮起<br/>✅ 按鈕點擊<br/>✅ 玩家加入通知<br/>✅ 徽章解鎖<br/>✅ 等級升級]
    end

    subgraph VOICE_PLAY["🗣️ 語音播放"]
        VOICE_LIST[語音事件：<br/>✅ 規則說明語音<br/>✅ 刺激物語音（男/女聲）<br/>✅ 徽章名稱播報<br/>✅ 等級名稱播報<br/>✅ 解鎖通知播報<br/>✅ WM 規則播報]
    end

    SFX_LIST --> FALLBACK
    VOICE_LIST --> FALLBACK

    subgraph FALLBACK["🔄 Fallback 機制"]
        FB1{自訂音效<br/>存在?}
        FB1 -->|✅| FB_OK[播放自訂]
        FB1 -->|❌| FB2{預設音效<br/>存在?}
        FB2 -->|✅| FB_DEFAULT[播放預設]
        FB2 -->|❌| FB_SKIP[靜默跳過<br/>console.warn]
    end

    style EVENT fill:#2196F3,color:#fff
    style SILENT_SFX fill:#9E9E9E,color:#fff
    style SILENT_VOICE fill:#9E9E9E,color:#fff
```

### 📌 關鍵設計點

- **兩個主開關**：🔊 音效 和 🗣️ 語音，各自獨立
- **無 BGM**：已取消背景音樂
- **三級 Fallback**：自訂 → 預設 → 靜默跳過
- **不彈錯誤**：缺失時只 console.warn

---

## Flow-30: 配色主題與刺激物 Config 載入流程

> **說明**：頁面載入時的主題、刺激物包、音效包選擇與 fallback。  
> **對應章節**：§4.4.5 主題切換、§4.5.4 切換流程

```mermaid
flowchart TB
    LOAD([🌐 頁面載入]) --> READ_LS[讀取 localStorage 偏好<br/>colorTheme / stimuliPack / soundPack]

    READ_LS --> THEME[1️⃣ 套用配色主題<br/>data-theme 屬性]

    THEME --> THEME_TYPE{主題類型?}
    THEME_TYPE -->|field-primary| FP[遊戲場主導配色<br/>🐭=綠色系 / 🐟=藍色系]
    THEME_TYPE -->|rule-independent| RI[規則獨立配色<br/>規則一=統一色A<br/>規則二=統一色B]

    FP --> STIMULI
    RI --> STIMULI

    STIMULI[2️⃣ 載入刺激物包<br/>currentPack]
    STIMULI --> STIM_CHECK{自訂包?}
    STIM_CHECK -->|default| STIM_DEFAULT[使用預設 SVG]
    STIM_CHECK -->|custom| STIM_CUSTOM{SVG 存在?}
    STIM_CUSTOM -->|✅| STIM_OK[使用自訂 SVG]
    STIM_CUSTOM -->|❌| STIM_EMOJI[回退 Emoji 🧀😺🐟🦈]

    STIM_DEFAULT --> SOUND
    STIM_OK --> SOUND
    STIM_EMOJI --> SOUND

    SOUND[3️⃣ 載入音效包<br/>currentSoundPack + soundOverrides]
    SOUND --> SOUND_CHECK{自訂音效?}
    SOUND_CHECK -->|default| SOUND_DEFAULT[使用預設音效]
    SOUND_CHECK -->|custom| SOUND_CUSTOM{檔案存在?}
    SOUND_CUSTOM -->|✅| SOUND_OK[使用自訂音效]
    SOUND_CUSTOM -->|❌| SOUND_FALLBACK[回退預設音效]

    SOUND_DEFAULT --> READY
    SOUND_OK --> READY
    SOUND_FALLBACK --> READY

    READY([✅ 初始化完成<br/>可開始遊戲])

    style LOAD fill:#2196F3,color:#fff
    style READY fill:#4CAF50,color:#fff
```

### 📌 關鍵設計點

- **3 步初始化**：主題 → 刺激物 → 音效，依序載入
- **localStorage 持久化**：偏好設定跨 session 保留
- **雙主題方案**：遊戲場主導 vs 規則獨立，使用者可切換
- **Fallback 鏈**：自訂 → 預設 → Emoji/靜默

---

## 📊 流程圖總覽統計

| 類別          |  數量  | 流程圖編號 |
| ------------- | :----: | ---------- |
| A. 使用者流程 |   8    | Flow 1-8   |
| B. 遊戲邏輯   |   7    | Flow 9-15  |
| C. 資料流程   |   5    | Flow 16-20 |
| D. 狀態機     |   5    | Flow 21-25 |
| E. 決策流程   |   5    | Flow 26-30 |
| **合計**      | **30** |            |

---

> 📌 本文件使用 Mermaid 語法，可在 GitHub、VS Code（Markdown Preview Mermaid Support 擴充套件）、或任何支援 Mermaid 的工具中直接預覽。
