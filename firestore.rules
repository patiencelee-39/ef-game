rules_version = '2';

// ====================================
// Firestore å®‰å…¨è¦å‰‡
// ====================================
// å°æ‡‰ï¼šæŽ’è¡Œæ¦œç³»çµ±ï¼ˆäºŒè»Œåˆ¶ï¼‰
//
// ç”¨é€”ï¼š
//   1. ðŸ“‹ ç­ç´šæŽ’è¡Œæ¦œï¼ˆclassLeaderboardsï¼‰â€” æŒä¹…åŒ–ï¼Œè€å¸«ä¸åˆªå°±ä¸€ç›´åœ¨
//   2. ðŸŒ ä¸–ç•ŒæŽ’è¡Œæ¦œï¼ˆworldLeaderboardï¼‰â€” åŒ¿åä¸Šå‚³ï¼Œè¦†è“‹æˆ–éŽæœŸåˆªé™¤
// ====================================

service cloud.firestore {
  match /databases/{database}/documents {

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ðŸ“‹ ç­ç´šæŽ’è¡Œæ¦œï¼ˆæŒä¹…åŒ–ï¼Œè€å¸«ç®¡ç†ï¼‰
    // è·¯å¾‘ï¼š/classLeaderboards/{boardId}/entries/{entryId}
    // boardId = è€å¸«å»ºç«‹æ™‚è‡ªå‹•ç”¢ç”Ÿçš„ ID
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /classLeaderboards/{boardId} {
      // âœ… çœ‹æ¿å…ƒè³‡æ–™ï¼šä»»ä½•å·²é©—è­‰ç”¨æˆ¶å¯è®€å–
      allow read: if request.auth != null;

      // âœ… å»ºç«‹çœ‹æ¿ï¼šå·²é©—è­‰ç”¨æˆ¶å¯å»ºç«‹ï¼ˆè¨˜éŒ„ ownerIdï¼‰
      allow create: if request.auth != null
        && request.resource.data.keys().hasAll(['ownerId', 'boardName', 'createdAt'])
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.boardName is string
        && request.resource.data.boardName.size() >= 1
        && request.resource.data.boardName.size() <= 50;

      // âœ… æ›´æ–°/åˆªé™¤ï¼šåƒ…çœ‹æ¿æ“æœ‰è€…
      allow update, delete: if request.auth != null
        && resource.data.ownerId == request.auth.uid;

      match /entries/{entryId} {
        // âœ… ä»»ä½•å·²é©—è­‰ç”¨æˆ¶å¯è®€å–ï¼ˆæŒæœ‰ä»£ç¢¼/é€£çµå³å¯çœ‹ï¼‰
        allow read: if request.auth != null;

        // âœ… ä»»ä½•å·²é©—è­‰ç”¨æˆ¶å¯å¯«å…¥ï¼ˆå­¸ç”ŸåŒ¿åä¸Šå‚³ï¼‰
        allow create, update: if request.auth != null
          && request.resource.data.keys().hasAll(['nickname', 'score', 'accuracy', 'uploadedAt'])
          && request.resource.data.nickname is string
          && request.resource.data.nickname.size() >= 1
          && request.resource.data.nickname.size() <= 20
          && request.resource.data.score is int
          && request.resource.data.score >= 0
          && request.resource.data.score <= 99999
          && request.resource.data.keys().size() <= 15;

        // âœ… åˆªé™¤ï¼šçœ‹æ¿æ“æœ‰è€… æˆ– ä¸Šå‚³è€…æœ¬äºº
        allow delete: if request.auth != null
          && (get(/databases/$(database)/documents/classLeaderboards/$(boardId)).data.ownerId == request.auth.uid
              || resource.data.uid == request.auth.uid);
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ðŸŒ ä¸–ç•ŒæŽ’è¡Œæ¦œï¼ˆåŒ¿åå³å¯ä¸Šå‚³ï¼Œper-rule åˆ†é–‹å­˜æ”¾ï¼‰
    // è·¯å¾‘ï¼š/worldLeaderboard/{docId}
    // docId = uid_fieldId_ruleIdï¼ˆper-ruleï¼‰æˆ– uidï¼ˆèˆŠç‰ˆç›¸å®¹ï¼‰
    // æ¯å€‹ doc å¿…é ˆå¸¶ uid æ¬„ä½ = request.auth.uid
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /worldLeaderboard/{docId} {
      // âœ… ä»»ä½•å·²é©—è­‰ç”¨æˆ¶å¯è®€å–æŽ’è¡Œæ¦œ
      allow read: if request.auth != null;

      // âœ… å·²é©—è­‰ç”¨æˆ¶å¯å»ºç«‹/æ›´æ–°è‡ªå·±çš„è³‡æ–™ï¼ˆuid æ¬„ä½å¿…é ˆç­‰æ–¼ auth.uidï¼‰
      allow create, update: if request.auth != null
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.nickname is string
        && request.resource.data.nickname.size() >= 1
        && request.resource.data.nickname.size() <= 20
        && request.resource.data.keys().size() <= 25;

      // âœ… åªèƒ½åˆªé™¤è‡ªå·±çš„è³‡æ–™ï¼ˆç”¨ uid æ¬„ä½é©—è­‰ï¼‰
      allow delete: if request.auth != null
        && resource.data.uid == request.auth.uid;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ðŸš« å…¶ä»–æ‰€æœ‰é›†åˆï¼šé è¨­æ‹’çµ•
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
