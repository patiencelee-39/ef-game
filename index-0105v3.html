<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>åŸ·è¡ŒåŠŸèƒ½èªçŸ¥è¨“ç·´ - ä¸­åŸå¤§å­¸ç‰¹æ•™ç³»ç ”ç©¶å·¥å…·</title>

    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;"
    />

    <style>
      /* [è‰¯å¥½å¯¦è¸ï¼šCSS è®Šæ•¸] */
      :root {
        --bg-color: #2c3e50;
        --text-color: #ecf0f1;
        --primary-color: #3498db;
        --success-color: #2ecc71;
        --error-color: #e74c3c;
        --accent-yellow: #f1c40f;
        --round1-color: #e67e22;
        --round2-color: #9b59b6;
        --practice-color: #1abc9c; /* æ–°å¢ï¼šç·´ç¿’æ¨¡å¼é¡è‰² (é’ç¶ è‰²) */
      }

      body {
        font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        text-align: center;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        touch-action: manipulation;
      }

      .landing-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 15px;
        max-width: 600px;
        margin-bottom: 20px;
        text-align: left;
        border-left: 5px solid var(--primary-color);
      }
      .landing-info h3 {
        margin-top: 0;
        color: var(--primary-color);
      }
      .landing-info p {
        line-height: 1.6;
        opacity: 0.9;
      }

      .tutorial-container {
        display: flex;
        flex-direction: row;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        width: 100%;
      }

      .rule-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        border: 2px solid rgba(255, 255, 255, 0.1);
      }

      /* ç¬¬ä¸€å›åˆèˆ‡ç·´ç¿’çš„é è¨­é¡è‰² */
      .rule-box.left-box {
        background: rgba(241, 196, 15, 0.2);
      } /* é»ƒè‰²èƒŒæ™¯ */
      .rule-box.right-box {
        background: rgba(230, 126, 34, 0.2);
      } /* æ©˜è‰²èƒŒæ™¯ */

      .rule-icon {
        font-size: 4em;
        margin-bottom: 10px;
      }
      .rule-arrow {
        font-size: 2em;
        color: #bdc3c7;
        margin: 10px 0;
      }

      .rule-key {
        border: 3px solid #fff;
        border-radius: 10px;
        padding: 5px 20px;
        font-family: monospace;
        background: rgba(0, 0, 0, 0.3);
        font-size: 3.5em;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 5px;
      }

      .key-desc {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .game-area {
        background-color: #34495e;
        border-radius: 15px;
        padding: 20px;
        width: 100%;
        max-width: 600px;
        margin: 20px auto;
        border: 5px solid transparent;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        height: 600px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      .round-label {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
        z-index: 10;
      }
      /* å„éšæ®µæ¨™ç±¤é¡è‰² */
      .round-practice {
        background-color: var(--practice-color);
      }
      .round1-badge {
        background-color: var(--round1-color);
      }
      .round2-badge {
        background-color: var(--round2-color);
      }

      /* é€²åº¦æ¢æ¨£å¼ */
      .progress-container {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        border-radius: 10px;
        transition: width 0.3s ease;
        width: 0%;
      }

      .feedback-success {
        animation: pulse-green 0.3s ease-out;
        border-color: var(--success-color) !important;
      }
      .feedback-error {
        animation: shake-red 0.2s ease-in-out;
        border-color: var(--error-color) !important;
      }

      @keyframes pulse-green {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 0 15px rgba(46, 204, 113, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
        }
      }
      @keyframes shake-red {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-15px);
        }
        75% {
          transform: translateX(15px);
        }
      }

      .stimulus {
        font-size: 150px;
        height: 200px;
        width: 200px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: transform 0.1s;
        margin: 0 auto;
      }
      .stimulus.pop {
        transform: scale(1.3);
      }

      .controls-area {
        width: 100%;
        display: flex;
        justify-content: space-around;
        padding-bottom: 20px;
        gap: 20px;
      }

      .btn-key {
        flex: 1;
        height: 100px;
        border: none;
        border-radius: 15px;
        font-size: 1.5em;
        color: white;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: transform 0.1s, opacity 0.3s;
        box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
      }
      .btn-key:active,
      .btn-key.active-key {
        transform: translateY(4px);
        box-shadow: none;
      }

      .btn-f {
        background-color: #f1c40f;
        color: #2c3e50;
      }
      .btn-j {
        background-color: #e67e22;
      }
      .btn-disabled {
        background-color: #7f8c8d;
        opacity: 0.3;
        pointer-events: none;
      }
      .key-hint {
        font-size: 0.6em;
        opacity: 0.8;
        margin-bottom: 5px;
      }

      @keyframes pulse-correct {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
          filter: brightness(1.5);
        }
        100% {
          transform: scale(1);
        }
      }
      @keyframes shake-error {
        0%,
        100% {
          transform: translateX(0) rotate(0deg);
        }
        25% {
          transform: translateX(-10px) rotate(-5deg);
        }
        75% {
          transform: translateX(10px) rotate(5deg);
        }
      }

      .correct-flash {
        animation: pulse-correct 0.5s ease-out;
        filter: drop-shadow(0 0 20px #2ecc71);
      }
      .error-flash {
        animation: shake-error 0.4s ease-in-out;
        filter: drop-shadow(0 0 20px #e74c3c);
      }

      .hidden {
        display: none !important;
      }
      .screen-layer {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 25px;
        font-size: 1.2em;
        border-radius: 50px;
        cursor: pointer;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>ğŸ§  åŸ·è¡ŒåŠŸèƒ½èªçŸ¥è¨“ç·´</h1>
      <p style="opacity: 0.7">ä¸­åŸå¤§å­¸ç‰¹æ®Šæ•™è‚²å­¸ç³» | å­¸è¡“ç ”ç©¶å·¥å…· v2.5</p>
    </header>

    <main class="game-area" id="gameContainer">
      <div id="landingPage" class="screen-layer">
        <div class="landing-info">
          <h3>ğŸ« é—œæ–¼æœ¬ç ”ç©¶å·¥å…·</h3>
          <p>
            æœ¬å·¥å…·ç”±ä¸­åŸå¤§å­¸ç‰¹æ®Šæ•™è‚²å­¸ç³»é–‹ç™¼ï¼Œæ—¨åœ¨å”åŠ©è½éšœå­¸ç«¥é€²è¡Œã€ŒåŸ·è¡ŒåŠŸèƒ½ã€çš„è¨“ç·´èˆ‡è©•ä¼°ã€‚
          </p>
          <hr
            style="
              border: 0;
              border-top: 1px solid rgba(255, 255, 255, 0.2);
              margin: 15px 0;
            "
          />
          <p><strong>ğŸ”’ éš±ç§æ¬Šè²æ˜ï¼š</strong></p>
          <p>
            æœ¬æ¸¬é©—ç‚ºç´”å‰ç«¯é‹ä½œï¼Œæ‚¨çš„åæ‡‰æ™‚é–“èˆ‡æ­£ç¢ºç‡æ•¸æ“š<b>åƒ…æš«å­˜æ–¼ç€è¦½å™¨ä¸­</b>ï¼Œæˆ‘å€‘ä¸æœƒå°‡ä»»ä½•å€‹äººè³‡æ–™ä¸Šå‚³è‡³ä¼ºæœå™¨ã€‚
          </p>
        </div>
        <button class="btn" onclick="game.showTutorial()">
          ğŸ‘‰ é€²å…¥æ¸¬é©—èªªæ˜
        </button>
        <br />
        <small
          ><a href="privacy.html" style="color: #bdc3c7"
            >è©³ç´°éš±ç§æ¬Šæ”¿ç­–</a
          ></small
        >
      </div>

      <div id="introScreen" class="screen-layer hidden">
        <h2>ç·´ç¿’æ¨¡å¼</h2>
        <p style="margin-bottom: 20px; color: #bdc3c7">
          æˆ‘å€‘å…ˆç·´ç¿’ä¸€ä¸‹ï¼<br />çœ‹ â­ æŒ‰å·¦é‚ŠFéµï¼Œçœ‹ â˜€ï¸ æŒ‰å³é‚ŠJéµ
        </p>

        <div class="tutorial-container">
          <div class="rule-box left-box">
            <span class="rule-icon">â­</span>
            <span class="rule-arrow">â¬‡</span>
            <span class="rule-key">F</span>
            <span class="key-desc">å·¦æ‰‹</span>
          </div>
          <div class="rule-box right-box">
            <span class="rule-icon">â˜€ï¸</span>
            <span class="rule-arrow">â¬‡</span>
            <span class="rule-key">J</span>
            <span class="key-desc">å³æ‰‹</span>
          </div>
        </div>
        <button class="btn" onclick="game.startPractice()">ğŸ’ª é–‹å§‹ç·´ç¿’</button>
      </div>

      <div id="practiceEndScreen" class="screen-layer hidden">
        <h2>ğŸ‘ ç·´ç¿’å®Œæˆï¼</h2>
        <p>åšå¾—å¾ˆæ£’ï¼çŸ¥é“æ€éº¼ç©äº†å—ï¼Ÿ</p>
        <p>æ¥ä¸‹ä¾†è¦<b>æ­£å¼é–‹å§‹</b>å›‰ï¼</p>
        <div style="margin-top: 20px">
          <button class="btn" onclick="game.startRound1()">
            â–¶ï¸ é–‹å§‹ç¬¬ä¸€å› (æ­£å¼)
          </button>
        </div>
      </div>

      <!-- ç·´ç¿’æ¨¡å¼ç•«é¢ -->
      <div id="practiceScreen" class="screen-layer hidden">
        <h2 style="color: #f39c12">ğŸ® ç·´ç¿’æ¨¡å¼</h2>
        <p style="color: #bdc3c7; margin-bottom: 30px">
          å…ˆä¾†ç·´ç¿’ 3 é¡Œï¼Œç†Ÿæ‚‰éŠæˆ²è¦å‰‡ï¼
        </p>

        <div class="tutorial-container">
          <div class="rule-box left-box">
            <span class="rule-icon">â­</span>
            <span class="rule-arrow">â¬‡</span>
            <span class="rule-key">F</span>
            <span class="key-desc">å·¦æ‰‹</span>
          </div>

          <div class="rule-box right-box">
            <span class="rule-icon">â˜€ï¸</span>
            <span class="rule-arrow">â¬‡</span>
            <span class="rule-key">J</span>
            <span class="key-desc">å³æ‰‹</span>
          </div>
        </div>

        <button class="btn" onclick="game.startPractice()">ğŸš€ é–‹å§‹ç·´ç¿’</button>
      </div>

      <div id="intermissionScreen" class="screen-layer hidden">
        <h2 style="color: var(--round2-color)">âš ï¸ è¦å‰‡æ”¹è®Šäº†ï¼</h2>

        <div class="tutorial-container">
          <div
            class="rule-box left-box"
            style="background: rgba(127, 140, 141, 0.5)"
          >
            <span class="rule-icon">â­</span>
            <span class="rule-arrow">â¬‡</span>
            <span class="rule-icon" style="font-size: 3em">ğŸ›‘</span>
            <span
              class="key-desc"
              style="color: var(--error-color); font-weight: bold"
              >ä¸è¦æŒ‰ï¼</span
            >
          </div>

          <div class="rule-box right-box">
            <span class="rule-icon">â˜€ï¸</span>
            <span class="rule-arrow">â¬‡</span>
            <span class="rule-key">J</span>
            <span class="key-desc">è¦æŒ‰ï¼</span>
          </div>
        </div>

        <button class="btn" onclick="game.startRound2()">ğŸš€ é–‹å§‹ç¬¬äºŒå›</button>
      </div>

      <div
        id="playScreen"
        class="hidden"
        style="
          width: 100%;
          height: 100%;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
        "
      >
        <div style="width: 100%">
          <div id="roundLabel" class="round-label round1-badge">ç¬¬ä¸€å›</div>
          <div
            style="
              margin-top: 25px;
              display: flex;
              justify-content: space-between;
            "
          >
            <span
              >é€²åº¦: <span id="currentTrialDisplay">0</span>/<span
                id="totalTrialDisplay"
                >10</span
              ></span
            >
          </div>
          <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
        </div>

        <div id="stimulusBox" class="stimulus"></div>

        <div class="controls-area">
          <button
            id="btnF"
            class="btn-key btn-f"
            onpointerdown="game.handleInput('F')"
          >
            <span class="key-hint">Keyboard F</span>
            â­
          </button>
          <button
            id="btnJ"
            class="btn-key btn-j"
            onpointerdown="game.handleInput('J')"
          >
            <span class="key-hint">Keyboard J</span>
            â˜€ï¸
          </button>
        </div>
      </div>

      <div id="resultScreen" class="screen-layer hidden">
        <h2>ğŸ‰ å…¨éƒ¨å®Œæˆï¼</h2>
        <div
          style="
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            width: 100%;
          "
        >
          <p>
            ç­”å°é¡Œæ•¸ï¼š<span
              id="scoreDisplay"
              style="color: var(--success-color); font-size: 1.5em"
              >0</span
            >
          </p>
          <p>å¹³å‡é€Ÿåº¦ï¼š<span id="avgTimeDisplay">0ms</span></p>
        </div>
        <button class="btn" onclick="location.reload()">ğŸ”„ å›åˆ°é¦–é </button>
        <button
          class="btn"
          onclick="game.exportData()"
          style="background-color: #7f8c8d"
        >
          ğŸ“¥ åŒ¯å‡ºè³‡æ–™
        </button>
      </div>
    </main>

    <script>
      const CONFIG = {
        practiceTrials: 5, // [æ–°å¢] ç·´ç¿’é¡Œæ•¸
        round1Trials: 5,
        round2Trials: 10,
        stimulusDuration: 1500,
        isiMin: 800,
        isiMax: 1200,
        goRatio: 0.5,
      };

      const game = {
        state: {
          currentRound: 1,
          currentTrial: 0,
          totalTrials: 0,
          score: 0,
          results: [],
          isPlaying: false,
          isPractice: false, // [æ–°å¢] ç·´ç¿’æ¨¡å¼æ——æ¨™
          currentStimulus: null,
          startTime: 0,
          responded: false,
          timer: null,
        },

        elements: {
          container: document.getElementById("gameContainer"),
          screens: {
            landing: document.getElementById("landingPage"),
            intro: document.getElementById("introScreen"),
            practiceEnd: document.getElementById("practiceEndScreen"), // [æ–°å¢]
            intermission: document.getElementById("intermissionScreen"),
            play: document.getElementById("playScreen"),
            result: document.getElementById("resultScreen"),
          },
          stimulus: document.getElementById("stimulusBox"),
          btnF: document.getElementById("btnF"),
          btnJ: document.getElementById("btnJ"),
          roundLabel: document.getElementById("roundLabel"),
          trialDisplay: document.getElementById("currentTrialDisplay"),
          totalDisplay: document.getElementById("totalTrialDisplay"),
          scoreDisplay: document.getElementById("scoreDisplay"),
          avgTimeDisplay: document.getElementById("avgTimeDisplay"),
        },

        showTutorial: function () {
          this.showScreen("practice"); // ğŸ‘ˆ æ”¹æˆå…ˆé¡¯ç¤ºç·´ç¿’ // âœ… å…ˆé€²å…¥ç·´ç¿’æ¨¡å¼
        },

        // [æ–°å¢] é–‹å§‹ç·´ç¿’æ¨¡å¼
        startPractice: function () {
          this.state.isPractice = true;
          this.state.currentRound = 1; // ç·´ç¿’é€šå¸¸æ¨¡æ“¬ç¬¬ä¸€å›è¦å‰‡
          this.state.totalTrials = CONFIG.practiceTrials;

          this.elements.roundLabel.innerText = "ç·´ç¿’æ¨¡å¼";
          this.elements.roundLabel.className = "round-label round-practice"; // é’è‰²æ¨™ç±¤

          this.elements.btnF.classList.remove("btn-disabled");
          this.elements.btnF.innerHTML =
            '<span class="key-hint">Keyboard F</span>â­';

          this.initGameSession();
        },

        /**
         * [åŠŸèƒ½] é–‹å§‹ç·´ç¿’æ¨¡å¼
         */
        startPractice: function () {
          this.state.currentRound = 0; // ç·´ç¿’å›åˆ
          this.state.totalTrials = 3; // åªç·´ç¿’ 3 é¡Œ
          this.state.results = [];
          this.state.currentTrial = 0;
          this.state.score = 0;
          this.state.isPlaying = true;

          this.elements.roundLabel.innerText = "ç·´ç¿’æ¨¡å¼";
          this.elements.roundLabel.className = "round-label round1-badge";
          this.elements.totalDisplay.innerText = this.state.totalTrials;

          // å•Ÿç”¨ F éµ
          this.elements.btnF.classList.remove("btn-disabled");
          this.elements.btnF.innerHTML =
            '<span class="key-hint">Keyboard F</span>â­';

          this.showScreen("play");
          this.nextTrial();
        },

        //* [åŠŸèƒ½] é–‹å§‹ç¬¬ä¸€å›
        //*/
        startRound1: function () {
          this.state.isPractice = false; // æ­£å¼é–‹å§‹
          this.state.currentRound = 1;
          this.state.totalTrials = CONFIG.round1Trials;
          this.state.results = []; // æ¸…ç©ºä¹‹å‰çš„æ•¸æ“š

          this.elements.roundLabel.innerText = "ç¬¬ä¸€å›ï¼šè¾¨è­˜";
          this.elements.roundLabel.className = "round-label round1-badge";

          this.elements.btnF.classList.remove("btn-disabled");
          this.elements.btnF.innerHTML =
            '<span class="key-hint">Keyboard F</span>â­';

          this.initGameSession();
        },

        startRound2: function () {
          this.state.isPractice = false;
          this.state.currentRound = 2;
          this.state.totalTrials = CONFIG.round2Trials;

          this.elements.roundLabel.innerText = "ç¬¬äºŒå›ï¼šæŠ‘åˆ¶";
          this.elements.roundLabel.className = "round-label round2-badge";

          this.elements.btnF.classList.add("btn-disabled");
          this.elements.btnF.innerHTML = '<span class="key-hint">â­</span>å¿ä½';

          this.initGameSession();
        },

        initGameSession: function () {
          this.state.currentTrial = 0;
          this.state.score = 0;
          this.state.isPlaying = true;
          this.elements.totalDisplay.innerText = this.state.totalTrials;
          this.showScreen("play");
          this.nextTrial();
        },

        nextTrial: function () {
          if (this.state.currentTrial >= this.state.totalTrials) {
            this.endSession();
            return;
          }

          this.state.currentTrial++;
          this.updateUI();

          this.elements.stimulus.innerText = "";
          this.elements.container.className = "game-area";
          this.elements.stimulus.classList.remove("pop");
          this.state.responded = false;

          const delay =
            Math.floor(Math.random() * (CONFIG.isiMax - CONFIG.isiMin + 1)) +
            CONFIG.isiMin;
          setTimeout(() => this.showStimulus(), delay);
        },

        showStimulus: function () {
          const isStar = Math.random() < CONFIG.goRatio;
          this.state.currentStimulus = isStar ? "sun" : "star";

          if (isStar) {
            this.elements.stimulus.innerText = "â˜€ï¸";
            this.elements.stimulus.style.color = "#f39c12";
          } else {
            this.elements.stimulus.innerText = "â­";
            this.elements.stimulus.style.color = "#f1c40f";
          }

          this.state.startTime = Date.now();
          this.state.timer = setTimeout(() => {
            if (!this.state.responded) {
              this.handleTimeout();
            }
          }, CONFIG.stimulusDuration);
        },

        handleInput: function (keyInput) {
          if (
            !this.state.isPlaying ||
            this.state.responded ||
            !this.elements.stimulus.innerText
          )
            return;

          this.state.responded = true;
          clearTimeout(this.state.timer);

          const btn =
            keyInput === "J" ? this.elements.btnJ : this.elements.btnF;
          btn.classList.add("active-key");
          setTimeout(() => btn.classList.remove("active-key"), 100);

          const reactionTime = Date.now() - this.state.startTime;
          const stimulus = this.state.currentStimulus;
          let isCorrect = false;

          if (this.state.currentRound === 1) {
            // ç·´ç¿’æ¨¡å¼ä¹Ÿæ˜¯èµ°é€™è£¡
            if (stimulus === "star" && keyInput === "F") isCorrect = true;
            else if (stimulus === "sun" && keyInput === "J") isCorrect = true;
          } else {
            if (stimulus === "sun" && keyInput === "J") isCorrect = true;
            else isCorrect = false;
          }

          this.triggerFeedback(isCorrect);
          this.recordResult(isCorrect, reactionTime, keyInput);

          setTimeout(() => this.nextTrial(), 800);
        },

        handleTimeout: function () {
          this.state.responded = true;
          const stimulus = this.state.currentStimulus;
          let isCorrect = false;

          if (this.state.currentRound === 1) {
            isCorrect = false;
          } else {
            if (stimulus === "star") isCorrect = true;
            else isCorrect = false;
          }

          if (isCorrect) this.triggerFeedback(true);
          else this.triggerFeedback(false);

          this.recordResult(isCorrect, 0, "none");
          setTimeout(() => this.nextTrial(), 800);
        },

        triggerFeedback: function (isSuccess) {
          this.elements.container.classList.remove(
            "feedback-success",
            "feedback-error"
          );
          this.elements.stimulus.classList.remove(
            "correct-flash",
            "error-flash"
          );
          void this.elements.container.offsetWidth;

          if (isSuccess) {
            this.elements.container.classList.add("feedback-success");
            this.elements.stimulus.classList.add("correct-flash");
          } else {
            this.elements.container.classList.add("feedback-error");
            this.elements.stimulus.classList.add("error-flash");
          }
        },

        recordResult: function (isCorrect, rt, inputKey) {
          if (isCorrect) {
            this.state.score++;
            const scoreEl = document.getElementById("scoreDisplay");
            if (scoreEl) {
              scoreEl.style.transform = "scale(1.3)";
              scoreEl.style.color = "#2ecc71";
              setTimeout(() => {
                scoreEl.style.transform = "scale(1)";
              }, 300);
            }
          }

          // [é‡è¦] å¦‚æœæ˜¯ç·´ç¿’æ¨¡å¼ï¼Œä¸è¦æŠŠè³‡æ–™å­˜åˆ° results (æˆ–å¯ä»¥å­˜ä½†ä¸åŒ¯å‡º)
          // é€™è£¡é¸æ“‡ä¸å­˜å…¥ï¼Œé¿å…å½±éŸ¿æœ€å¾Œçµ±è¨ˆ
          if (!this.state.isPractice) {
            this.state.results.push({
              round: this.state.currentRound,
              trial: this.state.currentTrial,
              stimulus: this.state.currentStimulus,
              input: inputKey,
              correct: isCorrect ? "yes" : "no",
              rt: rt,
            });
          }
        },

        endSession: function () {
          this.state.isPlaying = false;

          // [æ–°å¢] åˆ¤æ–·æ˜¯å¦ç‚ºç·´ç¿’çµæŸ
          if (this.state.isPractice) {
            this.showScreen("practiceEnd");
          } else if (this.state.currentRound === 1) {
            this.showScreen("intermission");
          } else {
            this.showFinalResult();
          }
        },

        showFinalResult: function () {
          this.showScreen("result");
          const totalCorrect = this.state.results.filter(
            (r) => r.correct === "yes"
          ).length;
          const validTrials = this.state.results.filter(
            (r) => r.input === "J" && r.correct === "yes"
          );
          const avgRT =
            validTrials.length > 0
              ? Math.round(
                  validTrials.reduce((sum, r) => sum + r.rt, 0) /
                    validTrials.length
                )
              : 0;

          this.elements.scoreDisplay.innerText = totalCorrect;
          this.elements.avgTimeDisplay.innerText = avgRT + "ms";
        },

        updateUI: function () {
          this.elements.trialDisplay.innerText = this.state.currentTrial;
          const progressBar = document.getElementById("progressBar");
          if (progressBar) {
            const progress =
              (this.state.currentTrial / this.state.totalTrials) * 100;
            progressBar.style.width = progress + "%";
            if (progress < 30) progressBar.style.background = "#3498db";
            else if (progress < 70) progressBar.style.background = "#f39c12";
            else progressBar.style.background = "#2ecc71";
          }
        },

        showScreen: function (name) {
          Object.values(this.elements.screens).forEach((el) =>
            el.classList.add("hidden")
          );
          this.elements.screens[name].classList.remove("hidden");
        },

        exportData: function () {
          let csv =
            "data:text/csv;charset=utf-8,Round,Trial,Stimulus,InputKey,Correct,RT(ms)\n";
          this.state.results.forEach((r) => {
            csv += `${r.round},${r.trial},${r.stimulus},${r.input},${r.correct},${r.rt}\n`;
          });
          const encodedUri = encodeURI(csv);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "ef_training_data.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },
      };

      document.addEventListener("keydown", function (event) {
        if (!game.state.isPlaying) return;
        const key = event.key.toUpperCase();
        if (key === "J" || key === "F") {
          game.handleInput(key);
        }
      });
    </script>
  </body>
</html>
