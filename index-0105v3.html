<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>åŸ·è¡ŒåŠŸèƒ½èªçŸ¥è¨“ç·´ - ä¸­åŸå¤§å­¸ç‰¹æ•™ç³»ç ”ç©¶å·¥å…·</title>

    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;"
    />

    <style>
      /* [è‰¯å¥½å¯¦è¸ï¼šCSS è®Šæ•¸ (CSS Variables)]
          ä¾†æºï¼šç¨‹å¼ç¢¼è‰¯å¥½å¯¦è¸å®Œæ•´æŒ‡å—.md ç¬¬ 3.1 ç«  (DRY åŸå‰‡)
          ç”¨é€”ï¼šå°‡é¡è‰²å®šç¾©åœ¨æ ¹ç›®éŒ„ï¼Œæœªä¾†è¦æ”¹é¡è‰²åªè¦æ”¹é€™è£¡ï¼Œä¸ç”¨å…¨æª”æ¡ˆæœå°‹å–ä»£ã€‚
        */
      :root {
        --bg-color: #2c3e50; /* æ·±è—èƒŒæ™¯ */
        --text-color: #ecf0f1; /* æ·ºè‰²æ–‡å­— */
        --primary-color: #3498db; /* ä¸»è¦æŒ‰éˆ•è— */
        --success-color: #2ecc71; /* æˆåŠŸç¶  */
        --error-color: #e74c3c; /* éŒ¯èª¤ç´… */
        --accent-yellow: #f1c40f; /* å¼·èª¿é»ƒ */
        --round1-color: #e67e22; /* ç¬¬ä¸€å›è­˜åˆ¥è‰² */
        --round2-color: #9b59b6; /* ç¬¬äºŒå›è­˜åˆ¥è‰² */
      }

      body {
        font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        text-align: center;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        /* é˜²æ­¢æ‰‹æ©Ÿæ“ä½œæ™‚æ„å¤–é›™æ“Šç¸®æ”¾ */
        touch-action: manipulation;
      }

      /* [å®‰å…¨æ€§è¨­è¨ˆï¼šé¦–é è³‡è¨Šå€å¡Š]
           é€™åŸæœ¬ä¸åœ¨éŠæˆ²éœ€æ±‚å…§ï¼Œä½†ç‚ºäº†é¿å…è¢« Google èª¤åˆ¤ï¼Œ
           æˆ‘å€‘éœ€è¦ä¸€å€‹æ¸…æ¥šé¡¯ç¤ºã€Œèº«åˆ†ã€èˆ‡ã€Œç”¨é€”ã€çš„å€å¡Šã€‚
        */
      .landing-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 15px;
        max-width: 600px;
        margin-bottom: 20px;
        text-align: left;
        border-left: 5px solid var(--primary-color);
      }

      .landing-info h3 {
        margin-top: 0;
        color: var(--primary-color);
      }
      .landing-info p {
        line-height: 1.6;
        opacity: 0.9;
      }

      /* --- éŠæˆ²èªªæ˜åœ–è§£å€å¡Š (å·¦å³å°æ‡‰ç‰ˆ) --- */
      .tutorial-container {
        display: flex;
        flex-direction: row; /* æ©«å‘æ’åˆ— */
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        width: 100%;
      }

      .rule-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        border: 2px solid rgba(255, 255, 255, 0.1);
      }

      /* [ä¿®æ”¹æ•™å­¸] é€™è£¡æ§åˆ¶å·¦é‚Šæ¡†æ¡† (æ˜Ÿæ˜Ÿ) çš„èƒŒæ™¯é¡è‰² */
      .rule-box.left-box {
        background: rgba(241, 196, 15, 0.4); /* ğŸ‘ˆ æ”¹æˆé»ƒè‰²ç³» */
        /* é»ƒè‰²èƒŒæ™¯ 
           æ•¸å€¼è§£é‡‹ï¼šrgba(ç´…è‰², ç¶ è‰², è—è‰², é€æ˜åº¦)
           å»ºè­°é€æ˜åº¦è¨­ç‚º 0.2 ~ 0.3ï¼Œé¿å…é¡è‰²å¤ªæ·±å½±éŸ¿æ–‡å­—é–±è®€ 
        */
      }

      /* [ä¿®æ”¹æ•™å­¸] é€™è£¡æ§åˆ¶å³é‚Šæ¡†æ¡† (å¤ªé™½) çš„èƒŒæ™¯é¡è‰² */
      .rule-box.right-box {
        background: rgba(243, 156, 18, 0.4); /* ğŸ‘ˆ æ”¹æˆæ©˜è‰²ç³» */
        /* æ©˜è‰²èƒŒæ™¯ 
           æ•¸å€¼è§£é‡‹ï¼šrgba(ç´…è‰², ç¶ è‰², è—è‰², é€æ˜åº¦)
           å»ºè­°é€æ˜åº¦è¨­ç‚º 0.2 ~ 0.3ï¼Œé¿å…é¡è‰²å¤ªæ·±å½±éŸ¿æ–‡å­—é–±è®€ 
        */
      }

      .rule-icon {
        font-size: 4em;
        margin-bottom: 10px;
      }
      .rule-arrow {
        font-size: 2em;
        color: #bdc3c7;
        margin: 10px 0;
      }

      .rule-key {
        border: 3px solid #fff;
        border-radius: 10px;
        padding: 5px 20px;
        font-family: monospace;
        background: rgba(0, 0, 0, 0.3);
        font-size: 3.5em;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 5px;
      }

      .key-desc {
        font-size: 1.2em;
        opacity: 0.9;
      }

      /* --- éŠæˆ²ä¸»å€åŸŸ --- */
      .game-area {
        background-color: #34495e;
        border-radius: 15px;
        padding: 20px;
        width: 100%;
        max-width: 600px;
        margin: 20px auto;
        border: 5px solid transparent;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        height: 600px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }

      /* éšæ®µæ¨™ç±¤ */
      .round-label {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
        z-index: 10;
      }
      .round1-badge {
        background-color: var(--round1-color);
      }
      .round2-badge {
        background-color: var(--round2-color);
      }

      /* å‹•ç•«æ•ˆæœ */
      .feedback-success {
        animation: pulse-green 0.3s ease-out;
        border-color: var(--success-color) !important;
      }
      .feedback-error {
        animation: shake-red 0.2s ease-in-out;
        border-color: var(--error-color) !important;
      }

      @keyframes pulse-green {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 0 15px rgba(46, 204, 113, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
        }
      }
      @keyframes shake-red {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-15px);
        }
        75% {
          transform: translateX(15px);
        }
      }

      .stimulus {
        font-size: 150px;
        height: 200px;
        width: 200px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: transform 0.1s;
        margin: 0 auto;
      }
      .stimulus.pop {
        transform: scale(1.3);
      }

      /* é›™æŒ‰éˆ•æ§åˆ¶å€ */
      .controls-area {
        width: 100%;
        display: flex;
        justify-content: space-around;
        padding-bottom: 20px;
        gap: 20px;
      }

      /* é€²åº¦æ¢ */
      .progress-container {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        border-radius: 10px;
        transition: width 0.3s ease;
        width: 0%;
      }

      .btn-key {
        flex: 1;
        height: 100px;
        border: none;
        border-radius: 15px;
        font-size: 1.5em;
        color: white;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: transform 0.1s, opacity 0.3s;
        box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
      }
      .btn-key:active,
      .btn-key.active-key {
        transform: translateY(4px);
        box-shadow: none;
      }

      .btn-f {
        background-color: #f1c40f; /* æ”¹æˆé»ƒè‰² (å°æ‡‰æ˜Ÿæ˜Ÿ) */
        color: #2c3e50; /* å› ç‚ºé»ƒè‰²å¤ªäº®ï¼Œå»ºè­°æ–‡å­—æ”¹æ·±è‰²æ‰çœ‹å¾—æ¸…æ¥šï¼Œæˆ–è€…ç¶­æŒç™½è‰² */
      }
      .btn-j {
        background-color: #e67e22; /* æ”¹æˆæ·±æ©˜è‰² (å°æ‡‰å¤ªé™½) */
      }

      .btn-disabled {
        background-color: #7f8c8d;
        opacity: 0.3;
        pointer-events: none;
      }

      .key-hint {
        font-size: 0.6em;
        opacity: 0.8;
        margin-bottom: 5px;
      }

      /* === è¦–è¦ºå›é¥‹å‹•ç•« === */
      @keyframes pulse-correct {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
          filter: brightness(1.5);
        }
        100% {
          transform: scale(1);
        }
      }

      @keyframes shake-error {
        0%,
        100% {
          transform: translateX(0) rotate(0deg);
        }
        25% {
          transform: translateX(-10px) rotate(-5deg);
        }
        75% {
          transform: translateX(10px) rotate(5deg);
        }
      }

      @keyframes progress-fill {
        from {
          width: 0%;
        }
        to {
          width: var(--progress-width);
        }
      }

      .correct-flash {
        animation: pulse-correct 0.5s ease-out;
        filter: drop-shadow(0 0 20px #2ecc71);
      }

      .error-flash {
        animation: shake-error 0.4s ease-in-out;
        filter: drop-shadow(0 0 20px #e74c3c);
      }

      /* é€šç”¨å·¥å…·é¡åˆ¥ */
      .hidden {
        display: none !important;
      }

      .screen-layer {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 25px;
        font-size: 1.2em;
        border-radius: 50px;
        cursor: pointer;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>ğŸ§  åŸ·è¡ŒåŠŸèƒ½èªçŸ¥è¨“ç·´</h1>
      <p style="opacity: 0.7">ä¸­åŸå¤§å­¸ç‰¹æ®Šæ•™è‚²å­¸ç³» | å­¸è¡“ç ”ç©¶å·¥å…· v2.4</p>
    </header>

    <main class="game-area" id="gameContainer">
      <div id="landingPage" class="screen-layer">
        <div class="landing-info">
          <h3>ğŸ« é—œæ–¼æœ¬ç ”ç©¶å·¥å…·</h3>
          <p>
            æœ¬å·¥å…·ç”±ä¸­åŸå¤§å­¸ç‰¹æ®Šæ•™è‚²å­¸ç³»é–‹ç™¼ï¼Œæ—¨åœ¨å”åŠ©è½éšœå­¸ç«¥é€²è¡Œã€ŒåŸ·è¡ŒåŠŸèƒ½ï¼ˆExecutive
            Functionï¼‰ã€çš„è¨“ç·´èˆ‡è©•ä¼°ã€‚
          </p>
          <hr
            style="
              border: 0;
              border-top: 1px solid rgba(255, 255, 255, 0.2);
              margin: 15px 0;
            "
          />
          <p><strong>ğŸ”’ éš±ç§æ¬Šè²æ˜ï¼š</strong></p>
          <p>
            æœ¬æ¸¬é©—ç‚ºç´”å‰ç«¯é‹ä½œï¼Œæ‚¨çš„åæ‡‰æ™‚é–“èˆ‡æ­£ç¢ºç‡æ•¸æ“š<b>åƒ…æš«å­˜æ–¼ç€è¦½å™¨ä¸­</b>ï¼Œæˆ‘å€‘ä¸æœƒå°‡ä»»ä½•å€‹äººè³‡æ–™ä¸Šå‚³è‡³ä¼ºæœå™¨ã€‚
          </p>
        </div>

        <button class="btn" onclick="game.showTutorial()">
          ğŸ‘‰ é€²å…¥æ¸¬é©—èªªæ˜
        </button>
        <br />
        <small
          ><a href="privacy.html" style="color: #bdc3c7"
            >è©³ç´°éš±ç§æ¬Šæ”¿ç­–</a
          ></small
        >
      </div>

      <div id="introScreen" class="screen-layer hidden">
        <h2>ç¬¬ä¸€å›ï¼šè¾¨è­˜ç·´ç¿’</h2>
        <p style="margin-bottom: 20px; color: #bdc3c7">
          çœ‹ â­ æŒ‰å·¦é‚ŠFéµï¼Œçœ‹ â˜€ï¸ æŒ‰å³é‚ŠJéµ
        </p>

        <div class="tutorial-container">
          <div class="rule-box left-box">
            <span class="rule-icon">â­</span>
            <span class="rule-arrow">â¬‡</span>
            <span class="rule-key">F</span>
            <span class="key-desc">å·¦æ‰‹</span>
          </div>

          <div class="rule-box right-box">
            <span class="rule-icon">â˜€ï¸</span>
            <span class="rule-arrow">â¬‡</span>
            <span class="rule-key">J</span>
            <span class="key-desc">å³æ‰‹</span>
          </div>
        </div>

        <button class="btn" onclick="game.startRound1()">ğŸš€ é–‹å§‹ç¬¬ä¸€å›</button>
      </div>

      <div id="intermissionScreen" class="screen-layer hidden">
        <h2 style="color: var(--round2-color)">âš ï¸ è¦å‰‡æ”¹è®Šäº†ï¼</h2>

        <div class="tutorial-container">
          <div class="rule-box left-box" style="opacity: 0.8">
            <span class="rule-icon">â­</span>
            <span class="rule-arrow">â¬‡</span>
            <span class="rule-icon" style="font-size: 3em">ğŸ›‘</span>
            <span
              class="key-desc"
              style="color: var(--error-color); font-weight: bold"
              >ä¸è¦æŒ‰ï¼</span
            >
          </div>

          <div class="rule-box right-box">
            <span class="rule-icon">â˜€ï¸</span>
            <span class="rule-arrow">â¬‡</span>
            <span class="rule-key">J</span>
            <span class="key-desc">è¦æŒ‰ï¼</span>
          </div>
        </div>

        <button class="btn" onclick="game.startRound2()">ğŸš€ é–‹å§‹ç¬¬äºŒå›</button>
      </div>

      <div
        id="playScreen"
        class="hidden"
        style="
          width: 100%;
          height: 100%;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
        "
      >
        <div style="width: 100%">
          <div id="roundLabel" class="round-label round1-badge">ç¬¬ä¸€å›</div>
          <div
            style="
              margin-top: 25px;
              display: flex;
              justify-content: space-between;
            "
          >
            <span
              >é€²åº¦: <span id="currentTrialDisplay">0</span>/<span
                id="totalTrialDisplay"
                >10</span
              ></span
            >
          </div>

          <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
        </div>

        <div id="stimulusBox" class="stimulus"></div>

        <div class="controls-area">
          <button
            id="btnF"
            class="btn-key btn-f"
            onpointerdown="game.handleInput('F')"
          >
            <span class="key-hint">Keyboard F</span>
            â­
          </button>
          <button
            id="btnJ"
            class="btn-key btn-j"
            onpointerdown="game.handleInput('J')"
          >
            <span class="key-hint">Keyboard J</span>
            â˜€ï¸
          </button>
        </div>
      </div>

      <div id="resultScreen" class="screen-layer hidden">
        <h2>ğŸ‰ å…¨éƒ¨å®Œæˆï¼</h2>
        <div
          style="
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            width: 100%;
          "
        >
          <p>
            ç­”å°é¡Œæ•¸ï¼š<span
              id="scoreDisplay"
              style="color: var(--success-color); font-size: 1.5em"
              >0</span
            >
          </p>
          <p>å¹³å‡é€Ÿåº¦ï¼š<span id="avgTimeDisplay">0ms</span></p>
        </div>
        <button class="btn" onclick="location.reload()">ğŸ”„ å›åˆ°é¦–é </button>
        <button
          class="btn"
          onclick="game.exportData()"
          style="background-color: #7f8c8d"
        >
          ğŸ“¥ åŒ¯å‡ºè³‡æ–™
        </button>
      </div>
    </main>

    <script>
      /**
       * [è‰¯å¥½å¯¦è¸ï¼šé…ç½®è¨­å®š (Configuration)]
       * ä¾†æºï¼šç¨‹å¼ç¢¼è‰¯å¥½å¯¦è¸å®Œæ•´æŒ‡å—.md ç¬¬ 1.3 ç« 
       * é¿å…åœ¨ç¨‹å¼ç¢¼ä¸­ä½¿ç”¨ã€ŒMagic Numbersã€ï¼ˆä¸æ˜æ„ç¾©çš„æ•¸å­—ï¼‰ã€‚
       * å°‡æ‰€æœ‰åƒæ•¸é›†ä¸­åœ¨é€™è£¡ï¼Œæ–¹ä¾¿æœªä¾†èª¿æ•´é¡Œæ•¸æˆ–æ™‚é–“ã€‚
       */
      const CONFIG = {
        round1Trials: 5, // ç¬¬ä¸€å›é¡Œæ•¸
        round2Trials: 10, // ç¬¬äºŒå›é¡Œæ•¸
        stimulusDuration: 1500, // åˆºæ¿€é¡¯ç¤ºå¤šä¹… (æ¯«ç§’)
        isiMin: 800, // æœ€å°é–“éš”æ™‚é–“
        isiMax: 1200, // æœ€å¤§é–“éš”æ™‚é–“
        goRatio: 0.5, // åˆºæ¿€å‡ºç¾æ©Ÿç‡
      };

      /**
       * [è‰¯å¥½å¯¦è¸ï¼šå–®ä¸€è·è²¬åŸå‰‡ (SRP)]
       * ä¾†æºï¼šç¨‹å¼ç¢¼è‰¯å¥½å¯¦è¸å®Œæ•´æŒ‡å—.md ç¬¬ 2.1 ç« 
       * æˆ‘å€‘å°‡éŠæˆ²çš„æ‰€æœ‰é‚è¼¯å°è£åœ¨ 'game' é€™å€‹ç‰©ä»¶ä¸­ã€‚
       * é€™æ¨£å…¨åŸŸè®Šæ•¸åªæœ‰ä¸€å€‹ 'game'ï¼Œé¿å…è®Šæ•¸åç¨±è¡çªã€‚
       */
      const game = {
        // [ç‹€æ…‹ç®¡ç†]ï¼šé›†ä¸­ç®¡ç†è®Šå‹•çš„è³‡æ–™
        state: {
          currentRound: 1,
          currentTrial: 0,
          totalTrials: 0,
          score: 0,
          results: [],
          isPlaying: false,
          currentStimulus: null,
          startTime: 0,
          responded: false,
          timer: null,
        },

        // [DOM å…ƒç´ å¿«å–]ï¼šé¿å…é‡è¤‡æŸ¥è©¢ DOMï¼Œæå‡æ•ˆèƒ½
        elements: {
          container: document.getElementById("gameContainer"),
          screens: {
            landing: document.getElementById("landingPage"), // æ–°å¢é¦–é 
            intro: document.getElementById("introScreen"),
            intermission: document.getElementById("intermissionScreen"),
            play: document.getElementById("playScreen"),
            result: document.getElementById("resultScreen"),
          },
          stimulus: document.getElementById("stimulusBox"),
          btnF: document.getElementById("btnF"),
          btnJ: document.getElementById("btnJ"),
          roundLabel: document.getElementById("roundLabel"),
          trialDisplay: document.getElementById("currentTrialDisplay"),
          totalDisplay: document.getElementById("totalTrialDisplay"),
          scoreDisplay: document.getElementById("scoreDisplay"),
          avgTimeDisplay: document.getElementById("avgTimeDisplay"),
        },

        /**
         * [åŠŸèƒ½] å¾é¦–é åˆ‡æ›åˆ°æ•™å­¸é é¢
         */
        showTutorial: function () {
          this.showScreen("intro");
        },

        /**
         * [åŠŸèƒ½] é–‹å§‹ç¬¬ä¸€å›
         * è¨­å®šï¼šè¾¨è­˜ä»»å‹™ (XæŒ‰Fï¼Œæ˜ŸæŒ‰J)
         */
        startRound1: function () {
          this.state.currentRound = 1;
          this.state.totalTrials = CONFIG.round1Trials;
          this.state.results = [];

          // UI æ›´æ–°
          this.elements.roundLabel.innerText = "ç¬¬ä¸€å›ï¼šè¾¨è­˜";
          this.elements.roundLabel.className = "round-label round1-badge";

          // å•Ÿç”¨ F éµ (ç¬¬ä¸€å› F éµæ˜¯æœ‰æ•ˆçš„)
          this.elements.btnF.classList.remove("btn-disabled");
          this.elements.btnF.innerHTML =
            '<span class="key-hint">Keyboard F</span>â­';

          this.initGameSession();
        },

        /**
         * [åŠŸèƒ½] é–‹å§‹ç¬¬äºŒå›
         * è¨­å®šï¼šæŠ‘åˆ¶ä»»å‹™ (Xä¸èƒ½æŒ‰ï¼Œæ˜ŸæŒ‰J)
         */
        startRound2: function () {
          this.state.currentRound = 2;
          this.state.totalTrials = CONFIG.round2Trials;

          // UI æ›´æ–°
          this.elements.roundLabel.innerText = "ç¬¬äºŒå›ï¼šæŠ‘åˆ¶";
          this.elements.roundLabel.className = "round-label round2-badge";

          // ç¦ç”¨ F éµ (ç¬¬äºŒå› F éµä»£è¡¨æŠ‘åˆ¶ï¼Œä¸èƒ½æŒ‰)
          this.elements.btnF.classList.add("btn-disabled");
          this.elements.btnF.innerHTML = '<span class="key-hint">â­</span>å¿ä½';

          this.initGameSession();
        },

        /**
         * [è‰¯å¥½å¯¦è¸ï¼šDRY åŸå‰‡]
         * å› ç‚ºç¬¬ä¸€å›å’Œç¬¬äºŒå›çš„ã€Œåˆå§‹åŒ–æµç¨‹ã€å¾ˆåƒï¼Œ
         * æˆ‘å€‘æå–å‡ºå…±ç”¨çš„å‡½å¼ initGameSessionï¼Œé¿å…å¯«é‡è¤‡çš„ç¨‹å¼ç¢¼ã€‚
         */
        initGameSession: function () {
          this.state.currentTrial = 0;
          this.state.score = 0;
          this.state.isPlaying = true;
          this.elements.totalDisplay.innerText = this.state.totalTrials;
          this.showScreen("play");
          this.nextTrial();
        },

        /**
         * [åŠŸèƒ½] é€²å…¥ä¸‹ä¸€é¡Œ
         */
        nextTrial: function () {
          // æª¢æŸ¥æ˜¯å¦çµæŸ
          if (this.state.currentTrial >= this.state.totalTrials) {
            this.endSession();
            return;
          }

          this.state.currentTrial++;
          this.updateUI();

          // æ¸…é™¤ä¸Šä¸€é¡Œçš„ç•«é¢
          this.elements.stimulus.innerText = "";
          this.elements.container.className = "game-area";
          this.elements.stimulus.classList.remove("pop");
          this.state.responded = false;

          // éš¨æ©Ÿç­‰å¾…æ™‚é–“
          const delay =
            Math.floor(Math.random() * (CONFIG.isiMax - CONFIG.isiMin + 1)) +
            CONFIG.isiMin;

          setTimeout(() => this.showStimulus(), delay);
        },

        /**
         * [åŠŸèƒ½] é¡¯ç¤ºåˆºæ¿€ç‰© (æ˜Ÿæ˜Ÿæˆ–å‰å‰)
         */
        showStimulus: function () {
          const isStar = Math.random() < CONFIG.goRatio;
          this.state.currentStimulus = isStar ? "sun" : "star"; // âœ… æ”¹åç¨±

          if (isStar) {
            this.elements.stimulus.innerText = "â˜€ï¸";
            this.elements.stimulus.style.color = "#f39c12"; // æ©˜è‰²
          } else {
            this.elements.stimulus.innerText = "â­";
            this.elements.stimulus.style.color = "#f1c40f"; // é»ƒè‰²
          }

          this.state.startTime = Date.now();

          // è¨­å®šè¨ˆæ™‚å™¨ï¼Œå¦‚æœæ™‚é–“åˆ°é‚„æ²’æŒ‰ï¼Œå°±è§¸ç™¼ handleTimeout
          this.state.timer = setTimeout(() => {
            if (!this.state.responded) {
              this.handleTimeout();
            }
          }, CONFIG.stimulusDuration);
        },

        /**
         * [åŠŸèƒ½] è™•ç†æŒ‰éµè¼¸å…¥
         * @param {string} keyInput - æŒ‰ä¸‹çš„æ˜¯ 'J' é‚„æ˜¯ 'F'
         */
        handleInput: function (keyInput) {
          if (
            !this.state.isPlaying ||
            this.state.responded ||
            !this.elements.stimulus.innerText
          )
            return;

          this.state.responded = true;
          clearTimeout(this.state.timer);

          // è¦–è¦ºå›é¥‹ï¼šè®“æŒ‰éˆ•å¾€ä¸‹æ²‰ä¸€ä¸‹
          const btn =
            keyInput === "J" ? this.elements.btnJ : this.elements.btnF;
          btn.classList.add("active-key");
          setTimeout(() => btn.classList.remove("active-key"), 100);

          const reactionTime = Date.now() - this.state.startTime;
          const stimulus = this.state.currentStimulus;
          let isCorrect = false;

          // [æ ¸å¿ƒé‚è¼¯]// [æ ¸å¿ƒé‚è¼¯ä¿®æ­£] é…åˆæ–°çš„ç¬¦è™Ÿï¼šsun(å¤ªé™½) èˆ‡ star(æ˜Ÿæ˜Ÿ)
          if (this.state.currentRound === 1) {
            // ç¬¬ä¸€å›ï¼šå®Œå…¨å°æ‡‰ è¾¨è­˜ç·´ç¿’ (â­->F, â˜€ï¸->J)
            // è¦å‰‡ï¼šçœ‹ â­ æŒ‰ Fï¼Œçœ‹ â˜€ï¸ æŒ‰ J
            if (stimulus === "star" && keyInput === "F") isCorrect = true;
            else if (stimulus === "sun" && keyInput === "J") isCorrect = true;
          } else {
            // ç¬¬äºŒå›ï¼šæŠ‘åˆ¶ä»»å‹™ (â˜€ï¸->J, â­->ä¸èƒ½æŒ‰)
            // è¦å‰‡ï¼šçœ‹ â˜€ï¸ (è¦æŒ‰) æŒ‰ Jï¼Œçœ‹ â­ (ä¸è¦æŒ‰)
            if (stimulus === "sun" && keyInput === "J") isCorrect = true;
            else isCorrect = false; // çœ‹åˆ°æ˜Ÿæ˜ŸæŒ‰éµå°±æ˜¯éŒ¯
          }

          this.triggerFeedback(isCorrect);
          this.recordResult(isCorrect, reactionTime, keyInput);

          // çŸ­æš«å»¶é²å¾Œé€²å…¥ä¸‹ä¸€é¡Œ
          setTimeout(() => this.nextTrial(), 800);
        },

        /**
         * [åŠŸèƒ½] è™•ç†è¶…æ™‚ (ä½¿ç”¨è€…æ²’æœ‰åæ‡‰)
         */
        handleTimeout: function () {
          this.state.responded = true;
          const stimulus = this.state.currentStimulus;
          let isCorrect = false;

          if (this.state.currentRound === 1) {
            // ç¬¬ä¸€å›ï¼šéƒ½è¦æŒ‰ï¼Œæ²’æŒ‰å°±æ˜¯éŒ¯
            isCorrect = false;
          } else {
            // ç¬¬äºŒå›ï¼šçœ‹åˆ°â­æ²’æŒ‰ = æ­£ç¢ºæŠ‘åˆ¶ (Correct Rejection)
            // è¦å‰‡ï¼šçœ‹ â­ (ä¸è¦æŒ‰) æ²’æŒ‰ = æ­£ç¢º
            if (stimulus === "star") isCorrect = true;
            else isCorrect = false; // çœ‹åˆ°â˜€ï¸æ²’æŒ‰ = æ¼æŒ‰ (Miss)
          }

          // æ ¹æ“šå°éŒ¯çµ¦äºˆå›é¥‹
          if (isCorrect) this.triggerFeedback(true);
          else this.triggerFeedback(false);

          this.recordResult(isCorrect, 0, "none");
          setTimeout(() => this.nextTrial(), 800);
        },

        /**
         * [åŠŸèƒ½] è§¸ç™¼è¦–è¦ºå›é¥‹ (å‹•ç•«)
         */
        triggerFeedback: function (isSuccess) {
          // é‡ç½®å‹•ç•« classï¼Œç¢ºä¿æ¯æ¬¡éƒ½èƒ½è§¸ç™¼ // ç§»é™¤èˆŠå‹•ç•«
          this.elements.container.classList.remove(
            "feedback-success",
            "feedback-error"
          );
          this.elements.stimulus.classList.remove(
            "correct-flash",
            "error-flash"
          );

          void this.elements.container.offsetWidth; // å¼·åˆ¶é‡ç¹ª

          if (isSuccess) {
            this.elements.container.classList.add("feedback-success");
            this.elements.stimulus.classList.add("correct-flash");
          } else {
            this.elements.container.classList.add("feedback-error");
            this.elements.stimulus.classList.add("error-flash");
          }
        },

        /**
         * [åŠŸèƒ½] è¨˜éŒ„æ•¸æ“š
         */
        recordResult: function (isCorrect, rt, inputKey) {
          if (isCorrect) {
            // [ä¿®å¾©ï¼šèªæ³•éŒ¯èª¤] è£œä¸Šäº†é€™è£¡éºå¤±çš„ "{"
            this.state.score++;

            // åˆ†æ•¸å¢åŠ å‹•ç•«
            const scoreEl = document.getElementById("scoreDisplay");
            if (scoreEl) {
              scoreEl.style.transform = "scale(1.3)";
              scoreEl.style.color = "#2ecc71";
              setTimeout(() => {
                scoreEl.style.transform = "scale(1)";
              }, 300);
            }
          } // if (isCorrect) çµæŸ

          this.state.results.push({
            round: this.state.currentRound,
            trial: this.state.currentTrial,
            stimulus: this.state.currentStimulus,
            input: inputKey,
            correct: isCorrect ? "yes" : "no",
            rt: rt,
          });
        },

        /**
         * [åŠŸèƒ½] çµæŸå›åˆ
         */
        endSession: function () {
          this.state.isPlaying = false;
          if (this.state.currentRound === 1) {
            // ç¬¬ä¸€å›çµæŸ -> é¡¯ç¤ºä¸­å ´ç•«é¢
            this.showScreen("intermission");
          } else {
            // ç¬¬äºŒå›çµæŸ -> é¡¯ç¤ºæˆç¸¾
            this.showFinalResult();
          }
        },

        /**
         * [åŠŸèƒ½] é¡¯ç¤ºæœ€çµ‚æˆç¸¾
         */
        showFinalResult: function () {
          this.showScreen("result");
          const totalCorrect = this.state.results.filter(
            (r) => r.correct === "yes"
          ).length;

          // è¨ˆç®—å¹³å‡åæ‡‰æ™‚é–“ (åªç®—æŒ‰å°çš„ J éµ)
          const validTrials = this.state.results.filter(
            (r) => r.input === "J" && r.correct === "yes"
          );
          const avgRT =
            validTrials.length > 0
              ? Math.round(
                  validTrials.reduce((sum, r) => sum + r.rt, 0) /
                    validTrials.length
                )
              : 0;

          this.elements.scoreDisplay.innerText = totalCorrect;
          this.elements.avgTimeDisplay.innerText = avgRT + "ms";
        },

        updateUI: function () {
          this.elements.trialDisplay.innerText = this.state.currentTrial;

          // é€²åº¦æ¢æ›´æ–°
          const progressBar = document.getElementById("progressBar");
          if (progressBar) {
            const progress =
              (this.state.currentTrial / this.state.totalTrials) * 100;
            progressBar.style.width = progress + "%";

            // é¡è‰²è®ŠåŒ–
            if (progress < 30) {
              progressBar.style.background = "#3498db";
            } else if (progress < 70) {
              progressBar.style.background = "#f39c12";
            } else {
              progressBar.style.background = "#2ecc71";
            }
          }
        },

        /**
         * [åŠŸèƒ½] åˆ‡æ›é¡¯ç¤ºçš„ç•«é¢ (Screen Manager)
         */
        showScreen: function (name) {
          // éš±è—æ‰€æœ‰ç•«é¢
          Object.values(this.elements.screens).forEach((el) =>
            el.classList.add("hidden")
          );
          // é¡¯ç¤ºæŒ‡å®šç•«é¢
          this.elements.screens[name].classList.remove("hidden");
        },

        /**
         * [åŠŸèƒ½] åŒ¯å‡º CSV
         * [å®‰å…¨æ€§å‚™è¨»] é€™æ˜¯ç´”å‰ç«¯ç”¢ç”Ÿæª”æ¡ˆï¼Œæ²’æœ‰ä¼ºæœå™¨äº’å‹•ï¼Œéš±ç§å®‰å…¨é«˜ã€‚
         */
        exportData: function () {
          let csv =
            "data:text/csv;charset=utf-8,Round,Trial,Stimulus,InputKey,Correct,RT(ms)\n";
          this.state.results.forEach((r) => {
            csv += `${r.round},${r.trial},${r.stimulus},${r.input},${r.correct},${r.rt}\n`;
          });
          const encodedUri = encodeURI(csv);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "ef_training_data.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },
      };

      /**
       * [è‰¯å¥½å¯¦è¸ï¼šäº‹ä»¶ç›£è½åˆ†é›¢]
       * ä¾†æºï¼šç¨‹å¼ç¢¼è‰¯å¥½å¯¦è¸å®Œæ•´æŒ‡å—.md ç¬¬ 2 ç« 
       * å°‡ä½¿ç”¨è€…è¼¸å…¥äº‹ä»¶ (keydown) èˆ‡éŠæˆ²é‚è¼¯åˆ†é–‹ã€‚
       */
      document.addEventListener("keydown", function (event) {
        if (!game.state.isPlaying) return;
        const key = event.key.toUpperCase();
        if (key === "J" || key === "F") {
          game.handleInput(key);
        }
      });
    </script>
  </body>
</html>
