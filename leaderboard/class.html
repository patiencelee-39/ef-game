<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app"
    />
    <title>ç­ç´šæ’è¡Œæ¦œ - åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ²</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/components/ranking.css" />
    <link rel="stylesheet" href="../css/components/csv-report.css" />
    <link rel="stylesheet" href="../css/components/landscape-hint.css" />
    <style>
      .class-page {
        max-width: 1100px;
        margin: 0 auto;
        padding: 1.5rem;
        min-height: 100vh;
      }
      .class-header {
        text-align: center;
        margin-bottom: 1.5rem;
      }
      .class-header h1 {
        font-size: 2rem;
        margin: 0 0 0.3rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .class-header .subtitle {
        color: #888;
        font-size: 0.9rem;
      }
      .board-name-display {
        font-size: 1.1rem;
        font-weight: 700;
        color: #333;
        margin-top: 0.5rem;
      }

      /* Tab */
      .mode-tabs {
        display: flex;
        justify-content: center;
        gap: 0;
        margin-bottom: 1.5rem;
      }
      .mode-tab {
        padding: 0.75rem 2rem;
        border: 2px solid #ddd;
        background: #fff;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s;
        user-select: none;
      }
      .mode-tab:first-child {
        border-radius: 10px 0 0 10px;
      }
      .mode-tab:last-child {
        border-radius: 0 10px 10px 0;
      }
      .mode-tab.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border-color: #667eea;
      }
      .mode-tab:hover:not(.active) {
        background: #f0f0f0;
      }

      .panel {
        display: none;
      }
      .panel.active {
        display: block;
      }

      /* Setup */
      .board-setup {
        max-width: 600px;
        margin: 0 auto 2rem;
      }
      .setup-card {
        background: #fff;
        border-radius: 14px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
      }
      .setup-card h3 {
        margin: 0 0 1rem;
        font-size: 1.1rem;
        color: #333;
      }
      .setup-card .input-row {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .setup-card input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.2s;
      }
      .setup-card input:focus {
        border-color: #667eea;
      }
      .btn {
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
      }
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      .btn-secondary {
        background: #f0f0f0;
        color: #333;
      }
      .btn-secondary:hover {
        background: #e0e0e0;
      }
      .btn-danger {
        background: #f44336;
        color: #fff;
      }
      .btn-danger:hover {
        background: #d32f2f;
      }

      /* Share */
      .share-methods {
        display: none;
        background: #fff;
        border-radius: 14px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
      }
      .share-methods.visible {
        display: block;
      }
      .share-methods h3 {
        margin: 0 0 1rem;
        font-size: 1.1rem;
        text-align: center;
      }
      .share-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
      }
      @media (max-width: 700px) {
        .share-grid {
          grid-template-columns: 1fr;
        }
      }
      .share-item {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #eee;
      }
      .share-item__label {
        font-weight: 700;
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 0.75rem;
      }
      .share-item__code {
        font-size: 2rem;
        font-weight: 800;
        letter-spacing: 4px;
        color: #333;
        font-family: "Courier New", monospace;
        margin-bottom: 0.5rem;
        user-select: all;
      }
      .share-item__qr {
        margin: 0.5rem auto;
      }
      .share-item__qr canvas {
        border-radius: 8px;
      }
      .share-item__link {
        word-break: break-all;
        font-size: 0.78rem;
        color: #667eea;
        padding: 6px 10px;
        background: #eef;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        user-select: all;
      }
      .share-item .btn {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
      }

      /* My Boards */
      .board-list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: #fff;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: all 0.2s;
      }
      .board-list-item:hover {
        background: #f0f4ff;
        transform: translateX(2px);
      }
      .board-list-item__name {
        font-weight: 600;
        color: #333;
      }
      .board-list-item__code {
        font-family: monospace;
        color: #667eea;
        font-weight: 700;
        font-size: 0.9rem;
      }
      .board-list-item__meta {
        font-size: 0.78rem;
        color: #999;
      }

      /* Actions */
      .board-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        margin: 1.5rem 0;
        flex-wrap: wrap;
      }
      .board-actions .btn {
        font-size: 0.9rem;
        padding: 0.6rem 1.2rem;
      }
      .class-footer {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        flex-wrap: wrap;
      }
      .class-footer .btn {
        font-size: 0.9rem;
        padding: 0.6rem 1.2rem;
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 0.75rem 1.5rem;
        border-radius: 24px;
        font-size: 0.9rem;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }
      .toast.show {
        opacity: 1;
      }

      /* Import */
      .import-upload-zone {
        border: 2px dashed #ccc;
        border-radius: 14px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 1.5rem;
        background: #fafafa;
      }
      .import-upload-zone:hover,
      .import-upload-zone.dragover {
        border-color: #667eea;
        background: #f0f4ff;
      }
      .import-upload-zone p {
        margin: 0 0 0.5rem;
        font-size: 1rem;
        color: #555;
      }

      /* Delete rules */
      .delete-rules {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
        padding: 1rem 1.25rem;
        border-radius: 0 10px 10px 0;
        margin: 1.5rem 0;
        font-size: 0.85rem;
        line-height: 1.6;
        color: #555;
      }
      .delete-rules strong {
        color: #e65100;
      }
      .delete-rules ul {
        margin: 0.5rem 0 0 1.25rem;
        padding: 0;
      }
    </style>
    <link rel="stylesheet" href="../css/components/navbar.css" />
  </head>
  <body>
    <main class="class-page" id="main-content">
      <div class="class-header">
        <h1>ğŸ“‹ ç­ç´šæ’è¡Œæ¦œ</h1>
        <p class="subtitle">å³æ™‚æ”¶é›†å­¸ç”Ÿæˆç¸¾ æˆ– åŒ¯å…¥ CSV åˆ†æ</p>
        <div
          class="board-name-display"
          id="boardNameDisplay"
          style="display: none"
        ></div>
      </div>

      <div class="mode-tabs">
        <button class="mode-tab active" data-panel="live">ğŸ“¡ å³æ™‚æ¨¡å¼</button>
        <button class="mode-tab" data-panel="import">ğŸ“ åŒ¯å…¥æ¨¡å¼</button>
      </div>

      <!-- â•â•â• å³æ™‚æ¨¡å¼ â•â•â• -->
      <div class="panel active" id="panelLive">
        <div class="board-setup" id="boardSetup">
          <div class="setup-card">
            <h3>ğŸ« è€å¸«ï¼šå»ºç«‹æ–°çœ‹æ¿</h3>
            <div class="input-row">
              <input
                type="text"
                id="boardNameInput"
                placeholder="çœ‹æ¿åç¨±ï¼ˆå¦‚ï¼šä¸­ç­ç¬¬ä¸‰é€±ï¼‰"
                maxlength="50"
                aria-label="çœ‹æ¿åç¨±"
              />
              <button class="btn btn-primary" id="btnCreateBoard">å»ºç«‹</button>
            </div>
          </div>
          <div class="setup-card">
            <h3>ğŸ’ å­¸ç”Ÿï¼šè¼¸å…¥ä»£ç¢¼ä¸Šå‚³æˆç¸¾</h3>
            <div class="input-row">
              <input
                type="text"
                id="joinCodeInput"
                placeholder="è¼¸å…¥ 6 ä½ä»£ç¢¼"
                maxlength="6"
                aria-label="çœ‹æ¿ä»£ç¢¼"
                style="
                  text-transform: uppercase;
                  letter-spacing: 2px;
                  text-align: center;
                  font-weight: 700;
                "
              />
              <button class="btn btn-primary" id="btnJoinBoard">åŠ å…¥</button>
            </div>
          </div>
          <div class="my-boards" id="myBoardsSection" style="display: none">
            <h3 style="margin: 0 0 0.75rem; color: #555">ğŸ“‚ æˆ‘çš„çœ‹æ¿</h3>
            <div id="myBoardsList"></div>
          </div>
        </div>

        <div class="share-methods" id="shareMethods">
          <h3>ğŸ“¢ åˆ†äº«çµ¦å­¸ç”Ÿï¼ˆä¸‰ç¨®æ–¹å¼çš†å¯ï¼‰</h3>
          <div class="share-grid">
            <div class="share-item">
              <div class="share-item__label">ğŸ”¢ ä»£ç¢¼</div>
              <div class="share-item__code" id="shareCode">------</div>
              <button class="btn btn-secondary" onclick="copyCode()">
                ğŸ“‹ è¤‡è£½ä»£ç¢¼
              </button>
            </div>
            <div class="share-item">
              <div class="share-item__label">ğŸ“± QR Code</div>
              <div class="share-item__qr" id="shareQR"></div>
              <button class="btn btn-secondary" onclick="downloadQR()">
                ğŸ’¾ ä¸‹è¼‰ QR
              </button>
            </div>
            <div class="share-item">
              <div class="share-item__label">ğŸ”— å…±äº«é€£çµ</div>
              <div class="share-item__link" id="shareLink">â€”</div>
              <button class="btn btn-secondary" onclick="copyLink()">
                ğŸ“‹ è¤‡è£½é€£çµ
              </button>
            </div>
          </div>
        </div>

        <div id="liveStatsContainer" style="display: none"></div>
        <div id="liveRankingContainer">
          <div class="ranking-empty">
            <span class="ranking-empty__icon">ğŸ“¡</span>
            <p>å»ºç«‹æˆ–åŠ å…¥çœ‹æ¿å¾Œï¼Œæ’è¡Œæ¦œå°‡åœ¨æ­¤å³æ™‚æ›´æ–°</p>
          </div>
        </div>
        <div class="board-actions" id="boardActions" style="display: none">
          <button class="btn btn-secondary" onclick="exportBoardCSV()">
            ğŸ’¾ åŒ¯å‡º CSV
          </button>
          <button class="btn btn-secondary" onclick="exportBoardPDF()">
            ğŸ“„ åŒ¯å‡º PDF
          </button>
          <button class="btn btn-secondary" onclick="screenshotBoard()">
            ğŸ“¸ æˆªåœ–
          </button>
          <button class="btn btn-danger" onclick="deleteBoard()">
            ğŸ—‘ï¸ åˆªé™¤æ­¤çœ‹æ¿
          </button>
        </div>
        <div class="delete-rules" id="deleteRulesLive" style="display: none">
          <strong>â„¹ï¸ è³‡æ–™ç®¡ç†èªªæ˜</strong>
          <ul>
            <li>
              ç­ç´šæ’è¡Œæ¦œè³‡æ–™å„²å­˜åœ¨é›²ç«¯ï¼Œ<strong>è€å¸«ä¸åˆªé™¤å°±æœƒä¸€ç›´ä¿ç•™</strong>
            </li>
            <li>
              å­¸ç”Ÿå¯ä»¥é‡è¤‡ä¸Šå‚³ï¼Œ<strong>åŒä¸€ä½å­¸ç”Ÿçš„è³‡æ–™æœƒè¦†è“‹å‰ä¸€ç­†</strong>ï¼ˆä¿ç•™æœ€æ–°çš„ï¼‰
            </li>
            <li>åªæœ‰çœ‹æ¿å»ºç«‹è€…ï¼ˆè€å¸«ï¼‰å¯ä»¥åˆªé™¤æ•´å€‹çœ‹æ¿æˆ–å€‹åˆ¥è¨˜éŒ„</li>
            <li>åˆªé™¤å¾Œ<strong>ç„¡æ³•æ¢å¾©</strong>ï¼Œå»ºè­°å…ˆåŒ¯å‡º CSV å‚™ä»½</li>
          </ul>
        </div>
      </div>

      <!-- â•â•â• åŒ¯å…¥æ¨¡å¼ â•â•â• -->
      <div class="panel" id="panelImport">
        <div class="import-upload-zone" id="importUploadZone">
          <p>ğŸ“ æ‹–æ”¾ CSV æª”æ¡ˆåˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
          <small>æ”¯æ´ EFè¨“ç·´éŠæˆ²æ•¸æ“š_ID_æ—¥æœŸ_æ™‚é–“.csv æ ¼å¼ï¼Œå¯å¤šæª”ä¸Šå‚³</small>
          <input
            type="file"
            id="importFileInput"
            accept=".csv"
            multiple
            style="display: none"
            aria-label="é¸æ“‡ CSV æª”æ¡ˆ"
          />
        </div>
        <div id="importStatsContainer" style="display: none"></div>
        <div id="importRankingContainer">
          <div class="ranking-empty">
            <span class="ranking-empty__icon">ğŸ“</span>
            <p>åŒ¯å…¥ CSV æª”æ¡ˆå¾Œï¼Œæ’è¡Œæ¦œå°‡é¡¯ç¤ºåœ¨æ­¤</p>
          </div>
        </div>
        <div id="importReportContainer"></div>
        <div class="board-actions" id="importActions" style="display: none">
          <button class="btn btn-secondary" id="importBtnExport">
            ğŸ’¾ åŒ¯å‡º CSV
          </button>
          <button class="btn btn-secondary" id="importBtnPdf">
            ğŸ“„ åŒ¯å‡º PDF
          </button>
          <button class="btn btn-secondary" id="importBtnScreenshot">
            ğŸ“¸ æˆªåœ–
          </button>
          <button class="btn btn-secondary" id="importBtnClear">
            ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™
          </button>
        </div>
        <div class="delete-rules">
          <strong>â„¹ï¸ åŒ¯å…¥æ¨¡å¼èªªæ˜</strong>
          <ul>
            <li>
              åŒ¯å…¥çš„ CSV
              è³‡æ–™<strong>åƒ…å­˜åœ¨ç€è¦½å™¨è¨˜æ†¶é«”ä¸­</strong>ï¼Œé—œé–‰é é¢å³æ¶ˆå¤±
            </li>
            <li>
              é©åˆå­¸æœŸæœ«<strong>æ‰¹æ¬¡åŒ¯å…¥åˆ†æ</strong>ï¼Œä¸€æ¬¡è§€å¯Ÿæ‰€æœ‰å­¸ç”Ÿçš„å­¸ç¿’ç‹€æ³
            </li>
            <li>åŒ¯å…¥å¾Œå¯åŒ¯å‡º CSV / PDF / æˆªåœ–ï¼Œä¿å­˜åˆ†æçµæœ</li>
          </ul>
        </div>
      </div>

      <div class="class-footer">
        <button
          class="btn btn-secondary"
          onclick="location.href = 'index.html'"
        >
          â† è¿”å›æ’è¡Œæ¦œ
        </button>
        <button
          class="btn btn-secondary"
          onclick="location.href = '../index.html'"
        >
          ğŸ  å›é¦–é 
        </button>
      </div>
    </main>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <!-- === ä¾è³´ === -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <script src="../js/utils/constants.js"></script>
    <script src="../js/shared/ranking-renderer.js"></script>
    <script src="../js/shared/firestore-leaderboard.js"></script>
    <script src="../js/shared/csv-report.js"></script>

    <!-- === æ§åˆ¶å™¨ === -->
    <script>
      (function () {
        "use strict";

        var _currentBoardId = null;
        var _currentCode = null;
        var _currentShareUrl = null;
        var _unsubscribe = null;
        var _isOwner = false;
        var _importParsedData = null;

        // DOM
        var boardNameInput = document.getElementById("boardNameInput");
        var joinCodeInput = document.getElementById("joinCodeInput");
        var boardSetup = document.getElementById("boardSetup");
        var shareMethods = document.getElementById("shareMethods");
        var liveRankingContainer = document.getElementById(
          "liveRankingContainer",
        );
        var liveStatsContainer = document.getElementById("liveStatsContainer");
        var boardActions = document.getElementById("boardActions");
        var deleteRulesLive = document.getElementById("deleteRulesLive");
        var boardNameDisplay = document.getElementById("boardNameDisplay");
        var myBoardsSection = document.getElementById("myBoardsSection");
        var myBoardsList = document.getElementById("myBoardsList");

        // === åˆå§‹åŒ– ===
        firebase.auth().onAuthStateChanged(function (user) {
          if (user) {
            _checkUrlParams();
            _loadMyBoards();
          }
        });

        function _checkUrlParams() {
          var params = new URLSearchParams(window.location.search);
          var boardId = params.get("board");
          var code = params.get("code");
          if (boardId) _openBoard(boardId, code);
        }

        // === Tab åˆ‡æ› ===
        var tabs = document.querySelectorAll(".mode-tab");
        tabs.forEach(function (tab) {
          tab.addEventListener("click", function () {
            tabs.forEach(function (t) {
              t.classList.remove("active");
            });
            tab.classList.add("active");
            document.querySelectorAll(".panel").forEach(function (p) {
              p.classList.remove("active");
            });
            document
              .getElementById(
                tab.getAttribute("data-panel") === "live"
                  ? "panelLive"
                  : "panelImport",
              )
              .classList.add("active");
          });
        });

        // === å»ºç«‹çœ‹æ¿ ===
        document
          .getElementById("btnCreateBoard")
          .addEventListener("click", function () {
            var name = boardNameInput.value.trim();
            if (!name) {
              boardNameInput.style.borderColor = "#e74c3c";
              boardNameInput.focus();
              return;
            }
            this.disabled = true;
            this.textContent = "å»ºç«‹ä¸­â€¦";
            var btn = this;

            FirestoreLeaderboard.createClassBoard(name)
              .then(function (result) {
                _currentBoardId = result.boardId;
                _currentCode = result.code;
                _currentShareUrl = result.shareUrl;
                _isOwner = true;
                _showBoardUI(name, result.code, result.shareUrl);
                _startListening(result.boardId);
                _loadMyBoards();
                _toast("âœ… çœ‹æ¿å·²å»ºç«‹ï¼");
              })
              .catch(function (err) {
                alert("âŒ å»ºç«‹å¤±æ•—ï¼š" + err.message);
              })
              .finally(function () {
                btn.disabled = false;
                btn.textContent = "å»ºç«‹";
              });
          });

        // === åŠ å…¥çœ‹æ¿ ===
        document
          .getElementById("btnJoinBoard")
          .addEventListener("click", function () {
            var code = joinCodeInput.value.trim().toUpperCase();
            if (!code || code.length < 4) {
              joinCodeInput.style.borderColor = "#e74c3c";
              joinCodeInput.focus();
              return;
            }
            this.disabled = true;
            this.textContent = "æœå°‹ä¸­â€¦";
            var btn = this;

            FirestoreLeaderboard.findBoardByCode(code)
              .then(function (board) {
                if (!board) {
                  alert("âš ï¸ æ‰¾ä¸åˆ°æ­¤ä»£ç¢¼å°æ‡‰çš„çœ‹æ¿");
                  return;
                }
                _currentBoardId = board.boardId;
                _currentCode = board.code;
                _isOwner = board.ownerId === firebase.auth().currentUser.uid;
                var shareUrl =
                  window.location.origin +
                  "/leaderboard/class.html?board=" +
                  board.boardId +
                  "&code=" +
                  board.code;
                _currentShareUrl = shareUrl;
                _showBoardUI(board.boardName, board.code, shareUrl);
                _startListening(board.boardId);
                _toast("âœ… å·²åŠ å…¥çœ‹æ¿ï¼");
              })
              .catch(function (err) {
                alert("âŒ æŸ¥è©¢å¤±æ•—ï¼š" + err.message);
              })
              .finally(function () {
                btn.disabled = false;
                btn.textContent = "åŠ å…¥";
              });
          });

        // === çœ‹æ¿ UI ===
        function _showBoardUI(boardName, code, shareUrl) {
          boardSetup.style.display = "none";
          shareMethods.classList.add("visible");
          boardActions.style.display = "";
          deleteRulesLive.style.display = "";
          boardNameDisplay.textContent = "ğŸ“‹ " + boardName;
          boardNameDisplay.style.display = "";
          document.getElementById("shareCode").textContent = code;
          document.getElementById("shareLink").textContent = shareUrl;

          var qrContainer = document.getElementById("shareQR");
          qrContainer.innerHTML = "";
          if (typeof QRCode !== "undefined") {
            QRCode.toCanvas(
              shareUrl,
              { width: 150, margin: 1 },
              function (err, canvas) {
                if (!err) qrContainer.appendChild(canvas);
              },
            );
          }
          if (!_isOwner) {
            var db = boardActions.querySelector(".btn-danger");
            if (db) db.style.display = "none";
          }
        }

        function _openBoard(boardId, code) {
          FirestoreLeaderboard.findBoardByCode(code || "")
            .then(function (board) {
              // findBoardByCode å¯èƒ½æ‰¾ä¸åˆ°ï¼ˆå¦‚åªæœ‰ boardId æ²’æœ‰ codeï¼‰
              // æ­¤æ™‚ç›´æ¥ç”¨ boardId å¾ Firestore è®€å–
              if (board && board.boardId === boardId) {
                _currentBoardId = boardId;
                _currentCode = board.code || code;
                _isOwner = board.ownerId === firebase.auth().currentUser.uid;
                var shareUrl =
                  window.location.origin +
                  "/leaderboard/class.html?board=" +
                  boardId +
                  "&code=" +
                  _currentCode;
                _currentShareUrl = shareUrl;
                _showBoardUI(board.boardName, _currentCode, shareUrl);
                _startListening(boardId);
                return;
              }
              // Fallback: ç›´æ¥ç”¨ boardId è®€å–
              return _openBoardById(boardId, code);
            })
            .catch(function () {
              _openBoardById(boardId, code);
            });
        }

        function _openBoardById(boardId, code) {
          var db = window.firebaseServices.firestore;
          db.collection("classLeaderboards")
            .doc(boardId)
            .get()
            .then(function (doc) {
              if (!doc.exists) {
                _toast("âš ï¸ çœ‹æ¿ä¸å­˜åœ¨æˆ–å·²è¢«åˆªé™¤");
                return;
              }
              var data = doc.data();
              _currentBoardId = boardId;
              _currentCode = data.code || code;
              _isOwner = data.ownerId === firebase.auth().currentUser.uid;
              var shareUrl =
                window.location.origin +
                "/leaderboard/class.html?board=" +
                boardId +
                "&code=" +
                _currentCode;
              _currentShareUrl = shareUrl;
              _showBoardUI(data.boardName, _currentCode, shareUrl);
              _startListening(boardId);
            })
            .catch(function (err) {
              console.error("é–‹å•Ÿçœ‹æ¿å¤±æ•—", err);
              _toast("âŒ é–‹å•Ÿçœ‹æ¿å¤±æ•—ï¼š" + err.message);
            });
        }

        // === Firestore å³æ™‚ç›£è½ ===
        function _startListening(boardId) {
          if (_unsubscribe) _unsubscribe();
          _unsubscribe = FirestoreLeaderboard.listenClassBoard(
            boardId,
            function (entries) {
              RankingRenderer.renderStats(liveStatsContainer, entries);
              var uid = firebase.auth().currentUser
                ? firebase.auth().currentUser.uid
                : null;
              RankingRenderer.render(liveRankingContainer, entries, {
                sortBy: "score",
                showAccuracy: true,
                showRT: true,
                showTime: true,
                highlightUid: uid,
                onDelete: _isOwner
                  ? function (entryId) {
                      FirestoreLeaderboard.deleteClassEntry(boardId, entryId)
                        .then(function () {
                          _toast("âœ… å·²åˆªé™¤");
                        })
                        .catch(function (err) {
                          alert("âŒ " + err.message);
                        });
                    }
                  : null,
                emptyText: "ç­‰å¾…å­¸ç”Ÿä¸Šå‚³æˆç¸¾â€¦",
                emptyIcon: "ğŸ“¡",
              });
            },
          );
        }

        // === æˆ‘çš„çœ‹æ¿åˆ—è¡¨ ===
        function _loadMyBoards() {
          FirestoreLeaderboard.getMyBoards().then(function (boards) {
            if (boards.length === 0) {
              myBoardsSection.style.display = "none";
              return;
            }
            myBoardsSection.style.display = "";
            myBoardsList.innerHTML = "";
            boards.forEach(function (board) {
              var item = document.createElement("div");
              item.className = "board-list-item";
              item.innerHTML =
                '<div><div class="board-list-item__name">' +
                _esc(board.boardName) +
                '</div><div class="board-list-item__meta">ä»£ç¢¼ï¼š<span class="board-list-item__code">' +
                board.code +
                '</span></div></div><div style="font-size:1.2rem">â†’</div>';
              item.addEventListener("click", function () {
                _openBoard(board.boardId, board.code);
              });
              myBoardsList.appendChild(item);
            });
          });
        }

        // === åˆ†äº«åŠŸèƒ½ ===
        window.copyCode = function () {
          if (_currentCode)
            navigator.clipboard.writeText(_currentCode).then(function () {
              _toast("âœ… ä»£ç¢¼å·²è¤‡è£½ï¼š" + _currentCode);
            });
        };
        window.copyLink = function () {
          if (_currentShareUrl)
            navigator.clipboard.writeText(_currentShareUrl).then(function () {
              _toast("âœ… é€£çµå·²è¤‡è£½");
            });
        };
        window.downloadQR = function () {
          var c = document.querySelector("#shareQR canvas");
          if (!c) return;
          var a = document.createElement("a");
          a.download = "ç­ç´šæ’è¡Œæ¦œ_QR_" + _currentCode + ".png";
          a.href = c.toDataURL();
          a.click();
          _toast("âœ… QR Code å·²ä¸‹è¼‰");
        };

        // === çœ‹æ¿æ“ä½œ ===
        window.exportBoardCSV = function () {
          if (!_currentBoardId) return;
          FirestoreLeaderboard.getClassBoardEntries(_currentBoardId).then(
            function (entries) {
              if (!entries.length) {
                _toast("âš ï¸ ç„¡è³‡æ–™");
                return;
              }
              var csv = "æ’å,æš±ç¨±,åˆ†æ•¸,æ­£ç¢ºç‡(%),å¹³å‡RT(ms),æ˜Ÿæ˜Ÿ,ä¸Šå‚³æ™‚é–“\n";
              entries.forEach(function (e, i) {
                var t =
                  e.uploadedAt && e.uploadedAt.toDate
                    ? e.uploadedAt.toDate().toISOString()
                    : "";
                csv +=
                  i +
                  1 +
                  "," +
                  e.nickname +
                  "," +
                  e.score +
                  "," +
                  (e.accuracy || 0) +
                  "," +
                  (e.avgRT || 0) +
                  "," +
                  (e.stars || 0) +
                  "," +
                  t +
                  "\n";
              });
              var blob = new Blob(["\uFEFF" + csv], {
                type: "text/csv;charset=utf-8;",
              });
              var a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              a.download =
                "ç­ç´šæ’è¡Œæ¦œ_" +
                _currentCode +
                "_" +
                new Date().toISOString().slice(0, 10) +
                ".csv";
              a.click();
              _toast("âœ… CSV å·²åŒ¯å‡º");
            },
          );
        };
        window.exportBoardPDF = function () {
          if (!liveRankingContainer) return;
          html2pdf()
            .set({
              margin: 10,
              filename: "ç­ç´šæ’è¡Œæ¦œ_" + _currentCode + ".pdf",
              jsPDF: { unit: "mm", format: "a4" },
            })
            .from(liveRankingContainer)
            .save()
            .then(function () {
              _toast("âœ… PDF å·²åŒ¯å‡º");
            });
        };
        window.screenshotBoard = function () {
          if (!liveRankingContainer) return;
          html2pdf()
            .from(liveRankingContainer)
            .toImg()
            .get("img")
            .then(function (img) {
              var a = document.createElement("a");
              a.download = "ç­ç´šæ’è¡Œæ¦œ_" + _currentCode + ".png";
              a.href = img.src;
              a.click();
              _toast("âœ… æˆªåœ–å·²ä¸‹è¼‰");
            });
        };
        window.deleteBoard = function () {
          if (!_currentBoardId || !_isOwner) return;
          if (
            !confirm(
              "âš ï¸ ç¢ºå®šè¦åˆªé™¤æ­¤çœ‹æ¿å—ï¼Ÿ\n\nåˆªé™¤å¾Œæ‰€æœ‰å­¸ç”Ÿæˆç¸¾å°‡æ°¸ä¹…æ¶ˆå¤±ï¼Œç„¡æ³•æ¢å¾©ã€‚\nå»ºè­°å…ˆåŒ¯å‡º CSV å‚™ä»½ã€‚",
            )
          )
            return;
          if (!confirm("âš ï¸âš ï¸ å†æ¬¡ç¢ºèªåˆªé™¤ï¼Ÿ")) return;
          FirestoreLeaderboard.deleteClassBoard(_currentBoardId)
            .then(function () {
              _toast("âœ… çœ‹æ¿å·²åˆªé™¤");
              _currentBoardId = null;
              _currentCode = null;
              if (_unsubscribe) _unsubscribe();
              shareMethods.classList.remove("visible");
              boardActions.style.display = "none";
              deleteRulesLive.style.display = "none";
              boardNameDisplay.style.display = "none";
              boardSetup.style.display = "";
              liveRankingContainer.innerHTML =
                '<div class="ranking-empty"><span class="ranking-empty__icon">ğŸ“¡</span><p>å»ºç«‹æˆ–åŠ å…¥çœ‹æ¿å¾Œï¼Œæ’è¡Œæ¦œå°‡åœ¨æ­¤å³æ™‚æ›´æ–°</p></div>';
              liveStatsContainer.style.display = "none";
              _loadMyBoards();
            })
            .catch(function (err) {
              alert("âŒ " + err.message);
            });
        };

        // === åŒ¯å…¥æ¨¡å¼ ===
        var importUploadZone = document.getElementById("importUploadZone");
        var importFileInput = document.getElementById("importFileInput");
        var importRankingContainer = document.getElementById(
          "importRankingContainer",
        );
        var importStatsContainer = document.getElementById(
          "importStatsContainer",
        );
        var importReportContainer = document.getElementById(
          "importReportContainer",
        );
        var importActions = document.getElementById("importActions");

        importUploadZone.addEventListener("click", function () {
          importFileInput.click();
        });
        importFileInput.addEventListener("change", function () {
          if (importFileInput.files.length)
            _handleImport(importFileInput.files);
        });
        importUploadZone.addEventListener("dragover", function (e) {
          e.preventDefault();
          importUploadZone.classList.add("dragover");
        });
        importUploadZone.addEventListener("dragleave", function () {
          importUploadZone.classList.remove("dragover");
        });
        importUploadZone.addEventListener("drop", function (e) {
          e.preventDefault();
          importUploadZone.classList.remove("dragover");
          if (e.dataTransfer.files.length) _handleImport(e.dataTransfer.files);
        });

        function _handleImport(fileList) {
          CsvReport.parseFiles(fileList)
            .then(function (parsed) {
              _importParsedData = parsed;
              importUploadZone.querySelector("p").textContent =
                "âœ… å·²åŒ¯å…¥ " +
                fileList.length +
                " å€‹æª”æ¡ˆï¼ˆå…± " +
                parsed.allData.length +
                " ç­†è³‡æ–™ï¼‰";
              importActions.style.display = "";
              var entries = _csvToRanking(parsed);
              RankingRenderer.renderStats(importStatsContainer, entries);
              RankingRenderer.render(importRankingContainer, entries, {
                sortBy: "score",
                showAccuracy: true,
                showRT: true,
                emptyText: "æ²’æœ‰ä¸€èˆ¬è©¦é¡Œè³‡æ–™",
              });
              CsvReport.renderReport(importReportContainer, parsed);
            })
            .catch(function (err) {
              alert("âš ï¸ " + err.message);
            });
        }

        function _csvToRanking(parsed) {
          var data = parsed.regularTrials || [];
          var pm = {};
          for (var i = 0; i < data.length; i++) {
            var r = data[i];
            var pid = r.Participant || "Unknown";
            if (!pm[pid])
              pm[pid] = {
                name: pid,
                total: 0,
                correct: 0,
                rtSum: 0,
                rtCount: 0,
              };
            pm[pid].total++;
            if (r.Correct === "yes") pm[pid].correct++;
            var rt = parseFloat(r["RT(ms)"]);
            if (!isNaN(rt) && rt > 0) {
              pm[pid].rtSum += rt;
              pm[pid].rtCount++;
            }
          }
          return Object.keys(pm).map(function (k) {
            var p = pm[k];
            var acc = p.total > 0 ? (p.correct / p.total) * 100 : 0;
            var avgRT = p.rtCount > 0 ? p.rtSum / p.rtCount : 0;
            return {
              nickname: p.name,
              score: Math.round(acc * 10 - avgRT / 10),
              accuracy: acc,
              avgRT: avgRT,
            };
          });
        }

        document
          .getElementById("importBtnExport")
          .addEventListener("click", function () {
            if (_importParsedData) CsvReport.exportCsv(_importParsedData);
          });
        document
          .getElementById("importBtnPdf")
          .addEventListener("click", function () {
            if (_importParsedData)
              CsvReport.exportPdf(importReportContainer, _importParsedData);
          });
        document
          .getElementById("importBtnScreenshot")
          .addEventListener("click", function () {
            if (_importParsedData)
              CsvReport.exportScreenshot(importReportContainer);
          });
        document
          .getElementById("importBtnClear")
          .addEventListener("click", function () {
            CsvReport.destroy();
            _importParsedData = null;
            importRankingContainer.innerHTML =
              '<div class="ranking-empty"><span class="ranking-empty__icon">ğŸ“</span><p>åŒ¯å…¥ CSV æª”æ¡ˆå¾Œï¼Œæ’è¡Œæ¦œå°‡é¡¯ç¤ºåœ¨æ­¤</p></div>';
            importReportContainer.innerHTML = "";
            importStatsContainer.style.display = "none";
            importActions.style.display = "none";
            importUploadZone.querySelector("p").textContent =
              "ğŸ“ æ‹–æ”¾ CSV æª”æ¡ˆåˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ";
            importFileInput.value = "";
            _toast("âœ… å·²æ¸…é™¤");
          });

        // === å·¥å…· ===
        function _toast(msg) {
          var t = document.getElementById("toast");
          t.textContent = msg;
          t.classList.add("show");
          setTimeout(function () {
            t.classList.remove("show");
          }, 2500);
        }
        function _esc(s) {
          var d = document.createElement("div");
          d.textContent = s;
          return d.innerHTML;
        }
        window.addEventListener("beforeunload", function () {
          if (_unsubscribe) _unsubscribe();
        });
      })();
    </script>
    <script src="../js/shared/navbar.js"></script>
    <script src="../js/shared/landscape-hint.js"></script>
  </body>
</html>
