<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app"
    />
    <title>班級排行榜 - 執行功能訓練遊戲</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="preload" href="../css/components/ranking.css" as="style" onload="this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="../css/components/ranking.css" /></noscript>
    <link rel="preload" href="../css/components/csv-report.css" as="style" onload="this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="../css/components/csv-report.css" /></noscript>
    <link rel="preload" href="../css/components/landscape-hint.css" as="style" onload="this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="../css/components/landscape-hint.css" /></noscript>
    <link rel="stylesheet" href="../css/pages/class-leaderboard.css" />
    <link rel="preload" href="../css/components/navbar.css" as="style" onload="this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="../css/components/navbar.css" /></noscript>
    <!-- === 依賴 === -->
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"
    ></script>
    <script
      defer
      src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"
    ></script>
    <script defer src="../js/firebase-config.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"
    ></script>
    <script defer src="../js/utils/constants.js"></script>
    <script defer src="../js/shared/ranking-renderer.js"></script>
    <script defer src="../js/shared/firestore-leaderboard.js"></script>
    <script defer src="../js/shared/csv-report.js"></script>
    <script defer src="../js/shared/navbar.js"></script>
    <script defer src="../js/shared/landscape-hint.js"></script>
  </head>
  <body>
    <main class="class-page" id="main-content">
      <div class="class-header">
        <h1>📋 班級排行榜</h1>
        <p class="subtitle">即時收集學生成績 或 匯入 CSV 分析</p>
        <div
          class="board-name-display"
          id="boardNameDisplay"
          style="display: none"
        ></div>
      </div>

      <div class="mode-tabs">
        <button class="mode-tab active" data-panel="live">📡 即時模式</button>
        <button class="mode-tab" data-panel="import">📁 匯入模式</button>
      </div>

      <!-- ═══ 即時模式 ═══ -->
      <div class="panel active" id="panelLive">
        <div class="board-setup" id="boardSetup">
          <div class="setup-card">
            <h3>🏫 老師：建立新看板</h3>
            <div class="input-row">
              <input
                type="text"
                id="boardNameInput"
                placeholder="看板名稱（如：中班第三週）"
                maxlength="50"
                aria-label="看板名稱"
              />
              <button class="btn btn-primary" id="btnCreateBoard">建立</button>
            </div>
          </div>
          <div class="setup-card">
            <h3>🎒 學生：輸入代碼上傳成績</h3>
            <div class="input-row">
              <input
                type="text"
                id="joinCodeInput"
                placeholder="輸入 6 位代碼"
                maxlength="6"
                aria-label="看板代碼"
                style="
                  text-transform: uppercase;
                  letter-spacing: 2px;
                  text-align: center;
                  font-weight: 700;
                "
              />
              <button class="btn btn-primary" id="btnJoinBoard">加入</button>
            </div>
          </div>
          <div class="my-boards" id="myBoardsSection" style="display: none">
            <h3 style="margin: 0 0 0.75rem; color: #555">📂 我的看板</h3>
            <div id="myBoardsList"></div>
          </div>
        </div>

        <div class="share-methods" id="shareMethods">
          <h3>📢 分享給學生（三種方式皆可）</h3>
          <div class="share-grid">
            <div class="share-item">
              <div class="share-item__label">🔢 代碼</div>
              <div class="share-item__code" id="shareCode">------</div>
              <button class="btn btn-secondary" onclick="copyCode()">
                📋 複製代碼
              </button>
            </div>
            <div class="share-item">
              <div class="share-item__label">📱 QR Code</div>
              <div class="share-item__qr" id="shareQR"></div>
              <button class="btn btn-secondary" onclick="downloadQR()">
                💾 下載 QR
              </button>
            </div>
            <div class="share-item">
              <div class="share-item__label">🔗 共享連結</div>
              <div class="share-item__link" id="shareLink">—</div>
              <button class="btn btn-secondary" onclick="copyLink()">
                📋 複製連結
              </button>
            </div>
          </div>
        </div>

        <div id="liveStatsContainer" style="display: none"></div>
        <div id="liveRankingContainer">
          <div class="ranking-empty">
            <span class="ranking-empty__icon">📡</span>
            <p>建立或加入看板後，排行榜將在此即時更新</p>
          </div>
        </div>
        <div class="board-actions" id="boardActions" style="display: none">
          <button class="btn btn-secondary" onclick="exportBoardCSV()">
            💾 匯出 CSV
          </button>
          <button class="btn btn-secondary" onclick="exportBoardPDF()">
            📄 匯出 PDF
          </button>
          <button class="btn btn-secondary" onclick="screenshotBoard()">
            📸 截圖
          </button>
          <button class="btn btn-danger" onclick="deleteBoard()">
            🗑️ 刪除此看板
          </button>
        </div>
        <div class="delete-rules" id="deleteRulesLive" style="display: none">
          <strong>ℹ️ 資料管理說明</strong>
          <ul>
            <li>
              班級排行榜資料儲存在雲端，<strong>老師不刪除就會一直保留</strong>
            </li>
            <li>
              學生可以重複上傳，<strong>同一位學生的資料會覆蓋前一筆</strong>（保留最新的）
            </li>
            <li>只有看板建立者（老師）可以刪除整個看板或個別記錄</li>
            <li>刪除後<strong>無法恢復</strong>，建議先匯出 CSV 備份</li>
          </ul>
        </div>
      </div>

      <!-- ═══ 匯入模式 ═══ -->
      <div class="panel" id="panelImport">
        <div class="import-upload-zone" id="importUploadZone">
          <p>📁 拖放 CSV 檔案到此處，或點擊選擇檔案</p>
          <small>支援 EF訓練遊戲數據_ID_日期_時間.csv 格式，可多檔上傳</small>
          <input
            type="file"
            id="importFileInput"
            accept=".csv"
            multiple
            style="display: none"
            aria-label="選擇 CSV 檔案"
          />
        </div>
        <div id="importStatsContainer" style="display: none"></div>
        <div id="importRankingContainer">
          <div class="ranking-empty">
            <span class="ranking-empty__icon">📁</span>
            <p>匯入 CSV 檔案後，排行榜將顯示在此</p>
          </div>
        </div>
        <div id="importReportContainer"></div>
        <div class="board-actions" id="importActions" style="display: none">
          <button class="btn btn-secondary" id="importBtnExport">
            💾 匯出 CSV
          </button>
          <button class="btn btn-secondary" id="importBtnPdf">
            📄 匯出 PDF
          </button>
          <button class="btn btn-secondary" id="importBtnScreenshot">
            📸 截圖
          </button>
          <button class="btn btn-secondary" id="importBtnClear">
            🗑️ 清除資料
          </button>
        </div>
        <div class="delete-rules">
          <strong>ℹ️ 匯入模式說明</strong>
          <ul>
            <li>
              匯入的 CSV
              資料<strong>僅存在瀏覽器記憶體中</strong>，關閉頁面即消失
            </li>
            <li>
              適合學期末<strong>批次匯入分析</strong>，一次觀察所有學生的學習狀況
            </li>
            <li>匯入後可匯出 CSV / PDF / 截圖，保存分析結果</li>
          </ul>
        </div>
      </div>

      <div class="class-footer">
        <button
          class="btn btn-secondary"
          onclick="location.href = 'index.html'"
        >
          ← 返回排行榜
        </button>
        <button
          class="btn btn-secondary"
          onclick="location.href = '../index.html'"
        >
          🏠 回首頁
        </button>
      </div>
    </main>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <!-- === 控制器 === -->
    <script defer src="../js/shared/class-leaderboard-controller.js"></script>
  </body>
</html>
