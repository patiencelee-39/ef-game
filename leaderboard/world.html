<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app"
    />
    <title>ä¸–ç•Œæ’è¡Œæ¦œ - åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ²</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/components/ranking.css" />
    <link rel="stylesheet" href="../css/components/landscape-hint.css" />
    <style>
      .world-page {
        max-width: 900px;
        margin: 0 auto;
        padding: 1.5rem;
        min-height: 100vh;
      }
      .world-header {
        text-align: center;
        margin-bottom: 2rem;
      }
      .world-header h1 {
        font-size: 2rem;
        margin: 0 0 0.4rem;
        color: #ffd700;
        background: linear-gradient(135deg, #ffd700, #ffaa00);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .world-header .subtitle {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.92rem;
        line-height: 1.5;
      }

      /* Upload Card */
      .upload-section {
        max-width: 500px;
        margin: 0 auto 2rem;
      }
      .upload-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        text-align: center;
        backdrop-filter: blur(8px);
      }
      .upload-card h3 {
        margin: 0 0 0.5rem;
        font-size: 1.05rem;
        color: var(--text-white);
      }
      .upload-card p {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.85rem;
        margin-bottom: 0.75rem;
        line-height: 1.5;
      }
      .local-score {
        margin: 0.75rem 0;
      }
      .local-score__label {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
      }
      .local-score__value {
        font-size: 2.5rem;
        font-weight: 800;
        color: #ffd700;
        background: linear-gradient(135deg, #ffd700, #ff6b6b);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0.25rem 0;
      }
      .local-score__detail {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.65);
      }
      .local-score__nickname {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 0.25rem;
      }
      .upload-status {
        margin-top: 0.75rem;
        font-size: 0.85rem;
        min-height: 1.5em;
      }
      .upload-status.success {
        color: #4caf50;
      }
      .upload-status.error {
        color: #e74c3c;
      }

      .btn {
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      .btn-primary {
        background: linear-gradient(135deg, #ffd700, #ffaa00);
        color: #333;
      }
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-light);
      }
      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* Footer */
      .world-footer {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        flex-wrap: wrap;
      }
      .world-footer .btn {
        font-size: 0.9rem;
        padding: 0.6rem 1.2rem;
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: #fff;
        padding: 0.75rem 1.5rem;
        border-radius: 24px;
        font-size: 0.9rem;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }
      .toast.show {
        opacity: 1;
      }

      /* Explanation */
      .explain-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 1.25rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        margin: 1.5rem auto;
        max-width: 600px;
        font-size: 0.85rem;
        line-height: 1.7;
        color: rgba(255, 255, 255, 0.6);
      }
      .explain-card strong {
        color: var(--text-white);
      }
      .explain-card ul {
        margin: 0.5rem 0 0 1.25rem;
        padding: 0;
      }

      /* No-data notice */
      .no-data-notice {
        text-align: center;
        padding: 1rem;
        background: rgba(230, 81, 0, 0.12);
        border: 1px solid rgba(230, 81, 0, 0.25);
        border-radius: 10px;
        margin: 0.75rem 0;
        font-size: 0.85rem;
        color: #ffab40;
      }
    </style>
    <link rel="stylesheet" href="../css/components/navbar.css" />
    <!-- === ä¾è³´ === -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script defer src="../js/firebase-config.js"></script>
    <script defer src="../js/utils/constants.js"></script>
    <script defer src="../js/shared/ranking-renderer.js"></script>
    <script defer src="../js/shared/firestore-leaderboard.js"></script>
    <script defer src="../js/shared/navbar.js"></script>
    <script defer src="../js/shared/landscape-hint.js"></script>
  </head>
  <body>
    <main class="world-page" id="main-content">
      <div class="world-header">
        <h1>ğŸŒ ä¸–ç•Œæ’è¡Œæ¦œ</h1>
        <p class="subtitle">
          èˆ‡å…¨ä¸–ç•Œçš„ç©å®¶æ¯”è¼ƒæˆç¸¾ï¼<br />ä¸éœ€è¦ç™»å…¥å¸³è™Ÿï¼Œå®ŒæˆéŠæˆ²å¾Œå³å¯ä¸Šå‚³
        </p>
      </div>

      <!-- Upload Section -->
      <div class="upload-section" id="uploadSection">
        <div class="upload-card">
          <h3>ğŸ“¤ ä¸Šå‚³æˆ‘çš„æˆç¸¾</h3>
          <p>ä½ çš„æœ€æ–°éŠæˆ²æˆç¸¾ï¼š</p>
          <div class="local-score">
            <div class="local-score__nickname" id="localNickname"></div>
            <div class="local-score__label">æœ€é«˜åˆ†</div>
            <div class="local-score__value" id="localScoreValue">---</div>
            <div class="local-score__detail" id="localScoreDetail"></div>
          </div>
          <div id="noDataNotice" class="no-data-notice" style="display: none">
            âš ï¸ æœ¬åœ°æ²’æœ‰éŠæˆ²ç´€éŒ„ï¼Œè«‹å…ˆç©ä¸€å ´éŠæˆ²å†ä¾†ä¸Šå‚³ï¼
          </div>
          <button class="btn btn-primary" id="btnUpload" disabled>
            ğŸš€ ä¸Šå‚³åˆ°ä¸–ç•Œæ’è¡Œæ¦œ
          </button>
          <div
            class="upload-status"
            id="uploadStatus"
            role="status"
            aria-live="polite"
          ></div>
        </div>
      </div>

      <!-- Stats -->
      <div id="worldStatsContainer" style="display: none"></div>

      <!-- Ranking -->
      <div id="worldRankingContainer">
        <div class="ranking-empty">
          <span class="ranking-empty__icon">ğŸŒ</span>
          <p>è¼‰å…¥ä¸–ç•Œæ’è¡Œæ¦œä¸­â€¦</p>
        </div>
      </div>

      <!-- Explain -->
      <div class="explain-card">
        <strong>â„¹ï¸ ä¸–ç•Œæ’è¡Œæ¦œèªªæ˜</strong>
        <ul>
          <li><strong>ä¸éœ€è¦ç™»å…¥å¸³è™Ÿ</strong>ï¼Œå®ŒæˆéŠæˆ²å¾Œå³å¯ä¸Šå‚³</li>
          <li>
            ä»¥ã€Œæš±ç¨± + è£ç½®ã€è¾¨è­˜èº«ä»½ï¼Œ<strong>åŒä¸€è£ç½®ä¸Šå‚³æœƒè¦†è“‹å‰ä¸€ç­†</strong>
          </li>
          <li>ä¸Šå‚³å¾Œ<strong>ç„¡æ³•è‡ªè¡Œåˆªé™¤</strong>ï¼Œåªèƒ½è¢«æ–°ä¸Šå‚³è¦†è“‹</li>
          <li>
            è¨ªå®¢æ¨¡å¼ï¼ˆ00NoNameï¼‰ä½¿ç”¨
            sessionStorageï¼Œ<strong>é—œé–‰åˆ†é å¾Œè³‡æ–™å³æ¸…é™¤</strong>ï¼Œä½†ä»å¯ä¸Šå‚³è‡³ä¸–ç•Œæ’è¡Œæ¦œ
          </li>
          <li>æœªè¼¸å…¥æš±ç¨±/åº§è™Ÿ = è¨ªå®¢ï¼Œè³‡æ–™ä¸å„²å­˜ä¹Ÿä¸ä¸Šå‚³</li>
        </ul>
      </div>

      <div class="world-footer">
        <button
          class="btn btn-secondary"
          onclick="location.href = 'index.html'"
        >
          â† è¿”å›æ’è¡Œæ¦œ
        </button>
        <button
          class="btn btn-secondary"
          onclick="location.href = '../index.html'"
        >
          ğŸ  å›é¦–é 
        </button>
      </div>
    </main>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <script>
      (function () {
        "use strict";

        // DOM
        var localNickname = document.getElementById("localNickname");
        var localScoreValue = document.getElementById("localScoreValue");
        var localScoreDetail = document.getElementById("localScoreDetail");
        var noDataNotice = document.getElementById("noDataNotice");
        var btnUpload = document.getElementById("btnUpload");
        var uploadStatus = document.getElementById("uploadStatus");
        var worldRankingContainer = document.getElementById(
          "worldRankingContainer",
        );
        var worldStatsContainer = document.getElementById(
          "worldStatsContainer",
        );

        var _bestEntry = null; // å¿«å–æ‰¾åˆ°çš„æœ€ä½³ç´€éŒ„
        var GUEST_NICKNAME = "00NoName";

        // === åˆå§‹åŒ– ===
        firebase.auth().onAuthStateChanged(function (user) {
          if (!user) {
            // è‡ªå‹•åŒ¿åç™»å…¥
            firebase
              .auth()
              .signInAnonymously()
              .catch(function (err) {
                console.error("åŒ¿åç™»å…¥å¤±æ•—", err);
              });
            return;
          }
          _loadLocalScore();
          _loadWorldRanking();
        });

        // === è®€å–æœ¬åœ°æˆç¸¾ ===
        function _loadLocalScore() {
          try {
            var raw = localStorage.getItem("efgame_leaderboard");
            if (!raw) {
              _showNoData();
              return;
            }
            var data = JSON.parse(raw);
            if (!data || !data.length) {
              _showNoData();
              return;
            }

            // æ‰¾æœ€é«˜åˆ†ï¼ˆç›¸å®¹ nickname å’Œ name å…©ç¨®æ¬„ä½ï¼‰
            var validEntries = data.filter(function (e) {
              return e.nickname || e.name;
            });

            if (validEntries.length === 0) {
              _showNoData();
              return;
            }

            var best = validEntries.reduce(function (a, b) {
              return (b.bestScore || 0) > (a.bestScore || 0) ? b : a;
            }, validEntries[0]);

            _bestEntry = best;
            localNickname.textContent =
              "ğŸ·ï¸ " + (best.nickname || best.name || "åŒ¿å");
            localScoreValue.textContent = best.bestScore || 0;

            var details = [];
            if (best.accuracy != null)
              details.push("æ­£ç¢ºç‡ " + Math.round(best.accuracy) + "%");
            if (best.avgRT)
              details.push("å¹³å‡ RT " + Math.round(best.avgRT) + "ms");
            if (best.totalStars != null) details.push("â­ " + best.totalStars);
            if (best.gamesPlayed)
              details.push("ğŸ® " + best.gamesPlayed + " å ´");
            localScoreDetail.textContent = details.join(" Â· ");

            noDataNotice.style.display = "none";
            btnUpload.disabled = false;
          } catch (e) {
            _showNoData();
          }
        }

        function _showNoData() {
          localScoreValue.textContent = "ç„¡ç´€éŒ„";
          noDataNotice.style.display = "";
          btnUpload.disabled = true;
        }

        // === ä¸Šå‚³åˆ°ä¸–ç•Œæ’è¡Œæ¦œ ===
        btnUpload.addEventListener("click", function () {
          if (!_bestEntry) return;
          btnUpload.disabled = true;
          btnUpload.textContent = "ä¸Šå‚³ä¸­â€¦";
          uploadStatus.textContent = "";
          uploadStatus.className = "upload-status";

          var entry = {
            nickname: _bestEntry.nickname || _bestEntry.name || "åŒ¿å",
            totalStars: _bestEntry.totalStars || _bestEntry.stars || 0,
            bestScore: _bestEntry.bestScore || 0,
            bestAccuracy: _bestEntry.accuracy || 0,
            bestAvgRT: _bestEntry.avgRT || 0,
            gamesPlayed: _bestEntry.gamesPlayed || 1,
          };

          FirestoreLeaderboard.uploadToWorld(entry)
            .then(function () {
              uploadStatus.textContent =
                "âœ… ä¸Šå‚³æˆåŠŸï¼ä½ çš„æˆç¸¾å·²åŠ å…¥ä¸–ç•Œæ’è¡Œæ¦œ";
              uploadStatus.className = "upload-status success";
              _loadWorldRanking();
            })
            .catch(function (err) {
              uploadStatus.textContent = "âŒ ä¸Šå‚³å¤±æ•—ï¼š" + err.message;
              uploadStatus.className = "upload-status error";
            })
            .finally(function () {
              btnUpload.disabled = false;
              btnUpload.textContent = "ğŸš€ ä¸Šå‚³åˆ°ä¸–ç•Œæ’è¡Œæ¦œ";
            });
        });

        // === è¼‰å…¥ä¸–ç•Œæ’è¡Œ ===
        function _loadWorldRanking() {
          FirestoreLeaderboard.getWorldLeaderboard(100)
            .then(function (entries) {
              RankingRenderer.renderStats(worldStatsContainer, entries);
              var uid = firebase.auth().currentUser
                ? firebase.auth().currentUser.uid
                : null;
              RankingRenderer.render(worldRankingContainer, entries, {
                sortBy: "bestScore",
                showAccuracy: true,
                showRT: true,
                showStars: true,
                highlightUid: uid,
                emptyText: "ä¸–ç•Œæ’è¡Œæ¦œç›®å‰é‚„æ²’æœ‰ç´€éŒ„ï¼Œæˆç‚ºç¬¬ä¸€å€‹ä¸Šæ¦œçš„ç©å®¶å§ï¼",
                emptyIcon: "ğŸŒ",
              });
            })
            .catch(function (err) {
              worldRankingContainer.innerHTML =
                '<div class="ranking-empty"><span class="ranking-empty__icon">âš ï¸</span><p>è¼‰å…¥å¤±æ•—ï¼š' +
                err.message +
                "</p></div>";
            });
        }

        // === å·¥å…· ===
        function _toast(msg) {
          var t = document.getElementById("toast");
          t.textContent = msg;
          t.classList.add("show");
          setTimeout(function () {
            t.classList.remove("show");
          }, 2500);
        }
      })();
    </script>
  </body>
</html>
