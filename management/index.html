<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app"
    />
    <title>æ•™å¸«ç®¡ç†å¾Œå° - åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ²</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/components/navbar.css" />
    <link rel="stylesheet" href="../css/components/landscape-hint.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei",
          "PingFang TC", "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(
          135deg,
          #0f0c29 0%,
          #302b63 50%,
          #24243e 100%
        );
        min-height: 100vh;
        color: #e8e8e8;
      }

      /* === é é¢å®¹å™¨ === */
      .admin-page {
        max-width: 640px;
        margin: 0 auto;
        padding: 24px 16px 120px;
      }

      /* === æ¨™é¡Œ === */
      .admin-page > h1 {
        text-align: center;
        font-size: 1.5rem;
        font-weight: 800;
        margin-bottom: 8px;
        color: #c9b1ff;
        background: linear-gradient(135deg, #c9b1ff, #fed6e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .admin-subtitle {
        text-align: center;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.65);
        margin-bottom: 24px;
      }

      /* === å¿«æ·å°èˆª === */
      .quick-nav {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .quick-nav__btn {
        padding: 8px 14px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.75);
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition:
          background 0.2s,
          border-color 0.2s;
      }
      .quick-nav__btn:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.25);
      }

      /* === çµ±è¨ˆå¡ç‰‡ === */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 16px 12px;
        text-align: center;
        backdrop-filter: blur(8px);
      }
      .stat-card__icon {
        font-size: 1.6rem;
        margin-bottom: 6px;
      }
      .stat-card__value {
        font-size: 1.8rem;
        font-weight: 800;
        color: #fff;
        line-height: 1.2;
      }
      .stat-card__label {
        font-size: 0.78rem;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 4px;
      }

      /* === å€å¡Š === */
      .admin-section {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 18px 16px;
        margin-bottom: 16px;
        backdrop-filter: blur(8px);
      }
      .admin-section h2 {
        font-size: 1rem;
        font-weight: 700;
        margin: 0 0 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #fff;
      }

      /* === ç­ç´šç®¡ç† === */
      .class-form {
        display: flex;
        gap: 8px;
        margin-bottom: 14px;
      }
      .class-form__input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        font-size: 0.92rem;
        outline: none;
        transition: border-color 0.2s;
      }
      .class-form__input::placeholder {
        color: rgba(255, 255, 255, 0.35);
      }
      .class-form__input:focus {
        border-color: rgba(155, 89, 182, 0.5);
      }
      .class-form__btn {
        padding: 10px 16px;
        border: none;
        border-radius: 10px;
        background: rgba(155, 89, 182, 0.25);
        color: #c9a0dc;
        font-size: 0.88rem;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        transition: background 0.2s;
      }
      .class-form__btn:hover {
        background: rgba(155, 89, 182, 0.4);
      }

      .class-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .class-chip {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .class-chip__info {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.92rem;
      }
      .class-chip__count {
        font-size: 0.78rem;
        color: rgba(255, 255, 255, 0.65);
      }
      .class-chip__del {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 8px;
        background: rgba(231, 76, 60, 0.12);
        color: #e74c3c;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      .class-chip__del:hover {
        background: rgba(231, 76, 60, 0.3);
      }

      /* === å­¸ç”Ÿåˆ—è¡¨ === */
      .student-table-wrap {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .student-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      .student-table th {
        padding: 8px 10px;
        text-align: left;
        font-size: 0.78rem;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 600;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        white-space: nowrap;
      }
      .student-table td {
        padding: 9px 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.85);
      }
      .student-table tr:hover td {
        background: rgba(255, 255, 255, 0.03);
      }
      .student-table .rank-medal {
        font-size: 1.1rem;
      }

      /* === ç¯©é¸åˆ— === */
      .filter-row {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .filter-chip {
        padding: 5px 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        background: transparent;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .filter-chip.active {
        background: rgba(155, 89, 182, 0.2);
        border-color: rgba(155, 89, 182, 0.5);
        color: #c9a0dc;
        font-weight: 600;
      }

      /* === ç©ºç‹€æ…‹ === */
      .empty-state {
        text-align: center;
        padding: 28px 16px;
        color: rgba(255, 255, 255, 0.65);
      }
      .empty-state__icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }
      .empty-state__text {
        font-size: 0.88rem;
        line-height: 1.5;
      }

      /* === è³‡æ–™ç®¡ç†æŒ‰éˆ• === */
      .admin-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-size: 0.92rem;
        font-weight: 600;
        cursor: pointer;
        transition:
          opacity 0.2s,
          transform 0.1s;
        margin-bottom: 10px;
      }
      .admin-btn:last-child {
        margin-bottom: 0;
      }
      .admin-btn:active {
        transform: scale(0.97);
      }
      .admin-btn--export {
        background: rgba(52, 152, 219, 0.2);
        color: #3498db;
        border: 1px solid rgba(52, 152, 219, 0.3);
      }
      .admin-btn--import {
        background: rgba(46, 204, 113, 0.2);
        color: #2ecc71;
        border: 1px solid rgba(46, 204, 113, 0.3);
      }
      .admin-btn--danger {
        background: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
        border: 1px solid rgba(231, 76, 60, 0.25);
      }

      /* === Toast === */
      .admin-toast {
        position: fixed;
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 0.88rem;
        z-index: 9999;
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 0.3s,
          transform 0.3s;
        backdrop-filter: blur(8px);
      }
      .admin-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* === ç¢ºèªå½ˆçª— === */
      .confirm-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s;
      }
      .confirm-overlay.show {
        opacity: 1;
        pointer-events: auto;
      }
      .confirm-dialog {
        background: #2a2a4a;
        border-radius: 16px;
        padding: 28px 24px 20px;
        max-width: 320px;
        width: 90%;
        text-align: center;
      }
      .confirm-dialog__icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
      }
      .confirm-dialog__title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: #fff;
      }
      .confirm-dialog__msg {
        font-size: 0.88rem;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 20px;
        line-height: 1.5;
      }
      .confirm-dialog__actions {
        display: flex;
        gap: 10px;
      }
      .confirm-dialog__btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 10px;
        font-size: 0.92rem;
        font-weight: 600;
        cursor: pointer;
      }
      .confirm-dialog__btn--cancel {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.7);
      }
      .confirm-dialog__btn--danger {
        background: #e74c3c;
        color: #fff;
      }

      /* === éš±è— file input === */
      #importFileInput {
        display: none;
      }

      /* === éŸ¿æ‡‰å¼ === */
      @media (max-width: 400px) {
        .stats-grid {
          gap: 8px;
        }
        .stat-card {
          padding: 12px 8px;
        }
        .stat-card__value {
          font-size: 1.5rem;
        }
      }
    </style>
    <!-- === Scripts === -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="../js/firebase-config.js"></script>
    <script defer src="../js/shared/firestore-leaderboard.js"></script>
    <script defer src="../js/shared/navbar.js"></script>
    <script defer src="../js/shared/landscape-hint.js"></script>
  </head>
  <body>
    <main class="admin-page" id="main-content">
      <h1>ğŸ« æ•™å¸«ç®¡ç†å¾Œå°</h1>
      <p class="admin-subtitle">
        ç­ç´šç®¡ç† Â· å­¸ç”Ÿé€²åº¦ Â· è³‡æ–™åŒ¯å‡º
        <span id="authStatus" style="font-size: 0.75rem">â³ é€£ç·šä¸­â€¦</span>
      </p>

      <!-- === å¿«æ·å°èˆª === -->
      <div class="quick-nav">
        <a class="quick-nav__btn" href="../leaderboard/class.html">
          ğŸ† ç­ç´šæ’è¡Œæ¦œ
        </a>
        <a class="quick-nav__btn" href="../multiplayer/room-create.html">
          ğŸ® å»ºç«‹æˆ¿é–“
        </a>
        <a class="quick-nav__btn" href="../settings/index.html"> âš™ï¸ è¨­å®š </a>
      </div>

      <!-- === çµ±è¨ˆæ‘˜è¦ === -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-card__icon">ğŸ‘©â€ğŸ“</div>
          <div class="stat-card__value" id="statStudents">0</div>
          <div class="stat-card__label">å­¸ç”Ÿäººæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-card__icon">ğŸ…</div>
          <div class="stat-card__value" id="statClasses">0</div>
          <div class="stat-card__label">ç­ç´šæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-card__icon">ğŸ®</div>
          <div class="stat-card__value" id="statGames">0</div>
          <div class="stat-card__label">ç¸½éŠæˆ²å ´æ¬¡</div>
        </div>
        <div class="stat-card">
          <div class="stat-card__icon">ğŸ’¯</div>
          <div class="stat-card__value" id="statAvgAcc">-</div>
          <div class="stat-card__label">å¹³å‡æº–ç¢ºç‡</div>
        </div>
      </div>

      <!-- === ç­ç´šç®¡ç† === -->
      <div class="admin-section">
        <h2>ğŸ“š ç­ç´šç®¡ç†</h2>
        <div class="class-form">
          <input
            type="text"
            id="newClassName"
            class="class-form__input"
            placeholder="è¼¸å…¥ç­ç´šåç¨±ï¼ˆå¦‚ï¼šå‘æ—¥è‘µç­ï¼‰"
            maxlength="20"
            aria-label="æ–°ç­ç´šåç¨±"
          />
          <button class="class-form__btn" id="btnAddClass">â• æ–°å¢</button>
        </div>
        <div class="class-list" id="classList">
          <!-- å‹•æ…‹ç”¢ç”Ÿ -->
        </div>
      </div>

      <!-- === å­¸ç”Ÿå­¸ç¿’é€²åº¦ === -->
      <div class="admin-section">
        <h2>ğŸ§‘â€ğŸ“ å­¸ç”Ÿå­¸ç¿’é€²åº¦</h2>
        <div class="filter-row" id="filterRow">
          <!-- å‹•æ…‹ç”¢ç”Ÿç¯©é¸æŒ‰éˆ• -->
        </div>
        <div id="studentArea">
          <div class="empty-state">
            <div class="empty-state__icon">ğŸ“­</div>
            <p class="empty-state__text">
              å°šç„¡å­¸ç”Ÿè³‡æ–™<br />å­¸ç”Ÿå®ŒæˆéŠæˆ²å¾Œï¼Œè³‡æ–™å°‡è‡ªå‹•å‡ºç¾æ–¼æ­¤
            </p>
          </div>
        </div>
      </div>

      <!-- === è³‡æ–™ç®¡ç† === -->
      <div class="admin-section">
        <h2>ğŸ’¾ è³‡æ–™ç®¡ç†</h2>
        <button class="admin-btn admin-btn--export" id="btnExport">
          ğŸ“¥ åŒ¯å‡ºæ‰€æœ‰è³‡æ–™ (JSON)
        </button>
        <button class="admin-btn admin-btn--import" id="btnImport">
          ğŸ“¤ åŒ¯å…¥è³‡æ–™ (JSON)
        </button>
        <button
          class="admin-btn admin-btn--danger"
          id="btnClearAll"
          style="
            background: rgba(100, 100, 200, 0.2);
            border: 1px solid rgba(150, 150, 220, 0.3);
          "
        >
          ğŸ”„ é‡æ–°æ•´ç†
        </button>
        <input type="file" id="importFileInput" accept=".json" />
      </div>
    </div>

    <!-- Toast -->
    <div class="admin-toast" id="toast" role="status" aria-live="polite"></div>

    <!-- ç¢ºèªå½ˆçª— -->
    <div class="confirm-overlay" id="confirmOverlay" role="dialog" aria-modal="true" aria-label="ç¢ºèªæ“ä½œ">
      <div class="confirm-dialog">
        <div class="confirm-dialog__icon" id="confirmIcon">âš ï¸</div>
        <div class="confirm-dialog__title" id="confirmTitle">ç¢ºèªæ“ä½œ</div>
        <div class="confirm-dialog__msg" id="confirmMsg">ç¢ºå®šå—ï¼Ÿ</div>
        <div class="confirm-dialog__actions">
          <button
            class="confirm-dialog__btn confirm-dialog__btn--cancel"
            id="confirmCancel"
          >
            å–æ¶ˆ
          </button>
          <button
            class="confirm-dialog__btn confirm-dialog__btn--danger"
            id="confirmOk"
          >
            ç¢ºå®š
          </button>
        </div>
      </div>
    </main>

    <script>
      /**
       * ============================================
       * æ•™å¸«ç®¡ç†å¾Œå°æ§åˆ¶å™¨ v2
       * ============================================
       * è³‡æ–™ä¾†æºï¼š
       *   - ç­ç´šçœ‹æ¿ï¼šFirestore classLeaderboardsï¼ˆvia FirestoreLeaderboardï¼‰
       *   - å­¸ç”Ÿæˆç¸¾ï¼šFirestore entriesï¼ˆvia getClassBoardEntriesï¼‰
       *   - æœ¬åœ°åŒ¯å‡º/åŒ¯å…¥ï¼šä¿ç•™ JSON åŠŸèƒ½
       * ============================================
       */
      (function () {
        "use strict";

        // =========================================
        // ç‹€æ…‹
        // =========================================
        var _boards = []; // æ•™å¸«çš„æ‰€æœ‰çœ‹æ¿
        var _currentBoardId = null; // ç•¶å‰é¸ä¸­çš„çœ‹æ¿
        var _allEntries = []; // ç•¶å‰çœ‹æ¿çš„æ‰€æœ‰æˆç¸¾
        var _isLoggedIn = false;

        // =========================================
        // DOM refs
        // =========================================
        var els = {};

        function cacheDom() {
          els = {
            statStudents: document.getElementById("statStudents"),
            statClasses: document.getElementById("statClasses"),
            statGames: document.getElementById("statGames"),
            statAvgAcc: document.getElementById("statAvgAcc"),
            boardNameInput: document.getElementById("newClassName"),
            btnAddClass: document.getElementById("btnAddClass"),
            classList: document.getElementById("classList"),
            filterRow: document.getElementById("filterRow"),
            studentArea: document.getElementById("studentArea"),
            btnExport: document.getElementById("btnExport"),
            btnImport: document.getElementById("btnImport"),
            btnClearAll: document.getElementById("btnClearAll"),
            importFileInput: document.getElementById("importFileInput"),
            toast: document.getElementById("toast"),
            authStatus: document.getElementById("authStatus"),
          };
        }

        // =========================================
        // Firebase é©—è­‰
        // =========================================
        function initAuth() {
          firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
              _isLoggedIn = true;
              if (els.authStatus) {
                els.authStatus.textContent = "âœ… å·²é€£ç·š";
                els.authStatus.style.color = "#81c784";
              }
              loadBoards();
            } else {
              // åŒ¿åç™»å…¥
              firebase
                .auth()
                .signInAnonymously()
                .catch(function (err) {
                  console.error("âŒ åŒ¿åç™»å…¥å¤±æ•—:", err);
                  if (els.authStatus) {
                    els.authStatus.textContent = "âŒ é€£ç·šå¤±æ•—";
                    els.authStatus.style.color = "#e74c3c";
                  }
                  showToast("âŒ Firebase é€£ç·šå¤±æ•—ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨");
                });
            }
          });
        }

        // =========================================
        // çœ‹æ¿ï¼ˆç­ç´šï¼‰ç®¡ç†
        // =========================================
        function loadBoards() {
          FirestoreLeaderboard.getMyBoards()
            .then(function (boards) {
              _boards = boards;
              renderAll();
            })
            .catch(function (err) {
              console.error("âŒ è¼‰å…¥çœ‹æ¿å¤±æ•—:", err);
              showToast("âŒ è¼‰å…¥ç­ç´šçœ‹æ¿å¤±æ•—");
            });
        }

        function addBoard() {
          var name = (els.boardNameInput.value || "").trim();
          if (!name) {
            showToast("âš ï¸ è«‹è¼¸å…¥ç­ç´šåç¨±");
            return;
          }
          // é‡åæª¢æŸ¥
          for (var i = 0; i < _boards.length; i++) {
            if (_boards[i].boardName === name) {
              showToast("âš ï¸ æ­¤ç­ç´šåç¨±å·²å­˜åœ¨");
              return;
            }
          }
          els.btnAddClass.disabled = true;
          els.btnAddClass.textContent = "å»ºç«‹ä¸­â€¦";

          FirestoreLeaderboard.createClassBoard(name)
            .then(function (board) {
              els.boardNameInput.value = "";
              showToast("âœ… å·²å»ºç«‹ç­ç´šã€Œ" + name + "ã€\nä»£ç¢¼ï¼š" + board.code);
              loadBoards();
            })
            .catch(function (err) {
              showToast("âŒ å»ºç«‹å¤±æ•—ï¼š" + err.message);
            })
            .finally(function () {
              els.btnAddClass.disabled = false;
              els.btnAddClass.textContent = "â• æ–°å¢";
            });
        }

        function deleteBoard(boardId, boardName) {
          showConfirm(
            "ğŸ—‘ï¸",
            "åˆªé™¤ç­ç´šçœ‹æ¿",
            "ç¢ºå®šè¦åˆªé™¤ã€Œ" +
              boardName +
              "ã€å—ï¼Ÿ\næ‰€æœ‰å­¸ç”Ÿæˆç¸¾å°‡ä¸€ä½µåˆªé™¤ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚",
            function () {
              FirestoreLeaderboard.deleteClassBoard(boardId)
                .then(function () {
                  if (_currentBoardId === boardId) {
                    _currentBoardId = null;
                    _allEntries = [];
                  }
                  showToast("âœ… å·²åˆªé™¤ã€Œ" + boardName + "ã€");
                  loadBoards();
                })
                .catch(function (err) {
                  showToast("âŒ åˆªé™¤å¤±æ•—ï¼š" + err.message);
                });
            },
          );
        }

        function renderBoards() {
          if (_boards.length === 0) {
            els.classList.innerHTML =
              '<div class="empty-state" style="padding:16px">' +
              '<p class="empty-state__text">å°šæœªå»ºç«‹ç­ç´šçœ‹æ¿<br>é»æ“Šä¸Šæ–¹ã€Œâ• æ–°å¢ã€å»ºç«‹ç¬¬ä¸€å€‹ç­ç´š</p>' +
              "</div>";
            return;
          }

          var html = "";
          for (var i = 0; i < _boards.length; i++) {
            var b = _boards[i];
            html +=
              '<div class="class-chip" data-board-id="' +
              _escAttr(b.boardId) +
              '">' +
              '<div class="class-chip__info">' +
              "<span>ğŸ“–</span>" +
              "<span>" +
              _escHtml(b.boardName) +
              "</span>" +
              '<span class="class-chip__count">' +
              'ä»£ç¢¼ï¼š<strong style="color:#c9a0dc;letter-spacing:1px;">' +
              _escHtml(b.code) +
              "</strong>" +
              " Â· " +
              (b.entryCount || 0) +
              " ç­†æˆç¸¾</span>" +
              "</div>" +
              '<button class="class-chip__del" data-board-id="' +
              _escAttr(b.boardId) +
              '" data-board-name="' +
              _escAttr(b.boardName) +
              '" title="åˆªé™¤">ğŸ—‘ï¸</button>' +
              "</div>";
          }
          els.classList.innerHTML = html;
        }

        // =========================================
        // ç¯©é¸ï¼ˆé¸æ“‡çœ‹æ¿ï¼‰
        // =========================================
        function renderFilters() {
          var html =
            '<button class="filter-chip' +
            (_currentBoardId === null ? " active" : "") +
            '" data-filter="all">å…¨éƒ¨</button>';

          for (var i = 0; i < _boards.length; i++) {
            var b = _boards[i];
            html +=
              '<button class="filter-chip' +
              (_currentBoardId === b.boardId ? " active" : "") +
              '" data-filter="' +
              _escAttr(b.boardId) +
              '">' +
              _escHtml(b.boardName) +
              "</button>";
          }
          els.filterRow.innerHTML = html;
        }

        // =========================================
        // å­¸ç”Ÿæˆç¸¾
        // =========================================
        function loadEntries(boardId) {
          _currentBoardId = boardId;
          els.studentArea.innerHTML =
            '<div class="empty-state" style="padding:20px">' +
            '<p class="empty-state__text">â³ è¼‰å…¥ä¸­â€¦</p></div>';

          if (!boardId) {
            // å…¨éƒ¨æ¨¡å¼ï¼šè¼‰å…¥æ‰€æœ‰çœ‹æ¿çš„æˆç¸¾
            var promises = _boards.map(function (b) {
              return FirestoreLeaderboard.getClassBoardEntries(b.boardId).then(
                function (entries) {
                  entries.forEach(function (e) {
                    e._boardName = b.boardName;
                  });
                  return entries;
                },
              );
            });
            Promise.all(promises)
              .then(function (results) {
                _allEntries = [];
                results.forEach(function (arr) {
                  _allEntries = _allEntries.concat(arr);
                });
                renderStudents();
                updateStats();
              })
              .catch(function (err) {
                console.error("âŒ è¼‰å…¥æˆç¸¾å¤±æ•—:", err);
                els.studentArea.innerHTML =
                  '<div class="empty-state" style="padding:20px">' +
                  '<p class="empty-state__text">âŒ è¼‰å…¥å¤±æ•—ï¼š' +
                  _escHtml(err.message) +
                  "</p></div>";
              });
          } else {
            var boardObj = _boards.find(function (b) {
              return b.boardId === boardId;
            });
            FirestoreLeaderboard.getClassBoardEntries(boardId)
              .then(function (entries) {
                entries.forEach(function (e) {
                  e._boardName = boardObj ? boardObj.boardName : "æœªçŸ¥";
                });
                _allEntries = entries;
                renderStudents();
                updateStats();
              })
              .catch(function (err) {
                console.error("âŒ è¼‰å…¥æˆç¸¾å¤±æ•—:", err);
                els.studentArea.innerHTML =
                  '<div class="empty-state" style="padding:20px">' +
                  '<p class="empty-state__text">âŒ è¼‰å…¥å¤±æ•—</p></div>';
              });
          }
        }

        function renderStudents() {
          if (_allEntries.length === 0) {
            els.studentArea.innerHTML =
              '<div class="empty-state">' +
              '<div class="empty-state__icon">ğŸ“­</div>' +
              '<p class="empty-state__text">' +
              "å°šç„¡å­¸ç”Ÿæˆç¸¾<br>å­¸ç”Ÿåœ¨çµç®—é é¢ä¸Šå‚³å¾Œï¼Œæˆç¸¾å°‡å‡ºç¾æ–¼æ­¤" +
              "</p></div>";
            return;
          }

          // æ’åºï¼šåˆ†æ•¸é™åº
          var sorted = _allEntries.slice().sort(function (a, b) {
            return (b.score || 0) - (a.score || 0);
          });

          var html =
            '<div class="student-table-wrap"><table class="student-table">' +
            "<thead><tr>" +
            "<th>#</th><th>æš±ç¨±</th><th>ç­ç´š</th><th>åˆ†æ•¸</th><th>æº–ç¢ºç‡</th><th>å¹³å‡RT</th><th>â­</th>" +
            "</tr></thead><tbody>";

          for (var i = 0; i < sorted.length; i++) {
            var s = sorted[i];
            var rankText = "";
            if (i === 0) rankText = '<span class="rank-medal">ğŸ¥‡</span>';
            else if (i === 1) rankText = '<span class="rank-medal">ğŸ¥ˆ</span>';
            else if (i === 2) rankText = '<span class="rank-medal">ğŸ¥‰</span>';
            else rankText = String(i + 1);

            var accDisplay =
              s.accuracy != null
                ? (typeof s.accuracy === "number" && s.accuracy <= 1
                    ? Math.round(s.accuracy * 100)
                    : Math.round(s.accuracy)) + "%"
                : "-";

            html +=
              "<tr>" +
              "<td>" +
              rankText +
              "</td>" +
              "<td>" +
              _escHtml(s.nickname || "åŒ¿å") +
              "</td>" +
              "<td>" +
              _escHtml(s._boardName || "-") +
              "</td>" +
              "<td>" +
              (s.score || 0) +
              "</td>" +
              "<td>" +
              accDisplay +
              "</td>" +
              "<td>" +
              (s.avgRT ? Math.round(s.avgRT) + "ms" : "-") +
              "</td>" +
              "<td>" +
              (s.stars || 0) +
              "</td>" +
              "</tr>";
          }

          html += "</tbody></table></div>";
          els.studentArea.innerHTML = html;
        }

        // =========================================
        // çµ±è¨ˆæ‘˜è¦
        // =========================================
        function updateStats() {
          var totalGames = _allEntries.length;
          var totalAcc = 0;
          var accCount = 0;
          for (var i = 0; i < _allEntries.length; i++) {
            var acc = _allEntries[i].accuracy;
            if (acc != null) {
              // çµ±ä¸€ç‚ºç™¾åˆ†æ¯”
              totalAcc += typeof acc === "number" && acc <= 1 ? acc * 100 : acc;
              accCount++;
            }
          }
          var avgAcc = accCount > 0 ? Math.round(totalAcc / accCount) : 0;

          // å­¸ç”Ÿäººæ•¸å»é‡ï¼ˆæŒ‰ nicknameï¼‰
          var uniqueNames = {};
          for (var j = 0; j < _allEntries.length; j++) {
            var name = _allEntries[j].nickname || "åŒ¿å";
            uniqueNames[name] = true;
          }

          els.statStudents.textContent = Object.keys(uniqueNames).length;
          els.statClasses.textContent = _boards.length;
          els.statGames.textContent = totalGames;
          els.statAvgAcc.textContent = accCount > 0 ? avgAcc + "%" : "-";
        }

        // =========================================
        // è³‡æ–™ç®¡ç†ï¼ˆJSON åŒ¯å‡º/åŒ¯å…¥ï¼‰
        // =========================================
        function handleExport() {
          if (_allEntries.length === 0 && _boards.length === 0) {
            showToast("âš ï¸ æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™");
            return;
          }
          var data = {
            exportDate: new Date().toISOString(),
            boards: _boards.map(function (b) {
              return {
                boardId: b.boardId,
                boardName: b.boardName,
                code: b.code,
              };
            }),
            entries: _allEntries,
            version: "6.0-firestore",
          };
          var blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          var url = URL.createObjectURL(blob);
          var a = document.createElement("a");
          a.href = url;
          a.download =
            "efgame-teacher-" + new Date().toISOString().slice(0, 10) + ".json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast("âœ… è³‡æ–™å·²åŒ¯å‡ºï¼ˆå« " + _allEntries.length + " ç­†æˆç¸¾ï¼‰");
        }

        function handleImport(e) {
          var file = e.target.files && e.target.files[0];
          if (!file) return;
          if (!file.name.endsWith(".json")) {
            showToast("âŒ è«‹é¸æ“‡ .json æª”æ¡ˆ");
            els.importFileInput.value = "";
            return;
          }
          var reader = new FileReader();
          reader.onload = function (ev) {
            try {
              var data = JSON.parse(ev.target.result);
              // å‘å¾Œç›¸å®¹ï¼šèˆŠç‰ˆåŒ¯å‡ºæ ¼å¼
              if (data.classes && !data.boards) {
                showToast(
                  "â„¹ï¸ åµæ¸¬åˆ°èˆŠç‰ˆæ ¼å¼ã€‚ç­ç´šåç¨±å·²è¼‰å…¥ï¼Œä½†å­¸ç”Ÿè³‡æ–™éœ€å¾é›²ç«¯è®€å–ã€‚",
                );
              } else if (data.boards) {
                showToast(
                  "âœ… åŒ¯å…¥æˆåŠŸï¼çœ‹æ¿è³‡è¨Šå·²è¼‰å…¥ã€‚\næ³¨æ„ï¼šé›²ç«¯è³‡æ–™ä»¥ Firestore ç‚ºæº–ã€‚",
                );
              }
              loadBoards(); // é‡æ–°å¾ Firestore è¼‰å…¥
            } catch (err) {
              showToast("âŒ åŒ¯å…¥å¤±æ•—ï¼š" + err.message);
            }
          };
          reader.readAsText(file);
          els.importFileInput.value = "";
        }

        function handleRefresh() {
          showToast("ğŸ”„ é‡æ–°è¼‰å…¥ä¸­â€¦");
          loadBoards();
        }

        // =========================================
        // Toast
        // =========================================
        var _toastTimer = null;
        function showToast(msg) {
          if (_toastTimer) clearTimeout(_toastTimer);
          els.toast.textContent = msg;
          els.toast.classList.add("show");
          _toastTimer = setTimeout(function () {
            els.toast.classList.remove("show");
          }, 3000);
        }

        // =========================================
        // ç¢ºèªå½ˆçª—
        // =========================================
        function showConfirm(icon, title, msg, onOk) {
          var overlay = document.getElementById("confirmOverlay");
          document.getElementById("confirmIcon").textContent = icon;
          document.getElementById("confirmTitle").textContent = title;
          document.getElementById("confirmMsg").textContent = msg;
          overlay.classList.add("show");

          var okBtn = document.getElementById("confirmOk");
          var cancelBtn = document.getElementById("confirmCancel");

          function cleanup() {
            overlay.classList.remove("show");
            okBtn.removeEventListener("click", onConfirm);
            cancelBtn.removeEventListener("click", onCancel);
          }
          function onConfirm() {
            cleanup();
            if (onOk) onOk();
          }
          function onCancel() {
            cleanup();
          }
          okBtn.addEventListener("click", onConfirm);
          cancelBtn.addEventListener("click", onCancel);
        }

        // =========================================
        // Util
        // =========================================
        function _escHtml(s) {
          var div = document.createElement("div");
          div.textContent = s;
          return div.innerHTML;
        }
        function _escAttr(s) {
          return s
            .replace(/&/g, "&amp;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        // =========================================
        // äº‹ä»¶ç¶å®š
        // =========================================
        function bindEvents() {
          // æ–°å¢çœ‹æ¿
          els.btnAddClass.addEventListener("click", addBoard);
          els.boardNameInput.addEventListener("keydown", function (e) {
            if (e.key === "Enter") addBoard();
          });

          // åˆªé™¤çœ‹æ¿ï¼ˆäº‹ä»¶å§”æ´¾ï¼‰
          els.classList.addEventListener("click", function (e) {
            var btn = e.target.closest(".class-chip__del");
            if (!btn) return;
            var boardId = btn.getAttribute("data-board-id");
            var boardName = btn.getAttribute("data-board-name");
            if (boardId) deleteBoard(boardId, boardName);
          });

          // ç¯©é¸ï¼ˆäº‹ä»¶å§”æ´¾ï¼‰
          els.filterRow.addEventListener("click", function (e) {
            var chip = e.target.closest(".filter-chip");
            if (!chip) return;
            var filter = chip.getAttribute("data-filter");
            if (filter === "all") {
              _currentBoardId = null;
            } else {
              _currentBoardId = filter;
            }
            renderFilters();
            loadEntries(_currentBoardId);
          });

          // åŒ¯å‡º
          els.btnExport.addEventListener("click", handleExport);

          // åŒ¯å…¥ï¼ˆæ”¹ç‚ºé‡æ–°æ•´ç†ï¼‰
          els.btnImport.addEventListener("click", function () {
            els.importFileInput.click();
          });
          els.importFileInput.addEventListener("change", handleImport);

          // æ¸…é™¤æ”¹ç‚ºé‡æ–°æ•´ç†
          els.btnClearAll.addEventListener("click", handleRefresh);
        }

        // =========================================
        // æ¸²æŸ“å…¨éƒ¨
        // =========================================
        function renderAll() {
          renderBoards();
          renderFilters();
          // è‡ªå‹•è¼‰å…¥æ‰€æœ‰çœ‹æ¿çš„æˆç¸¾
          loadEntries(_currentBoardId);
        }

        // =========================================
        // Init
        // =========================================
        function init() {
          cacheDom();
          bindEvents();
          initAuth();
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init);
        } else {
          init();
        }
      })();
    </script>
  </body>
</html>
