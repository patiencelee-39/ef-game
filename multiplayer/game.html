<!doctype html>
<html lang="zh-TW" data-theme="field-primary">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://*.firebasedatabase.app https://*.firebaseio.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app"
    />
    <title>執行功能訓練遊戲 — 多人模式</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />

    <!-- CSS -->
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link
      rel="preload"
      href="../css/components/landscape-hint.css"
      as="style"
      onload="this.rel = 'stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="../css/components/landscape-hint.css"
    /></noscript>
    <link rel="stylesheet" href="../css/pages/game.css" />
    <link rel="stylesheet" href="../css/pages/game-multiplayer.css" />
    <!-- Firebase Bundle -->
    <script defer src="../js/firebase-bundle.js"></script>
    <!-- Game config -->
    <script defer src="../js/game-config.js"></script>
    <script defer src="../js/adaptive/difficulty-provider.js"></script>
    <script defer src="../js/adaptive/simple-adaptive-engine.js"></script>
    <script defer src="../js/svg-assets.js"></script>
    <script defer src="../js/shared/trial-renderer.js"></script>
    <!-- Utils -->
    <script defer src="../js/utils/storage.js"></script>
    <script defer src="../js/utils/score-calculator.js"></script>
    <script defer src="../js/utils/level-calculator.js"></script>
    <script defer src="../js/utils/badge-checker.js"></script>
    <script defer src="../js/utils/question-generator.js"></script>
    <!-- Shared components -->
    <script defer src="../js/sound-config.js"></script>
    <script defer src="../js/shared/audio-player.js"></script>
    <script defer src="../js/shared/countdown.js"></script>
    <script defer src="../js/shared/focus-trap.js"></script>
    <script defer src="../js/shared/feedback-overlay.js"></script>
    <script defer src="../js/shared/working-memory.js"></script>
    <script defer src="../js/shared/completion-notify.js"></script>
    <script defer src="../js/shared/game-session-builder.js"></script>
    <!-- Singleplayer core (reused) -->
    <script defer src="../js/singleplayer/progress-tracker.js"></script>
    <script defer src="../js/singleplayer/mode-controller.js"></script>
    <!-- Multiplayer sync -->
    <script defer src="../js/multiplayer/game-sync.js"></script>
    <script defer src="../js/shared/landscape-hint.js"></script>
  </head>

  <body>
    <a href="#main-content" class="skip-link">跳到主要內容</a>
    <main class="game-page" id="main-content">
      <h1 class="sr-only">多人遊戲</h1>
      <div class="game-header">
        <button id="btnBack" class="header-btn" aria-label="返回" title="返回">
          &#x2190;
        </button>
        <div id="headerTitle" class="game-header-title">多人模式 — 載入中…</div>
        <span
          class="difficulty-badge"
          id="diffBadge"
          title="自適應難度"
          role="img"
          aria-label="目前難度"
        >
          <span class="diff-dots" id="diffDots"></span>
        </span>
        <button id="btnPause" class="header-btn" aria-label="暫停" title="暫停">
          &#x23F8;
        </button>
      </div>

      <div class="game-play-area" id="gameContainer">
        <div id="rule-intro-screen" class="screen">
          <div class="rule-intro">
            <h2 id="ruleIntroTitle"></h2>
            <div id="ruleIntroBoxes" class="rule-box-group"></div>
            <div id="ruleIntroContext" class="context-notice hidden"></div>
            <div id="ruleIntroWM" class="wm-notice-tag hidden">
              &#x1F9E0; 本組含工作記憶測驗
            </div>
            <button id="btnRuleStart" class="btn btn-primary">
              &#x25B6;&#xFE0F; 開始
            </button>
          </div>
        </div>

        <div id="play-screen" class="screen">
          <div class="trial-info">
            <span id="roundLabel" class="round-label"></span>
            <span class="trial-counter" aria-live="polite" aria-atomic="true">
              <span id="trialCurrent">0</span> / <span id="trialTotal">0</span>
            </span>
            <div
              class="progress-bar-container"
              role="progressbar"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
              aria-label="遊戲進度"
            >
              <div id="progressBar" class="progress-bar"></div>
            </div>
          </div>
          <div class="stimulus-container" id="stimulusContainer">
            <div id="backgroundLayer"></div>
            <div id="contextIndicator"></div>
            <div id="stimulus"></div>
          </div>
          <div class="control-area">
            <button id="btnSpace" class="btn-key" disabled>
              <span id="btnLabel">準備中…</span>
              <span class="key-hint">按空白鍵 或 點此</span>
            </button>
          </div>
        </div>

        <div id="spectator-screen" class="screen">
          <div class="spectator-dashboard">
            <h2>&#x1F441;&#xFE0F; 觀戰模式</h2>
            <p style="text-align: center; color: var(--text-light)">
              即時查看所有玩家進度
            </p>
            <div id="spectatorPlayerList" class="spectator-player-list">
              <p style="text-align: center; color: var(--text-light)">
                等待玩家資料…
              </p>
            </div>
            <div style="text-align: center; margin-top: 1rem">
              <button
                class="btn btn-secondary"
                onclick="location.href = '../index.html'"
              >
                &#x1F6AA; 離開
              </button>
            </div>
          </div>
        </div>

        <div id="wm-container" class="hidden"></div>
        <div id="combo-transition-container" class="hidden"></div>

        <div
          id="pause-overlay"
          role="dialog"
          aria-modal="true"
          aria-label="暫停選單"
        >
          <h2>&#x23F8; 暫停</h2>
          <p style="color: var(--text-light)">遊戲已暫停，按下方按鈕繼續</p>
          <button id="btnResume" class="btn btn-primary">
            &#x25B6;&#xFE0F; 繼續
          </button>
          <button
            id="btnQuit"
            class="btn btn-secondary"
            style="margin-top: 8px"
          >
            &#x1F6AA; 結束遊戲
          </button>
        </div>

        <!-- 離開確認覆蓋 -->
        <div
          id="exit-confirm-overlay"
          role="dialog"
          aria-modal="true"
          aria-label="離開遊戲確認"
        >
          <h2>🚪 離開遊戲？</h2>
          <p>確定要離開嗎？<br />已作答的題目仍會保存。</p>
          <div class="exit-confirm-btns">
            <button id="btnExitCancel" class="btn btn-primary">繼續遊戲</button>
            <button id="btnExitConfirm" class="btn btn-secondary">
              確定離開
            </button>
          </div>
        </div>
      </div>

      <!-- 即時 Mini 排行榜（浮動） -->
      <div class="live-leaderboard" id="liveLeaderboard" style="display: none">
        <div class="live-lb__title" id="lbToggle">
          <span>🏆 即時排行</span>
          <button class="live-lb__toggle" id="btnLbToggle">◀</button>
        </div>
        <div id="liveLeaderboardBody"></div>
      </div>
    </main>

    <!-- 等待其他玩家覆蓋 -->
    <div id="waiting-overlay">
      <h2>⏳ 等待其他玩家完成</h2>
      <p class="waiting-count" id="waitingCount">0 / 0 位玩家已完成</p>
      <p>
        <span class="waiting-dots">
          <span>.</span><span>.</span><span>.</span>
        </span>
      </p>
      <button
        class="btn btn-secondary"
        id="btnSkipWait"
        style="margin-top: 1rem"
      >
        跳過等待，直接看結果
      </button>
    </div>

    <script defer src="../js/multiplayer/multiplayer-bridge.js"></script>
    <script defer src="../js/multiplayer/game-controller.js"></script>
  </body>
</html>
