<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app"
    />
    <title>éŠæˆ²çµæœ - åŸ·è¡ŒåŠŸèƒ½éŠæˆ²</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/components/landscape-hint.css" />
    <style>
      /* result é é¢è¦†å¯« */
      body {
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 40px;
        max-width: 800px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .celebration {
        font-size: 5rem;
        margin-bottom: 20px;
        animation: bounce 1s ease-in-out;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-30px);
        }
      }

      .header h1 {
        color: var(--primary-blue);
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        color: rgba(255, 255, 255, 0.6);
        font-size: 1.1rem;
      }

      /* åˆ†æ•¸å¡ç‰‡ */
      .score-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
      }

      .score-card::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 70%
        );
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translate(-50%, -50%);
        }
        100% {
          transform: translate(50%, 50%);
        }
      }

      .score-card .label {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
      }

      .score-card .value {
        font-size: 5rem;
        font-weight: bold;
        position: relative;
        z-index: 1;
      }

      .score-card .rank {
        font-size: 1.3rem;
        margin-top: 15px;
        opacity: 0.95;
        position: relative;
        z-index: 1;
      }

      /* çµ±è¨ˆè³‡è¨Š */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        transition: transform 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--text-white);
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
      }

      /* è©³ç´°åˆ†æ */
      .analysis-section {
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 1.3rem;
        color: var(--text-white);
        margin-bottom: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .accuracy-bar {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 25px;
        height: 50px;
        overflow: hidden;
        margin-bottom: 20px;
        position: relative;
      }

      .accuracy-fill {
        height: 100%;
        background: linear-gradient(90deg, #55efc4 0%, #00b894 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        transition: width 2s ease-out;
      }

      .stage-breakdown {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .stage-item {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .stage-icon-box {
        font-size: 2rem;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
      }

      .stage-details {
        flex: 1;
      }

      .stage-name {
        font-weight: 600;
        color: var(--text-white);
        margin-bottom: 8px;
      }

      .stage-progress {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .mini-bar {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
      }

      .mini-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      }

      .stage-stats {
        text-align: right;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
      }

      /* æŒ‰éˆ•å€åŸŸ */
      .actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 15px 40px;
        border: none;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-light);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .btn-success {
        background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(85, 239, 196, 0.3);
      }

      /* çç«  */
      .badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin: 5px;
      }

      .badge-gold {
        background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
        color: #2d3436;
      }

      .badge-silver {
        background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
        color: #2d3436;
      }

      .badge-bronze {
        background: linear-gradient(135deg, #fab1a0 0%, #e17055 100%);
        color: white;
      }

      .badges-section {
        text-align: center;
        margin-bottom: 30px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 25px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .score-card .value {
          font-size: 3.5rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
    <link rel="stylesheet" href="../css/components/navbar.css" />
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="../js/firebase-config.js"></script>
    <!-- åŠŸèƒ½æ¨¡çµ„ -->
    <script defer src="../js/shared/leaderboard-writer.js"></script>
    <script defer src="../js/shared/firestore-leaderboard.js"></script>
    <script defer src="../js/sound-config.js"></script>
    <script defer src="../js/shared/audio-player.js"></script>
    <script defer src="../js/shared/navbar.js"></script>
    <script defer src="../js/shared/landscape-hint.js"></script>
  </head>
  <body>
    <main class="container" id="main-content">
      <div class="header">
        <div class="celebration" id="celebration">ğŸ‰</div>
        <h1>éŠæˆ²å®Œæˆï¼</h1>
        <p>æ­å–œä½ å®Œæˆäº†æ‰€æœ‰æŒ‘æˆ°</p>
      </div>

      <!-- åˆ†æ•¸å¡ç‰‡ -->
      <div class="score-card">
        <div class="label">æœ€çµ‚åˆ†æ•¸</div>
        <div class="value" id="finalScore">0</div>
        <div class="rank" id="rankInfo">æ­£åœ¨è¨ˆç®—æ’å...</div>
      </div>

      <!-- ç²å¾—çç«  -->
      <div class="badges-section" id="badgesSection">
        <!-- çç« å°‡å‹•æ…‹ç”Ÿæˆ -->
      </div>

      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ¯</div>
          <div class="stat-value" id="accuracyValue">0%</div>
          <div class="stat-label">æº–ç¢ºç‡</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âš¡</div>
          <div class="stat-value" id="avgTimeValue">0s</div>
          <div class="stat-label">å¹³å‡åæ‡‰æ™‚é–“</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âœ“</div>
          <div class="stat-value" id="correctValue">0</div>
          <div class="stat-label">ç­”å°é¡Œæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â±ï¸</div>
          <div class="stat-value" id="totalTimeValue">0s</div>
          <div class="stat-label">ç¸½éŠæˆ²æ™‚é–“</div>
        </div>
      </div>

      <!-- è©³ç´°åˆ†æ -->
      <div class="analysis-section">
        <div class="section-title">ğŸ“Š æº–ç¢ºç‡åˆ†æ</div>
        <div class="accuracy-bar">
          <div class="accuracy-fill" id="accuracyBar" style="width: 0%">0%</div>
        </div>
      </div>

      <div class="analysis-section">
        <div class="section-title">ğŸ® å ´åœ°è¡¨ç¾</div>
        <div class="stage-breakdown" id="stageBreakdown">
          <!-- å ´åœ°çµ±è¨ˆå°‡å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>

      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="actions">
        <button class="btn btn-success" onclick="shareResult()">
          ğŸ“¤ åˆ†äº«çµæœ
        </button>
        <button class="btn btn-primary" onclick="playAgain()">
          ğŸ”„ å†ç©ä¸€æ¬¡
        </button>
        <button
          class="btn btn-success"
          id="btnUploadClass"
          style="
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
          "
        >
          ğŸ“¤ ä¸Šå‚³è‡³ç­ç´šæ’è¡Œæ¦œ
        </button>
        <div
          id="uploadCodeRow"
          style="display: none; gap: 8px; margin-top: 8px; width: 100%"
        >
          <input
            id="uploadCodeInput"
            placeholder="è¼¸å…¥ 6 ä½ä»£ç¢¼"
            maxlength="6"
            style="
              flex: 1;
              padding: 8px 12px;
              border: 2px solid #ddd;
              border-radius: 8px;
              font-size: 1rem;
              font-weight: 700;
              text-align: center;
              letter-spacing: 2px;
              text-transform: uppercase;
            "
          />
          <button
            id="uploadCodeSubmit"
            class="btn btn-primary"
            style="padding: 8px 16px; font-size: 0.9rem"
          >
            ä¸Šå‚³
          </button>
        </div>
        <div
          id="uploadStatusMsg"
          style="
            text-align: center;
            font-size: 0.85rem;
            min-height: 24px;
            width: 100%;
          "
        ></div>
        <button
          class="btn btn-success"
          id="btnUploadWorld"
          style="
            background: linear-gradient(135deg, #00c9ff, #92fe9d);
            color: #1a1a2e;
            border: none;
            font-weight: 700;
          "
        >
          ğŸŒ ä¸Šå‚³è‡³ä¸–ç•Œæ’è¡Œæ¦œ
        </button>
        <div
          id="worldUploadNotice"
          style="
            display: none;
            font-size: 0.78rem;
            color: #999;
            text-align: center;
            padding: 2px 16px 0;
            line-height: 1.4;
            width: 100%;
          "
        >
          ğŸ“‹ ä¸Šå‚³å¾Œï¼Œä½ çš„æš±ç¨±èˆ‡æœ¬æ¬¡æˆç¸¾å°‡å…¬é–‹é¡¯ç¤ºæ–¼ä¸–ç•Œæ’è¡Œæ¦œã€‚<br />ç›¸åŒè£ç½®å†æ¬¡ä¸Šå‚³æœƒè¦†è“‹å…ˆå‰ç´€éŒ„ã€‚è³‡æ–™åƒ…ä¾›æ’åå±•ç¤ºï¼Œä¸æœƒç”¨æ–¼å…¶ä»–ç”¨é€”ã€‚
        </div>
        <div
          id="worldUploadStatus"
          style="
            text-align: center;
            font-size: 0.85rem;
            min-height: 24px;
            width: 100%;
          "
        ></div>
      </div>
    </main>

    <script>
      let resultData = null;

      // åˆå§‹åŒ–
      window.addEventListener("DOMContentLoaded", () => {
        // ğŸ”Š åˆå§‹åŒ–éŸ³è¨Š
        if (typeof AudioPlayer !== "undefined" && AudioPlayer.init) {
          AudioPlayer.init();
        }
        loadResults();
      });

      function loadResults() {
        // å¾ localStorage ç²å–çµæœ
        const savedResult = localStorage.getItem("gameResult");
        if (!savedResult) {
          alert("æœªæ‰¾åˆ°éŠæˆ²çµæœ");
          window.location.href = "../index.html";
          return;
        }

        resultData = JSON.parse(savedResult);

        // å¯«å…¥æ’è¡Œæ¦œï¼ˆP0-3 ä¿®å¾©ï¼šæ’è¡Œæ¦œè³‡æ–™å¾æœªè¢«å¯«å…¥ï¼‰
        if (typeof LeaderboardWriter !== "undefined") {
          LeaderboardWriter.recordFromMultiplayer(resultData);
        }

        displayResults();

        // ğŸ”Š æ’­æ”¾çµç®—éŸ³æ•ˆ
        if (typeof AudioPlayer !== "undefined" && AudioPlayer.playSfx) {
          AudioPlayer.playSfx(
            typeof getSoundFile === "function"
              ? getSoundFile("feedback.complete")
              : null,
            { synthPreset: "complete" },
          );
        }
      }

      function displayResults() {
        // åŸºæœ¬åˆ†æ•¸
        document.getElementById("finalScore").textContent = resultData.score;
        document.getElementById("accuracyValue").textContent =
          resultData.accuracy.toFixed(1) + "%";
        document.getElementById("correctValue").textContent =
          `${resultData.correctAnswers}/${resultData.totalQuestions}`;
        document.getElementById("totalTimeValue").textContent =
          (resultData.totalTime / 1000).toFixed(1) + "s";

        // è¨ˆç®—å¹³å‡åæ‡‰æ™‚é–“ï¼ˆç›¸å®¹ rt / reactionTime å…©ç¨®æ¬„ä½ï¼‰
        const validRTs = (resultData.answers || []).filter(
          (a) => (a.rt || a.reactionTime) > 0,
        );
        const avgTime =
          validRTs.length > 0
            ? validRTs.reduce(
                (sum, a) => sum + (a.rt || a.reactionTime || 0),
                0,
              ) / validRTs.length
            : 0;
        document.getElementById("avgTimeValue").textContent =
          (avgTime / 1000).toFixed(2) + "s";

        // æº–ç¢ºç‡é€²åº¦æ¢å‹•ç•«
        setTimeout(() => {
          const bar = document.getElementById("accuracyBar");
          bar.style.width = resultData.accuracy + "%";
          bar.textContent = resultData.accuracy.toFixed(1) + "%";
        }, 300);

        // ç²å¾—çç« 
        displayBadges();

        // å ´åœ°åˆ†æ
        displayStageBreakdown();

        // æ…¶ç¥å‹•ç•«
        if (resultData.accuracy >= 90) {
          document.getElementById("celebration").textContent = "ğŸ†";
        } else if (resultData.accuracy >= 70) {
          document.getElementById("celebration").textContent = "ğŸ‰";
        } else {
          document.getElementById("celebration").textContent = "ğŸ’ª";
        }

        // è¨ˆç®—æ’åï¼ˆå¦‚æœæ˜¯å¤šäººæ¨¡å¼ï¼‰
        calculateRank();
      }

      function displayBadges() {
        const badges = [];

        // æ ¹æ“šè¡¨ç¾çµ¦äºˆçç« 
        if (resultData.accuracy === 100) {
          badges.push({ text: "ğŸ¯ å®Œç¾è¡¨ç¾", class: "badge-gold" });
        } else if (resultData.accuracy >= 90) {
          badges.push({ text: "â­ å„ªç§€è¡¨ç¾", class: "badge-gold" });
        } else if (resultData.accuracy >= 70) {
          badges.push({ text: "ğŸ‘ è‰¯å¥½è¡¨ç¾", class: "badge-silver" });
        }

        // é€Ÿåº¦çç« 
        const validRTs2 = (resultData.answers || []).filter(
          (a) => (a.rt || a.reactionTime) > 0,
        );
        const avgTime =
          validRTs2.length > 0
            ? validRTs2.reduce(
                (sum, a) => sum + (a.rt || a.reactionTime || 0),
                0,
              ) / validRTs2.length
            : 9999;
        if (avgTime < 1000) {
          badges.push({ text: "âš¡ é–ƒé›»åæ‡‰", class: "badge-gold" });
        } else if (avgTime < 1500) {
          badges.push({ text: "ğŸš€ å¿«é€Ÿåæ‡‰", class: "badge-silver" });
        }

        // å®Œæˆçç« 
        badges.push({ text: "âœ… æŒ‘æˆ°å®Œæˆ", class: "badge-bronze" });

        // é¡¯ç¤ºçç« 
        const badgesSection = document.getElementById("badgesSection");
        if (badges.length > 0) {
          badges.forEach((badge) => {
            const span = document.createElement("span");
            span.className = `badge ${badge.class}`;
            span.textContent = badge.text;
            badgesSection.appendChild(span);
          });
        }
      }

      function displayStageBreakdown() {
        // æŒ‰å ´åœ°åˆ†çµ„çµ±è¨ˆ
        const stageStats = {};

        (resultData.answers || []).forEach((answer) => {
          // ç›¸å®¹å¤šç¨®è³‡æ–™æ ¼å¼ï¼šstageId > fieldId > 'unknown'
          var key = answer.stageId || answer.context || "game";
          if (!stageStats[key]) {
            stageStats[key] = {
              total: 0,
              correct: 0,
            };
          }
          stageStats[key].total++;
          if (answer.isCorrect) {
            stageStats[key].correct++;
          }
        });

        // å ´åœ°è³‡è¨Šå°æ‡‰
        const stageInfo = {
          A: { name: "å ´åœ°Aï¼šèµ·å¸æ£®æ—", icon: "ğŸ§€" },
          B: { name: "å ´åœ°Bï¼šäººé¡æ‘èŠ", icon: "ğŸ§‘" },
          C: { name: "å ´åœ°Cï¼šæµ·æ´‹ä¸–ç•Œ", icon: "ğŸŸ" },
          D: { name: "å ´åœ°Dï¼šæ™å¤œè¿·å®®", icon: "ğŸŒ™" },
          E: { name: "å ´åœ°Eï¼šè½‰æ›æ˜Ÿçƒ", icon: "ğŸ”„" },
          F: { name: "å ´åœ°Fï¼šè€åŠ›è³½é“", icon: "ğŸ’ª" },
          G: { name: "å ´åœ°Gï¼šæ¥µé€ŸæŒ‘æˆ°", icon: "âš¡" },
          H: { name: "å ´åœ°Hï¼šå¤§å¸«è€ƒé©—", icon: "ğŸ‘‘" },
        };

        const breakdown = document.getElementById("stageBreakdown");
        breakdown.innerHTML = "";

        Object.entries(stageStats).forEach(([stageId, stats]) => {
          const info = stageInfo[stageId] || {
            name: `å ´åœ° ${stageId}`,
            icon: "ğŸ¯",
          };
          const accuracy = ((stats.correct / stats.total) * 100).toFixed(1);

          const item = document.createElement("div");
          item.className = "stage-item";
          item.innerHTML = `
            <div class="stage-icon-box">${info.icon}</div>
            <div class="stage-details">
              <div class="stage-name">${info.name}</div>
              <div class="stage-progress">
                <div class="mini-bar">
                  <div class="mini-bar-fill" style="width: ${accuracy}%"></div>
                </div>
                <span>${accuracy}%</span>
              </div>
            </div>
            <div class="stage-stats">
              ${stats.correct}/${stats.total} æ­£ç¢º
            </div>
          `;
          breakdown.appendChild(item);
        });
      }

      async function calculateRank() {
        // å¦‚æœæ˜¯å¤šäººæ¨¡å¼ï¼Œå¾ Firebase å³æ™‚ç›£è½å…¶ä»–ç©å®¶æˆç¸¾
        const roomData = localStorage.getItem("currentRoom");
        const urlRoom = new URLSearchParams(window.location.search).get("room");

        if (!roomData && !urlRoom) {
          document.getElementById("rankInfo").textContent = "å–®äººæ¨¡å¼";
          return;
        }

        let roomCode = urlRoom;
        if (!roomCode && roomData) {
          try {
            const room = JSON.parse(roomData);
            roomCode = room.code || room.roomCode;
          } catch (e) {}
        }
        if (!roomCode) {
          document.getElementById("rankInfo").textContent = "å–®äººæ¨¡å¼";
          return;
        }

        const rankEl = document.getElementById("rankInfo");
        rankEl.textContent = "ç­‰å¾…å…¶ä»–ç©å®¶å®Œæˆâ€¦";

        const roomRef = firebase
          .database()
          .ref("rooms/" + roomCode + "/scores");

        // å³æ™‚ç›£è½ï¼ˆè€Œé .onceï¼‰
        roomRef.on("value", function (snapshot) {
          const results = snapshot.val();
          if (!results) {
            rankEl.textContent = "ç­‰å¾…å…¶ä»–ç©å®¶å®Œæˆâ€¦";
            return;
          }

          const allResults = Object.entries(results)
            .map(([uid, data]) => ({
              playerId: uid,
              score: data.totalScore || 0,
              nickname: data.nickname || "ç©å®¶",
            }))
            .sort((a, b) => b.score - a.score);

          const myId =
            resultData.playerId ||
            (firebase.auth().currentUser && firebase.auth().currentUser.uid);
          const myRank = allResults.findIndex((r) => r.playerId === myId) + 1;
          const totalPlayers = allResults.length;

          let rankText = "";
          if (myRank === 1) {
            rankText = "ğŸ¥‡ ç¬¬ 1 å / " + totalPlayers + " äºº";
          } else if (myRank === 2) {
            rankText = "ğŸ¥ˆ ç¬¬ 2 å / " + totalPlayers + " äºº";
          } else if (myRank === 3) {
            rankText = "ğŸ¥‰ ç¬¬ 3 å / " + totalPlayers + " äºº";
          } else if (myRank > 0) {
            rankText = "ç¬¬ " + myRank + " å / " + totalPlayers + " äºº";
          } else {
            rankText = "è¨ˆç®—ä¸­â€¦ (" + totalPlayers + " äººå·²å®Œæˆ)";
          }

          rankEl.textContent = rankText;
        });
      }

      function shareResult() {
        const shareText = `æˆ‘åœ¨åŸ·è¡ŒåŠŸèƒ½éŠæˆ²ä¸­ç²å¾—äº† ${resultData.score} åˆ†ï¼æº–ç¢ºç‡ ${resultData.accuracy.toFixed(1)}%ï¼å¿«ä¾†æŒ‘æˆ°çœ‹çœ‹ï¼`;

        if (navigator.share) {
          navigator
            .share({
              title: "åŸ·è¡ŒåŠŸèƒ½éŠæˆ² - æˆ‘çš„æˆç¸¾",
              text: shareText,
            })
            .catch(() => {
              // åˆ†äº«å¤±æ•—ï¼Œæ”¹ç”¨è¤‡è£½
              copyToClipboard(shareText);
            });
        } else {
          copyToClipboard(shareText);
        }
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          alert("æˆç¸¾å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
        });
      }

      function playAgain() {
        // æ¸…é™¤éŠæˆ²è¨˜éŒ„
        localStorage.removeItem("gameResult");

        // è¿”å›é¦–é 
        window.location.href = "../index.html";
      }

      // === ä¸Šå‚³è‡³ç­ç´šæ’è¡Œæ¦œ ===
      (function () {
        var btn = document.getElementById("btnUploadClass");
        var codeRow = document.getElementById("uploadCodeRow");
        var codeInput = document.getElementById("uploadCodeInput");
        var codeSubmit = document.getElementById("uploadCodeSubmit");
        var statusMsg = document.getElementById("uploadStatusMsg");
        if (!btn) return;

        btn.addEventListener("click", function () {
          codeRow.style.display =
            codeRow.style.display === "none" ? "flex" : "none";
          if (codeRow.style.display === "flex") codeInput.focus();
        });
        codeSubmit.addEventListener("click", doUpload);
        codeInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter") doUpload();
        });

        function doUpload() {
          var code = codeInput.value.trim().toUpperCase();
          if (!code || code.length < 4) {
            codeInput.style.borderColor = "#e74c3c";
            codeInput.focus();
            return;
          }
          if (typeof FirestoreLeaderboard === "undefined") {
            statusMsg.textContent = "âŒ ä¸Šå‚³æ¨¡çµ„æœªè¼‰å…¥";
            statusMsg.style.color = "#e74c3c";
            return;
          }
          codeSubmit.disabled = true;
          codeSubmit.textContent = "ä¸Šå‚³ä¸­â€¦";
          statusMsg.textContent = "";
          statusMsg.style.color = "";

          var authP = firebase.auth().currentUser
            ? Promise.resolve()
            : firebase.auth().signInAnonymously();
          authP
            .then(function () {
              return FirestoreLeaderboard.findBoardByCode(code);
            })
            .then(function (board) {
              if (!board) throw new Error("æ‰¾ä¸åˆ°æ­¤ä»£ç¢¼å°æ‡‰çš„çœ‹æ¿");
              var d = resultData || {};
              var entry = {
                nickname: d.playerName || d.nickname || "ç©å®¶",
                score: d.score || 0,
                accuracy: d.accuracy || 0,
                avgRT: d.avgRT || 0,
                stars: 0,
                level: "",
                mode: "multiplayer",
              };
              return FirestoreLeaderboard.uploadToClassBoard(
                board.boardId,
                entry,
              );
            })
            .then(function () {
              statusMsg.textContent = "âœ… ä¸Šå‚³æˆåŠŸï¼";
              statusMsg.style.color = "#4caf50";
            })
            .catch(function (err) {
              statusMsg.textContent = "âŒ " + err.message;
              statusMsg.style.color = "#e74c3c";
            })
            .finally(function () {
              codeSubmit.disabled = false;
              codeSubmit.textContent = "ä¸Šå‚³";
            });
        }
      })();

      // === ä¸Šå‚³è‡³ä¸–ç•Œæ’è¡Œæ¦œ ===
      (function () {
        var btn = document.getElementById("btnUploadWorld");
        var notice = document.getElementById("worldUploadNotice");
        var statusMsg = document.getElementById("worldUploadStatus");
        if (!btn) return;

        btn.addEventListener("click", function () {
          // é»æ“Šå¾Œéš±è—åŸæŒ‰éˆ•ï¼Œé¡¯ç¤ºç¢ºèªåˆ—ï¼ˆå–æ¶ˆ + ä¸Šå‚³ï¼‰
          btn.style.display = "none";
          notice.style.display = "block";
          // å‹•æ…‹å»ºç«‹ç¢ºèªåˆ—
          if (!document.getElementById("worldUploadConfirmRow")) {
            var row = document.createElement("div");
            row.id = "worldUploadConfirmRow";
            row.style.cssText =
              "display:flex;gap:10px;width:100%;margin-top:8px;";
            var cancelBtn = document.createElement("button");
            cancelBtn.className = "btn";
            cancelBtn.style.cssText =
              "flex:1;background:rgba(255,255,255,0.1);color:#aaa;border:1px solid rgba(255,255,255,0.15);padding:0.6rem;border-radius:10px;font-size:0.95rem;cursor:pointer;";
            cancelBtn.textContent = "å–æ¶ˆ";
            cancelBtn.addEventListener("click", function () {
              row.style.display = "none";
              notice.style.display = "none";
              btn.style.display = "";
            });
            var confirmBtn = document.createElement("button");
            confirmBtn.className = "btn";
            confirmBtn.style.cssText =
              "flex:1;background:linear-gradient(135deg,#00c9ff,#92fe9d);color:#1a1a2e;font-weight:700;padding:0.6rem;border:none;border-radius:10px;font-size:0.95rem;cursor:pointer;";
            confirmBtn.textContent = "ä¸Šå‚³";
            confirmBtn.addEventListener("click", function () {
              // çœŸæ­£ä¸Šå‚³
              if (typeof FirestoreLeaderboard === "undefined") {
                statusMsg.textContent = "âŒ ä¸Šå‚³æ¨¡çµ„æœªè¼‰å…¥";
                statusMsg.style.color = "#e74c3c";
                return;
              }
              confirmBtn.disabled = true;
              confirmBtn.textContent = "ä¸Šå‚³ä¸­â€¦";
              statusMsg.textContent = "";
              statusMsg.style.color = "";

              var authP = firebase.auth().currentUser
                ? Promise.resolve()
                : firebase.auth().signInAnonymously();
              authP
                .then(function () {
                  var d = resultData || {};
                  // è¨ˆç®—å¹³å‡ RT
                  var validRTs = (d.answers || []).filter(function (a) {
                    return (a.rt || a.reactionTime) > 0;
                  });
                  var avgRT =
                    validRTs.length > 0
                      ? validRTs.reduce(function (sum, a) {
                          return sum + (a.rt || a.reactionTime || 0);
                        }, 0) / validRTs.length
                      : 0;
                  var worldData = {
                    nickname: d.playerName || d.nickname || "ç©å®¶",
                    bestScore: d.score || 0,
                    bestAccuracy: Math.round(d.accuracy || 0),
                    bestAvgRT: Math.round(avgRT),
                    totalStars: 0,
                    level: "",
                    gamesPlayed: 1,
                  };
                  return FirestoreLeaderboard.uploadToWorld(worldData);
                })
                .then(function () {
                  statusMsg.textContent = "âœ… å·²ä¸Šå‚³è‡³ä¸–ç•Œæ’è¡Œæ¦œï¼";
                  statusMsg.style.color = "#4caf50";
                  row.style.display = "none";
                  notice.style.display = "none";
                  btn.style.display = "";
                  btn.textContent = "ğŸŒ å·²ä¸Šå‚³";
                  btn.disabled = true;
                  btn.style.opacity = "0.6";
                })
                .catch(function (err) {
                  statusMsg.textContent = "âŒ " + err.message;
                  statusMsg.style.color = "#e74c3c";
                  confirmBtn.disabled = false;
                  confirmBtn.textContent = "ä¸Šå‚³";
                });
            });
            row.appendChild(cancelBtn);
            row.appendChild(confirmBtn);
            notice.parentNode.insertBefore(row, notice.nextSibling);
          }
        });
      })();
    </script>
  </body>
</html>
