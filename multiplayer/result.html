<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>éŠæˆ²çµæœ - åŸ·è¡ŒåŠŸèƒ½éŠæˆ²</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 800px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .celebration {
        font-size: 5rem;
        margin-bottom: 20px;
        animation: bounce 1s ease-in-out;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-30px);
        }
      }

      .header h1 {
        color: #667eea;
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        color: #636e72;
        font-size: 1.1rem;
      }

      /* åˆ†æ•¸å¡ç‰‡ */
      .score-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
      }

      .score-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translate(-50%, -50%);
        }
        100% {
          transform: translate(50%, 50%);
        }
      }

      .score-card .label {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
      }

      .score-card .value {
        font-size: 5rem;
        font-weight: bold;
        position: relative;
        z-index: 1;
      }

      .score-card .rank {
        font-size: 1.3rem;
        margin-top: 15px;
        opacity: 0.95;
        position: relative;
        z-index: 1;
      }

      /* çµ±è¨ˆè³‡è¨Š */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        transition: transform 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2d3436;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #636e72;
      }

      /* è©³ç´°åˆ†æ */
      .analysis-section {
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 1.3rem;
        color: #2d3436;
        margin-bottom: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .accuracy-bar {
        background: #e9ecef;
        border-radius: 25px;
        height: 50px;
        overflow: hidden;
        margin-bottom: 20px;
        position: relative;
      }

      .accuracy-fill {
        height: 100%;
        background: linear-gradient(90deg, #55efc4 0%, #00b894 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        transition: width 2s ease-out;
      }

      .stage-breakdown {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .stage-item {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .stage-icon-box {
        font-size: 2rem;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 12px;
      }

      .stage-details {
        flex: 1;
      }

      .stage-name {
        font-weight: 600;
        color: #2d3436;
        margin-bottom: 8px;
      }

      .stage-progress {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .mini-bar {
        flex: 1;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
      }

      .mini-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      }

      .stage-stats {
        text-align: right;
        font-size: 0.9rem;
        color: #636e72;
      }

      /* æŒ‰éˆ•å€åŸŸ */
      .actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 15px 40px;
        border: none;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #e9ecef;
        color: #495057;
      }

      .btn-secondary:hover {
        background: #dee2e6;
      }

      .btn-success {
        background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(85, 239, 196, 0.3);
      }

      /* çç«  */
      .badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin: 5px;
      }

      .badge-gold {
        background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
        color: #2d3436;
      }

      .badge-silver {
        background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
        color: #2d3436;
      }

      .badge-bronze {
        background: linear-gradient(135deg, #fab1a0 0%, #e17055 100%);
        color: white;
      }

      .badges-section {
        text-align: center;
        margin-bottom: 30px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 25px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .score-card .value {
          font-size: 3.5rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="celebration" id="celebration">ğŸ‰</div>
        <h1>éŠæˆ²å®Œæˆï¼</h1>
        <p>æ­å–œä½ å®Œæˆäº†æ‰€æœ‰æŒ‘æˆ°</p>
      </div>

      <!-- åˆ†æ•¸å¡ç‰‡ -->
      <div class="score-card">
        <div class="label">æœ€çµ‚åˆ†æ•¸</div>
        <div class="value" id="finalScore">0</div>
        <div class="rank" id="rankInfo">æ­£åœ¨è¨ˆç®—æ’å...</div>
      </div>

      <!-- ç²å¾—çç«  -->
      <div class="badges-section" id="badgesSection">
        <!-- çç« å°‡å‹•æ…‹ç”Ÿæˆ -->
      </div>

      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ¯</div>
          <div class="stat-value" id="accuracyValue">0%</div>
          <div class="stat-label">æº–ç¢ºç‡</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âš¡</div>
          <div class="stat-value" id="avgTimeValue">0s</div>
          <div class="stat-label">å¹³å‡åæ‡‰æ™‚é–“</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âœ“</div>
          <div class="stat-value" id="correctValue">0</div>
          <div class="stat-label">ç­”å°é¡Œæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â±ï¸</div>
          <div class="stat-value" id="totalTimeValue">0s</div>
          <div class="stat-label">ç¸½éŠæˆ²æ™‚é–“</div>
        </div>
      </div>

      <!-- è©³ç´°åˆ†æ -->
      <div class="analysis-section">
        <div class="section-title">ğŸ“Š æº–ç¢ºç‡åˆ†æ</div>
        <div class="accuracy-bar">
          <div class="accuracy-fill" id="accuracyBar" style="width: 0%">0%</div>
        </div>
      </div>

      <div class="analysis-section">
        <div class="section-title">ğŸ® å ´åœ°è¡¨ç¾</div>
        <div class="stage-breakdown" id="stageBreakdown">
          <!-- å ´åœ°çµ±è¨ˆå°‡å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>

      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="actions">
        <button class="btn btn-secondary" onclick="window.location.href = '../index.html'">
          è¿”å›é¦–é 
        </button>
        <button class="btn btn-success" onclick="shareResult()">ğŸ“¤ åˆ†äº«çµæœ</button>
        <button class="btn btn-primary" onclick="playAgain()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
      </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="../js/firebase-config.js"></script>

    <script>
      let resultData = null;

      // åˆå§‹åŒ–
      window.addEventListener('DOMContentLoaded', () => {
        loadResults();
      });

      function loadResults() {
        // å¾ localStorage ç²å–çµæœ
        const savedResult = localStorage.getItem('gameResult');
        if (!savedResult) {
          alert('æœªæ‰¾åˆ°éŠæˆ²çµæœ');
          window.location.href = '../index.html';
          return;
        }

        resultData = JSON.parse(savedResult);
        displayResults();
      }

      function displayResults() {
        // åŸºæœ¬åˆ†æ•¸
        document.getElementById('finalScore').textContent = resultData.score;
        document.getElementById('accuracyValue').textContent = resultData.accuracy.toFixed(1) + '%';
        document.getElementById('correctValue').textContent =
          `${resultData.correctAnswers}/${resultData.totalQuestions}`;
        document.getElementById('totalTimeValue').textContent =
          (resultData.totalTime / 1000).toFixed(1) + 's';

        // è¨ˆç®—å¹³å‡åæ‡‰æ™‚é–“
        const avgTime =
          resultData.answers.reduce((sum, a) => sum + a.reactionTime, 0) /
          resultData.answers.length;
        document.getElementById('avgTimeValue').textContent = (avgTime / 1000).toFixed(2) + 's';

        // æº–ç¢ºç‡é€²åº¦æ¢å‹•ç•«
        setTimeout(() => {
          const bar = document.getElementById('accuracyBar');
          bar.style.width = resultData.accuracy + '%';
          bar.textContent = resultData.accuracy.toFixed(1) + '%';
        }, 300);

        // ç²å¾—çç« 
        displayBadges();

        // å ´åœ°åˆ†æ
        displayStageBreakdown();

        // æ…¶ç¥å‹•ç•«
        if (resultData.accuracy >= 90) {
          document.getElementById('celebration').textContent = 'ğŸ†';
        } else if (resultData.accuracy >= 70) {
          document.getElementById('celebration').textContent = 'ğŸ‰';
        } else {
          document.getElementById('celebration').textContent = 'ğŸ’ª';
        }

        // è¨ˆç®—æ’åï¼ˆå¦‚æœæ˜¯å¤šäººæ¨¡å¼ï¼‰
        calculateRank();
      }

      function displayBadges() {
        const badges = [];

        // æ ¹æ“šè¡¨ç¾çµ¦äºˆçç« 
        if (resultData.accuracy === 100) {
          badges.push({ text: 'ğŸ¯ å®Œç¾è¡¨ç¾', class: 'badge-gold' });
        } else if (resultData.accuracy >= 90) {
          badges.push({ text: 'â­ å„ªç§€è¡¨ç¾', class: 'badge-gold' });
        } else if (resultData.accuracy >= 70) {
          badges.push({ text: 'ğŸ‘ è‰¯å¥½è¡¨ç¾', class: 'badge-silver' });
        }

        // é€Ÿåº¦çç« 
        const avgTime =
          resultData.answers.reduce((sum, a) => sum + a.reactionTime, 0) /
          resultData.answers.length;
        if (avgTime < 1000) {
          badges.push({ text: 'âš¡ é–ƒé›»åæ‡‰', class: 'badge-gold' });
        } else if (avgTime < 1500) {
          badges.push({ text: 'ğŸš€ å¿«é€Ÿåæ‡‰', class: 'badge-silver' });
        }

        // å®Œæˆçç« 
        badges.push({ text: 'âœ… æŒ‘æˆ°å®Œæˆ', class: 'badge-bronze' });

        // é¡¯ç¤ºçç« 
        const badgesSection = document.getElementById('badgesSection');
        if (badges.length > 0) {
          badges.forEach((badge) => {
            const span = document.createElement('span');
            span.className = `badge ${badge.class}`;
            span.textContent = badge.text;
            badgesSection.appendChild(span);
          });
        }
      }

      function displayStageBreakdown() {
        // æŒ‰å ´åœ°åˆ†çµ„çµ±è¨ˆ
        const stageStats = {};

        resultData.answers.forEach((answer) => {
          if (!stageStats[answer.stageId]) {
            stageStats[answer.stageId] = {
              total: 0,
              correct: 0,
            };
          }
          stageStats[answer.stageId].total++;
          if (answer.isCorrect) {
            stageStats[answer.stageId].correct++;
          }
        });

        // å ´åœ°è³‡è¨Šå°æ‡‰
        const stageInfo = {
          A: { name: 'å ´åœ°Aï¼šèµ·å¸æ£®æ—', icon: 'ğŸ§€' },
          B: { name: 'å ´åœ°Bï¼šäººé¡æ‘èŠ', icon: 'ğŸ§‘' },
          C: { name: 'å ´åœ°Cï¼šæµ·æ´‹ä¸–ç•Œ', icon: 'ğŸŸ' },
          D: { name: 'å ´åœ°Dï¼šæ™å¤œè¿·å®®', icon: 'ğŸŒ™' },
          E: { name: 'å ´åœ°Eï¼šè½‰æ›æ˜Ÿçƒ', icon: 'ğŸ”„' },
          F: { name: 'å ´åœ°Fï¼šè€åŠ›è³½é“', icon: 'ğŸ’ª' },
          G: { name: 'å ´åœ°Gï¼šæ¥µé€ŸæŒ‘æˆ°', icon: 'âš¡' },
          H: { name: 'å ´åœ°Hï¼šå¤§å¸«è€ƒé©—', icon: 'ğŸ‘‘' },
        };

        const breakdown = document.getElementById('stageBreakdown');
        breakdown.innerHTML = '';

        Object.entries(stageStats).forEach(([stageId, stats]) => {
          const info = stageInfo[stageId] || { name: `å ´åœ° ${stageId}`, icon: 'ğŸ¯' };
          const accuracy = ((stats.correct / stats.total) * 100).toFixed(1);

          const item = document.createElement('div');
          item.className = 'stage-item';
          item.innerHTML = `
            <div class="stage-icon-box">${info.icon}</div>
            <div class="stage-details">
              <div class="stage-name">${info.name}</div>
              <div class="stage-progress">
                <div class="mini-bar">
                  <div class="mini-bar-fill" style="width: ${accuracy}%"></div>
                </div>
                <span>${accuracy}%</span>
              </div>
            </div>
            <div class="stage-stats">
              ${stats.correct}/${stats.total} æ­£ç¢º
            </div>
          `;
          breakdown.appendChild(item);
        });
      }

      async function calculateRank() {
        // å¦‚æœæ˜¯å¤šäººæ¨¡å¼ï¼Œå¾ Firebase ç²å–å…¶ä»–ç©å®¶æˆç¸¾
        const roomData = localStorage.getItem('currentRoom');
        if (!roomData) {
          document.getElementById('rankInfo').textContent = 'å–®äººæ¨¡å¼';
          return;
        }

        const room = JSON.parse(roomData);
        const roomRef = firebase.database().ref(`rooms/${room.code}/results`);

        try {
          const snapshot = await roomRef.once('value');
          const results = snapshot.val();

          if (!results) {
            document.getElementById('rankInfo').textContent = 'å–®äººæ¨¡å¼';
            return;
          }

          // æ’åºæ‰€æœ‰ç©å®¶æˆç¸¾
          const allResults = Object.values(results).sort((a, b) => b.score - a.score);
          const myRank = allResults.findIndex((r) => r.playerId === resultData.playerId) + 1;
          const totalPlayers = allResults.length;

          // é¡¯ç¤ºæ’å
          let rankText = '';
          if (myRank === 1) {
            rankText = `ğŸ¥‡ ç¬¬ 1 å / ${totalPlayers} äºº`;
          } else if (myRank === 2) {
            rankText = `ğŸ¥ˆ ç¬¬ 2 å / ${totalPlayers} äºº`;
          } else if (myRank === 3) {
            rankText = `ğŸ¥‰ ç¬¬ 3 å / ${totalPlayers} äºº`;
          } else {
            rankText = `ç¬¬ ${myRank} å / ${totalPlayers} äºº`;
          }

          document.getElementById('rankInfo').textContent = rankText;
        } catch (error) {
          console.error('ç²å–æ’åå¤±æ•—:', error);
          document.getElementById('rankInfo').textContent = 'æ’åè¼‰å…¥å¤±æ•—';
        }
      }

      function shareResult() {
        const shareText = `æˆ‘åœ¨åŸ·è¡ŒåŠŸèƒ½éŠæˆ²ä¸­ç²å¾—äº† ${resultData.score} åˆ†ï¼æº–ç¢ºç‡ ${resultData.accuracy.toFixed(1)}%ï¼å¿«ä¾†æŒ‘æˆ°çœ‹çœ‹ï¼`;

        if (navigator.share) {
          navigator
            .share({
              title: 'åŸ·è¡ŒåŠŸèƒ½éŠæˆ² - æˆ‘çš„æˆç¸¾',
              text: shareText,
            })
            .catch(() => {
              // åˆ†äº«å¤±æ•—ï¼Œæ”¹ç”¨è¤‡è£½
              copyToClipboard(shareText);
            });
        } else {
          copyToClipboard(shareText);
        }
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          alert('æˆç¸¾å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        });
      }

      function playAgain() {
        // æ¸…é™¤éŠæˆ²è¨˜éŒ„
        localStorage.removeItem('gameResult');

        // è¿”å›é¦–é 
        window.location.href = '../index.html';
      }
    </script>
  </body>
</html>
