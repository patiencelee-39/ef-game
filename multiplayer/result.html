<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://*.firebasedatabase.app https://*.firebaseio.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self'; connect-src 'self' https://cdn.jsdelivr.net https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app"
    />
    <title>遊戲結果 - 執行功能遊戲</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/themes/theme-field-primary.css" />
    <link rel="stylesheet" href="../css/themes/theme-rule-independent.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link
      rel="preload"
      href="../css/components/landscape-hint.css"
      as="style"
      onload="this.rel = 'stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="../css/components/landscape-hint.css"
    /></noscript>
    <link rel="stylesheet" href="../css/pages/result.css" />
    <link rel="stylesheet" href="../css/pages/result-multiplayer.css" />
    <link rel="stylesheet" href="../css/components/relay.css" />
    <link
      rel="preload"
      href="../css/components/csv-report.css"
      as="style"
      onload="this.rel = 'stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="../css/components/csv-report.css"
    /></noscript>
    <link
      rel="preload"
      href="../css/components/navbar.css"
      as="style"
      onload="this.rel = 'stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="../css/components/navbar.css"
    /></noscript>
    <!-- Firebase Bundle -->
    <script defer src="../js/firebase-bundle.js"></script>
    <script defer src="../js/utils/logger.js"></script>
    <script defer src="../js/shared/game-modal.js"></script>
    <!-- 功能模組 -->
    <script defer src="../js/shared/leaderboard-writer.js"></script>
    <script defer src="../js/shared/firestore-leaderboard.js"></script>
    <script defer src="../js/sound-config.js"></script>
    <script defer src="../js/shared/audio-player.js"></script>
    <script defer src="../js/shared/navbar.js"></script>
    <script defer src="../js/shared/landscape-hint.js"></script>
    <script defer src="../js/utils/constants.js"></script>
    <!-- ==================== 分析報告依賴 ==================== -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
      integrity="sha384-9nhczxUqK87bcKHh20fSQcTGD4qq5GhayNYSYWqwBkINBhOfQLg/P5HG5lF1urn4"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"
      integrity="sha384-D/t0ZMqQW31H3az8ktEiNb39wyKnS82iFY52QPACM+IjKW3jDUhyIgh2PApRqJZs"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"
      integrity="sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"
      integrity="sha384-Yv5O+t3uE3hunW8uyrbpPW3iw6/5/Y7HitWJBLgqfMoA36NogMmy+8wWZMpn3HWc"
      crossorigin="anonymous"
    ></script>
    <script defer src="../js/shared/csv-report.js"></script>
    <script defer src="../js/shared/result-upload.js"></script>
    <script defer src="../js/shared/combo-selector.js"></script>
  </head>
  <body>
    <a href="#main-content" class="skip-link">跳到主要內容</a>
    <main class="container" id="main-content" aria-live="polite">
      <div class="header">
        <div class="celebration" id="celebration">🎉</div>
        <h1>遊戲完成！</h1>
        <p>恭喜你完成了所有挑戰</p>
      </div>

      <!-- 分數卡片 -->
      <div class="score-card">
        <div class="label">最終分數</div>
        <div class="value" id="finalScore">0</div>
        <div class="rank" id="rankInfo">正在計算排名...</div>
      </div>

      <!-- 獲得獎章 -->
      <div class="badges-section" id="badgesSection">
        <!-- 獎章將動態生成 -->
      </div>

      <!-- 統計資訊 -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">🎯</div>
          <div class="stat-value" id="accuracyValue">0%</div>
          <div class="stat-label">準確率</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">⚡</div>
          <div class="stat-value" id="avgTimeValue">0s</div>
          <div class="stat-label">平均反應時間</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">✓</div>
          <div class="stat-value" id="correctValue">0</div>
          <div class="stat-label">答對題數</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">⏱️</div>
          <div class="stat-value" id="totalTimeValue">0s</div>
          <div class="stat-label">總遊戲時間</div>
        </div>
      </div>

      <!-- 詳細分析 -->
      <div class="analysis-section">
        <div class="section-title">📊 準確率分析</div>
        <div class="accuracy-bar">
          <div class="accuracy-fill" id="accuracyBar" style="width: 0%">0%</div>
        </div>
      </div>

      <div class="analysis-section">
        <div class="section-title">🎮 場地表現</div>
        <div class="stage-breakdown" id="stageBreakdown">
          <!-- 場地統計將動態生成 -->
        </div>
      </div>

      <!-- SDT 信號偵測理論分析 -->
      <div id="sdtSection" class="analysis-section" style="display: none">
        <div class="section-title">🎯 信號偵測理論 (SDT)</div>
        <div id="sdtContent"></div>
      </div>

      <!-- 多人排名比較（動態生成） -->
      <div id="mpRankingSection" class="analysis-section" style="display: none">
        <div class="section-title">🏆 多人排名比較</div>
        <div id="mpRankingContent"></div>
      </div>

      <!-- 接力賽團隊排名（僅接力模式顯示） -->
      <div
        id="relayResultSection"
        class="relay-result-section"
        style="display: none"
      >
        <div class="section-title">🏁 團隊接力排名</div>
        <div id="relayTeamRanking" class="relay-team-ranking"></div>
      </div>

      <!-- 分析報告區域 -->
      <div id="reportContainer" style="display: none; padding: 16px; background: var(--bg-dark, #1a1a2e);">
        <div id="reportContent"></div>
        <div style="text-align:center;margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
          <button class="btn btn-primary" id="btnExportCsvFromReport" style="font-size:0.85rem;">💾 匯出 CSV</button>
          <button class="btn btn-primary" id="btnExportPdf" style="font-size:0.85rem;">📄 匯出 PDF</button>
          <button class="btn btn-primary" id="btnExportScreenshot" style="font-size:0.85rem;">📸 匯出長截圖</button>
        </div>
      </div>

      <!-- 操作按鈕 -->
      <div class="actions">
        <button class="btn btn-primary" id="btnToggleReport" onclick="toggleMultiplayerReport()">
          📊 展開分析報告
        </button>
        <button class="btn btn-primary" onclick="playAgain()">
          🔄 再玩一次
        </button>
        <button
          class="btn btn-success"
          id="btnUploadClass"
          style="
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
          "
        >
          📤 上傳至班級排行榜
        </button>
        <div
          id="uploadCodeRow"
          style="display: none; gap: 8px; margin-top: 8px; width: 100%"
        >
          <input
            id="uploadCodeInput"
            placeholder="輸入 6 位代碼"
            maxlength="6"
            style="
              flex: 1;
              padding: 8px 12px;
              border: 2px solid #ddd;
              border-radius: 8px;
              font-size: 1rem;
              font-weight: 700;
              text-align: center;
              letter-spacing: 2px;
              text-transform: uppercase;
            "
          />
          <button
            id="uploadCodeSubmit"
            class="btn btn-primary"
            style="padding: 8px 16px; font-size: 0.9rem"
          >
            上傳
          </button>
        </div>
        <div
          id="uploadStatusMsg"
          style="
            text-align: center;
            font-size: 0.85rem;
            min-height: 24px;
            width: 100%;
          "
        ></div>
        <button
          class="btn btn-success"
          id="btnUploadWorld"
          style="
            background: linear-gradient(135deg, #00c9ff, #92fe9d);
            color: #1a1a2e;
            border: none;
            font-weight: 700;
          "
        >
          🌐 上傳至世界排行榜
        </button>
        <div
          id="worldUploadNotice"
          style="
            display: none;
            font-size: 0.78rem;
            color: #999;
            text-align: center;
            padding: 2px 16px 0;
            line-height: 1.4;
            width: 100%;
          "
        >
          📋 上傳後，你的暱稱與本次成績將公開顯示於世界排行榜。<br />相同裝置再次上傳會覆蓋先前紀錄。資料僅供排名展示，不會用於其他用途。
        </div>
        <div
          id="worldUploadStatus"
          style="
            text-align: center;
            font-size: 0.85rem;
            min-height: 24px;
            width: 100%;
          "
        ></div>
      </div>
    </main>

    <script defer src="../js/multiplayer/result-controller.js"></script>
  </body>
</html>
