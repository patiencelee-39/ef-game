<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://*.firebasedatabase.app https://*.firebaseio.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app"
    />
    <title>建立房間 - 執行功能訓練遊戲</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/themes/theme-field-primary.css" />
    <link rel="stylesheet" href="../css/themes/theme-rule-independent.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link
      rel="preload"
      href="../css/components/landscape-hint.css"
      as="style"
      onload="this.rel = 'stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="../css/components/landscape-hint.css"
    /></noscript>
    <link rel="stylesheet" href="../css/pages/room-create.css" />
    <link rel="stylesheet" href="../css/components/stage-picker.css" />
    <link rel="stylesheet" href="../css/components/relay.css" />
    <link
      rel="preload"
      href="../css/components/navbar.css"
      as="style"
      onload="this.rel = 'stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="../css/components/navbar.css"
    /></noscript>
    <!-- Firebase Bundle -->
    <script defer src="../js/firebase-bundle.js"></script>
    <script defer src="../js/utils/logger.js"></script>
    <script defer src="../js/shared/game-modal.js"></script>
    <!-- 工具函式 -->
    <script defer src="../js/game-config.js"></script>
    <script defer src="../js/utils/constants.js"></script>
    <script defer src="../js/utils/question-generator.js"></script>
    <script defer src="../js/utils/room-code.js"></script>
    <!-- 場地×規則共用模組 -->
    <script defer src="../js/shared/combo-selector.js"></script>
    <script defer src="../js/shared/stage-picker.js"></script>
    <!-- 頁面邏輯 -->
    <script defer src="../js/multiplayer/room-manager.js"></script>
    <script defer src="../js/shared/navbar.js"></script>
    <script defer src="../js/shared/landscape-hint.js"></script>
  </head>
  <body>
    <a href="#main-content" class="skip-link">跳到主要內容</a>
    <div class="container">
      <header>
        <h1>🏠 建立遊戲房間</h1>
        <p class="subtitle">設定房間並邀請朋友一起遊玩</p>
      </header>

      <main id="main-content">
        <form id="createRoomForm">
          <!-- 基本設定 -->
          <section class="form-section">
            <h2>📋 基本設定</h2>

            <div class="form-group">
              <label for="hostNickname">👤 房主暱稱</label>
              <input
                type="text"
                id="hostNickname"
                placeholder="輸入你的暱稱（留空可匿名建立）"
                maxlength="20"
              />
            </div>

            <div class="form-group">
              <label for="roomName">房間名稱</label>
              <input
                type="text"
                id="roomName"
                value="我的遊戲房"
                required
                aria-required="true"
              />
            </div>

            <div class="form-group">
              <label for="roomCode"
                >房間代碼（6位，可自行填入或留空自動生成）</label
              >
              <input
                type="text"
                id="roomCode"
                placeholder="留空則自動生成"
                maxlength="7"
                style="
                  text-transform: uppercase;
                  letter-spacing: 2px;
                  text-align: center;
                  font-weight: 700;
                "
              />
              <small
                id="codeWarning"
                style="color: #e74c3c; display: none; margin-top: 4px"
                >⚠️ 代碼包含容易混淆的字元（0/O/I/1/l），建議避免使用</small
              >
            </div>

            <div class="form-group checkbox-group">
              <input type="checkbox" id="hasPassword" />
              <label for="hasPassword">設定房間密碼</label>
            </div>

            <div class="form-group hidden" id="passwordGroup">
              <label for="password">密碼（4位數字）</label>
              <input
                type="password"
                id="password"
                pattern="[0-9]{4}"
                maxlength="4"
                placeholder="1234"
                inputmode="numeric"
                aria-describedby="passwordHint"
              />
              <span id="passwordHint" class="sr-only">請輸入4位數字密碼</span>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="hostJoinsGame" checked />
              <label for="hostJoinsGame">房主參與遊戲</label>
              <small class="host-joins-hint">
                取消勾選後，房主將只能觀戰和管理遊戲
              </small>
            </div>
          </section>

          <!-- 遊戲模式 -->
          <section class="form-section">
            <h2>🏁 遊戲模式</h2>
            <div class="game-mode-selector" id="gameModeSelector">
              <button
                type="button"
                class="game-mode-btn active"
                data-mode="individual"
              >
                <span class="mode-icon">👤</span>個人競賽
              </button>
              <button type="button" class="game-mode-btn" data-mode="team">
                <span class="mode-icon">⚔️</span>隊伍對抗
              </button>
              <button type="button" class="game-mode-btn" data-mode="relay">
                <span class="mode-icon">🏁</span>接力賽
              </button>
            </div>

            <!-- 隊伍對抗選項 -->
            <div class="team-options" id="teamOptions">
              <div class="form-group">
                <label for="teamCount">隊伍數量</label>
                <div class="team-count-slider-row">
                  <input
                    type="range"
                    id="teamCount"
                    min="2"
                    max="10"
                    value="2"
                    class="team-count-slider"
                  />
                  <span class="team-count-value" id="teamCountValue">2 隊</span>
                </div>
              </div>
              <div class="form-group">
                <label>分隊方式</label>
                <div class="team-assign-row" id="teamAssignRow">
                  <button
                    type="button"
                    class="team-assign-btn active"
                    data-assign="random"
                  >
                    🔀 隨機分隊
                  </button>
                  <button
                    type="button"
                    class="team-assign-btn"
                    data-assign="selfSelect"
                  >
                    🙋 玩家自選
                  </button>
                  <button
                    type="button"
                    class="team-assign-btn"
                    data-assign="manual"
                  >
                    ✋ 手動分隊
                  </button>
                </div>
                <small class="team-assign-hint" id="teamAssignHint"
                  >開始遊戲時自動隨機分隊</small
                >
              </div>
              <div class="form-group">
                <label>隊長選擇</label>
                <div class="team-assign-row" id="captainSelectRow">
                  <button
                    type="button"
                    class="team-assign-btn active"
                    data-captain="hostAssign"
                  >
                    👑 房主指派
                  </button>
                  <button
                    type="button"
                    class="team-assign-btn"
                    data-captain="random"
                  >
                    🎲 隨機產生
                  </button>
                </div>
                <small class="team-assign-hint" id="captainSelectHint"
                  >房主在等待室指定各隊隊長</small
                >
              </div>
            </div>

            <!-- 接力賽選項 -->
            <div class="relay-options" id="relayOptions">
              <label>隊伍數量</label>
              <div class="team-count-row" id="teamCountRow">
                <button
                  type="button"
                  class="team-count-btn active"
                  data-count="2"
                >
                  2 隊
                </button>
                <button type="button" class="team-count-btn" data-count="3">
                  3 隊
                </button>
                <button type="button" class="team-count-btn" data-count="4">
                  4 隊
                </button>
              </div>
              <div class="form-group" style="margin-top: 12px;">
                <label>隊長選擇</label>
                <div class="team-assign-row" id="relayCaptainSelectRow">
                  <button
                    type="button"
                    class="team-assign-btn active"
                    data-captain="hostAssign"
                  >
                    👑 房主指派
                  </button>
                  <button
                    type="button"
                    class="team-assign-btn"
                    data-captain="random"
                  >
                    🎲 隨機產生
                  </button>
                </div>
                <small class="team-assign-hint" id="relayCaptainSelectHint"
                  >房主在等待室指定各隊隊長</small
                >
              </div>
            </div>
          </section>

          <!-- 遊戲場選擇（StagePicker 共用元件） -->
          <section class="form-section stage-selector">
            <h2>🎮 遊戲場選擇（拖曳排序）</h2>

            <div
              class="selected-stages"
              id="selectedStages"
              role="list"
              aria-live="polite"
              aria-label="已選擇的遊戲場"
            >
              <div class="selected-stages-empty">
                👆 請從下方選擇遊戲場（可重複，最多20個）
              </div>
            </div>

            <h3>可選擇的遊戲場（12 個）：</h3>
            <div class="stage-picker-cards" id="availableStages">
              <!-- 由 StagePicker 動態生成 -->
            </div>
          </section>

          <!-- 遊戲設定 -->
          <section class="form-section">
            <h2>⚙️ 遊戲設定</h2>

            <div class="form-group">
              <label for="questionsCount">每場地題數</label>
              <select id="questionsCount">
                <option value="3">3題</option>
                <option value="6" selected>6題</option>
                <option value="12">12題</option>
                <option value="24">24題</option>
              </select>
            </div>

            <div class="form-group">
              <label for="countdownSeconds">倒數秒數</label>
              <select id="countdownSeconds">
                <option value="0">0秒</option>
                <option value="3" selected>3秒</option>
                <option value="5">5秒</option>
                <option value="10">10秒</option>
              </select>
            </div>

            <!-- WM 已整合至探險點設計，不再需要獨立開關 -->
            <!--
            <div class="checkbox-group">
              <input type="checkbox" id="enableWM" />
              <label for="enableWM">🧠 啟用工作記憶測驗</label>
              <small
                style="
                  display: block;
                  color: rgba(255, 255, 255, 0.6);
                  font-size: 0.8rem;
                  margin-top: 2px;
                "
                >每場地結束後加入工作記憶測驗</small
              >
            </div>
            -->
          </section>

          <!-- 進階設定 -->
          <section class="form-section">
            <h2>🔧 進階設定</h2>

            <div class="form-group">
              <label for="maxPlayers">房間人數上限</label>
              <div class="team-count-slider-row">
                <input
                  type="range"
                  id="maxPlayers"
                  min="2"
                  max="20"
                  value="8"
                  class="team-count-slider"
                />
                <span class="team-count-value" id="maxPlayersValue">8 人</span>
              </div>
              <small style="color: rgba(255,255,255,0.5); font-size: 0.75rem;">
                建議 8 人以內；超過 10 人時接力賽等待時間會增加
              </small>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="showLeaderboard" checked />
              <label for="showLeaderboard">顯示即時計分板</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="showCompletionNotification" checked />
              <label for="showCompletionNotification">顯示場地完成通知</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="allowLateJoin" />
              <label for="allowLateJoin">允許中途加入</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="showFinalRanking" checked />
              <label for="showFinalRanking">顯示最終排名</label>
            </div>
          </section>

          <!-- 按鈕 -->
          <div class="button-group">
            <button type="button" id="backBtn" class="btn-secondary">
              返回
            </button>
            <button type="submit" class="btn-primary flex-1">建立房間</button>
          </div>
        </form>
      </main>
    </div>

    <script defer src="../js/multiplayer/room-create-controller.js"></script>
  </body>
</html>
