<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å»ºç«‹æˆ¿é–“ - åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ²</title>
    <link rel="stylesheet" href="../css/main.css" />
    <style>
      .stage-selector {
        margin: 2rem 0;
      }

      .selected-stages {
        min-height: 100px;
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f9f9f9;
      }

      .selected-stages-empty {
        text-align: center;
        color: #999;
        padding: 2rem;
      }

      .stage-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: white;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        cursor: move;
      }

      .stage-chip .emoji {
        font-size: 1.5rem;
      }

      .stage-chip .remove-btn {
        background: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 0.875rem;
      }

      .available-stages {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
      }

      .stage-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .stage-card:hover {
        transform: translateY(-5px);
      }

      .stage-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .stage-card .emoji {
        font-size: 3rem;
        display: block;
        margin-bottom: 0.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .checkbox-group input[type='checkbox'] {
        width: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ  å»ºç«‹éŠæˆ²æˆ¿é–“</h1>
        <p class="subtitle">è¨­å®šæˆ¿é–“ä¸¦é‚€è«‹æœ‹å‹ä¸€èµ·éŠç©</p>
      </header>

      <main>
        <form id="createRoomForm">
          <!-- åŸºæœ¬è¨­å®š -->
          <section class="form-section">
            <h2>ğŸ“‹ åŸºæœ¬è¨­å®š</h2>

            <div class="form-group">
              <label for="roomName">æˆ¿é–“åç¨±</label>
              <input type="text" id="roomName" value="æˆ‘çš„ç·´ç¿’æˆ¿" required />
            </div>

            <div class="form-group">
              <label for="roomCode">æˆ¿é–“ä»£ç¢¼ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰</label>
              <input type="text" id="roomCode" readonly />
              <button type="button" id="regenerateCode" class="btn-secondary mt-sm">
                ğŸ”„ é‡æ–°ç”Ÿæˆ
              </button>
            </div>

            <div class="form-group checkbox-group">
              <input type="checkbox" id="hasPassword" />
              <label for="hasPassword">è¨­å®šæˆ¿é–“å¯†ç¢¼</label>
            </div>

            <div class="form-group" id="passwordGroup" style="display: none">
              <label for="password">å¯†ç¢¼ï¼ˆ4ä½æ•¸å­—ï¼‰</label>
              <input
                type="password"
                id="password"
                pattern="[0-9]{4}"
                maxlength="4"
                placeholder="1234"
              />
            </div>
          </section>

          <!-- éŠæˆ²å ´é¸æ“‡ -->
          <section class="form-section stage-selector">
            <h2>ğŸ® éŠæˆ²å ´é¸æ“‡ï¼ˆæ‹–æ›³æ’åºï¼‰</h2>

            <div class="selected-stages" id="selectedStages">
              <div class="selected-stages-empty">ğŸ‘† è«‹å¾ä¸‹æ–¹é¸æ“‡éŠæˆ²å ´ï¼ˆæœ€å¤š4å€‹ï¼‰</div>
            </div>

            <h3>å¯é¸æ“‡çš„éŠæˆ²å ´ï¼š</h3>
            <div class="available-stages" id="availableStages">
              <div class="stage-card" data-stage="A">
                <span class="emoji">ğŸ§€</span>
                <div>å ´åœ°A</div>
                <div>èµ·å¸æ£®æ—</div>
                <small>ç°¡å–®</small>
              </div>
              <div class="stage-card" data-stage="B">
                <span class="emoji">ğŸ§‘</span>
                <div>å ´åœ°B</div>
                <div>äººé¡æ‘èŠ</div>
                <small>ä¸­ç­‰</small>
              </div>
              <div class="stage-card" data-stage="C">
                <span class="emoji">ğŸŸ</span>
                <div>å ´åœ°C</div>
                <div>æµ·æ´‹ä¸–ç•Œ</div>
                <small>ä¸­ç­‰</small>
              </div>
              <div class="stage-card" data-stage="D">
                <span class="emoji">ğŸŒ™</span>
                <div>å ´åœ°D</div>
                <div>æ™å¤œè¿·å®®</div>
                <small>å›°é›£</small>
              </div>
            </div>
          </section>

          <!-- éŠæˆ²è¨­å®š -->
          <section class="form-section">
            <h2>âš™ï¸ éŠæˆ²è¨­å®š</h2>

            <div class="form-group">
              <label for="questionsCount">æ¯å ´åœ°é¡Œæ•¸</label>
              <select id="questionsCount">
                <option value="5">5é¡Œ</option>
                <option value="10" selected>10é¡Œ</option>
                <option value="15">15é¡Œ</option>
                <option value="20">20é¡Œ</option>
              </select>
            </div>

            <div class="form-group">
              <label for="countdownSeconds">å€’æ•¸ç§’æ•¸</label>
              <select id="countdownSeconds">
                <option value="2">2ç§’</option>
                <option value="3" selected>3ç§’</option>
                <option value="4">4ç§’</option>
                <option value="5">5ç§’</option>
              </select>
            </div>
          </section>

          <!-- é€²éšè¨­å®š -->
          <section class="form-section">
            <h2>ğŸ”§ é€²éšè¨­å®š</h2>

            <div class="checkbox-group">
              <input type="checkbox" id="showLeaderboard" checked />
              <label for="showLeaderboard">é¡¯ç¤ºå³æ™‚è¨ˆåˆ†æ¿</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="showAnswerStatus" checked />
              <label for="showAnswerStatus">é¡¯ç¤ºç­”é¡Œç‹€æ…‹</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="showCompletionNotification" checked />
              <label for="showCompletionNotification">é¡¯ç¤ºå ´åœ°å®Œæˆé€šçŸ¥</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="allowLateJoin" />
              <label for="allowLateJoin">å…è¨±ä¸­é€”åŠ å…¥</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="showFinalRanking" checked />
              <label for="showFinalRanking">é¡¯ç¤ºæœ€çµ‚æ’å</label>
            </div>
          </section>

          <!-- æŒ‰éˆ• -->
          <div class="button-group" style="display: flex; gap: 1rem; margin-top: 2rem">
            <button type="button" onclick="location.href = '../index.html'" class="btn-secondary">
              è¿”å›
            </button>
            <button type="submit" class="btn-primary" style="flex: 1">å»ºç«‹æˆ¿é–“</button>
          </div>
        </form>
      </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

    <!-- å·¥å…·å‡½å¼ -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils/constants.js"></script>
    <script src="../js/utils/room-code.js"></script>
    <script src="../js/utils/question-generator.js"></script>

    <!-- é é¢é‚è¼¯ -->
    <script src="../js/multiplayer/room-manager.js"></script>

    <script>
      // é é¢åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', async () => {
        // ç”Ÿæˆæˆ¿é–“ä»£ç¢¼
        const roomCode = await window.RoomCodeUtils.generateUnique();
        document.getElementById('roomCode').value = window.RoomCodeUtils.format(roomCode);

        // å¯†ç¢¼é–‹é—œ
        document.getElementById('hasPassword').addEventListener('change', (e) => {
          document.getElementById('passwordGroup').style.display = e.target.checked
            ? 'block'
            : 'none';
        });

        // é‡æ–°ç”Ÿæˆä»£ç¢¼
        document.getElementById('regenerateCode').addEventListener('click', async () => {
          const newCode = await window.RoomCodeUtils.generateUnique();
          document.getElementById('roomCode').value = window.RoomCodeUtils.format(newCode);
        });

        // éŠæˆ²å ´é¸æ“‡é‚è¼¯
        initStageSelector();

        // è¡¨å–®æäº¤
        document.getElementById('createRoomForm').addEventListener('submit', handleFormSubmit);
      });

      // éŠæˆ²å ´é¸æ“‡å™¨åˆå§‹åŒ–
      let selectedStages = [];

      function initStageSelector() {
        const availableStages = document.getElementById('availableStages');
        const selectedStagesContainer = document.getElementById('selectedStages');

        // é»æ“Šå¯é¸å ´åœ°
        availableStages.addEventListener('click', (e) => {
          const card = e.target.closest('.stage-card');
          if (!card || card.classList.contains('disabled')) return;

          const stageId = card.dataset.stage;
          addStage(stageId);
        });
      }

      function addStage(stageId) {
        if (selectedStages.length >= 4) {
          alert('æœ€å¤šåªèƒ½é¸æ“‡4å€‹éŠæˆ²å ´');
          return;
        }

        if (selectedStages.includes(stageId)) {
          alert('æ­¤éŠæˆ²å ´å·²é¸æ“‡');
          return;
        }

        selectedStages.push(stageId);
        updateStageDisplay();
      }

      function removeStage(stageId) {
        selectedStages = selectedStages.filter((id) => id !== stageId);
        updateStageDisplay();
      }

      function updateStageDisplay() {
        const container = document.getElementById('selectedStages');
        const stageInfo = window.QuestionGenerator.GAME_STAGES;

        if (selectedStages.length === 0) {
          container.innerHTML =
            '<div class="selected-stages-empty">ğŸ‘† è«‹å¾ä¸‹æ–¹é¸æ“‡éŠæˆ²å ´ï¼ˆæœ€å¤š4å€‹ï¼‰</div>';
        } else {
          container.innerHTML = selectedStages
            .map((stageId) => {
              const stage = stageInfo[stageId];
              return `
                        <div class="stage-chip" draggable="true" data-stage="${stageId}">
                            <span class="emoji">${stage.icon}</span>
                            <span>${stage.name}</span>
                            <button type="button" class="remove-btn" onclick="removeStage('${stageId}')">âœ•</button>
                        </div>
                    `;
            })
            .join('');
        }

        // æ›´æ–°å¯é¸å ´åœ°ç‹€æ…‹
        document.querySelectorAll('.stage-card').forEach((card) => {
          const stageId = card.dataset.stage;
          if (selectedStages.includes(stageId)) {
            card.classList.add('disabled');
          } else {
            card.classList.remove('disabled');
          }
        });
      }

      // è¡¨å–®æäº¤è™•ç†
      async function handleFormSubmit(e) {
        e.preventDefault();

        if (selectedStages.length === 0) {
          alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹éŠæˆ²å ´');
          return;
        }

        const button = e.target.querySelector('button[type="submit"]');
        button.disabled = true;
        button.textContent = 'å»ºç«‹ä¸­...';

        try {
          const roomData = collectFormData();
          const roomCode = await window.RoomManager.createRoom(roomData);

          // è·³è½‰åˆ°ç­‰å¾…å®¤
          window.location.href = `waiting-room.html?code=${roomCode}`;
        } catch (error) {
          alert('å»ºç«‹æˆ¿é–“å¤±æ•—: ' + error.message);
          button.disabled = false;
          button.textContent = 'å»ºç«‹æˆ¿é–“';
        }
      }

      function collectFormData() {
        const roomCode = window.RoomCodeUtils.unformat(document.getElementById('roomCode').value);
        const hasPassword = document.getElementById('hasPassword').checked;

        return {
          roomCode,
          roomName: document.getElementById('roomName').value,
          hasPassword,
          password: hasPassword ? document.getElementById('password').value : null,
          selectedStages,
          questionsCount: parseInt(document.getElementById('questionsCount').value),
          countdownSeconds: parseInt(document.getElementById('countdownSeconds').value),
          displaySettings: {
            showLeaderboard: document.getElementById('showLeaderboard').checked,
            showAnswerStatus: document.getElementById('showAnswerStatus').checked,
            showCompletionNotification: document.getElementById('showCompletionNotification')
              .checked,
            allowLateJoin: document.getElementById('allowLateJoin').checked,
            showFinalRanking: document.getElementById('showFinalRanking').checked,
          },
        };
      }
    </script>
  </body>
</html>
