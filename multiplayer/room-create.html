<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app"
    />
    <title>å»ºç«‹æˆ¿é–“ - åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ²</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/components/landscape-hint.css" />
    <style>
      .stage-selector {
        margin: 2rem 0;
      }

      .selected-stages {
        min-height: 100px;
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: rgba(255, 255, 255, 0.05);
      }

      .selected-stages-empty {
        text-align: center;
        color: rgba(255, 255, 255, 0.7);
        padding: 2rem;
      }

      .stage-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        cursor: move;
        color: var(--text-light);
      }

      .stage-chip .emoji {
        font-size: 1.5rem;
      }

      .stage-chip .remove-btn {
        background: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 0.875rem;
      }

      .available-stages {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
      }

      .stage-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .stage-card:hover {
        transform: translateY(-5px);
      }

      .stage-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .stage-card .emoji {
        font-size: 3rem;
        display: block;
        margin-bottom: 0.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        font-size: 1rem;
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-light);
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .checkbox-group input[type="checkbox"] {
        width: auto;
      }
    </style>
    <link rel="stylesheet" href="../css/components/navbar.css" />
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- å·¥å…·å‡½å¼ï¼ˆæ³¨æ„é †åºï¼šconstants å¿…é ˆæœ€å…ˆè¼‰å…¥ï¼‰-->
    <script defer src="../js/utils/constants.js"></script>
    <script defer src="../js/firebase-config.js"></script>
    <script defer src="../js/utils/question-generator.js"></script>
    <script defer src="../js/utils/room-code.js"></script>
    <!-- é é¢é‚è¼¯ -->
    <script defer src="../js/multiplayer/room-manager.js"></script>
    <script defer src="../js/shared/navbar.js"></script>
    <script defer src="../js/shared/landscape-hint.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ  å»ºç«‹éŠæˆ²æˆ¿é–“</h1>
        <p class="subtitle">è¨­å®šæˆ¿é–“ä¸¦é‚€è«‹æœ‹å‹ä¸€èµ·éŠç©</p>
      </header>

      <main id="main-content">
        <form id="createRoomForm">
          <!-- åŸºæœ¬è¨­å®š -->
          <section class="form-section">
            <h2>ğŸ“‹ åŸºæœ¬è¨­å®š</h2>

            <div class="form-group">
              <label for="roomName">æˆ¿é–“åç¨±</label>
              <input
                type="text"
                id="roomName"
                value="æˆ‘çš„ç·´ç¿’æˆ¿"
                required
                aria-required="true"
              />
            </div>

            <div class="form-group">
              <label for="roomCode">æˆ¿é–“ä»£ç¢¼ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰</label>
              <input type="text" id="roomCode" readonly />
              <button
                type="button"
                id="regenerateCode"
                class="btn-secondary mt-sm"
              >
                ğŸ”„ é‡æ–°ç”Ÿæˆ
              </button>
            </div>

            <div class="form-group checkbox-group">
              <input type="checkbox" id="hasPassword" />
              <label for="hasPassword">è¨­å®šæˆ¿é–“å¯†ç¢¼</label>
            </div>

            <div class="form-group" id="passwordGroup" style="display: none">
              <label for="password">å¯†ç¢¼ï¼ˆ4ä½æ•¸å­—ï¼‰</label>
              <input
                type="password"
                id="password"
                pattern="[0-9]{4}"
                maxlength="4"
                placeholder="1234"
                inputmode="numeric"
                aria-describedby="passwordHint"
              />
              <span id="passwordHint" class="sr-only">è«‹è¼¸å…¥4ä½æ•¸å­—å¯†ç¢¼</span>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="hostJoinsGame" checked />
              <label for="hostJoinsGame">æˆ¿ä¸»åƒèˆ‡éŠæˆ²</label>
              <small
                style="
                  display: block;
                  margin-left: 1.5rem;
                  color: rgba(255, 255, 255, 0.7);
                "
              >
                å–æ¶ˆå‹¾é¸å¾Œï¼Œæˆ¿ä¸»å°‡åªèƒ½è§€æˆ°å’Œç®¡ç†éŠæˆ²
              </small>
            </div>
          </section>

          <!-- éŠæˆ²å ´é¸æ“‡ -->
          <section class="form-section stage-selector">
            <h2>ğŸ® éŠæˆ²å ´é¸æ“‡ï¼ˆæ‹–æ›³æ’åºï¼‰</h2>

            <div
              class="selected-stages"
              id="selectedStages"
              role="status"
              aria-live="polite"
            >
              <div class="selected-stages-empty">
                ğŸ‘† è«‹å¾ä¸‹æ–¹é¸æ“‡éŠæˆ²å ´ï¼ˆæœ€å¤š4å€‹ï¼‰
              </div>
            </div>

            <h3>å¯é¸æ“‡çš„éŠæˆ²å ´ï¼š</h3>
            <div class="available-stages" id="availableStages">
              <div class="stage-card" data-stage="A">
                <span class="emoji">ğŸ§€</span>
                <div>å ´åœ°A</div>
                <div>èµ·å¸æ£®æ—</div>
                <small>ç°¡å–®</small>
              </div>
              <div class="stage-card" data-stage="B">
                <span class="emoji">ğŸ§‘</span>
                <div>å ´åœ°B</div>
                <div>äººé¡æ‘èŠ</div>
                <small>ä¸­ç­‰</small>
              </div>
              <div class="stage-card" data-stage="C">
                <span class="emoji">ğŸŸ</span>
                <div>å ´åœ°C</div>
                <div>æµ·æ´‹ä¸–ç•Œ</div>
                <small>ä¸­ç­‰</small>
              </div>
              <div class="stage-card" data-stage="D">
                <span class="emoji">ğŸŒ™</span>
                <div>å ´åœ°D</div>
                <div>æ™å¤œè¿·å®®</div>
                <small>å›°é›£</small>
              </div>
            </div>
          </section>

          <!-- éŠæˆ²è¨­å®š -->
          <section class="form-section">
            <h2>âš™ï¸ éŠæˆ²è¨­å®š</h2>

            <div class="form-group">
              <label for="questionsCount">æ¯å ´åœ°é¡Œæ•¸</label>
              <select id="questionsCount">
                <option value="5">5é¡Œ</option>
                <option value="10" selected>10é¡Œ</option>
                <option value="15">15é¡Œ</option>
                <option value="20">20é¡Œ</option>
              </select>
            </div>

            <div class="form-group">
              <label for="countdownSeconds">å€’æ•¸ç§’æ•¸</label>
              <select id="countdownSeconds">
                <option value="2">2ç§’</option>
                <option value="3" selected>3ç§’</option>
                <option value="4">4ç§’</option>
                <option value="5">5ç§’</option>
              </select>
            </div>
          </section>

          <!-- é€²éšè¨­å®š -->
          <section class="form-section">
            <h2>ğŸ”§ é€²éšè¨­å®š</h2>

            <div class="checkbox-group">
              <input type="checkbox" id="showLeaderboard" checked />
              <label for="showLeaderboard">é¡¯ç¤ºå³æ™‚è¨ˆåˆ†æ¿</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="showAnswerStatus" checked />
              <label for="showAnswerStatus">é¡¯ç¤ºç­”é¡Œç‹€æ…‹</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="showCompletionNotification" checked />
              <label for="showCompletionNotification">é¡¯ç¤ºå ´åœ°å®Œæˆé€šçŸ¥</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="allowLateJoin" />
              <label for="allowLateJoin">å…è¨±ä¸­é€”åŠ å…¥</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="showFinalRanking" checked />
              <label for="showFinalRanking">é¡¯ç¤ºæœ€çµ‚æ’å</label>
            </div>
          </section>

          <!-- æŒ‰éˆ• -->
          <div
            class="button-group"
            style="display: flex; gap: 1rem; margin-top: 2rem"
          >
            <button
              type="button"
              onclick="location.href = '../index.html'"
              class="btn-secondary"
            >
              è¿”å›
            </button>
            <button type="submit" class="btn-primary" style="flex: 1">
              å»ºç«‹æˆ¿é–“
            </button>
          </div>
        </form>
      </main>
    </div>

    <script>
      // é é¢åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", async () => {
        // ç¢ºä¿ Firebase åˆå§‹åŒ–å®Œæˆ
        if (!firebase.apps.length) {
          console.error("Firebase æœªåˆå§‹åŒ–");
          alert("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
          return;
        }

        // åŒ¿åç™»å…¥ Firebase
        try {
          await firebase.auth().signInAnonymously();
          console.log("âœ… Firebase ç™»å…¥æˆåŠŸ");
        } catch (error) {
          console.error("âŒ Firebase ç™»å…¥å¤±æ•—:", error);
          alert("ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
          return;
        }

        // ç”Ÿæˆæˆ¿é–“ä»£ç¢¼
        try {
          // ç¢ºä¿ RoomCodeUtils å·²è¼‰å…¥
          if (!window.RoomCodeUtils) {
            throw new Error("RoomCodeUtils æœªè¼‰å…¥");
          }

          const roomCode = await window.RoomCodeUtils.generateUnique();
          const formattedCode = window.RoomCodeUtils.format(roomCode);
          document.getElementById("roomCode").value = formattedCode;
          console.log("âœ… æˆ¿é–“ä»£ç¢¼ç”ŸæˆæˆåŠŸ:", formattedCode);
        } catch (error) {
          console.error("âŒ ç”Ÿæˆæˆ¿é–“ä»£ç¢¼å¤±æ•—:", error);
          // å¦‚æœè‡ªå‹•ç”Ÿæˆå¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ
          const fallbackCode = "ABCDE";
          document.getElementById("roomCode").value =
            window.RoomCodeUtils?.format(fallbackCode) || fallbackCode;
          console.warn("âš ï¸ ä½¿ç”¨å‚™ç”¨ä»£ç¢¼:", fallbackCode);
        }

        // å¯†ç¢¼é–‹é—œ
        document
          .getElementById("hasPassword")
          .addEventListener("change", (e) => {
            document.getElementById("passwordGroup").style.display = e.target
              .checked
              ? "block"
              : "none";
          });

        // é‡æ–°ç”Ÿæˆä»£ç¢¼
        document
          .getElementById("regenerateCode")
          .addEventListener("click", async () => {
            try {
              const newCode = await window.RoomCodeUtils.generateUnique();
              document.getElementById("roomCode").value =
                window.RoomCodeUtils.format(newCode);
            } catch (error) {
              alert("ç”Ÿæˆä»£ç¢¼å¤±æ•—: " + error.message);
            }
          });

        // éŠæˆ²å ´é¸æ“‡é‚è¼¯
        initStageSelector();

        // è¡¨å–®æäº¤
        document
          .getElementById("createRoomForm")
          .addEventListener("submit", handleFormSubmit);
      });

      // éŠæˆ²å ´é¸æ“‡å™¨åˆå§‹åŒ–
      let selectedStages = [];

      // å ´åœ°è³‡è¨Šå®šç¾©ï¼ˆåªä¿ç•™ A-D å››å€‹å ´åœ°ï¼‰
      const stageInfo = {
        A: { id: "A", name: "å ´åœ°Aï¼šèµ·å¸æ£®æ—", icon: "ğŸ§€", difficulty: "easy" },
        B: {
          id: "B",
          name: "å ´åœ°Bï¼šäººé¡æ‘èŠ",
          icon: "ğŸ§‘",
          difficulty: "medium",
        },
        C: {
          id: "C",
          name: "å ´åœ°Cï¼šæµ·æ´‹ä¸–ç•Œ",
          icon: "ğŸŸ",
          difficulty: "medium",
        },
        D: { id: "D", name: "å ´åœ°Dï¼šæ™å¤œè¿·å®®", icon: "ğŸŒ™", difficulty: "hard" },
      };

      function initStageSelector() {
        const availableStages = document.getElementById("availableStages");
        const selectedStagesContainer =
          document.getElementById("selectedStages");

        // é»æ“Šå¯é¸å ´åœ°
        availableStages.addEventListener("click", (e) => {
          const card = e.target.closest(".stage-card");
          if (!card || card.classList.contains("disabled")) return;

          const stageId = card.dataset.stage;
          addStage(stageId);
        });
      }

      function addStage(stageId) {
        if (selectedStages.length >= 4) {
          alert("æœ€å¤šåªèƒ½é¸æ“‡4å€‹éŠæˆ²å ´");
          return;
        }

        if (selectedStages.includes(stageId)) {
          alert("æ­¤éŠæˆ²å ´å·²é¸æ“‡");
          return;
        }

        selectedStages.push(stageId);
        updateStageDisplay();
      }

      function removeStage(stageId) {
        selectedStages = selectedStages.filter((id) => id !== stageId);
        updateStageDisplay();
      }

      // æ‹–æ›³åŠŸèƒ½
      let draggedStageId = null;

      function handleDragStart(e) {
        draggedStageId = e.target.closest(".stage-chip").dataset.stage;
        e.dataTransfer.effectAllowed = "move";
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        return false;
      }

      function handleDrop(e) {
        e.preventDefault();
        const targetStageId = e.target.closest(".stage-chip")?.dataset.stage;

        if (!targetStageId || draggedStageId === targetStageId) return;

        const draggedIndex = selectedStages.indexOf(draggedStageId);
        const targetIndex = selectedStages.indexOf(targetStageId);

        selectedStages.splice(draggedIndex, 1);
        selectedStages.splice(targetIndex, 0, draggedStageId);

        updateStageDisplay();
        draggedStageId = null;
      }

      function updateStageDisplay() {
        const container = document.getElementById("selectedStages");

        if (selectedStages.length === 0) {
          container.innerHTML =
            '<div class="selected-stages-empty">ğŸ‘† è«‹å¾ä¸‹æ–¹é¸æ“‡éŠæˆ²å ´ï¼ˆæœ€å¤š4å€‹ï¼‰</div>';
        } else {
          container.innerHTML = selectedStages
            .map((stageId) => {
              const stage = stageInfo[stageId];
              return `
                        <div class="stage-chip" draggable="true" data-stage="${stageId}" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
                            <span class="emoji">${stage.icon}</span>
                            <span>${stage.name}</span>
                            <button type="button" class="remove-btn" onclick="removeStage('${stageId}')">âœ•</button>
                        </div>
                    `;
            })
            .join("");
        }

        // æ›´æ–°å¯é¸å ´åœ°ç‹€æ…‹
        document.querySelectorAll(".stage-card").forEach((card) => {
          const stageId = card.dataset.stage;
          if (selectedStages.includes(stageId)) {
            card.classList.add("disabled");
          } else {
            card.classList.remove("disabled");
          }
        });
      }

      // è¡¨å–®æäº¤è™•ç†
      async function handleFormSubmit(e) {
        e.preventDefault();

        if (selectedStages.length === 0) {
          alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹éŠæˆ²å ´");
          return;
        }

        const button = e.target.querySelector('button[type="submit"]');
        button.disabled = true;
        button.textContent = "å»ºç«‹ä¸­...";

        try {
          const roomData = collectFormData();
          const roomCode = await window.RoomManager.createRoom(roomData);

          // ä¿å­˜æˆ¿é–“è³‡è¨Šåˆ° localStorage
          const currentUser = firebase.auth().currentUser;
          localStorage.setItem(
            "currentRoom",
            JSON.stringify({
              code: roomCode,
              name: roomData.roomName,
              hostId: currentUser.uid,
            }),
          );

          // åªæœ‰æˆ¿ä¸»åƒèˆ‡éŠæˆ²æ™‚æ‰ä¿å­˜ currentPlayer
          if (roomData.hostJoinsGame) {
            localStorage.setItem(
              "currentPlayer",
              JSON.stringify({
                id: currentUser.uid,
                isHost: true,
                nickname: "æˆ¿ä¸»",
              }),
            );
          } else {
            // æˆ¿ä¸»ä¸åƒèˆ‡éŠæˆ²ï¼Œä½†ä»éœ€è¦è¨˜éŒ„èº«ä»½ç”¨æ–¼ç®¡ç†
            localStorage.setItem(
              "currentPlayer",
              JSON.stringify({
                id: currentUser.uid,
                isHost: true,
                isSpectator: true,
                nickname: "æˆ¿ä¸»ï¼ˆè§€æˆ°ï¼‰",
              }),
            );
          }

          // è·³è½‰åˆ°æˆ¿é–“å¤§å»³
          window.location.href = `room-lobby.html?code=${roomCode}`;
        } catch (error) {
          alert("å»ºç«‹æˆ¿é–“å¤±æ•—: " + error.message);
          button.disabled = false;
          button.textContent = "å»ºç«‹æˆ¿é–“";
        }
      }

      function collectFormData() {
        // ç§»é™¤æˆ¿é–“ä»£ç¢¼ä¸­çš„ç©ºæ ¼
        const roomCodeValue = document.getElementById("roomCode").value;
        const roomCode = roomCodeValue.replace(/\s+/g, ""); // ç›´æ¥ç§»é™¤ç©ºæ ¼ï¼Œä¸ä¾è³´ RoomCodeUtils
        const hasPassword = document.getElementById("hasPassword").checked;
        const hostJoinsGame = document.getElementById("hostJoinsGame").checked;

        return {
          roomCode,
          roomName: document.getElementById("roomName").value,
          hasPassword,
          password: hasPassword
            ? document.getElementById("password").value
            : null,
          hostJoinsGame,
          selectedStages,
          questionsCount: parseInt(
            document.getElementById("questionsCount").value,
          ),
          countdownSeconds: parseInt(
            document.getElementById("countdownSeconds").value,
          ),
          displaySettings: {
            showLeaderboard: document.getElementById("showLeaderboard").checked,
            showAnswerStatus:
              document.getElementById("showAnswerStatus").checked,
            showCompletionNotification: document.getElementById(
              "showCompletionNotification",
            ).checked,
            allowLateJoin: document.getElementById("allowLateJoin").checked,
            showFinalRanking:
              document.getElementById("showFinalRanking").checked,
          },
        };
      }
    </script>
  </body>
</html>
