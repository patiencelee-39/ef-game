<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åŠ å…¥æˆ¿é–“ - åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ²</title>
    <link rel="stylesheet" href="../css/main.css" />
    <style>
      .join-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 2rem;
      }

      .code-input-group {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin: 2rem 0;
      }

      .code-input {
        width: 60px;
        height: 80px;
        font-size: 2rem;
        text-align: center;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-weight: bold;
        text-transform: uppercase;
        transition: all 0.3s;
      }

      .code-input:focus {
        border-color: #4caf50;
        outline: none;
        transform: scale(1.05);
      }

      .code-separator {
        display: flex;
        align-items: center;
        font-size: 2rem;
        color: #999;
        font-weight: bold;
      }

      .player-name-input {
        width: 100%;
        padding: 1rem;
        font-size: 1.2rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        margin: 1rem 0;
        transition: all 0.3s;
      }

      .player-name-input:focus {
        border-color: #4caf50;
        outline: none;
      }

      .join-status {
        margin: 2rem 0;
        padding: 1rem;
        border-radius: 8px;
        display: none;
      }

      .join-status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .join-status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .join-status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .room-info {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
      }

      .room-info h3 {
        margin-bottom: 1rem;
        color: #333;
      }

      .room-info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dee2e6;
      }

      .room-info-item:last-child {
        border-bottom: none;
      }

      .btn-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
      }

      .btn-group button {
        flex: 1;
      }

      .loading {
        text-align: center;
        padding: 1rem;
        display: none;
      }

      .loading::after {
        content: '';
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4caf50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ”— åŠ å…¥æˆ¿é–“</h1>
        <p class="subtitle">è¼¸å…¥æˆ¿é–“ä»£ç¢¼ä»¥åŠ å…¥éŠæˆ²</p>
      </header>

      <main class="join-container">
        <div class="form-group">
          <label for="playerName">æ‚¨çš„åå­—</label>
          <input
            type="text"
            id="playerName"
            class="player-name-input"
            placeholder="è¼¸å…¥æ‚¨çš„åå­—"
            maxlength="20"
          />
        </div>

        <div class="form-group">
          <label>æˆ¿é–“ä»£ç¢¼</label>
          <div class="code-input-group">
            <input type="text" class="code-input" id="code1" maxlength="1" autocomplete="off" />
            <input type="text" class="code-input" id="code2" maxlength="1" autocomplete="off" />
            <input type="text" class="code-input" id="code3" maxlength="1" autocomplete="off" />
            <span class="code-separator">-</span>
            <input type="text" class="code-input" id="code4" maxlength="1" autocomplete="off" />
            <input type="text" class="code-input" id="code5" maxlength="1" autocomplete="off" />
            <input type="text" class="code-input" id="code6" maxlength="1" autocomplete="off" />
          </div>
        </div>

        <div class="loading" id="loading">æ­£åœ¨å°‹æ‰¾æˆ¿é–“...</div>

        <div class="join-status" id="joinStatus"></div>

        <div class="room-info" id="roomInfo">
          <h3>ğŸ“‹ æˆ¿é–“è³‡è¨Š</h3>
          <div class="room-info-item">
            <span>æˆ¿ä¸»ï¼š</span>
            <span id="roomHost">-</span>
          </div>
          <div class="room-info-item">
            <span>ç©å®¶äººæ•¸ï¼š</span>
            <span id="playerCount">-</span>
          </div>
          <div class="room-info-item">
            <span>é—œå¡æ•¸é‡ï¼š</span>
            <span id="stageCount">-</span>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn-secondary" onclick="location.href = '../index.html'">è¿”å›é¦–é </button>
          <button class="btn-primary" id="joinBtn" onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
        </div>
      </main>

      <footer>
        <p>&copy; 2026 åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ². All rights reserved.</p>
      </footer>
    </div>

    <script src="../js/firebase-config.js"></script>
    <script src="../js/utils/constants.js"></script>
    <script src="../js/utils/room-code.js"></script>
    <script>
      // ä»£ç¢¼è¼¸å…¥è‡ªå‹•è·³è½‰
      const codeInputs = document.querySelectorAll('.code-input');
      codeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.toUpperCase();
          e.target.value = value;

          if (value && index < codeInputs.length - 1) {
            codeInputs[index + 1].focus();
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            codeInputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pastedText = e.clipboardData.getData('text').toUpperCase().replace(/-/g, '');
          const chars = pastedText.split('');

          codeInputs.forEach((input, i) => {
            if (chars[i]) {
              input.value = chars[i];
            }
          });

          if (chars.length > 0) {
            const lastIndex = Math.min(chars.length - 1, codeInputs.length - 1);
            codeInputs[lastIndex].focus();
          }
        });
      });

      function getRoomCode() {
        const code = Array.from(codeInputs)
          .map((input) => input.value)
          .join('');
        return code.substring(0, 3) + '-' + code.substring(3, 6);
      }

      function showStatus(message, type) {
        const statusEl = document.getElementById('joinStatus');
        statusEl.textContent = message;
        statusEl.className = `join-status ${type}`;
        statusEl.style.display = 'block';
      }

      function hideStatus() {
        document.getElementById('joinStatus').style.display = 'none';
      }

      async function joinRoom() {
        const playerName = document.getElementById('playerName').value.trim();
        const roomCode = getRoomCode();

        // é©—è­‰è¼¸å…¥
        if (!playerName) {
          showStatus('âŒ è«‹è¼¸å…¥æ‚¨çš„åå­—', 'error');
          return;
        }

        if (roomCode.replace('-', '').length !== 6) {
          showStatus('âŒ è«‹è¼¸å…¥å®Œæ•´çš„ 6 ä½æˆ¿é–“ä»£ç¢¼', 'error');
          return;
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        document.getElementById('loading').style.display = 'block';
        document.getElementById('joinBtn').disabled = true;
        hideStatus();

        try {
          // æª¢æŸ¥æˆ¿é–“æ˜¯å¦å­˜åœ¨
          const roomRef = firebase.database().ref(`rooms/${roomCode}`);
          const snapshot = await roomRef.once('value');

          if (!snapshot.exists()) {
            showStatus('âŒ æˆ¿é–“ä¸å­˜åœ¨ï¼Œè«‹ç¢ºèªä»£ç¢¼æ˜¯å¦æ­£ç¢º', 'error');
            return;
          }

          const roomData = snapshot.val();

          // æª¢æŸ¥æˆ¿é–“ç‹€æ…‹
          if (roomData.status === 'playing') {
            showStatus('âŒ éŠæˆ²å·²é–‹å§‹ï¼Œç„¡æ³•åŠ å…¥', 'error');
            return;
          }

          if (roomData.status === 'finished') {
            showStatus('âŒ éŠæˆ²å·²çµæŸ', 'error');
            return;
          }

          // æª¢æŸ¥ç©å®¶æ•¸é‡
          const currentPlayers = roomData.players ? Object.keys(roomData.players).length : 0;
          const maxPlayers = roomData.settings?.maxPlayers || 4;

          if (currentPlayers >= maxPlayers) {
            showStatus(`âŒ æˆ¿é–“å·²æ»¿ï¼ˆ${maxPlayers}/${maxPlayers}ï¼‰`, 'error');
            return;
          }

          // é¡¯ç¤ºæˆ¿é–“è³‡è¨Š
          document.getElementById('roomHost').textContent = roomData.hostName || 'æœªçŸ¥';
          document.getElementById('playerCount').textContent = `${currentPlayers}/${maxPlayers}`;
          document.getElementById('stageCount').textContent = roomData.stages?.length || 0;
          document.getElementById('roomInfo').style.display = 'block';

          // åŠ å…¥æˆ¿é–“
          const playerId = `player_${Date.now()}`;
          await roomRef.child(`players/${playerId}`).set({
            name: playerName,
            joinedAt: firebase.database.ServerValue.TIMESTAMP,
            ready: false,
            score: 0,
          });

          showStatus('âœ… æˆåŠŸåŠ å…¥æˆ¿é–“ï¼æ­£åœ¨é€²å…¥éŠæˆ²...', 'success');

          // å„²å­˜ç©å®¶è³‡è¨Šåˆ° localStorage
          localStorage.setItem('currentRoomCode', roomCode);
          localStorage.setItem('currentPlayerId', playerId);
          localStorage.setItem('currentPlayerName', playerName);

          // å»¶é²å¾Œè·³è½‰åˆ°éŠæˆ²ç­‰å¾…å®¤
          setTimeout(() => {
            // TODO: è·³è½‰åˆ°éŠæˆ²ç­‰å¾…å®¤é é¢
            alert('åŠŸèƒ½é–‹ç™¼ä¸­ï¼šå°‡è·³è½‰åˆ°éŠæˆ²ç­‰å¾…å®¤');
            // location.href = `room-lobby.html?room=${roomCode}&player=${playerId}`;
          }, 1500);
        } catch (error) {
          console.error('åŠ å…¥æˆ¿é–“å¤±æ•—:', error);
          showStatus('âŒ åŠ å…¥æˆ¿é–“å¤±æ•—ï¼š' + error.message, 'error');
        } finally {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('joinBtn').disabled = false;
        }
      }

      // Enter éµæäº¤
      document.getElementById('playerName').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          codeInputs[0].focus();
        }
      });

      codeInputs[codeInputs.length - 1].addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          joinRoom();
        }
      });
    </script>
  </body>
</html>
