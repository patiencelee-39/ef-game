<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self'"
    />
    <title>è¨­å®š - åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ²</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/components/navbar.css" />
    <link rel="stylesheet" href="../css/components/landscape-hint.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei",
          "PingFang TC", "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(
          135deg,
          #0f0c29 0%,
          #302b63 50%,
          #24243e 100%
        );
        min-height: 100vh;
        color: #e8e8e8;
      }

      .settings-page {
        max-width: 480px;
        margin: 0 auto;
        padding: 24px 16px 120px;
      }

      /* === æ¨™é¡Œ === */
      .settings-page h1 {
        text-align: center;
        font-size: 1.5rem;
        font-weight: 800;
        margin-bottom: 24px;
        background: linear-gradient(135deg, #a8edea, #fed6e3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* === å€å¡Šå¡ç‰‡ === */
      .settings-section {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 18px 16px;
        margin-bottom: 16px;
        backdrop-filter: blur(8px);
      }
      .settings-section h2 {
        font-size: 1rem;
        font-weight: 700;
        margin: 0 0 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #fff;
      }

      /* === è¨­å®šåˆ— === */
      .settings-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 11px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .settings-item:last-child {
        border-bottom: none;
      }

      .settings-item__label {
        font-size: 0.92rem;
        color: rgba(255, 255, 255, 0.85);
        flex-shrink: 0;
      }
      .settings-item__value {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
        text-align: right;
      }

      /* === éŸ³é‡æ»‘æ¡¿ === */
      .volume-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 11px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .volume-row:last-child {
        border-bottom: none;
      }
      .volume-row__label {
        font-size: 0.92rem;
        color: rgba(255, 255, 255, 0.85);
        white-space: nowrap;
        min-width: 60px;
      }
      .volume-row__slider {
        flex: 1;
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.15);
        outline: none;
      }
      .volume-row__slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #ffd700;
        cursor: pointer;
        border: 2px solid rgba(0, 0, 0, 0.2);
      }
      .volume-row__slider::-moz-range-thumb {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #ffd700;
        cursor: pointer;
        border: 2px solid rgba(0, 0, 0, 0.2);
      }
      .volume-row__percent {
        font-size: 0.85rem;
        color: #ffd700;
        min-width: 36px;
        text-align: right;
        font-weight: 600;
      }

      /* === Toggle é–‹é—œ === */
      .toggle-switch {
        position: relative;
        width: 48px;
        height: 26px;
        flex-shrink: 0;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-switch__track {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 13px;
        cursor: pointer;
        transition: background 0.25s;
      }
      .toggle-switch__track::after {
        content: "";
        position: absolute;
        left: 3px;
        top: 3px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #fff;
        transition: transform 0.25s;
      }
      .toggle-switch input:checked + .toggle-switch__track {
        background: #2ecc71;
      }
      .toggle-switch input:checked + .toggle-switch__track::after {
        transform: translateX(22px);
      }

      /* === èªé€ŸæŒ‰éˆ•ç¾¤ === */
      .rate-selector {
        display: flex;
        gap: 6px;
      }
      .rate-btn {
        padding: 5px 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        background: transparent;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .rate-btn.active {
        background: rgba(255, 215, 0, 0.2);
        border-color: #ffd700;
        color: #ffd700;
        font-weight: 600;
      }

      /* === é¡Œæ•¸é¸æ“‡ === */
      .count-selector {
        display: flex;
        gap: 6px;
      }
      .count-btn {
        width: 38px;
        height: 34px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        background: transparent;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .count-btn.active {
        background: rgba(52, 152, 219, 0.25);
        border-color: var(--primary-blue, #3498db);
        color: var(--primary-blue, #3498db);
        font-weight: 700;
      }

      /* === æŒ‰éˆ• === */
      .settings-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 10px;
        font-size: 0.92rem;
        font-weight: 600;
        cursor: pointer;
        transition:
          opacity 0.2s,
          transform 0.1s;
        margin-bottom: 10px;
      }
      .settings-btn:last-child {
        margin-bottom: 0;
      }
      .settings-btn:active {
        transform: scale(0.97);
      }

      .settings-btn--export {
        background: rgba(52, 152, 219, 0.2);
        color: #3498db;
        border: 1px solid rgba(52, 152, 219, 0.3);
      }
      .settings-btn--import {
        background: rgba(46, 204, 113, 0.2);
        color: #2ecc71;
        border: 1px solid rgba(46, 204, 113, 0.3);
      }
      .settings-btn--danger {
        background: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
        border: 1px solid rgba(231, 76, 60, 0.25);
      }

      /* === è¨ªå®¢æ¨™ç±¤ === */
      .guest-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.78rem;
        font-weight: 600;
        background: rgba(243, 156, 18, 0.2);
        color: #f39c12;
        border: 1px solid rgba(243, 156, 18, 0.3);
      }

      /* === æç¤ºè¨Šæ¯ === */
      .settings-toast {
        position: fixed;
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 0.88rem;
        z-index: 9999;
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 0.3s,
          transform 0.3s;
        backdrop-filter: blur(8px);
      }
      .settings-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* === éš±è—çš„ file input === */
      #importFileInput {
        display: none;
      }

      /* === ç¢ºèªå½ˆçª— === */
      .confirm-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s;
      }
      .confirm-overlay.show {
        opacity: 1;
        pointer-events: auto;
      }
      .confirm-dialog {
        background: #2a2a4a;
        border-radius: 16px;
        padding: 28px 24px 20px;
        max-width: 320px;
        width: 90%;
        text-align: center;
      }
      .confirm-dialog__icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
      }
      .confirm-dialog__title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: #fff;
      }
      .confirm-dialog__msg {
        font-size: 0.88rem;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 20px;
        line-height: 1.5;
      }
      .confirm-dialog__actions {
        display: flex;
        gap: 10px;
      }
      .confirm-dialog__btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 10px;
        font-size: 0.92rem;
        font-weight: 600;
        cursor: pointer;
      }
      .confirm-dialog__btn--cancel {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.7);
      }
      .confirm-dialog__btn--danger {
        background: #e74c3c;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <main class="settings-page" id="main-content">
      <h1>âš™ï¸ è¨­å®š</h1>

      <!-- ==================== -->
      <!-- ğŸ‘¤ ç©å®¶è³‡è¨Š           -->
      <!-- ==================== -->
      <div class="settings-section" id="sectionPlayerInfo">
        <h2>ğŸ‘¤ ç©å®¶è³‡è¨Š</h2>
        <div class="settings-item">
          <span class="settings-item__label">åº§è™Ÿ</span>
          <span class="settings-item__value" id="infoSeatNumber">--</span>
        </div>
        <div class="settings-item">
          <span class="settings-item__label">æš±ç¨±</span>
          <span class="settings-item__value" id="infoNickname">--</span>
        </div>
        <div class="settings-item">
          <span class="settings-item__label">ç­‰ç´š</span>
          <span class="settings-item__value" id="infoLevel">--</span>
        </div>
        <div class="settings-item">
          <span class="settings-item__label">â­ ç¸½æ˜Ÿæ˜Ÿ</span>
          <span class="settings-item__value" id="infoTotalStars">--</span>
        </div>
        <div class="settings-item">
          <span class="settings-item__label">â­ å¯ç”¨æ˜Ÿæ˜Ÿ</span>
          <span class="settings-item__value" id="infoAvailStars">--</span>
        </div>
        <div class="settings-item">
          <span class="settings-item__label">ğŸ… å¾½ç« æ•¸</span>
          <span class="settings-item__value" id="infoBadgeCount">--</span>
        </div>
        <div class="settings-item" id="guestInfoRow" style="display: none">
          <span class="settings-item__label">èº«ä»½</span>
          <span class="guest-badge">ğŸ‘¤ è¨ªå®¢æ¨¡å¼</span>
        </div>
      </div>

      <!-- ==================== -->
      <!-- ğŸ”Š éŸ³æ•ˆè¨­å®š           -->
      <!-- ==================== -->
      <div class="settings-section">
        <h2>ğŸ”Š éŸ³æ•ˆè¨­å®š</h2>
        <!-- ä¸»éŸ³é‡ -->
        <div class="volume-row">
          <span class="volume-row__label">ğŸ”Š éŸ³é‡</span>
          <input
            type="range"
            id="volumeSlider"
            class="volume-row__slider"
            min="0"
            max="100"
            value="80"
            aria-label="ä¸»éŸ³é‡"
          />
          <span class="volume-row__percent" id="volumePercent">80%</span>
        </div>
        <!-- éŸ³æ•ˆé–‹é—œ -->
        <div class="settings-item">
          <span class="settings-item__label">ğŸµ éŸ³æ•ˆ</span>
          <label class="toggle-switch">
            <input type="checkbox" id="sfxToggle" checked aria-label="éŸ³æ•ˆé–‹é—œ" />
            <span class="toggle-switch__track"></span>
          </label>
        </div>
        <!-- èªéŸ³é–‹é—œ -->
        <div class="settings-item">
          <span class="settings-item__label">ğŸ—£ï¸ èªéŸ³</span>
          <label class="toggle-switch">
            <input type="checkbox" id="voiceToggle" checked aria-label="èªéŸ³é–‹é—œ" />
            <span class="toggle-switch__track"></span>
          </label>
        </div>
        <!-- èªé€Ÿ -->
        <div class="settings-item">
          <span class="settings-item__label">ğŸ—£ï¸ èªé€Ÿ</span>
          <div class="rate-selector" id="rateSelector">
            <button class="rate-btn" data-rate="0.7">ğŸ¢ æ…¢</button>
            <button class="rate-btn active" data-rate="1.0">ğŸ‡ æ­£å¸¸</button>
            <button class="rate-btn" data-rate="1.2">ğŸ† å¿«</button>
          </div>
        </div>
      </div>

      <!-- ==================== -->
      <!-- ğŸ¯ éŠæˆ²è¨­å®š           -->
      <!-- ==================== -->
      <div class="settings-section">
        <h2>ğŸ¯ éŠæˆ²è¨­å®š</h2>
        <!-- é¡Œæ•¸è¨­å®š -->
        <div class="settings-item">
          <span class="settings-item__label">ğŸ“ æ¯å›åˆé¡Œæ•¸</span>
          <div class="count-selector" id="countSelector">
            <button class="count-btn" data-count="4">4</button>
            <button class="count-btn active" data-count="6">6</button>
            <button class="count-btn" data-count="8">8</button>
            <button class="count-btn" data-count="10">10</button>
          </div>
        </div>
      </div>

      <!-- ==================== -->
      <!-- ğŸ—„ï¸ è³‡æ–™ç®¡ç†           -->
      <!-- ==================== -->
      <div class="settings-section">
        <h2>ğŸ—„ï¸ è³‡æ–™ç®¡ç†</h2>
        <button class="settings-btn settings-btn--export" id="btnExport">
          ğŸ“¤ åŒ¯å‡ºéŠæˆ²ç´€éŒ„
        </button>
        <button class="settings-btn settings-btn--import" id="btnImport">
          ğŸ“¥ åŒ¯å…¥éŠæˆ²ç´€éŒ„
        </button>
        <button class="settings-btn settings-btn--danger" id="btnClearAll">
          ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™
        </button>
        <input type="file" id="importFileInput" accept=".json" aria-label="é¸æ“‡ JSON å‚™ä»½æª”" />
      </div>

      <!-- ==================== -->
      <!-- ï¿½ æˆ‘çš„çµ±è¨ˆ           -->
      <!-- ==================== -->
      <div class="settings-section">
        <h2>ğŸ“ˆ æˆ‘çš„çµ±è¨ˆ</h2>
        <a
          href="../singleplayer/stats.html"
          class="settings-btn"
          style="
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
            border: 1px solid rgba(79, 195, 247, 0.3);
            text-decoration: none;
          "
        >
          ğŸ“Š æŸ¥çœ‹å€‹äººçµ±è¨ˆ
        </a>
        <p
          style="
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.65);
            text-align: center;
            margin-top: 6px;
            line-height: 1.4;
          "
        >
          æ¢éšªé€²åº¦ã€è¦å‰‡è¡¨ç¾ã€å¾½ç« æ”¶é›†ä¸€è¦½
        </p>
      </div>

      <!-- ==================== -->
      <!-- ï¿½ğŸ‘©â€ğŸ« æ•™å¸«å°ˆå€           -->
      <!-- ==================== -->
      <div class="settings-section">
        <h2>ğŸ‘©â€ğŸ« æ•™å¸«å°ˆå€</h2>
        <a
          href="../management/index.html"
          class="settings-btn"
          style="
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
            border: 1px solid rgba(155, 89, 182, 0.3);
            text-decoration: none;
          "
        >
          ğŸ« æ•™å¸«ç®¡ç†å¾Œå°
        </a>
        <p
          style="
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.65);
            text-align: center;
            margin-top: 6px;
            line-height: 1.4;
          "
        >
          ç­ç´šç®¡ç†ã€å­¸ç”Ÿé€²åº¦æŸ¥çœ‹ã€è³‡æ–™åŒ¯å‡º
        </p>
      </div>

      <!-- ==================== -->
      <!-- â„¹ï¸ é—œæ–¼               -->
      <!-- ==================== -->
      <div class="settings-section">
        <h2>â„¹ï¸ é—œæ–¼</h2>
        <div class="settings-item">
          <span class="settings-item__label">ç‰ˆæœ¬</span>
          <span class="settings-item__value">v5.0</span>
        </div>
        <div class="settings-item">
          <span class="settings-item__label">é–‹ç™¼è€…</span>
          <span class="settings-item__value">Patience Lee</span>
        </div>
        <div class="settings-item">
          <span class="settings-item__label">å°ˆæ¡ˆ</span>
          <span class="settings-item__value">åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ²</span>
        </div>
        <a
          href="../privacy.html"
          class="settings-item"
          style="text-decoration: none; cursor: pointer"
        >
          <span class="settings-item__label">éš±ç§æ¬Šæ”¿ç­–</span>
          <span
            class="settings-item__value"
            style="color: rgba(168, 237, 234, 0.8)"
            >æŸ¥çœ‹ â†’</span
          >
        </a>
      </div>
    </div>

    <!-- Toast æç¤º -->
    <div class="settings-toast" id="toast" role="status" aria-live="polite"></div>

    <!-- ç¢ºèªå½ˆçª— -->
    <div class="confirm-overlay" id="confirmOverlay" role="dialog" aria-modal="true" aria-label="ç¢ºèªæ“ä½œ">
      <div class="confirm-dialog">
        <div class="confirm-dialog__icon" id="confirmIcon">âš ï¸</div>
        <div class="confirm-dialog__title" id="confirmTitle">ç¢ºèªæ“ä½œ</div>
        <div class="confirm-dialog__msg" id="confirmMsg">ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ</div>
        <div class="confirm-dialog__actions">
          <button
            class="confirm-dialog__btn confirm-dialog__btn--cancel"
            id="confirmCancel"
          >
            å–æ¶ˆ
          </button>
          <button
            class="confirm-dialog__btn confirm-dialog__btn--danger"
            id="confirmOk"
          >
            ç¢ºå®š
          </button>
        </div>
      </div>
    </main>

    <!-- === Scripts === -->
    <script src="../js/utils/storage.js"></script>
    <script src="../js/shared/audio-player.js"></script>
    <script>
      // =========================================
      // âš™ï¸ è¨­å®šé é¢æ§åˆ¶å™¨
      // =========================================
      (function () {
        "use strict";

        // ----- DOM å…ƒç´  -----
        var volumeSlider = document.getElementById("volumeSlider");
        var volumePercent = document.getElementById("volumePercent");
        var sfxToggle = document.getElementById("sfxToggle");
        var voiceToggle = document.getElementById("voiceToggle");
        var rateSelector = document.getElementById("rateSelector");
        var countSelector = document.getElementById("countSelector");
        var btnExport = document.getElementById("btnExport");
        var btnImport = document.getElementById("btnImport");
        var btnClearAll = document.getElementById("btnClearAll");
        var importFileInput = document.getElementById("importFileInput");
        var toast = document.getElementById("toast");

        // ----- åˆå§‹åŒ– -----
        function init() {
          loadPlayerInfo();
          loadAudioSettings();
          loadGameSettings();
          bindEvents();
        }

        // =========================================
        // ğŸ‘¤ ç©å®¶è³‡è¨Š
        // =========================================
        function loadPlayerInfo() {
          var profile =
            typeof getPlayerProfile === "function" ? getPlayerProfile() : null;
          if (!profile) {
            document.getElementById("infoSeatNumber").textContent = "æœªè¨­å®š";
            document.getElementById("infoNickname").textContent = "æœªè¨­å®š";
            document.getElementById("infoLevel").textContent = "1";
            document.getElementById("infoTotalStars").textContent = "0";
            document.getElementById("infoAvailStars").textContent = "0";
            document.getElementById("infoBadgeCount").textContent = "0";
            return;
          }

          document.getElementById("infoSeatNumber").textContent =
            profile.seatNumber || "--";
          document.getElementById("infoNickname").textContent =
            profile.nickname || "--";
          document.getElementById("infoLevel").textContent =
            "Lv." +
            (typeof getLevel === "function" ? getLevel() : profile.level || 1);
          document.getElementById("infoTotalStars").textContent =
            typeof getTotalStars === "function"
              ? getTotalStars()
              : profile.totalStars || 0;
          document.getElementById("infoAvailStars").textContent =
            typeof getAvailableStars === "function" ? getAvailableStars() : 0;

          var badges =
            typeof getBadges === "function"
              ? getBadges()
              : profile.badges || [];
          document.getElementById("infoBadgeCount").textContent = badges.length;

          // è¨ªå®¢æ¨™è¨˜
          var isGuest = typeof isGuestPlayer === "function" && isGuestPlayer();
          document.getElementById("guestInfoRow").style.display = isGuest
            ? "flex"
            : "none";
        }

        // =========================================
        // ğŸ”Š éŸ³æ•ˆè¨­å®š
        // =========================================
        function loadAudioSettings() {
          // ç¢ºä¿ AudioPlayer å·²åˆå§‹åŒ–
          if (typeof AudioPlayer !== "undefined") {
            // éŸ³é‡
            var vol = AudioPlayer.getVolume();
            var pct = Math.round(vol * 100);
            volumeSlider.value = pct;
            volumePercent.textContent = pct + "%";

            // SFX / Voice é–‹é—œ
            sfxToggle.checked = AudioPlayer.isSfxEnabled();
            voiceToggle.checked = AudioPlayer.isVoiceEnabled();

            // èªé€Ÿ
            var rate = AudioPlayer.getVoiceRate();
            updateRateButtons(rate);
          }
        }

        function updateRateButtons(rate) {
          var btns = rateSelector.querySelectorAll(".rate-btn");
          // æ‰¾æœ€æ¥è¿‘çš„
          var closest = 1.0;
          var minDiff = 999;
          btns.forEach(function (b) {
            var r = parseFloat(b.getAttribute("data-rate"));
            var diff = Math.abs(r - rate);
            if (diff < minDiff) {
              minDiff = diff;
              closest = r;
            }
          });
          btns.forEach(function (b) {
            var r = parseFloat(b.getAttribute("data-rate"));
            b.classList.toggle("active", r === closest);
          });
        }

        // =========================================
        // ğŸ¯ éŠæˆ²è¨­å®š
        // =========================================
        function loadGameSettings() {
          var count =
            typeof getQuestionCountPreference === "function"
              ? getQuestionCountPreference()
              : 6;
          var btns = countSelector.querySelectorAll(".count-btn");
          btns.forEach(function (b) {
            var c = parseInt(b.getAttribute("data-count"), 10);
            b.classList.toggle("active", c === count);
          });
        }

        // =========================================
        // äº‹ä»¶ç¶å®š
        // =========================================
        function bindEvents() {
          // --- éŸ³é‡æ»‘æ¡¿ ---
          volumeSlider.addEventListener("input", function () {
            var pct = parseInt(this.value, 10);
            volumePercent.textContent = pct + "%";
            if (typeof AudioPlayer !== "undefined") {
              AudioPlayer.setVolume(pct / 100);
            }
            // åŒæ­¥åˆ° profile
            if (typeof saveSoundSettings === "function") {
              saveSoundSettings({ masterVolume: pct / 100 });
            }
          });

          // --- SFX é–‹é—œ ---
          sfxToggle.addEventListener("change", function () {
            if (typeof AudioPlayer !== "undefined") {
              AudioPlayer.setSfxEnabled(this.checked);
            }
            if (typeof saveSoundSettings === "function") {
              saveSoundSettings({ sfx: this.checked });
            }
          });

          // --- èªéŸ³é–‹é—œ ---
          voiceToggle.addEventListener("change", function () {
            if (typeof AudioPlayer !== "undefined") {
              AudioPlayer.setVoiceEnabled(this.checked);
            }
            if (typeof saveSoundSettings === "function") {
              saveSoundSettings({ voice: this.checked });
            }
          });

          // --- èªé€ŸæŒ‰éˆ• ---
          rateSelector.addEventListener("click", function (e) {
            var btn = e.target.closest(".rate-btn");
            if (!btn) return;
            var rate = parseFloat(btn.getAttribute("data-rate"));
            if (typeof AudioPlayer !== "undefined") {
              AudioPlayer.setVoiceRate(rate);
            }
            updateRateButtons(rate);
            showToast("èªé€Ÿå·²è¨­å®šç‚º " + btn.textContent.trim());
          });

          // --- é¡Œæ•¸æŒ‰éˆ• ---
          countSelector.addEventListener("click", function (e) {
            var btn = e.target.closest(".count-btn");
            if (!btn) return;
            var count = parseInt(btn.getAttribute("data-count"), 10);
            if (typeof saveQuestionCountPreference === "function") {
              saveQuestionCountPreference(count);
            }
            var btns = countSelector.querySelectorAll(".count-btn");
            btns.forEach(function (b) {
              b.classList.toggle(
                "active",
                parseInt(b.getAttribute("data-count"), 10) === count,
              );
            });
            showToast("æ¯å›åˆé¡Œæ•¸å·²è¨­å®šç‚º " + count + " é¡Œ");
          });

          // --- åŒ¯å‡º ---
          btnExport.addEventListener("click", handleExport);

          // --- åŒ¯å…¥ ---
          btnImport.addEventListener("click", function () {
            importFileInput.click();
          });
          importFileInput.addEventListener("change", handleImport);

          // --- æ¸…é™¤æ‰€æœ‰è³‡æ–™ ---
          btnClearAll.addEventListener("click", handleClearAll);
        }

        // =========================================
        // ğŸ“¤ åŒ¯å‡º
        // =========================================
        function handleExport() {
          if (typeof exportGameData !== "function") {
            showToast("âŒ åŒ¯å‡ºåŠŸèƒ½ä¸å¯ç”¨");
            return;
          }
          try {
            var json = exportGameData();
            var blob = new Blob([json], { type: "application/json" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            var profile =
              typeof getPlayerProfile === "function"
                ? getPlayerProfile()
                : null;
            var name = profile
              ? profile.seatNumber + "_" + profile.nickname
              : "game";
            var date = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = "efgame-backup-" + name + "-" + date + ".json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("âœ… éŠæˆ²ç´€éŒ„å·²åŒ¯å‡º");
          } catch (e) {
            console.error("åŒ¯å‡ºå¤±æ•—:", e);
            showToast("âŒ åŒ¯å‡ºå¤±æ•—");
          }
        }

        // =========================================
        // ğŸ“¥ åŒ¯å…¥
        // =========================================
        function handleImport(e) {
          var file = e.target.files && e.target.files[0];
          if (!file) return;
          if (!file.name.endsWith(".json")) {
            showToast("âŒ è«‹é¸æ“‡ .json æª”æ¡ˆ");
            importFileInput.value = "";
            return;
          }
          var reader = new FileReader();
          reader.onload = function (ev) {
            if (typeof importGameData !== "function") {
              showToast("âŒ åŒ¯å…¥åŠŸèƒ½ä¸å¯ç”¨");
              return;
            }
            var ok = importGameData(ev.target.result);
            if (ok) {
              showToast("âœ… éŠæˆ²ç´€éŒ„å·²åŒ¯å…¥ï¼Œé‡æ–°è¼‰å…¥ä¸­â€¦");
              setTimeout(function () {
                location.reload();
              }, 1200);
            } else {
              showToast("âŒ åŒ¯å…¥å¤±æ•—ï¼Œæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º");
            }
          };
          reader.readAsText(file);
          importFileInput.value = "";
        }

        // =========================================
        // ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™
        // =========================================
        function handleClearAll() {
          showConfirm(
            "âš ï¸",
            "æ¸…é™¤æ‰€æœ‰è³‡æ–™",
            "æ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰éŠæˆ²ç´€éŒ„ã€é€²åº¦ã€æ˜Ÿæ˜Ÿå’Œå¾½ç« ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚",
            function () {
              if (typeof clearAllGameData === "function") {
                clearAllGameData();
                showToast("âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼Œé‡æ–°è¼‰å…¥ä¸­â€¦");
                setTimeout(function () {
                  location.reload();
                }, 1200);
              } else {
                showToast("âŒ æ¸…é™¤åŠŸèƒ½ä¸å¯ç”¨");
              }
            },
          );
        }

        // =========================================
        // ğŸ”” Toast æç¤º
        // =========================================
        var _toastTimer = null;
        function showToast(msg) {
          if (_toastTimer) clearTimeout(_toastTimer);
          toast.textContent = msg;
          toast.classList.add("show");
          _toastTimer = setTimeout(function () {
            toast.classList.remove("show");
          }, 2200);
        }

        // =========================================
        // âš ï¸ ç¢ºèªå½ˆçª—
        // =========================================
        function showConfirm(icon, title, msg, onOk) {
          var overlay = document.getElementById("confirmOverlay");
          document.getElementById("confirmIcon").textContent = icon;
          document.getElementById("confirmTitle").textContent = title;
          document.getElementById("confirmMsg").textContent = msg;
          overlay.classList.add("show");

          var okBtn = document.getElementById("confirmOk");
          var cancelBtn = document.getElementById("confirmCancel");

          function cleanup() {
            overlay.classList.remove("show");
            okBtn.removeEventListener("click", onConfirm);
            cancelBtn.removeEventListener("click", onCancel);
          }
          function onConfirm() {
            cleanup();
            if (onOk) onOk();
          }
          function onCancel() {
            cleanup();
          }
          okBtn.addEventListener("click", onConfirm);
          cancelBtn.addEventListener("click", onCancel);
        }

        // ----- å•Ÿå‹• -----
        document.addEventListener("DOMContentLoaded", init);
      })();
    </script>
    <script src="../js/shared/navbar.js"></script>
    <script src="../js/shared/landscape-hint.js"></script>
  </body>
</html>
