<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;"
    />
    <title>è‡ªç”±é¸æ“‡ â€” åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ²</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/components/landscape-hint.css" />
    <style>
      ==================================== */ body {
        padding: var(--spacing-md);
      }

      .free-select-container {
        max-width: 720px;
        margin: 0 auto;
      }

      /* --- Header --- */
      .fs-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: var(--spacing-lg);
      }

      .btn-back {
        background: none;
        border: none;
        color: var(--text-white);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        min-width: var(--touch-target-min);
        min-height: var(--touch-target-min);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background var(--transition-fast);
      }

      .btn-back:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .fs-title {
        font-size: var(--font-size-xxl);
        color: var(--text-white);
        font-weight: 900;
      }

      /* --- éŠæˆ²å ´é¸æ“‡ --- */
      .section-label {
        font-size: var(--font-size-md);
        color: var(--text-light);
        margin-bottom: var(--spacing-xs);
        font-weight: 600;
      }

      .field-selector {
        display: flex;
        gap: 12px;
        margin-bottom: var(--spacing-md);
        flex-wrap: wrap;
      }

      .field-btn {
        flex: 1;
        min-width: 140px;
        padding: 16px;
        border-radius: var(--border-radius-lg);
        border: 2px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-white);
        font-size: var(--font-size-lg);
        font-weight: 700;
        cursor: pointer;
        transition: all var(--transition-fast);
        text-align: center;
        min-height: var(--touch-target-min);
      }

      .field-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .field-btn.selected {
        border-color: var(--primary-blue);
        background: rgba(52, 152, 219, 0.2);
      }

      /* --- è¦å‰‡é¸æ“‡ --- */
      .rule-selector {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: var(--spacing-md);
      }

      .rule-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: var(--border-radius-md);
        border: 2px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
        cursor: pointer;
        transition: all var(--transition-fast);
        min-height: var(--touch-target-min);
        /* button reset */
        font: inherit;
        color: inherit;
        text-align: left;
        width: 100%;
      }

      .rule-option:hover {
        background: rgba(255, 255, 255, 0.06);
      }

      .rule-option.selected {
        border-color: var(--primary-blue);
        background: rgba(52, 152, 219, 0.15);
      }

      .rule-checkbox {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all var(--transition-fast);
      }

      .rule-option.selected .rule-checkbox {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
      }

      .rule-option.selected .rule-checkbox::after {
        content: "âœ“";
        color: #fff;
        font-weight: 900;
        font-size: 14px;
      }

      .rule-info {
        flex: 1;
      }

      .rule-name {
        font-size: var(--font-size-md);
        color: var(--text-white);
        font-weight: 600;
      }

      .rule-desc {
        font-size: var(--font-size-xs);
        color: var(--text-light);
        margin-top: 2px;
      }

      /* --- WM é–‹é—œ --- */
      .wm-toggle-section {
        margin-bottom: var(--spacing-md);
        padding: 16px;
        border-radius: var(--border-radius-lg);
        background: rgba(92, 107, 192, 0.1);
        border: 1px solid rgba(92, 107, 192, 0.2);
      }

      .wm-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        /* button reset */
        background: none;
        border: none;
        padding: 0;
        font: inherit;
        color: inherit;
        width: 100%;
      }

      .wm-label {
        font-size: var(--font-size-md);
        color: var(--text-white);
        font-weight: 600;
      }

      .toggle-switch {
        width: 52px;
        height: 28px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 14px;
        position: relative;
        transition: background var(--transition-fast);
        cursor: pointer;
      }

      .toggle-switch.active {
        background: var(--wm-color);
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        width: 22px;
        height: 22px;
        background: #fff;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: transform var(--transition-fast);
      }

      .toggle-switch.active::after {
        transform: translateX(24px);
      }

      /* --- é¡Œæ•¸é¸æ“‡ --- */
      .question-count-section {
        margin-bottom: var(--spacing-lg);
      }

      .count-slider-row {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .count-slider {
        flex: 1;
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 3px;
        outline: none;
      }

      .count-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--primary-blue);
        cursor: pointer;
      }

      .count-value {
        font-size: var(--font-size-lg);
        color: var(--accent-yellow);
        font-weight: 900;
        min-width: 50px;
        text-align: center;
      }

      /* --- çµ„åˆé è¦½ --- */
      .combo-preview {
        margin-bottom: var(--spacing-md);
        padding: 16px;
        border-radius: var(--border-radius-lg);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .combo-list {
        list-style: none;
        padding: 0;
      }

      .combo-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        color: var(--text-light);
        font-size: var(--font-size-sm);
      }

      .combo-item:last-child {
        border-bottom: none;
      }

      .combo-item-name {
        font-weight: 600;
        color: var(--text-white);
      }

      .combo-item-meta {
        font-size: var(--font-size-xs);
        color: var(--text-light);
      }

      .no-combo-msg {
        text-align: center;
        color: var(--text-light);
        font-size: var(--font-size-sm);
        padding: 16px;
      }

      /* --- é–‹å§‹æŒ‰éˆ• --- */
      .btn-start-game {
        width: 100%;
        padding: 16px;
        font-size: var(--font-size-lg);
        font-weight: 900;
        border-radius: var(--border-radius-lg);
        border: none;
        background: var(--success-green);
        color: #fff;
        cursor: pointer;
        min-height: var(--touch-target-min);
        transition: all var(--transition-fast);
      }

      .btn-start-game:hover {
        background: #27ae60;
      }

      .btn-start-game:disabled {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.3);
        cursor: not-allowed;
      }

      /* --- éŸ¿æ‡‰å¼ --- */
      @media (max-width: 480px) {
        .fs-title {
          font-size: var(--font-size-xl);
        }

        .field-btn {
          min-width: 100px;
          padding: 12px;
          font-size: var(--font-size-md);
        }
      }
    </style>
    <link rel="stylesheet" href="../css/components/navbar.css" />
    <!-- JS ä¾è³´ -->
    <script defer src="../js/game-config.js"></script>
    <script defer src="../js/adventure-maps-config.js"></script>
    <script defer src="../js/utils/storage.js"></script>
    <script defer src="../js/utils/score-calculator.js"></script>
    <script defer src="../js/utils/level-calculator.js"></script>
    <script defer src="../js/utils/badge-checker.js"></script>
    <script defer src="../js/shared/game-session-builder.js"></script>
    <script defer src="../js/singleplayer/progress-tracker.js"></script>
    <script defer src="../js/singleplayer/mode-controller.js"></script>
    <script defer src="../js/shared/navbar.js"></script>
    <script defer src="../js/shared/landscape-hint.js"></script>
  </head>
  <body>
    <main class="free-select-container" id="main-content">
      <!-- Header -->
      <div class="fs-header">
        <button
          class="btn-back"
          onclick="ModeController.goToAdventureMap()"
          aria-label="è¿”å›æ¢éšªåœ°åœ–"
        >
          â†
        </button>
        <h1 class="fs-title">ğŸ†“ è‡ªç”±é¸æ“‡</h1>
      </div>

      <!-- éŠæˆ²å ´é¸æ“‡ -->
      <p class="section-label">é¸æ“‡éŠæˆ²å ´</p>
      <div class="field-selector" id="field-selector">
        <button
          class="field-btn"
          data-field="mouse"
          onclick="toggleField('mouse')"
        >
          ğŸ­ å°è€é¼ 
        </button>
        <button
          class="field-btn"
          data-field="fishing"
          onclick="toggleField('fishing')"
        >
          ğŸŸ é‡£é­š
        </button>
      </div>

      <!-- è¦å‰‡é¸æ“‡ -->
      <p class="section-label">é¸æ“‡è¦å‰‡</p>
      <div class="rule-selector" id="rule-selector">
        <button
          class="rule-option"
          type="button"
          data-rule="rule1"
          onclick="toggleRule('rule1')"
          role="checkbox"
          aria-checked="false"
        >
          <div class="rule-checkbox" aria-hidden="true"></div>
          <div class="rule-info">
            <div class="rule-name">è¦å‰‡ä¸€ï¼ˆå»ºç«‹è¦å‰‡ï¼‰</div>
            <div class="rule-desc">è¨“ç·´æŠ‘åˆ¶æ§åˆ¶</div>
          </div>
        </button>
        <button
          class="rule-option"
          type="button"
          data-rule="rule2"
          onclick="toggleRule('rule2')"
          role="checkbox"
          aria-checked="false"
        >
          <div class="rule-checkbox" aria-hidden="true"></div>
          <div class="rule-info">
            <div class="rule-name">è¦å‰‡äºŒï¼ˆè¦å‰‡è½‰æ›ï¼‰</div>
            <div class="rule-desc">è¨“ç·´èªçŸ¥å½ˆæ€§</div>
          </div>
        </button>
        <button
          class="rule-option"
          type="button"
          data-rule="mixed"
          onclick="toggleRule('mixed')"
          role="checkbox"
          aria-checked="false"
        >
          <div class="rule-checkbox" aria-hidden="true"></div>
          <div class="rule-info">
            <div class="rule-name">æ··åˆè¦å‰‡</div>
            <div class="rule-desc">è¨“ç·´å·¥ä½œè¨˜æ†¶ + èªçŸ¥å½ˆæ€§</div>
          </div>
        </button>
      </div>

      <!-- WM é–‹é—œ -->
      <div class="wm-toggle-section">
        <button
          type="button"
          class="wm-toggle"
          onclick="toggleWM()"
          role="switch"
          aria-checked="false"
          aria-label="å·¥ä½œè¨˜æ†¶æ¸¬é©—"
        >
          <span class="wm-label">ğŸ§  å·¥ä½œè¨˜æ†¶æ¸¬é©—</span>
          <div class="toggle-switch" id="wm-toggle" aria-hidden="true"></div>
        </button>
      </div>

      <!-- é¡Œæ•¸ -->
      <div class="question-count-section">
        <p class="section-label">æ¯è¦å‰‡é¡Œæ•¸</p>
        <div class="count-slider-row">
          <input
            type="range"
            class="count-slider"
            id="count-slider"
            min="6"
            max="30"
            step="2"
            value="6"
            aria-label="æ¯è¦å‰‡é¡Œæ•¸"
            oninput="updateQuestionCount(this.value)"
          />
          <span class="count-value" id="count-value">6</span>
        </div>
      </div>

      <!-- çµ„åˆé è¦½ -->
      <div class="combo-preview">
        <p class="section-label">çµ„åˆé è¦½</p>
        <ul class="combo-list" id="combo-list">
          <li class="no-combo-msg">è«‹é¸æ“‡éŠæˆ²å ´å’Œè¦å‰‡</li>
        </ul>
      </div>

      <!-- é–‹å§‹æŒ‰éˆ• -->
      <button
        class="btn-start-game"
        id="btn-start"
        disabled
        onclick="startGame()"
      >
        â–¶ï¸ é–‹å§‹éŠæˆ²
      </button>
    </main>

    <script>
      // =========================================
      // è‡ªç”±é¸æ“‡é é¢æ§åˆ¶
      // =========================================

      var selectedFields = [];
      var selectedRules = [];
      var wmEnabled = false;
      var questionCount = 6;

      // â”€â”€â”€ éŠæˆ²å ´ Toggle â”€â”€â”€
      function toggleField(fieldId) {
        var idx = selectedFields.indexOf(fieldId);
        if (idx === -1) {
          selectedFields.push(fieldId);
        } else {
          selectedFields.splice(idx, 1);
        }

        document.querySelectorAll(".field-btn").forEach(function (btn) {
          btn.classList.toggle(
            "selected",
            selectedFields.indexOf(btn.dataset.field) !== -1,
          );
        });

        updatePreview();
      }

      // â”€â”€â”€ è¦å‰‡ Toggle â”€â”€â”€
      function toggleRule(ruleId) {
        var idx = selectedRules.indexOf(ruleId);
        if (idx === -1) {
          selectedRules.push(ruleId);
        } else {
          selectedRules.splice(idx, 1);
        }

        document.querySelectorAll(".rule-option").forEach(function (opt) {
          var isSelected = selectedRules.indexOf(opt.dataset.rule) !== -1;
          opt.classList.toggle("selected", isSelected);
          opt.setAttribute("aria-checked", isSelected ? "true" : "false");
        });

        updatePreview();
      }

      // â”€â”€â”€ WM Toggle â”€â”€â”€
      function toggleWM() {
        wmEnabled = !wmEnabled;
        document
          .getElementById("wm-toggle")
          .classList.toggle("active", wmEnabled);
        // æ›´æ–° ARIA switch ç‹€æ…‹
        var wmBtn = document.querySelector(".wm-toggle");
        if (wmBtn)
          wmBtn.setAttribute("aria-checked", wmEnabled ? "true" : "false");
        updatePreview();
      }

      // â”€â”€â”€ é¡Œæ•¸æ›´æ–° â”€â”€â”€
      function updateQuestionCount(val) {
        questionCount = parseInt(val, 10);
        document.getElementById("count-value").textContent = questionCount;
        updatePreview();
      }

      // â”€â”€â”€ çµ„åˆé è¦½ â”€â”€â”€
      function updatePreview() {
        var combos = buildCombos();
        var list = document.getElementById("combo-list");
        var startBtn = document.getElementById("btn-start");

        if (combos.length === 0) {
          list.innerHTML = '<li class="no-combo-msg">è«‹é¸æ“‡éŠæˆ²å ´å’Œè¦å‰‡</li>';
          startBtn.disabled = true;
          return;
        }

        startBtn.disabled = false;
        list.innerHTML = "";

        combos.forEach(function (combo, idx) {
          var li = document.createElement("li");
          li.className = "combo-item";

          var fieldConfig = GAME_CONFIG.FIELDS[combo.fieldId];
          var ruleName =
            combo.ruleId === "rule1"
              ? "è¦å‰‡ä¸€"
              : combo.ruleId === "rule2"
                ? "è¦å‰‡äºŒ"
                : "æ··åˆè¦å‰‡";

          var actualCount =
            combo.ruleId === "mixed"
              ? questionCount * GAME_CONFIG.QUESTIONS.MIXED_MULTIPLIER
              : questionCount;

          li.innerHTML =
            '<span class="combo-item-name">' +
            (idx + 1) +
            ". " +
            (fieldConfig ? fieldConfig.icon : "") +
            " " +
            (fieldConfig ? fieldConfig.name : combo.fieldId) +
            " Ã— " +
            ruleName +
            (combo.hasWM ? " ğŸ§ " : "") +
            "</span>" +
            '<span class="combo-item-meta">' +
            actualCount +
            "é¡Œ</span>";

          list.appendChild(li);
        });
      }

      // â”€â”€â”€ å»ºç«‹çµ„åˆ â”€â”€â”€
      function buildCombos() {
        var combos = [];
        selectedFields.forEach(function (fieldId) {
          selectedRules.forEach(function (ruleId) {
            combos.push({
              fieldId: fieldId,
              ruleId: ruleId,
              hasWM: wmEnabled,
              questionCount: questionCount,
            });
          });
        });
        return combos;
      }

      // â”€â”€â”€ é–‹å§‹éŠæˆ² â”€â”€â”€
      function startGame() {
        var combos = buildCombos();
        if (combos.length === 0) return;
        ModeController.startFreeSelectGame(combos);
      }

      // â”€â”€â”€ åˆå§‹åŒ– â”€â”€â”€
      document.addEventListener("DOMContentLoaded", function () {
        // ç¢ºèªæ˜¯å¦æœ‰è‡ªç”±é¸æ“‡æ¬Šé™
        if (!ProgressTracker.isFreeSelectAvailable()) {
          alert("ğŸ”’ " + FREE_SELECT_UNLOCK.message);
          ModeController.goToAdventureMap();
          return;
        }

        // è®€å–åå¥½é¡Œæ•¸
        var savedCount = getQuestionCountPreference();
        if (savedCount) {
          questionCount = savedCount;
          document.getElementById("count-slider").value = savedCount;
          document.getElementById("count-value").textContent = savedCount;
        }
      });
    </script>
  </body>
</html>
