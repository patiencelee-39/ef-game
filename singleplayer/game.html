<!doctype html>
<html lang="zh-TW" data-theme="field-primary">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://*.firebasedatabase.app https://*.firebaseio.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; media-src 'self'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app"
    />
    <title>執行功能訓練遊戲</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />

    <!-- CSS 載入順序：base → theme → main → 本頁行內 -->
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/themes/theme-field-primary.css" />
    <link rel="stylesheet" href="../css/themes/theme-rule-independent.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link
      rel="preload"
      href="../css/components/landscape-hint.css"
      as="style"
      onload="this.rel = 'stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="../css/components/landscape-hint.css"
    /></noscript>
    <link rel="stylesheet" href="../css/pages/game.css" />

    <!-- ==================== 模組載入（依賴順序）==================== -->
    <!-- 配置 -->
    <script defer src="../js/utils/logger.js"></script>
    <script defer src="../js/shared/game-modal.js"></script>
    <script defer src="../js/game-config.js"></script>
    <script defer src="../js/adaptive/difficulty-provider.js"></script>
    <script defer src="../js/adaptive/simple-adaptive-engine.js"></script>
    <script defer src="../js/adaptive/irt-simple-engine.js"></script>
    <script defer src="../js/adventure-maps-config.js"></script>
    <script defer src="../js/svg-assets.js"></script>
    <script defer src="../js/stimuli-config.js"></script>
    <script defer src="../js/game/stimulus-renderer.js"></script>
    <script defer src="../js/shared/trial-renderer.js"></script>
    <!-- 工具 -->
    <script defer src="../js/utils/storage.js"></script>
    <script defer src="../js/utils/score-calculator.js"></script>
    <script defer src="../js/utils/level-calculator.js"></script>
    <script defer src="../js/utils/badge-checker.js"></script>
    <script defer src="../js/utils/question-generator.js"></script>
    <!-- 共用元件 -->
    <script defer src="../js/sound-config.js"></script>
    <script defer src="../js/shared/audio-player.js"></script>
    <script defer src="../js/shared/countdown.js"></script>
    <script defer src="../js/shared/focus-trap.js"></script>
    <script defer src="../js/shared/feedback-overlay.js"></script>
    <script defer src="../js/shared/working-memory.js"></script>
    <script defer src="../js/shared/completion-notify.js"></script>
    <script defer src="../js/shared/game-session-builder.js"></script>
    <script defer src="../js/story-config.js"></script>
    <script defer src="../js/shared/story-dialogue-controller.js"></script>
    <!-- 單人模式 -->
    <script defer src="../js/singleplayer/progress-tracker.js"></script>
    <script defer src="../js/singleplayer/mode-controller.js"></script>
    <script defer src="../js/shared/landscape-hint.js"></script>
  </head>

  <body
    style="
      overflow: hidden;
      touch-action: none;
      position: fixed;
      width: 100%;
      height: 100%;
    "
  >
    <a href="#main-content" class="skip-link">跳到主要內容</a>
    <main class="game-page" id="main-content" tabindex="-1">
      <h1 class="sr-only">單人遊戲</h1>
      <!-- === 頂部導航 === -->
      <div class="game-header">
        <button id="btnBack" class="header-btn" aria-label="返回" title="返回">
          ←
        </button>
        <div id="headerTitle" class="game-header-title">載入中…</div>
        <span
          class="difficulty-badge"
          id="diffBadge"
          title="自適應難度"
          role="img"
          aria-label="目前難度"
        >
          <span class="diff-dots" id="diffDots"></span>
        </span>
        <button id="btnPause" class="header-btn" aria-label="暫停" title="暫停">
          ⏸
        </button>
      </div>

      <!-- === 遊戲主區域 === -->
      <div class="game-play-area" id="gameContainer">
        <!-- 畫面 1：規則說明（舊版，Plan C 後備用） -->
        <div id="rule-intro-screen" class="screen">
          <div class="rule-intro">
            <h2 id="ruleIntroTitle"></h2>
            <!-- 口訣區 (Plan C) -->
            <div id="ruleIntroMnemonic" class="rule-mnemonic hidden"></div>
            <!-- 規則框 (Plan B：大圖 + 動畫手/X) -->
            <div id="ruleIntroBoxes" class="rule-box-group"></div>
            <!-- 混合分頁指示 -->
            <div id="ruleIntroPageIndicator" class="rule-page-indicator hidden">
              <span id="rulePageDot1" class="page-dot active"></span>
              <span id="rulePageDot2" class="page-dot"></span>
            </div>
            <div id="ruleIntroContext" class="context-notice hidden"></div>
            <div id="ruleIntroWM" class="wm-notice-tag hidden">
              🧠 本組含工作記憶測驗
            </div>
            <!-- 混合規則「下一頁」按鈕 -->
            <button id="btnRuleNext" class="btn btn-secondary hidden">
              下一頁 ▶
            </button>
            <button id="btnRuleStart" class="btn btn-primary">
              ▶️ 開始<span
                style="
                  display: block;
                  font-size: 0.7rem;
                  opacity: 0.6;
                  margin-top: 4px;
                "
                >（或按空白鍵）</span
              >
            </button>
          </div>
        </div>

        <!-- 階段過場提示（三階段共用） -->
        <div id="stageTransitionScreen" class="screen">
          <div class="stage-transition">
            <div id="stageTransIcon" class="stage-transition-icon"></div>
            <h2 id="stageTransTitle" class="stage-transition-title"></h2>
            <p id="stageTransSubtitle" class="stage-transition-subtitle"></p>
            <div class="stage-transition-progress">
              <div id="stageTransBar" class="stage-transition-bar"></div>
            </div>
            <span class="stage-transition-hint">點擊畫面或按空白鍵跳過</span>
          </div>
        </div>

        <!-- 畫面 1.2：規則動畫示範（iframe embed, Plan C） -->
        <div id="guideAnimScreen" class="screen">
          <iframe
            id="guideIframe"
            style="
              border: none;
              width: 100%;
              height: 100%;
              position: absolute;
              top: 0;
              left: 0;
            "
            allow="autoplay"
          ></iframe>
        </div>

        <!-- 畫面 1.3：WM 提示過場 -->
        <div id="wmTransitionScreen" class="screen">
          <div
            style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 100%;
              text-align: center;
              padding: 2rem;
              color: var(--text);
            "
          >
            <div style="font-size: 3rem; margin-bottom: 1rem">🧠</div>
            <h2 style="margin: 0 0 1rem; font-size: 1.4rem">注意！</h2>
            <p style="font-size: 1.1rem; line-height: 1.6; margin: 0 0 1.5rem">
              這一組包含<strong>工作記憶測驗</strong
              ><br />遊戲中會出現記憶問題，<br />要記住剛才看到的東西喔！
            </p>
            <button id="btnWmTransitionReady" class="btn btn-primary">
              我知道了！✅
            </button>
          </div>
        </div>

        <!-- 畫面 1.5：練習 (Plan D) — 與正式遊戲畫面一致 -->
        <div id="demoPracticeScreen" class="screen">
          <!-- 練習跳過按鈕 -->
          <button id="btnSkipPractice" class="practice-skip-btn">
            跳過練習 ⏩
          </button>

          <!-- 練習資訊列（與正式遊戲 trial-info 結構一致） -->
          <div class="trial-info">
            <span id="practiceRoundLabel" class="round-label">🎯 練習</span>
            <span class="trial-counter">
              <span id="practiceCurrent">0</span> /
              <span id="practiceTotal">0</span>
            </span>
            <div
              class="progress-bar-container"
              role="progressbar"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
              aria-label="練習進度"
            >
              <div id="practiceProgressBar" class="progress-bar"></div>
            </div>
          </div>

          <!-- 刺激物舞台（與正式遊戲一致） -->
          <div class="stimulus-container" id="demoStimulusContainer">
            <div id="demoBackgroundLayer"></div>
            <div id="demoContextIndicator"></div>
            <div id="demoStimulus"></div>
            <!-- 練習回饋覆蓋 -->
            <div id="demoFeedback" class="practice-feedback hidden"></div>
          </div>

          <!-- 控制按鈕（與正式遊戲一致） -->
          <div class="control-area" id="demoBtnArea">
            <button id="btnDemoSpace" class="btn-key" disabled>
              <span id="btnDemoLabel">準備中…</span>
              <span class="key-hint">按空白鍵 或 點此</span>
            </button>
          </div>

          <!-- 練習結果覆蓋 -->
          <div id="practiceResult" class="practice-result-overlay hidden"></div>
        </div>

        <!-- 畫面 2：遊戲進行 -->
        <div id="play-screen" class="screen">
          <!-- 試驗資訊 -->
          <div class="trial-info">
            <span id="roundLabel" class="round-label"></span>
            <span class="trial-counter" aria-live="polite" aria-atomic="true">
              <span id="trialCurrent">0</span> / <span id="trialTotal">0</span>
            </span>
            <div
              class="progress-bar-container"
              role="progressbar"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
              aria-label="遊戲進度"
            >
              <div id="progressBar" class="progress-bar"></div>
            </div>
          </div>

          <!-- 刺激物舞台 -->
          <div class="stimulus-container" id="stimulusContainer">
            <div id="backgroundLayer"></div>
            <div id="contextIndicator"></div>
            <div id="stimulus"></div>
          </div>

          <!-- 控制按鈕 -->
          <div class="control-area">
            <button id="btnSpace" class="btn-key" disabled>
              <span id="btnLabel">準備中…</span>
              <span class="key-hint">按空白鍵 或 點此</span>
            </button>
          </div>
        </div>

        <!-- WM 測驗容器 -->
        <div id="wm-container" class="hidden"></div>

        <!-- Combo 過場容器 -->
        <div id="combo-transition-container" class="hidden"></div>

        <!-- 暫停覆蓋 -->
        <div
          id="pause-overlay"
          role="dialog"
          aria-modal="true"
          aria-label="暫停選單"
        >
          <h2>⏸ 暫停</h2>
          <p style="color: var(--text-light)">遊戲已暫停，按下方按鈕繼續</p>
          <button id="btnResume" class="btn btn-primary">
            ▶️ 繼續<span
              style="
                display: block;
                font-size: 0.7rem;
                opacity: 0.6;
                margin-top: 4px;
              "
              >（或按空白鍵）</span
            >
          </button>
          <button
            id="btnQuit"
            class="btn btn-secondary"
            style="margin-top: 8px"
          >
            🚪 結束遊戲
          </button>
        </div>

        <!-- 離開確認覆蓋 -->
        <div
          id="exit-confirm-overlay"
          role="dialog"
          aria-modal="true"
          aria-label="離開遊戲確認"
        >
          <h2>🚪 離開遊戲？</h2>
          <p>確定要離開嗎？<br />已作答的題目仍會保存。</p>
          <div class="exit-confirm-btns">
            <button id="btnExitCancel" class="btn btn-primary">繼續遊戲</button>
            <button id="btnExitConfirm" class="btn btn-secondary">
              確定離開
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- ==================== 遊戲控制器 ==================== -->
    <script defer src="../js/singleplayer/game-controller.js"></script>
  </body>
</html>
