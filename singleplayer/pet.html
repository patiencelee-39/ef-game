<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;"
    />
    <title>æˆ‘çš„å°é› â€” åŸ·è¡ŒåŠŸèƒ½è¨“ç·´éŠæˆ²</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="../favicon.svg" />
    <link rel="manifest" href="../manifest.json" />
    <meta name="theme-color" content="#302b63" />
    <link rel="stylesheet" href="../css/themes/base.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/components/landscape-hint.css" />
    <style>
      /* å¯µç‰©é é¢è¦†å¯« */
      body {
        padding: 0;
        overflow-x: hidden;
        color: var(--text-white);
      }

      /* --- é ‚éƒ¨ç‹€æ…‹åˆ— --- */
      .pet-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 16px;
        background: rgba(26, 35, 50, 0.92);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .btn-back {
        background: none;
        border: none;
        color: var(--text-white);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 8px;
        transition: background var(--transition-fast);
        min-width: var(--touch-target-min);
        min-height: var(--touch-target-min);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn-back:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .header-title {
        font-size: var(--font-size-lg);
        font-weight: 700;
      }

      .stars-display {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: var(--font-size-md);
        color: var(--accent-yellow);
        font-weight: 700;
      }

      /* --- ä¸»å…§å®¹ --- */
      .pet-main {
        margin-top: 60px;
        padding: 16px;
        padding-bottom: 100px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
      }

      /* =========================================
         å¯µç‰©å±•ç¤ºå€
         ========================================= */
      .pet-stage {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius-xl);
        padding: 28px 16px 20px;
        margin-bottom: 16px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .pet-display {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .pet-emoji {
        font-size: 5rem;
        transition: transform 0.3s ease;
        display: inline-block;
      }

      .pet-mood-icon {
        position: absolute;
        top: -8px;
        right: -8px;
        font-size: 1.5rem;
        animation: mood-bounce 2s ease-in-out infinite;
      }

      @keyframes mood-bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      /* é…ä»¶é¡¯ç¤ºå±¤ */
      .pet-acc-layer {
        position: absolute;
        font-size: 1.6rem;
        pointer-events: none;
        z-index: 2;
      }
      .pet-acc-layer.acc-top {
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
      }
      .pet-acc-layer.acc-center {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .pet-acc-layer.acc-bottom {
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%);
      }
      .pet-acc-layer.acc-right {
        top: 30%;
        right: -10px;
      }
      .pet-acc-layer.acc-left {
        top: 30%;
        left: -10px;
      }

      .pet-name {
        font-size: var(--font-size-xl);
        font-weight: 900;
        margin-bottom: 2px;
      }

      .pet-stage-label {
        font-size: var(--font-size-sm);
        color: var(--text-light);
        margin-bottom: 8px;
      }

      .pet-mood-label {
        font-size: var(--font-size-sm);
        color: var(--text-light);
        margin-bottom: 4px;
      }

      .pet-fed-count {
        font-size: var(--font-size-xs);
        color: var(--text-light);
        opacity: 0.7;
      }

      /* --- æˆé•·é€²åº¦æ¢ --- */
      .progress-section {
        margin-top: 12px;
      }

      .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: var(--font-size-xs);
        color: var(--text-light);
        margin-bottom: 4px;
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-yellow), #ff9f43);
        border-radius: 5px;
        transition: width 0.5s ease;
      }

      .progress-stages {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 1.2rem;
      }

      .progress-stages span {
        opacity: 0.4;
        transition: opacity 0.3s;
      }
      .progress-stages span.reached {
        opacity: 1;
      }

      /* --- å¿ƒæƒ…å‹•ç•« --- */
      .pet-idle {
        animation: pet-idle 3s ease-in-out infinite;
      }
      .pet-happy {
        animation: pet-happy 1.5s ease-in-out infinite;
      }
      .pet-excited {
        animation: pet-excited 0.8s ease-in-out infinite;
      }
      .pet-hungry {
        animation: pet-hungry 2s ease-in-out infinite;
      }

      @keyframes pet-idle {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
      }

      @keyframes pet-happy {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
        }
        25% {
          transform: translateY(-6px) rotate(-5deg);
        }
        75% {
          transform: translateY(-6px) rotate(5deg);
        }
      }

      @keyframes pet-excited {
        0%,
        100% {
          transform: translateY(0) scale(1);
        }
        50% {
          transform: translateY(-10px) scale(1.1);
        }
      }

      @keyframes pet-hungry {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(3px);
        }
      }

      /* =========================================
         åˆ†é¡ Tab
         ========================================= */
      .section-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }

      .section-tab {
        flex: 1;
        padding: 10px 16px;
        font-size: var(--font-size-sm);
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        background: none;
        color: var(--text-light);
        cursor: pointer;
        transition: all var(--transition-fast);
        min-height: 44px;
      }
      .section-tab.active {
        background: var(--primary-blue);
        color: #fff;
        border-color: var(--primary-blue);
      }

      /* =========================================
         ç‰©å“ç¶²æ ¼ï¼ˆå…±ç”¨é£Ÿç‰© & é…ä»¶ï¼‰
         ========================================= */
      .item-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
      }

      .item-card {
        background: rgba(255, 255, 255, 0.03);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius-lg);
        padding: 16px 12px;
        text-align: center;
        transition: all var(--transition-fast);
        cursor: pointer;
      }
      .item-card:hover {
        transform: translateY(-2px);
        border-color: rgba(255, 255, 255, 0.25);
      }
      .item-card.locked {
        opacity: 0.35;
        filter: grayscale(1);
      }
      .item-card.locked:hover {
        transform: none;
      }
      .item-card.owned {
        border-color: var(--success-green);
        background: rgba(46, 204, 113, 0.08);
      }

      .lock-label {
        font-size: var(--font-size-xs);
        color: rgba(255, 255, 255, 0.7);
        margin-top: 4px;
      }

      .item-emoji {
        font-size: 2.5rem;
        margin-bottom: 8px;
      }
      .item-name {
        font-size: var(--font-size-sm);
        font-weight: 700;
        margin-bottom: 4px;
      }
      .item-cost {
        font-size: var(--font-size-xs);
        color: var(--accent-yellow);
      }
      .item-status {
        font-size: var(--font-size-xs);
        font-weight: 600;
        margin-top: 4px;
        color: var(--success-green);
      }

      /* =========================================
         å½ˆå‡ºè¦–çª—ï¼ˆè³¼è²·/é¤µé£Ÿç¢ºèªï¼‰
         ========================================= */
      .action-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 200;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
      }
      .action-popup.visible {
        display: flex;
      }

      .action-card {
        background: #1e2d3d;
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--border-radius-xl);
        padding: 32px 24px;
        max-width: 320px;
        width: 90%;
        text-align: center;
        animation: popup-in 0.3s ease-out;
      }

      @keyframes popup-in {
        0% {
          opacity: 0;
          transform: scale(0.9) translateY(20px);
        }
        100% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .action-emoji {
        font-size: 4rem;
        margin-bottom: 12px;
      }
      .action-name {
        font-size: var(--font-size-xl);
        font-weight: 900;
        margin-bottom: 4px;
      }
      .action-desc {
        font-size: var(--font-size-sm);
        color: var(--text-light);
        margin-bottom: 12px;
      }
      .action-price {
        font-size: var(--font-size-lg);
        color: var(--accent-yellow);
        font-weight: 700;
        margin-bottom: 20px;
      }

      .action-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .action-buttons button {
        padding: 12px 24px;
        font-size: var(--font-size-md);
        font-weight: 700;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        min-width: 100px;
        min-height: var(--touch-target-min);
        transition: all var(--transition-fast);
      }

      .btn-feed {
        background: var(--success-green);
        color: #fff;
      }
      .btn-feed:hover {
        background: #27ae60;
      }
      .btn-feed:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #555;
      }
      .btn-buy-acc {
        background: var(--primary-blue);
        color: #fff;
      }
      .btn-buy-acc:hover {
        background: #2980b9;
      }
      .btn-buy-acc:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #555;
      }
      .btn-cancel {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-light);
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
      }

      /* --- é¤µé£ŸæˆåŠŸå‹•ç•« --- */
      .feed-success-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 300;
        background: rgba(0, 0, 0, 0.4);
        align-items: center;
        justify-content: center;
      }
      .feed-success-overlay.visible {
        display: flex;
      }

      .feed-success-msg {
        font-size: 3rem;
        animation: feed-pop 1.2s ease-out forwards;
      }

      @keyframes feed-pop {
        0% {
          opacity: 0;
          transform: scale(0.5);
        }
        40% {
          opacity: 1;
          transform: scale(1.2);
        }
        100% {
          opacity: 0;
          transform: scale(1.5) translateY(-40px);
        }
      }

      /* --- éŸ¿æ‡‰å¼ --- */
      @media (max-width: 400px) {
        .item-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }
        .item-emoji {
          font-size: 2rem;
        }
        .pet-emoji {
          font-size: 4rem;
        }
        .pet-display {
          width: 100px;
          height: 100px;
        }
      }

      /* =========================================
         ğŸ’¬ å°è©±æ°£æ³¡
         ========================================= */
      .speech-bubble {
        position: absolute;
        top: -50px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        padding: 8px 14px;
        border-radius: 16px;
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
        pointer-events: none;
        z-index: 10;
        animation: bubble-pop 2s ease-out forwards;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
      }
      .speech-bubble::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid rgba(255, 255, 255, 0.95);
      }
      @keyframes bubble-pop {
        0% {
          opacity: 0;
          transform: translateX(-50%) translateY(10px) scale(0.8);
        }
        15% {
          opacity: 1;
          transform: translateX(-50%) translateY(0) scale(1);
        }
        75% {
          opacity: 1;
          transform: translateX(-50%) translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateX(-50%) translateY(-15px) scale(0.9);
        }
      }

      /* é»æ“Šåå½ˆå‹•ç•« */
      .pet-tap-bounce {
        animation: tap-bounce 0.4s ease-out !important;
      }
      @keyframes tap-bounce {
        0% {
          transform: scale(1);
        }
        30% {
          transform: scale(1.2) rotate(-5deg);
        }
        60% {
          transform: scale(0.95) rotate(3deg);
        }
        100% {
          transform: scale(1) rotate(0deg);
        }
      }

      /* æ„›å¿ƒç²’å­ */
      .heart-particle {
        position: absolute;
        font-size: 1.2rem;
        pointer-events: none;
        z-index: 10;
        animation: heart-float 1.2s ease-out forwards;
      }
      @keyframes heart-float {
        0% {
          opacity: 1;
          transform: translate(0, 0) scale(0.5);
        }
        100% {
          opacity: 0;
          transform: translate(var(--dx), -60px) scale(1.2);
        }
      }

      /* =========================================
         âœˆï¸ å¯µç‰©å‘½å
         ========================================= */
      .pet-name-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        margin-bottom: 2px;
      }
      .btn-rename {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.65);
        font-size: 0.9rem;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        min-width: 32px;
        min-height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
      }
      .btn-rename:hover {
        color: rgba(255, 255, 255, 0.7);
      }

      /* å‘½åå½ˆçª— */
      .rename-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 250;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
      }
      .rename-modal.visible {
        display: flex;
      }
      .rename-card {
        background: #1e2d3d;
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--border-radius-xl);
        padding: 28px 24px;
        max-width: 320px;
        width: 90%;
        text-align: center;
        animation: popup-in 0.3s ease-out;
      }
      .rename-card h3 {
        font-size: var(--font-size-lg);
        margin-bottom: 16px;
      }
      .rename-input {
        width: 100%;
        padding: 12px;
        font-size: var(--font-size-md);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-white);
        text-align: center;
        margin-bottom: 16px;
        outline: none;
        box-sizing: border-box;
      }
      .rename-input:focus {
        border-color: var(--primary-blue);
      }
      .rename-btns {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      .rename-btns button {
        padding: 10px 24px;
        font-size: var(--font-size-md);
        font-weight: 700;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        min-width: 80px;
        min-height: var(--touch-target-min);
      }

      /* =========================================
         ğŸ€ é…ä»¶ç©¿è„± Toggle
         ========================================= */
      .item-card.owned .equip-badge {
        display: inline-block;
        font-size: var(--font-size-xs);
        padding: 2px 8px;
        border-radius: 10px;
        margin-top: 4px;
        font-weight: 600;
      }
      .equip-badge--on {
        background: rgba(46, 204, 113, 0.2);
        color: #81c784;
      }
      .equip-badge--off {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.65);
      }

      /* å¯µç‰©å±•ç¤ºå€å¯é»æ“Šæç¤º */
      .pet-display {
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }

      /* =========================================
         ğŸ¨ è²¼ç´™åœ–é‘‘ â€” é–‹åŒ… & åœ–é‘‘
         ========================================= */

      /* é–‹åŒ…å€å¡Š */
      .pack-section {
        text-align: center;
        margin-bottom: 20px;
        padding: 20px 16px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius-xl);
      }
      .pack-title {
        font-size: var(--font-size-lg);
        font-weight: 800;
        margin-bottom: 4px;
      }
      .pack-subtitle {
        font-size: var(--font-size-xs);
        color: var(--text-light);
        margin-bottom: 16px;
      }
      .btn-open-pack {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 14px 32px;
        font-size: var(--font-size-md);
        font-weight: 800;
        border: none;
        border-radius: 24px;
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: #fff;
        cursor: pointer;
        min-height: var(--touch-target-min);
        transition: all var(--transition-fast);
        box-shadow: 0 4px 16px rgba(243, 156, 18, 0.3);
      }
      .btn-open-pack:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
      }
      .btn-open-pack:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* é–‹åŒ…å‹•ç•«å½ˆçª— */
      .pack-reveal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 350;
        background: rgba(0, 0, 0, 0.75);
        align-items: center;
        justify-content: center;
      }
      .pack-reveal-overlay.visible {
        display: flex;
      }
      .pack-reveal-card {
        background: #1e2d3d;
        border-radius: var(--border-radius-xl);
        padding: 36px 28px;
        text-align: center;
        max-width: 280px;
        width: 85%;
        animation: pack-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      @keyframes pack-pop {
        0% {
          opacity: 0;
          transform: scale(0.3) rotate(-15deg);
        }
        100% {
          opacity: 1;
          transform: scale(1) rotate(0);
        }
      }
      .reveal-emoji {
        font-size: 5rem;
        margin-bottom: 12px;
        display: inline-block;
        animation: reveal-bounce 0.6s 0.3s ease-out both;
      }
      @keyframes reveal-bounce {
        0% {
          transform: scale(0);
        }
        60% {
          transform: scale(1.3);
        }
        100% {
          transform: scale(1);
        }
      }
      .reveal-name {
        font-size: var(--font-size-xl);
        font-weight: 900;
        margin-bottom: 4px;
      }
      .reveal-rarity {
        font-size: var(--font-size-sm);
        font-weight: 700;
        margin-bottom: 4px;
      }
      .reveal-new {
        font-size: var(--font-size-sm);
        color: var(--accent-yellow);
        font-weight: 700;
      }
      .reveal-dup {
        font-size: var(--font-size-sm);
        color: var(--text-light);
      }
      .reveal-desc {
        font-size: var(--font-size-xs);
        color: var(--text-light);
        margin-top: 6px;
      }
      .btn-reveal-ok {
        margin-top: 20px;
        padding: 10px 40px;
        font-size: var(--font-size-md);
        font-weight: 700;
        border: none;
        border-radius: 8px;
        background: var(--primary-blue);
        color: #fff;
        cursor: pointer;
        min-height: var(--touch-target-min);
      }

      /* æ”¶è—é€²åº¦æ¢ */
      .collection-summary {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 12px;
      }
      .collection-summary .cs-label {
        font-size: var(--font-size-sm);
        color: var(--text-light);
      }
      .collection-summary .cs-bar {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
      }
      .collection-summary .cs-fill {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(90deg, var(--accent-yellow), #ff9f43);
        transition: width 0.5s ease;
      }
      .collection-summary .cs-pct {
        font-size: var(--font-size-sm);
        font-weight: 700;
        color: var(--accent-yellow);
        min-width: 40px;
        text-align: right;
      }

      /* åœ–é‘‘åˆ†é¡æ¨™ç±¤ */
      .sticker-category-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 4px;
      }
      .sticker-cat-tab {
        white-space: nowrap;
        padding: 6px 14px;
        font-size: var(--font-size-xs);
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        background: none;
        color: var(--text-light);
        cursor: pointer;
        transition: all var(--transition-fast);
        min-height: 36px;
      }
      .sticker-cat-tab.active {
        background: var(--primary-blue);
        color: #fff;
        border-color: var(--primary-blue);
      }

      /* è²¼ç´™å¡ç‰‡è¦†å¯« */
      .item-card.sticker-card {
        position: relative;
        padding: 14px 10px;
      }
      .item-card.sticker-card .item-emoji {
        font-size: 2.2rem;
        margin-bottom: 6px;
      }
      .sticker-rarity-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 4px;
        vertical-align: middle;
      }
      .item-card.sticker-card.rarity-common {
        border-color: rgba(149, 165, 166, 0.4);
      }
      .item-card.sticker-card.rarity-rare {
        border-color: rgba(52, 152, 219, 0.5);
      }
      .item-card.sticker-card.rarity-legendary {
        border-color: rgba(243, 156, 18, 0.6);
        background: rgba(243, 156, 18, 0.05);
      }
      .item-card.sticker-card.rarity-legendary .item-name {
        color: #f39c12;
      }

      /* ç©ºç‹€æ…‹æç¤º */
      .empty-hint {
        text-align: center;
        padding: 40px 16px;
        color: var(--text-light);
        font-size: var(--font-size-sm);
      }
      .empty-hint .hint-emoji {
        font-size: 3rem;
        margin-bottom: 12px;
      }

      /* =========================================
         ğŸ–¼ï¸ æ›è£å•†åº—
         ========================================= */
      .avatar-cat-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 14px;
      }
      .avatar-cat-tab {
        flex: 1;
        padding: 8px 14px;
        font-size: var(--font-size-sm);
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        background: none;
        color: var(--text-light);
        cursor: pointer;
        transition: all var(--transition-fast);
        min-height: 38px;
      }
      .avatar-cat-tab.active {
        background: var(--primary-blue);
        color: #fff;
        border-color: var(--primary-blue);
      }

      .item-card .equip-label {
        display: inline-block;
        font-size: var(--font-size-xs);
        padding: 2px 8px;
        border-radius: 10px;
        margin-top: 4px;
        font-weight: 600;
      }
      .equip-label--on {
        background: rgba(46, 204, 113, 0.2);
        color: #81c784;
      }
      .equip-label--off {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.65);
      }
    </style>
    <link rel="stylesheet" href="../css/components/navbar.css" />
  </head>
  <body>
    <header class="pet-header">
      <div class="header-left">
        <button class="btn-back" onclick="goBack()" aria-label="è¿”å›">â†</button>
        <span class="header-title">ğŸ” æˆ‘çš„å°é›</span>
      </div>
      <div class="stars-display">â­ <span id="available-stars">0</span></div>
    </header>

    <main class="pet-main" id="main-content">
      <h1 class="sr-only">æˆ‘çš„å°é›</h1>
      <!-- ===== å¯µç‰©å±•ç¤ºå€ ===== -->
      <div class="pet-stage" id="pet-stage">
        <div
          class="pet-display"
          id="pet-display"
          role="button"
          tabindex="0"
          aria-label="é»æ“Šå’Œå°é›äº’å‹•"
        >
          <span class="pet-emoji pet-idle" id="pet-emoji">ğŸ¥š</span>
          <span class="pet-mood-icon" id="pet-mood-icon">ğŸ˜</span>
          <!-- é…ä»¶ç”± JS å‹•æ…‹æ³¨å…¥ -->
        </div>
        <div class="pet-name-row">
          <span class="pet-name" id="pet-name">è›‹å¯¶å¯¶</span>
          <button
            class="btn-rename"
            onclick="showRenameModal()"
            aria-label="å‘½åå°é›"
          >
            âœï¸
          </button>
        </div>
        <div class="pet-stage-label" id="pet-stage-label">ç­‰ç´š 1</div>
        <div class="pet-mood-label" id="pet-mood-label">å¿ƒæƒ…ï¼šæ™®é€š ğŸ˜</div>
        <div class="pet-fed-count" id="pet-fed-count">ç´¯è¨ˆé¤µé£Ÿï¼š0 æ¬¡</div>

        <!-- æˆé•·é€²åº¦ -->
        <div class="progress-section">
          <div class="progress-label">
            <span id="progress-text">è·é›¢ä¸‹ä¸€éšæ®µ</span>
            <span id="progress-percent">0%</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="progress-fill"
              style="width: 0%"
            ></div>
          </div>
          <div class="progress-stages" id="progress-stages">
            <span>ğŸ¥š</span>
            <span>ğŸ£</span>
            <span>ğŸ¥</span>
            <span>ğŸ“</span>
            <span>ğŸ¦…</span>
          </div>
        </div>
      </div>

      <!-- ===== åˆ†é¡ Tab ===== -->
      <div class="section-tabs" id="section-tabs">
        <button
          class="section-tab active"
          data-section="food"
          onclick="switchSection('food')"
        >
          ğŸ½ï¸ é¤µé£Ÿ
        </button>
        <button
          class="section-tab"
          data-section="accessory"
          onclick="switchSection('accessory')"
        >
          ğŸ€ é…ä»¶
        </button>
        <button
          class="section-tab"
          data-section="sticker"
          onclick="switchSection('sticker')"
        >
          ğŸ¨ è²¼ç´™
        </button>
        <button
          class="section-tab"
          data-section="avatar"
          onclick="switchSection('avatar')"
        >
          ğŸ–¼ï¸ æ›è£
        </button>
      </div>

      <!-- ===== ç‰©å“ç¶²æ ¼ ===== -->
      <div class="item-grid" id="item-grid"></div>

      <!-- ===== é–‹åŒ…çµæœå½ˆçª— ===== -->
      <div
        class="pack-reveal-overlay"
        id="pack-reveal"
        role="dialog"
        aria-modal="true"
        aria-label="é–‹åŒ…çµæœ"
      >
        <div class="pack-reveal-card">
          <div class="reveal-emoji" id="reveal-emoji">ğŸ</div>
          <div class="reveal-name" id="reveal-name">â€”</div>
          <div class="reveal-rarity" id="reveal-rarity">â€”</div>
          <div id="reveal-new-dup"></div>
          <div class="reveal-desc" id="reveal-desc">â€”</div>
          <button class="btn-reveal-ok" onclick="closeReveal()">
            å¤ªæ£’äº†ï¼
          </button>
        </div>
      </div>
    </main>

    <!-- ===== å‹•ä½œç¢ºèªå½ˆçª— ===== -->
    <div
      class="action-popup"
      id="action-popup"
      role="dialog"
      aria-modal="true"
      aria-label="å‹•ä½œç¢ºèª"
    >
      <div class="action-card">
        <div class="action-emoji" id="popup-emoji">â€”</div>
        <div class="action-name" id="popup-name">â€”</div>
        <div class="action-desc" id="popup-desc">â€”</div>
        <div class="action-price" id="popup-price">â€”</div>
        <div class="action-buttons" id="popup-buttons"></div>
      </div>
    </div>

    <!-- ===== é¤µé£ŸæˆåŠŸå‹•ç•« ===== -->
    <div class="feed-success-overlay" id="feed-success">
      <div class="feed-success-msg" id="feed-success-msg">ğŸ˜‹ å¥½å¥½åƒï¼</div>
    </div>

    <!-- ===== å‘½åå½ˆçª— ===== -->
    <div
      class="rename-modal"
      id="rename-modal"
      role="dialog"
      aria-modal="true"
      aria-label="çµ¦å°é›å–åå­—"
    >
      <div class="rename-card">
        <h3>âœï¸ çµ¦å°é›å–å€‹åå­—</h3>
        <input
          class="rename-input"
          id="rename-input"
          type="text"
          maxlength="8"
          placeholder="è¼¸å…¥åå­—ï¼ˆæœ€å¤š 8 å­—ï¼‰"
          aria-label="å°é›åå­—"
        />
        <div class="rename-btns">
          <button
            style="background: var(--success-green); color: #fff"
            onclick="confirmRename()"
          >
            ç¢ºå®š
          </button>
          <button
            style="
              background: rgba(255, 255, 255, 0.1);
              color: var(--text-light);
              border: 1px solid rgba(255, 255, 255, 0.2) !important;
            "
            onclick="closeRenameModal()"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!-- ===== Scriptsï¼ˆä¾è³´éˆè¼‰å…¥é †åºï¼‰===== -->
    <script src="../js/game-config.js"></script>
    <script src="../js/utils/storage.js"></script>
    <script src="../js/utils/level-calculator.js"></script>
    <script src="../js/shop/pet-config.js"></script>
    <script src="../js/shop/pet-manager.js"></script>
    <script src="../js/shop/sticker-config.js"></script>
    <script src="../js/shop/sticker-manager.js"></script>
    <script src="../js/shop/avatar-config.js"></script>
    <script src="../js/shop/avatar-manager.js"></script>

    <script>
      /* =========================================
         é é¢ç‹€æ…‹
         ========================================= */
      var currentSection = "food";

      /* =========================================
         åˆå§‹åŒ–
         ========================================= */
      document.addEventListener("DOMContentLoaded", function () {
        refreshAll();
      });

      /* =========================================
         å°èˆª
         ========================================= */
      function goBack() {
        if (
          document.referrer &&
          document.referrer.indexOf("adventure-map") !== -1
        ) {
          history.back();
        } else {
          window.location.href = "adventure-map.html";
        }
      }

      /* =========================================
         å…¨ç•«é¢åˆ·æ–°
         ========================================= */
      function refreshAll() {
        updateStarsDisplay();
        renderPetStage();
        renderItemGrid(currentSection);
      }

      function updateStarsDisplay() {
        document.getElementById("available-stars").textContent =
          getAvailableStars();
      }

      /* =========================================
         å¯µç‰©å±•ç¤ºå€æ¸²æŸ“
         ========================================= */
      function renderPetStage() {
        var status = PetManager.getFullPetStatus();

        // æˆé•·åœ–ç¤º
        var petEmoji = document.getElementById("pet-emoji");
        petEmoji.textContent = status.stage ? status.stage.icon : "ğŸ¥š";

        // å¿ƒæƒ…å‹•ç•« class
        petEmoji.className =
          "pet-emoji " + (status.mood.animation || "pet-idle");

        // å¿ƒæƒ… icon
        document.getElementById("pet-mood-icon").textContent =
          status.mood.emoji || "ğŸ˜";

        // åç¨±ï¼šå„ªå…ˆé¡¯ç¤ºè‡ªè¨‚åå­—ï¼Œæ²’æœ‰æ‰é¡¯ç¤ºéšæ®µåç¨±
        var petState = getPetState();
        var customName = petState.petName;
        var stageName = status.stage
          ? status.stage.icon + " " + status.stage.name
          : "è›‹å¯¶å¯¶";
        document.getElementById("pet-name").textContent = customName
          ? customName
          : stageName;

        document.getElementById("pet-stage-label").textContent =
          "ç­‰ç´š " + (status.stage ? status.stage.level : 1);

        // å¿ƒæƒ…æ–‡å­—
        document.getElementById("pet-mood-label").textContent =
          "å¿ƒæƒ…ï¼š" + status.mood.label + " " + status.mood.emoji;

        // é¤µé£Ÿæ¬¡æ•¸
        document.getElementById("pet-fed-count").textContent =
          "ç´¯è¨ˆé¤µé£Ÿï¼š" + status.fedCount + " æ¬¡";

        // é€²åº¦æ¢
        renderProgress(status);

        // é…ä»¶
        renderPetAccessories(status);
      }

      function renderProgress(status) {
        var progress = status.progress;

        if (progress.isMaxLevel) {
          document.getElementById("progress-text").textContent =
            "å·²é”æœ€é«˜éšæ®µï¼";
          document.getElementById("progress-percent").textContent = "MAX";
          document.getElementById("progress-fill").style.width = "100%";
        } else {
          document.getElementById("progress-text").textContent =
            "è· " +
            progress.nextLevelDef.icon +
            " " +
            progress.nextLevelDef.name +
            " é‚„å·® " +
            progress.starsToNextLevel +
            " â­";
          document.getElementById("progress-percent").textContent =
            progress.progressPercent + "%";
          document.getElementById("progress-fill").style.width =
            progress.progressPercent + "%";
        }

        // æ¨™ç¤ºå·²åˆ°é”çš„éšæ®µåœ–ç¤º
        var stageSpans = document.querySelectorAll("#progress-stages span");
        var currentLevel = status.stage ? status.stage.level : 1;
        stageSpans.forEach(function (span, i) {
          span.classList.toggle("reached", i + 1 <= currentLevel);
        });
      }

      function renderPetAccessories(status) {
        // æ¸…é™¤èˆŠé…ä»¶
        var display = document.getElementById("pet-display");
        var oldAcc = display.querySelectorAll(".pet-acc-layer");
        oldAcc.forEach(function (el) {
          el.remove();
        });

        // åªé¡¯ç¤ºã€Œç©¿æˆ´ä¸­ã€çš„é…ä»¶
        var equipped = getEquippedAccessories();

        equipped.forEach(function (accId) {
          var acc = getPetAccessoryById(accId);
          if (!acc) return;

          var el = document.createElement("span");
          el.className = "pet-acc-layer acc-" + acc.position;
          el.textContent = acc.emoji;
          display.appendChild(el);
        });
      }

      /* =========================================
         Tab åˆ‡æ›
         ========================================= */
      function switchSection(section) {
        currentSection = section;
        document.querySelectorAll(".section-tab").forEach(function (tab) {
          tab.classList.toggle("active", tab.dataset.section === section);
        });
        renderItemGrid(section);
      }

      /* =========================================
         ç‰©å“ç¶²æ ¼ï¼ˆä¾ section æ¸²æŸ“ï¼‰
         ========================================= */
      var _stickerCatFilter = "all"; // è²¼ç´™åœ–é‘‘ç›®å‰åˆ†é¡
      var _avatarCatFilter = "frame"; // æ›è£å•†åº—ç›®å‰åˆ†é¡

      function renderItemGrid(section) {
        var grid = document.getElementById("item-grid");
        grid.innerHTML = "";

        if (section === "food") {
          renderFoodGrid(grid);
        } else if (section === "accessory") {
          renderAccessoryGrid(grid);
        } else if (section === "sticker") {
          renderStickerSection(grid);
        } else if (section === "avatar") {
          renderAvatarSection(grid);
        }
      }

      function renderFoodGrid(grid) {
        grid.style.display = ""; // reset to CSS grid
        var foods = getAllPetFoods();
        var available = getAvailableStars();
        var currentLevel = calculateLevel(getTotalStars());

        foods.forEach(function (food) {
          var requiredLevel = food.unlockLevel || 1;
          var isLocked = currentLevel < requiredLevel;
          var card = document.createElement("div");

          if (isLocked) {
            card.className = "item-card locked";
            card.innerHTML =
              '<div class="item-emoji">ğŸ”’</div>' +
              '<div class="item-name">' +
              food.name +
              "</div>" +
              '<div class="lock-label">ğŸ£ Lv.' +
              requiredLevel +
              " è§£é–</div>";
          } else {
            card.className = "item-card";
            card.innerHTML =
              '<div class="item-emoji">' +
              food.emoji +
              "</div>" +
              '<div class="item-name">' +
              food.name +
              "</div>" +
              '<div class="item-cost">â­ ' +
              food.cost +
              "</div>";

            card.addEventListener("click", function () {
              showFoodPopup(food);
            });
          }
          grid.appendChild(card);
        });
      }

      function renderAccessoryGrid(grid) {
        grid.style.display = ""; // reset to CSS grid
        var accessories = getAllPetAccessories();
        var currentLevel = calculateLevel(getTotalStars());
        var equipped = getEquippedAccessories();

        accessories.forEach(function (acc) {
          var owned = hasPetAccessory(acc.id);
          var requiredLevel = acc.unlockLevel || 1;
          var isLocked = currentLevel < requiredLevel;
          var isEquipped = equipped.indexOf(acc.id) !== -1;
          var card = document.createElement("div");

          if (isLocked) {
            card.className = "item-card locked";
            card.innerHTML =
              '<div class="item-emoji">ğŸ”’</div>' +
              '<div class="item-name">' +
              acc.name +
              "</div>" +
              '<div class="lock-label">ğŸ£ Lv.' +
              requiredLevel +
              " è§£é–</div>";
          } else {
            card.className = "item-card" + (owned ? " owned" : "");

            var statusHtml;
            if (owned) {
              statusHtml = isEquipped
                ? '<span class="equip-badge equip-badge--on">ç©¿æˆ´ä¸­</span>'
                : '<span class="equip-badge equip-badge--off">æœªç©¿æˆ´</span>';
            } else {
              statusHtml = '<div class="item-cost">â­ ' + acc.cost + "</div>";
            }

            card.innerHTML =
              '<div class="item-emoji">' +
              acc.emoji +
              "</div>" +
              '<div class="item-name">' +
              acc.name +
              "</div>" +
              statusHtml;

            card.addEventListener("click", function () {
              showAccessoryPopup(acc, owned, isEquipped);
            });
          }
          grid.appendChild(card);
        });
      }

      /* =========================================
         å½ˆçª— â€” é¤µé£Ÿ
         ========================================= */

      /* =========================================
         ğŸ¨ è²¼ç´™åœ–é‘‘ â€” æ¸²æŸ“
         ========================================= */
      function renderStickerSection(grid) {
        // ä½¿ç”¨ fragment å®¹å™¨ï¼ˆgrid æœ¬èº«è®Šæˆ block æš«å­˜ï¼‰
        grid.style.display = "block";

        // 1. é–‹åŒ…æŒ‰éˆ•å€
        var packCheck = StickerManager.canOpenPack();
        var packHtml =
          '<div class="pack-section">' +
          '<div class="pack-title">ğŸ è²¼ç´™æ‰­è›‹</div>' +
          '<div class="pack-subtitle">èŠ± ' +
          packCheck.cost +
          "â­ é–‹ä¸€åŒ…ï¼Œéš¨æ©Ÿç²å¾—è²¼ç´™ï¼</div>" +
          '<button class="btn-open-pack" id="btn-open-pack" onclick="handleOpenPack()"' +
          (packCheck.canOpen ? "" : " disabled") +
          ">" +
          "ğŸ° é–‹åŒ…ï¼ï¼ˆâ­" +
          packCheck.cost +
          "ï¼‰" +
          "</button>" +
          "</div>";
        grid.innerHTML = packHtml;

        // 2. æ”¶è—é€²åº¦æ¢
        var stats = StickerManager.getCollectionStats();
        var summaryHtml =
          '<div class="collection-summary">' +
          '<span class="cs-label">åœ–é‘‘ ' +
          stats.totalOwned +
          "/" +
          stats.totalDefined +
          "</span>" +
          '<div class="cs-bar"><div class="cs-fill" style="width:' +
          stats.completionPercent +
          '%"></div></div>' +
          '<span class="cs-pct">' +
          stats.completionPercent +
          "%</span>" +
          "</div>";
        grid.innerHTML += summaryHtml;

        // 3. åˆ†é¡ tabs
        var catTabsHtml =
          '<div class="sticker-category-tabs">' +
          '<button class="sticker-cat-tab' +
          (_stickerCatFilter === "all" ? " active" : "") +
          '" onclick="filterStickerCat(\'all\')">ğŸ“‹ å…¨éƒ¨</button>';
        STICKER_CATEGORIES.forEach(function (cat) {
          catTabsHtml +=
            '<button class="sticker-cat-tab' +
            (_stickerCatFilter === cat.id ? " active" : "") +
            '" onclick="filterStickerCat(\'' +
            cat.id +
            "')\">" +
            cat.label +
            "</button>";
        });
        catTabsHtml += "</div>";
        grid.innerHTML += catTabsHtml;

        // 4. è²¼ç´™å¡ç‰‡ç¶²æ ¼
        var innerGrid = document.createElement("div");
        innerGrid.className = "item-grid";
        innerGrid.style.display = "grid";

        var items = StickerManager.getAllStickersWithStatus(
          _stickerCatFilter === "all" ? undefined : _stickerCatFilter,
        );

        if (items.length === 0) {
          innerGrid.innerHTML =
            '<div class="empty-hint" style="grid-column:1/-1">' +
            '<div class="hint-emoji">ğŸ“­</div>' +
            "<div>é€™å€‹åˆ†é¡é‚„æ²’æœ‰è²¼ç´™å–”</div>" +
            "</div>";
        } else {
          items.forEach(function (entry) {
            var s = entry.sticker;
            var rarityObj = entry.rarity;
            var card = document.createElement("div");
            card.className =
              "item-card sticker-card rarity-" +
              s.rarity +
              (entry.owned ? " owned" : "") +
              (entry.locked ? " locked" : "");

            if (entry.locked) {
              card.innerHTML =
                '<div class="item-emoji">ğŸ”’</div>' +
                '<div class="item-name">' +
                s.name +
                "</div>" +
                '<div class="lock-label">ğŸ£ Lv.' +
                entry.requiredLevel +
                " è§£é–</div>";
            } else if (entry.owned) {
              card.innerHTML =
                '<div class="item-emoji">' +
                s.emoji +
                "</div>" +
                '<div class="item-name">' +
                s.name +
                "</div>" +
                '<div style="font-size:0.75rem">' +
                '<span class="sticker-rarity-dot" style="background:' +
                rarityObj.color +
                '"></span>' +
                '<span style="color:' +
                rarityObj.color +
                '">' +
                rarityObj.label +
                "</span>" +
                "</div>";
            } else {
              // æœªæ“æœ‰ä½†å·²è§£é– â†’ é¡¯ç¤ºå•è™Ÿ
              card.innerHTML =
                '<div class="item-emoji" style="opacity:0.3">â“</div>' +
                '<div class="item-name" style="opacity:0.5">' +
                s.name +
                "</div>" +
                '<div style="font-size:0.75rem">' +
                '<span class="sticker-rarity-dot" style="background:' +
                rarityObj.color +
                '"></span>' +
                '<span style="color:' +
                rarityObj.color +
                ';opacity:0.6">' +
                rarityObj.label +
                "</span>" +
                "</div>";
            }
            innerGrid.appendChild(card);
          });
        }

        grid.appendChild(innerGrid);
      }

      function filterStickerCat(catId) {
        _stickerCatFilter = catId;
        renderItemGrid("sticker");
      }

      function handleOpenPack() {
        var result = StickerManager.openPack();
        if (!result.success) {
          alert(result.reason);
          return;
        }

        var draw = result.results[0]; // æ¯åŒ… 1 å¼µ
        var s = draw.sticker;
        var rarityObj = STICKER_RARITY[s.rarity] || STICKER_RARITY.common;

        // æ›´æ–°æ˜Ÿæ˜Ÿé¡¯ç¤º
        updateStarsDisplay();

        // é¡¯ç¤ºé–‹åŒ…å‹•ç•«
        document.getElementById("reveal-emoji").textContent = s.emoji;
        document.getElementById("reveal-name").textContent = s.name;
        document.getElementById("reveal-rarity").style.color = rarityObj.color;
        document.getElementById("reveal-rarity").textContent =
          "âœ¦ " + rarityObj.label;
        document.getElementById("reveal-new-dup").innerHTML = draw.isNew
          ? '<span class="reveal-new">ğŸ‰ æ–°è²¼ç´™ï¼</span>'
          : '<span class="reveal-dup">ï¼ˆå·²æ“æœ‰ï¼‰</span>';
        document.getElementById("reveal-desc").textContent = s.desc;

        document.getElementById("pack-reveal").classList.add("visible");
        FocusTrap.activate(document.getElementById("pack-reveal"));
      }

      function closeReveal() {
        document.getElementById("pack-reveal").classList.remove("visible");
        FocusTrap.deactivate();
        renderItemGrid("sticker"); // åˆ·æ–°åœ–é‘‘
      }

      /* =========================================
         ğŸ–¼ï¸ æ›è£å•†åº— â€” æ¸²æŸ“
         ========================================= */
      function renderAvatarSection(grid) {
        grid.style.display = "block";

        // 1. åˆ†é¡ tab
        var catHtml = '<div class="avatar-cat-tabs">';
        AVATAR_CATEGORIES.forEach(function (cat) {
          catHtml +=
            '<button class="avatar-cat-tab' +
            (_avatarCatFilter === cat.id ? " active" : "") +
            '" onclick="filterAvatarCat(\'' +
            cat.id +
            "')\">" +
            cat.label +
            "</button>";
        });
        catHtml += "</div>";
        grid.innerHTML = catHtml;

        // 2. æ”¶è—çµ±è¨ˆ
        var shopStats = AvatarManager.getShopStats();
        grid.innerHTML +=
          '<div class="collection-summary">' +
          '<span class="cs-label">æ”¶è— ' +
          shopStats.ownedCount +
          "/" +
          shopStats.totalItems +
          "</span>" +
          '<div class="cs-bar"><div class="cs-fill" style="width:' +
          shopStats.completionPercent +
          '%"></div></div>' +
          '<span class="cs-pct">' +
          shopStats.completionPercent +
          "%</span>" +
          "</div>";

        // 3. ç‰©å“å¡ç‰‡
        var innerGrid = document.createElement("div");
        innerGrid.className = "item-grid";
        innerGrid.style.display = "grid";

        var items = AvatarManager.getAllItemsWithStatus(_avatarCatFilter);
        var currentLevel = calculateLevel(getTotalStars());

        if (items.length === 0) {
          innerGrid.innerHTML =
            '<div class="empty-hint" style="grid-column:1/-1">' +
            '<div class="hint-emoji">ğŸª</div><div>æš«ç„¡ç‰©å“</div>' +
            "</div>";
        } else {
          items.forEach(function (entry) {
            var item = entry.item;
            var card = document.createElement("div");
            card.className =
              "item-card" +
              (entry.owned ? " owned" : "") +
              (entry.locked ? " locked" : "");

            if (entry.locked) {
              card.innerHTML =
                '<div class="item-emoji">ğŸ”’</div>' +
                '<div class="item-name">' +
                item.name +
                "</div>" +
                '<div class="lock-label">ğŸ£ Lv.' +
                entry.requiredLevel +
                " è§£é–</div>";
            } else if (entry.owned) {
              var eqHtml = entry.equipped
                ? '<span class="equip-label equip-label--on">ç©¿æˆ´ä¸­</span>'
                : '<span class="equip-label equip-label--off">æœªç©¿æˆ´</span>';
              card.innerHTML =
                '<div class="item-emoji">' +
                item.emoji +
                "</div>" +
                '<div class="item-name">' +
                item.name +
                "</div>" +
                eqHtml;
              card.addEventListener("click", function () {
                showAvatarItemPopup(item, true, entry.equipped);
              });
            } else {
              card.innerHTML =
                '<div class="item-emoji">' +
                item.emoji +
                "</div>" +
                '<div class="item-name">' +
                item.name +
                "</div>" +
                '<div class="item-cost">â­ ' +
                item.cost +
                "</div>";
              card.addEventListener("click", function () {
                showAvatarItemPopup(item, false, false);
              });
            }
            innerGrid.appendChild(card);
          });
        }

        grid.appendChild(innerGrid);
      }

      function filterAvatarCat(catId) {
        _avatarCatFilter = catId;
        renderItemGrid("avatar");
      }

      /* =========================================
         å½ˆçª— â€” æ›è£ç‰©å“
         ========================================= */
      function showAvatarItemPopup(item, owned, equipped) {
        document.getElementById("popup-emoji").textContent = item.emoji;
        document.getElementById("popup-name").textContent = item.name;
        document.getElementById("popup-desc").textContent = item.desc;

        var btnsEl = document.getElementById("popup-buttons");
        btnsEl.innerHTML = "";

        if (owned) {
          document.getElementById("popup-price").textContent = equipped
            ? "âœ… ç©¿æˆ´ä¸­"
            : "ğŸ“¦ å·²æ“æœ‰";

          var btnToggle = document.createElement("button");
          btnToggle.className = equipped ? "btn-cancel" : "btn-buy-acc";
          btnToggle.textContent = equipped ? "å¸ä¸‹" : "ç©¿ä¸Š";
          btnToggle.onclick = function () {
            if (equipped) {
              AvatarManager.unequip(item.category);
            } else {
              AvatarManager.equip(item.id);
            }
            closePopup();
            refreshAll();
          };
          btnsEl.appendChild(btnToggle);
        } else {
          document.getElementById("popup-price").textContent =
            "â­ " + item.cost;
          var check = AvatarManager.canBuyItem(item.id);

          var btnBuy = document.createElement("button");
          btnBuy.className = "btn-buy-acc";
          btnBuy.textContent = "è³¼è²·";
          btnBuy.disabled = !check.canBuy;
          btnBuy.onclick = function () {
            var result = AvatarManager.buyItem(item.id);
            closePopup();
            if (result.success) {
              showFeedSuccess("ğŸ‰ ç²å¾— " + result.item.emoji + "ï¼");
              refreshAll();
            } else {
              alert(result.reason);
            }
          };
          btnsEl.appendChild(btnBuy);
        }

        var btnCancel = document.createElement("button");
        btnCancel.className = "btn-cancel";
        btnCancel.textContent = "é—œé–‰";
        btnCancel.onclick = closePopup;
        btnsEl.appendChild(btnCancel);

        document.getElementById("action-popup").classList.add("visible");
        FocusTrap.activate(document.getElementById("action-popup"));
      }
      function showFoodPopup(food) {
        document.getElementById("popup-emoji").textContent = food.emoji;
        document.getElementById("popup-name").textContent = food.name;
        document.getElementById("popup-desc").textContent = food.desc;
        document.getElementById("popup-price").textContent = "â­ " + food.cost;

        var btnsEl = document.getElementById("popup-buttons");
        btnsEl.innerHTML = "";

        var check = PetManager.canFeed(food.id);

        var btnFeed = document.createElement("button");
        btnFeed.className = "btn-feed";
        btnFeed.textContent = "é¤µé£Ÿï¼";
        btnFeed.disabled = !check.canFeed;
        btnFeed.onclick = function () {
          handleFeed(food.id);
        };
        btnsEl.appendChild(btnFeed);

        var btnCancel = document.createElement("button");
        btnCancel.className = "btn-cancel";
        btnCancel.textContent = "å–æ¶ˆ";
        btnCancel.onclick = closePopup;
        btnsEl.appendChild(btnCancel);

        document.getElementById("action-popup").classList.add("visible");
        FocusTrap.activate(document.getElementById("action-popup"));
      }

      function handleFeed(foodId) {
        var result = PetManager.feed(foodId);
        closePopup();

        if (result.success) {
          showFeedSuccess(result.food.emoji + " å¥½å¥½åƒï¼");
          refreshAll();
        } else {
          alert(result.reason);
        }
      }

      function showFeedSuccess(msg) {
        var overlay = document.getElementById("feed-success");
        var msgEl = document.getElementById("feed-success-msg");
        msgEl.textContent = msg;
        overlay.classList.add("visible");

        setTimeout(function () {
          overlay.classList.remove("visible");
        }, 1300);
      }

      /* =========================================
         å½ˆçª— â€” é…ä»¶
         ========================================= */
      function showAccessoryPopup(acc, owned, isEquipped) {
        document.getElementById("popup-emoji").textContent = acc.emoji;
        document.getElementById("popup-name").textContent = acc.name;
        document.getElementById("popup-desc").textContent = acc.desc;

        var btnsEl = document.getElementById("popup-buttons");
        btnsEl.innerHTML = "";

        if (owned) {
          document.getElementById("popup-price").textContent = isEquipped
            ? "âœ… ç©¿æˆ´ä¸­"
            : "ğŸ“¦ å·²æ“æœ‰ï¼ˆæœªç©¿æˆ´ï¼‰";

          // ç©¿æˆ´ / å¸ä¸‹ æŒ‰éˆ•
          var btnToggle = document.createElement("button");
          btnToggle.className = isEquipped ? "btn-cancel" : "btn-buy-acc";
          btnToggle.textContent = isEquipped ? "å¸ä¸‹" : "ç©¿ä¸Š";
          btnToggle.onclick = function () {
            togglePetAccessory(acc.id);
            closePopup();
            refreshAll();
          };
          btnsEl.appendChild(btnToggle);
        } else {
          document.getElementById("popup-price").textContent = "â­ " + acc.cost;
          var check = PetManager.canBuyAccessory(acc.id);

          var btnBuy = document.createElement("button");
          btnBuy.className = "btn-buy-acc";
          btnBuy.textContent = "è³¼è²·";
          btnBuy.disabled = !check.canBuy;
          btnBuy.onclick = function () {
            handleBuyAccessory(acc.id);
          };
          btnsEl.appendChild(btnBuy);
        }

        var btnCancel = document.createElement("button");
        btnCancel.className = "btn-cancel";
        btnCancel.textContent = "é—œé–‰";
        btnCancel.onclick = closePopup;
        btnsEl.appendChild(btnCancel);

        document.getElementById("action-popup").classList.add("visible");
        FocusTrap.activate(document.getElementById("action-popup"));
      }

      function handleBuyAccessory(accId) {
        var result = PetManager.buyAccessory(accId);
        closePopup();

        if (result.success) {
          showFeedSuccess("ğŸ‰ ç²å¾— " + result.accessory.emoji + "ï¼");
          refreshAll();
        } else {
          alert(result.reason);
        }
      }

      /* =========================================
         å…±ç”¨å½ˆçª—æ“ä½œ
         ========================================= */
      function closePopup() {
        document.getElementById("action-popup").classList.remove("visible");
        FocusTrap.deactivate();
      }

      // é»æ“Šå¤–éƒ¨é—œé–‰
      document
        .getElementById("action-popup")
        .addEventListener("click", function (e) {
          if (e.target === this) closePopup();
        });

      /* =========================================
         ğŸ” å¯µç‰©é»æ“Šäº’å‹•
         ========================================= */
      var PET_PHRASES = [
        "å’•å’•ï¼ğŸ”",
        "æ‘¸æ‘¸æˆ‘ï½ ğŸ’•",
        "å¥½é–‹å¿ƒï¼ğŸ˜†",
        "çµ¦æˆ‘åƒçš„ï½ ğŸ½ï¸",
        "å˜°å˜°ï¼ğŸ£",
        "æƒ³è·Ÿä½ ç©ï¼ğŸ®",
        "æœ€å–œæ­¡ä½ äº†ï¼â¤ï¸",
        "ä»Šå¤©ä¹ŸåŠ æ²¹ï¼ğŸ’ª",
        "å¥½ç„¡èŠå•Šï½ ğŸ˜´",
        "å’•åš•å’•åš• ğŸµ",
      ];
      var _bubbleTimer = null;

      document
        .getElementById("pet-display")
        .addEventListener("click", function (e) {
          handlePetTap(e);
        });

      // éµç›¤ Enter ä¹Ÿå¯è§¸ç™¼
      document
        .getElementById("pet-display")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            handlePetTap(e);
          }
        });

      function handlePetTap(e) {
        var display = document.getElementById("pet-display");
        var emoji = document.getElementById("pet-emoji");

        // 1) å½ˆè·³å‹•ç•«
        emoji.classList.remove("pet-tap-bounce");
        void emoji.offsetWidth; // reflow
        emoji.classList.add("pet-tap-bounce");
        setTimeout(function () {
          emoji.classList.remove("pet-tap-bounce");
        }, 450);

        // 2) æ„›å¿ƒç²’å­ Ã—3
        for (var i = 0; i < 3; i++) {
          spawnHeart(display);
        }

        // 3) å°è©±æ°£æ³¡
        showSpeechBubble(display);
      }

      function spawnHeart(container) {
        var heart = document.createElement("span");
        heart.className = "heart-particle";
        heart.textContent = "â¤ï¸";
        var dx = Math.round(Math.random() * 60 - 30);
        heart.style.setProperty("--dx", dx + "px");
        heart.style.left = 50 + Math.round(Math.random() * 20 - 10) + "%";
        heart.style.top = "30%";
        container.appendChild(heart);
        setTimeout(function () {
          heart.remove();
        }, 1300);
      }

      function showSpeechBubble(container) {
        // æ¸…é™¤èˆŠçš„
        var old = container.querySelector(".speech-bubble");
        if (old) old.remove();
        if (_bubbleTimer) clearTimeout(_bubbleTimer);

        var bubble = document.createElement("div");
        bubble.className = "speech-bubble";
        bubble.textContent =
          PET_PHRASES[Math.floor(Math.random() * PET_PHRASES.length)];
        container.appendChild(bubble);

        _bubbleTimer = setTimeout(function () {
          bubble.remove();
          _bubbleTimer = null;
        }, 2200);
      }

      /* =========================================
         âœï¸ å¯µç‰©å‘½å
         ========================================= */
      function showRenameModal() {
        var petState = getPetState();
        var input = document.getElementById("rename-input");
        input.value = petState.petName || "";
        document.getElementById("rename-modal").classList.add("visible");
        FocusTrap.activate(document.getElementById("rename-modal"));
        setTimeout(function () {
          input.focus();
        }, 100);
      }

      function closeRenameModal() {
        document.getElementById("rename-modal").classList.remove("visible");
        FocusTrap.deactivate();
      }

      function confirmRename() {
        var name = document.getElementById("rename-input").value.trim();
        if (name.length === 0) {
          // ç©ºå­—ä¸² â†’ æ¸…é™¤è‡ªè¨‚åï¼Œæ¢å¾©é è¨­
          setPetName("");
        } else if (name.length > 8) {
          alert("åå­—æœ€å¤š 8 å€‹å­—å–”ï¼");
          return;
        } else {
          setPetName(name);
        }
        closeRenameModal();
        renderPetStage();
      }

      // é»æ“Šå‘½åå½ˆçª—å¤–éƒ¨é—œé–‰
      document
        .getElementById("rename-modal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeRenameModal();
        });

      // Enter ç¢ºèªå‘½å
      document
        .getElementById("rename-input")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            confirmRename();
          }
        });
    </script>
    <script src="../js/shared/focus-trap.js"></script>
    <script src="../js/shared/navbar.js"></script>
    <script src="../js/shared/landscape-hint.js"></script>
  </body>
</html>
