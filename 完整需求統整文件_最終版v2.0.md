# 📋 執行功能訓練遊戲 - 完整需求統整文件（最終版 v2.0）

**專案名稱**：3-6歲聽障學齡前幼兒執行功能訓練遊戲  
**開發目標**：多人 Kahoot 風格 → 單人模式（優先順序）  
**開發時程**：2026/02/08 起，分階段實作  
**修改範圍**：從零開始，整合所有新功能  
**部署環境**：Firebase Hosting  
**文件版本**：v2.3（2026/02/18 更新）  
**文件作者**：小摩研究助理

---

## 📑 目錄

1. [核心設計原則](#一核心設計原則)
2. [多人模式（Kahoot 風格）](#二多人模式kahoot-風格)
3. [單人模式](#三單人模式)
4. [多感官設計（聲音系統）](#四多感官設計聲音系統)
5. [技術架構](#五技術架構)
6. [檔案結構規劃](#六檔案結構規劃)
7. [開發時程](#七開發時程修正版)
8. [關鍵設計決策總覽](#八關鍵設計決策總覽)
9. [待辦事項檢查表](#九待辦事項檢查表)
10. [文件版本紀錄](#十文件版本紀錄)

---

## 一、核心設計原則

### 1.1 多感官設計（參考聲音設計文件）

```
✅ 視覺為主（必要），聽覺為輔（增強）
✅ 無聲音 100% 可玩，有聲音體驗更佳
✅ 「多一個感官輸入，多一個理解機會」
```

### 1.2 目標使用者

- **年齡層**：3-6歲學齡前幼兒
- **障礙類別**：聽障學齡前幼兒
- **設計原則**：視覺優先、極簡文字、大圖示

---

## 二、多人模式（Kahoot 風格）

### 2.1 核心特性

| 特性         | 說明                                |
| ------------ | ----------------------------------- |
| **遊戲性質** | 同場競賽（各自節奏）                |
| **題目同步** | 題目順序一致，但進度獨立            |
| **題目切換** | 答題後立即切換（0秒） ⭐            |
| **即時回饋** | 在原畫面疊加綠/紅框（0.3秒） ⭐     |
| **完成通知** | 僅「完成整個場地」時顯示（3秒） ⭐  |
| **場地切換** | 各自按開始 → 各自倒數 → 各自開始 ⭐ |
| **遊戲開始** | 僅最開始需所有玩家一起倒數 ⭐       |

⭐ = 本次對話修正的關鍵設計

---

### 2.2 房間系統

#### 房間代碼

```
長度：5位字元
格式：英文字母 + 數字（排除 I/O/0/1）
顯示：H7K 2M（加空格分隔）
功能：代碼 = 短網址 ID
範例：https://game.web.app/r/H7K2M
```

#### 房間設定

```
基本設定：
  ✅ 房間名稱（有預設，可修改）
  ✅ 房間代碼（自動生成 / 自訂）
  ✅ 房間密碼（開關式）

遊戲設定：
  ✅ 遊戲場積木式選擇（1-4個場地）
  ✅ 每場地題數（3/6/12/24題，預設 6）
  ✅ 倒數秒數（0/3/5/10秒，預設 3）

進階設定：
  ✅ 顯示即時計分板
  ✅ 顯示答題狀態
  ✅ 顯示場地完成通知
  ✅ 允許中途加入
  ✅ 顯示最終排名
```

---

### 2.3 遊戲場系統（積木式選擇）

#### 可選場地

| 代號  | 名稱     | 圖示 | 難度          | 規則             | 訓練目標      |
| ----- | -------- | ---- | ------------- | ---------------- | ------------- |
| **A** | 起司森林 | 🧀   | 簡單（3-4歲） | 🧀按，😺不按     | 抑制控制      |
| **B** | 人類村莊 | 🧑   | 中等（4-5歲） | 🧑+🧀按，😺不按  | 工作記憶+抑制 |
| **C** | 海洋世界 | 🐟   | 中等（4-5歲） | 🐟按，🦈不按     | 抑制+規則切換 |
| **D** | 晝夜迷宮 | 🌙   | 困難（5-6歲） | 白天晚上規則相反 | 認知彈性+DCCS |

#### 選擇介面

```
┌─────────────────────────────────────┐
│ 📌 已選擇的遊戲場（拖曳排序）       │
│ ┌─────────────────────────────────┐ │
│ │ [🧀 A] [🧑 B]                   │ │
│ │  ↑拖曳排序（由左到右）           │ │
│ │  點擊「✕」可移除                 │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 🎮 點選下方遊戲場加入：             │
│ [🐟 C] [🌙 D]                       │
│  ↑點擊後移至上方                    │
└─────────────────────────────────────┘
```

**技術實作**：

- HTML5 Drag & Drop API
- 數量限制：1-4 個
- 房主建立時預先生成所有場地的題目序列

---

### 2.4 題目同步機制 ⭐

#### 核心概念

```
✅ 題目順序同步：所有玩家題目順序一致
✅ 進度獨立：各自答題，互不等待
✅ 立即切換：答題後 0 秒切換下一題
```

#### 題目生成流程

```
房主建立房間
  ↓
選擇遊戲場（例如：A、B）
  ↓
系統自動生成題目序列：
  場地A：[🧀, 😺, 🧀, 🧀, 😺, ...] 共10題
  場地B：[🧑, 🧀, 😺, 🧑, 🧀, ...] 共10題
  ↓
儲存到 Firebase：
  gameStages[0].questions[]
  gameStages[1].questions[]
  ↓
所有玩家讀取相同題目序列
```

#### 遊戲進行範例

```
時間點 T1：
  玩家A：正在答場地A的題目5 (🧀)
  玩家B：正在答場地A的題目2 (😺)
  玩家C：正在答場地A的題目8 (🧀)

  → 題目內容相同，但進度獨立

時間點 T2（玩家A答完題目5）：
  玩家A：立即顯示題目6 (😺)
  玩家B：仍在題目2（不受影響）
  玩家C：仍在題目8（不受影響）
```

---

### 2.5 即時回饋設計 ⭐

#### 視覺設計（在原畫面疊加）

**答對範例**：

```
原題目畫面：
┌────────────────────────────┐
│                            │
│        🧀                  │
│     (起司出現)              │
│                            │
└────────────────────────────┘
       ↓ 玩家按空白鍵
┌────────────────────────────┐
│                            │
│        🧀                  │ ← 刺激物保持
│  ┌──────────────────────┐  │
│  │  ✅ 正確！           │  │ ← 疊加綠框
│  │  +1 ⭐ +10 分        │  │
│  └──────────────────────┘  │
└────────────────────────────┘
       ↓ 0.3秒淡出動畫
┌────────────────────────────┐
│                            │
│        😺                  │ ← 下一題刺激物
│     (貓咪出現)              │
│                            │
└────────────────────────────┘
```

**答錯範例**：

```
┌────────────────────────────┐
│                            │
│        😺                  │ ← 刺激物保持
│  ┌──────────────────────┐  │
│  │  ❌ 錯誤！           │  │ ← 疊加紅框
│  └──────────────────────┘  │
└────────────────────────────┘
       ↓ 0.3秒淡出動畫
       ↓ 立即顯示下一題
```

#### 技術細節

```
1. 玩家按下空白鍵（或時間到）
2. 記錄答案到 Firebase
3. 在原畫面上方顯示回饋框（CSS absolute positioning）
4. 播放淡入動畫（0.1秒）
5. 停留（0.1秒）
6. 播放淡出動畫（0.1秒）
7. 移除回饋元素
8. 更新 currentQuestion++
9. 顯示下一題刺激物

總時長：0.3秒
```

#### 樣式設計

```
答對回饋框：
  背景：綠色漸層 (#4CAF50)
  邊框：深綠色 3px solid
  文字：白色、粗體、大字
  圖示：✅ + ⭐
  動畫：scale(0.8 → 1.0) + opacity(0 → 1 → 0)

答錯回饋框：
  背景：紅色漸層 (#F44336)
  邊框：深紅色 3px solid
  文字：白色、粗體、大字
  圖示：❌
  動畫：shake + opacity(0 → 1 → 0)
```

---

### 2.6 完成通知設計 ⭐

#### 觸發時機

```
✅ 僅在「完成整個場地」時觸發
❌ 不在「完成每一題」時觸發

範例：
  玩家完成場地A的第10題（最後一題）
    → Firebase: justCompleted = true
    → 通知：「✅ 小花 完成場地A了！」
    → 3秒後消失
    → Firebase: justCompleted = false
```

#### 顯示位置與樣式

```
位置：畫面右上角（不干擾主視覺）

┌────────────────────────────┐
│ ┌────────────────────┐     │
│ │ ✅ 小花 完成場地A了！│     │ ← 右上角
│ └────────────────────┘     │
│                            │
│        🐟                  │ ← 主視覺不受影響
│     (繼續遊戲)              │
│                            │
└────────────────────────────┘

樣式：
  背景：半透明藍色 (rgba(33, 150, 243, 0.9))
  邊框：圓角 8px
  文字：白色、粗體
  圖示：✅ + 場地圖示 (🧀/🧑/🐟/🌙)
  動畫：
    淡入 (0.5秒)
    → 停留 (3秒)
    → 淡出 (0.5秒)
  總時長：4秒
```

#### 多玩家完成時的堆疊

```
若多位玩家接連完成：

┌────────────────────────────┐
│ ┌────────────────────┐     │
│ │ ✅ 小花 完成場地A了！│ ← 最新
│ └────────────────────┘     │
│ ┌────────────────────┐     │
│ │ ✅ 小明 完成場地A了！│ ← 較舊（往下推）
│ └────────────────────┘     │
│                            │
│        🐟                  │
│                            │
└────────────────────────────┘

最多顯示：3個通知（超過則移除最舊的）
```

---

### 2.7 倒數機制 ⭐

#### 適用範圍

```
✅ 遊戲最開始（場地A開始前）
    → 所有玩家「一起」倒數

✅ 場地切換（場地B/C/D開始前）
    → 各自倒數（不用等彼此）

❌ 題目之間
    → 無倒數，立即切換
```

#### 倒數時長

```
房主可設定：2-5 秒
預設值：3 秒
```

#### 視覺設計

```
┌────────────────────────────┐
│                            │
│      準備開始！            │
│                            │
│      [3] ← 大數字 120px    │
│                            │
│  🎹 請將手指放在空白鍵上    │
│     ↑ 閃爍動畫              │
│                            │
│  ⏸️ 所有按鈕已鎖定          │
│                            │
│  背景：紅色                │
└────────────────────────────┘
       ↓ 1秒後
┌────────────────────────────┐
│      [2]                   │
│  背景：黃色                │
└────────────────────────────┘
       ↓ 1秒後
┌────────────────────────────┐
│      [1]                   │
│  背景：綠色                │
└────────────────────────────┘
       ↓ 1秒後
┌────────────────────────────┐
│    🚀 開始！               │
│  背景：閃爍白光            │
└────────────────────────────┘
       ↓ 0.5秒後
       題目1出現
```

#### 音效同步

```
數字3：🔊 "滴"（低音）
數字2：🔊 "滴"（中音）
數字1：🔊 "滴"（高音）
開始：🔊 "開始！"（語音）+ 短促音效
```

---

### 2.8 遊戲流程（完整版）⭐

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
階段 1：遊戲開始（唯一需要一起的時刻）
━━━━━━━━━━━━━━━━━━━━━━━━━━━

所有玩家進入房間
  ↓
房主按「開始遊戲」
  ↓
所有玩家一起看到倒數畫面
  ↓
3... 2... 1... 開始！
  ↓
場地A 題目1 開始

━━━━━━━━━━━━━━━━━━━━━━━━━━━
階段 2：場地內遊戲（各自節奏）
━━━━━━━━━━━━━━━━━━━━━━━━━━━

玩家A：
  題目1 (🧀) → 按空白鍵 → ✅ 正確（0.3秒）
    → 立即顯示題目2 (😺)
  題目2 (😺) → 沒按 → ✅ 正確（0.3秒）
    → 立即顯示題目3 (🧀)
  ...
  題目10 → 完成！

玩家B（較慢）：
  題目1 (🧀) → 按空白鍵 → ✅ 正確（0.3秒）
    → 立即顯示題目2 (😺)
  題目2 (😺) → 按了 → ❌ 錯誤（0.3秒）
    → 立即顯示題目3 (🧀)
  ...
  （仍在進行中）

玩家C（最快）：
  ...（已完成題目10）

→ 所有玩家看到通知：
  「✅ 玩家C 完成場地A了！」（3秒）

━━━━━━━━━━━━━━━━━━━━━━━━━━━
階段 3：場地完成等待
━━━━━━━━━━━━━━━━━━━━━━━━━━━

玩家C（已完成）：
┌────────────────────────────┐
│ 🎉 太棒了！你完成場地A了！  │
│                            │
│ 等待其他玩家完成...        │
│                            │
│ 📊 當前排名：              │
│ 1. 玩家C  100分 ✅         │
│ 2. 玩家A   80分 (8/10)     │
│ 3. 玩家B   60分 (6/10)     │
└────────────────────────────┘

玩家A（接著完成）：
  → 通知：「✅ 玩家A 完成場地A了！」
  → 進入等待畫面

玩家B（最後完成）：
  → 通知：「✅ 玩家B 完成場地A了！」
  → 進入等待畫面

━━━━━━━━━━━━━━━━━━━━━━━━━━━
階段 4：場地切換（各自準備）⭐
━━━━━━━━━━━━━━━━━━━━━━━━━━━

所有玩家看到過場畫面：
┌────────────────────────────┐
│ 🎊 場地A 全部完成！        │
│                            │
│ 即將進入：                 │
│ 🧑 場地B：人類村莊         │
│                            │
│ 新規則：                   │
│ 🧑+🧀 按空白鍵             │
│ 😺 不要按                  │
│                            │
│ [🔊 聽規則說明]            │
│ [開始場地B] ← 各自按        │
└────────────────────────────┘

玩家C（準備好了）：
  按下「開始場地B」
    ↓
  進入倒數（僅玩家C看到）
    3... 2... 1... 開始！
    ↓
  場地B 題目1 開始

玩家A、B：
  仍在過場畫面
  可隨時按「開始」
  不用等玩家C

━━━━━━━━━━━━━━━━━━━━━━━━━━━
階段 5：重複流程
━━━━━━━━━━━━━━━━━━━━━━━━━━━

場地B、C、D 重複上述流程
  ↓
所有場地完成
  ↓
最終排名

━━━━━━━━━━━━━━━━━━━━━━━━━━━
階段 6：遊戲結束
━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌────────────────────────────┐
│ 🏆 遊戲結束！              │
│ 最終排名                   │
├────────────────────────────┤
│ 🥇 玩家C  350分  ⭐×35     │
│ 🥈 玩家A  320分  ⭐×32     │
│ 🥉 玩家B  280分  ⭐×28     │
│                            │
│ ─── 輸出選項 ───           │
│ [📸 下載成績截圖]          │
│ [📊 匯出 CSV 檔案]         │
│                            │
│ [回到首頁]                 │
└────────────────────────────┘
```

---

### 2.9 邀請功能

#### 三種邀請方式

```
方法1：掃描 QR Code
  ┌──────────┐
  │ [QR碼]   │
  └──────────┘
  前端生成（qrcode.js）

方法2：分享短網址
  https://game.web.app/r/H7K2M
  [📋 複製連結]
  遊戲結束後連結失效

方法3：告訴朋友代碼
  ┌────────┐
  │ H7K 2M │ ← 大數字顯示
  └────────┘
```

---

### 2.10 成績處理 ⭐

#### 分離儲存（不寫入 Firestore）

```
✅ 所有成績僅在 Realtime Database
✅ 遊戲結束後 1 小時自動刪除
❌ 不寫入個人歷史紀錄（Firestore）
```

#### 輸出功能

**1. 截圖功能**

```
技術：html2canvas
格式：PNG
檔名：遊戲成績_YYYYMMDD_HHMMSS.png

內容：
┌─────────────────────────────────┐
│ 執行功能訓練遊戲 - 遊戲成績      │
│                                 │
│ 房間名稱：王老師的練習房         │
│ 遊戲日期：2026/02/08 14:30      │
│                                 │
│ 🏆 最終排名                     │
│ ────────────────────            │
│ 🥇 小花  350分  ⭐×35  98%     │
│ 🥈 小明  320分  ⭐×32  92%     │
│ 🥉 小美  280分  ⭐×28  87%     │
│                                 │
│ 完成場地：🧀🧑🐟🌙             │
└─────────────────────────────────┘
```

**2. CSV 匯出**

```
格式：UTF-8 BOM（Excel 可開啟中文）
檔名：多人遊戲成績_YYYYMMDD_HHMMSS.csv

內容：
排名,暱稱,總分,星星數,答對率,場地A,場地B,場地C,場地D,平均反應
1,小花,350,35,98%,90,90,85,85,1.5
2,小明,320,32,92%,85,80,80,75,1.8
3,小美,280,28,87%,75,70,70,65,2.1
```

**3. 逐題資料分析報告** ⭐ v2.2 新增

```
觸發方式：結算頁面按鈕「📊 查看分析報告」
資料來源：遊戲過程中的 trialDetails（逐題作答紀錄）
技術：共用模組 js/shared/csv-report.js（IIFE）
依賴：Chart.js 4.4.1 + PapaParse 5.4.1

報告內容：
  ├─ 概覽卡片（總試題數、正確率、平均 RT、WM 測試數）
  ├─ 各回合反應時間趨勢圖（Line chart）
  ├─ 綜合分析（各回合正確率比較 Bar chart、平均 RT 比較 Line chart）
  └─ 工作記憶測試詳細結果 + 圖表（若有 WM 資料）

使用頁面：
  ├─ singleplayer/result.html  結算頁（從逐題資料即時生成）
  ├─ leaderboard/class.html    班級排行榜（匯入 CSV 後生成）
  └─ leaderboard/live.html     即時排行看板（老師端查看）
```

**4. PDF 匯出** ⭐ v2.2 新增

```
技術：html2pdf.js 0.10.1（html2canvas + jsPDF）
格式：A4 直式 PDF
觸發：報告區下方「📄 匯出 PDF」按鈕

排版：
  ├─ 封面標題（📊 圖示 + 應用名稱 + 副標題 + 日期 + 參與者 + 試題數）
  ├─ 報告內容（深度複製 DOM、白底強制、CSS 變數轉具體值）
  ├─ 分頁控制（.csv-report__section 前自動斷頁）
  └─ 頁尾（版權 + 自動產生標記）

匯出品質：scale: 2, quality: 0.98, A4 794px 寬
檔名：EF訓練遊戲分析報告_YYYYMMDD.pdf
```

**5. 分析報告截圖** ⭐ v2.2 新增

```
技術：html2canvas → PNG Blob
觸發：「📸 截圖」按鈕
格式：PNG
檔名：EF訓練遊戲分析截圖_YYYYMMDD.png
品質：scale: 2, 白底強制
```

---

### 2.11 Firebase 資料結構（最終版）⭐

```javascript
{
  "rooms": {
    "H7K2M": {
      // ===== 基本資訊 =====
      "roomCode": "H7K2M",
      "roomName": "王老師的練習房",
      "hostId": "user_abc123",
      "hasPassword": true,
      "passwordHash": "hashed_password",
      "createdAt": 1739001600000,
      "expiresAt": 1739005200000, // 1小時後
      "status": "playing", // waiting / playing / finished

      // ===== 遊戲開始狀態 =====
      "gameStarted": true, // 是否已開始（用於判斷首次倒數）
      "countdownSeconds": 3, // 倒數秒數（0/3/5/10可設）

      // ===== 遊戲場設定 =====
      "gameStages": [
        {
          "id": "stage_A_1",
          "stageId": "A",
          "type": "cheese_cat",
          "name": "場地A：起司森林",
          "icon": "🧀",
          "difficulty": "easy",
          "order": 1,
          "questionsCount": 10,

          // ✅ 題目序列（房主建立時生成）
          "questions": [
            {
              "id": "q1",
              "stimulusType": "cheese", // cheese / cat / person / fish / shark
              "correctAction": "press",  // press / nopress
              "dayNight": null           // 場地D才有：day / night
            },
            {
              "id": "q2",
              "stimulusType": "cat",
              "correctAction": "nopress",
              "dayNight": null
            }
            // ... 共10題
          ]
        },
        {
          "id": "stage_B_1",
          "stageId": "B",
          "type": "person_cheese_cat",
          "name": "場地B：人類村莊",
          "icon": "🧑",
          "difficulty": "medium",
          "order": 2,
          "questionsCount": 10,
          "questions": [ /* 10題 */ ]
        }
      ],

      // ===== 進階設定 =====
      "displaySettings": {
        "showLeaderboard": true,
        "showAnswerStatus": true,
        "showCompletionNotification": true,
        "allowLateJoin": true,
        "showFinalRanking": true
      },

      // ===== 玩家資料 =====
      "players": {
        "user_abc123": {
          "nickname": "小花",
          "isHost": true,
          "online": true,
          "joinedAt": 1739001600000,

          // ===== 當前進度 =====
          "currentStageIndex": 0,     // 當前場地索引（0=場地A）
          "currentQuestion": 5,       // 當前題號（1-10）
          "completedStages": [],      // 已完成的場地 ID

          // ===== 場地狀態 =====
          "stageStatus": {
            "stage_A_1": {
              "started": true,        // 已開始此場地
              "startedAt": 1739001610000,
              "completed": false,     // 是否完成
              "completedAt": null,
              "justCompleted": false, // 剛完成（觸發通知）
              "score": 40,            // 當前分數
              "stars": 4,             // 當前星星數

              // 詳細答題記錄
              "answers": [
                {
                  "questionId": "q1",
                  "stimulusType": "cheese",
                  "playerAction": "press",
                  "correct": true,
                  "reactionTime": 1.2,
                  "timestamp": 1739001611000
                },
                {
                  "questionId": "q2",
                  "stimulusType": "cat",
                  "playerAction": "nopress",
                  "correct": true,
                  "reactionTime": 0.9,
                  "timestamp": 1739001612000
                }
              ]
            }
          },

          // ===== 總成績 =====
          "totalScore": 40,
          "totalStars": 4,
          "totalCorrect": 4,
          "totalQuestions": 4,
          "accuracy": 100 // 答對率百分比
        }
      }
    }
  }
}
```

---

## 三、單人模式

### 3.1 核心特性

| 特性         | 說明                                         |
| ------------ | -------------------------------------------- |
| **資料儲存** | localStorage（優先）+ Firestore（選擇性）    |
| **題目切換** | 答題後立即切換（0秒，與多人模式一致）        |
| **即時回饋** | 在原畫面疊加綠/紅框（0.3秒，與多人模式一致） |
| **計分系統** | 基礎分數 + 加權獎勵（可疊加）                |
| **排行榜**   | 本地班級榜 + 全球榜（選擇性上傳）            |

---

### 3.2 計分系統（完整版）

#### 視覺層（不變）

```
答對 → +1 顆亮星 ⭐（視覺回饋）
答錯 → 不顯示星星
```

#### 計分層（加權機制）

```
基礎：每顆星 = 1 分

加權（可疊加）：
🏆 全對獎勵     × 1.1  該場地答對率 100%
⚡ 速度突破     × 1.1  平均反應 < 個人最快紀錄
📈 進步獎勵     × 1.1  分數 > 個人最佳紀錄
🎯 完美表現     × 1.1  連續 5 題答對
🌟 首次通關     × 1.1  首次完成該場地該模式
```

#### 計算範例

```
基礎：10 分（答對10題）

獲得獎勵：
🏆 全對     × 1.1  (10 → 11.0)
⚡ 速度突破 × 1.1  (11 → 12.1)
🎯 完美表現 × 1.1  (12.1 → 13.31)

判斷進步：
  13.31 > 歷史最佳 12 分 → ✅ 獲得進步獎勵

📈 進步     × 1.1  (13.31 → 14.64)

最終得分：15 分（四捨五入）
```

#### 加權細節說明

**1. 速度突破獎勵**

```
條件：平均反應時間 < 個人該場地該模式最快紀錄

紀錄分開：
  場地A 正式模式：最快 1.5 秒
  場地A 挑戰模式：最快 2.0 秒
  場地B 正式模式：最快 1.8 秒
  ...

判斷：
  本次平均 1.2 秒 < 歷史最快 1.5 秒
  → ✅ 獲得速度獎勵
```

**2. 進步獎勵**

```
條件：最終分數 > 該場地個人最佳紀錄

計算順序（重要）：
  1. 基礎分數 × 其他加權（全對、速度、完美、首次）
  2. 比對歷史最佳紀錄
  3. 若超越 → 套用進步加權 × 1.1
  4. 四捨五入得最終分數
  5. 更新歷史最佳紀錄

避免循環：
  進步獎勵不參與比對，僅在判定後才套用
```

**3. 完美表現獎勵**

```
條件：整場遊戲中有出現連續 5 題答對

範例：
  題目序列：✓✓✓✓✓✗✓✓✓✓
  判斷：前 5 題連續答對 → ✅ 獲得獎勵

  題目序列：✓✓✗✓✓✓✓✓✓✓
  判斷：第 4-10 題連續答對 → ✅ 獲得獎勵

不需要：
  從頭到尾無失誤（那是「全對獎勵」）
```

**4. 首次通關獎勵**

```
條件：首次完成該場地該模式

範例：
  首次完成「場地A 正式模式」→ ✅ 獲得獎勵
  再次完成「場地A 正式模式」→ ❌ 不獲得
  首次完成「場地A 挑戰模式」→ ✅ 獲得獎勵（不同模式）
```

---

### 3.3 加權顯示介面（最終版）

```
┌────────────────────────────┐
│ 🎉 場地A完成！             │
├────────────────────────────┤
│ 答對題數：10 / 10 ✓        │
│ 平均反應：1.2 秒           │
│ 連續答對：10 題（最長）    │
│ 獲得星星：⭐ × 10          │
│                            │
│ ─── 分數計算 ───           │
│ 基礎分數：10 分            │
│                            │
│ 🎁 獲得獎勵：              │
│ 🏆 全對獎勵    × 1.1       │
│ ⚡ 速度突破    × 1.1       │
│    💬 比上次快 0.3 秒！     │
│ 📈 進步獎勵    × 1.1       │
│    💬 超越紀錄 1 分！       │
│ 🎯 完美表現    × 1.1       │
│    💬 連續 10 題答對！      │
│ 🌟 首次通關    × 1.1       │
│    💬 第一次完成此場地！    │
│                            │
│ ════════════════           │
│ 最終得分：18 分 🎊         │
│                            │
│ 💡 個人最佳紀錄已更新！    │
│                            │
│ [繼續下一場地]             │
└────────────────────────────┘
```

**若無獲得任何獎勵**：

```
┌────────────────────────────┐
│ 🎉 場地A完成！             │
├────────────────────────────┤
│ 答對題數：7 / 10           │
│ 獲得星星：⭐ × 7           │
│                            │
│ ─── 分數計算 ───           │
│ 基礎分數：7 分             │
│                            │
│ 💬 繼續加油！              │
│    再試試看能否全對獲得獎勵 │
│                            │
│ [重新挑戰] [下一場地]      │
└────────────────────────────┘
```

---

### 3.4 排行榜系統（雙軌制）

#### 本地班級排行榜（localStorage）

```
完全離線，隱私安全

功能：
✅ 教師建立多個班級
✅ 學生選擇班級後，分數儲存至該班級
✅ 匯出班級資料（JSON / CSV）
✅ 匯入班級資料（還原備份）

介面：
┌──────────────────────────────┐
│       📚 班級管理            │
├──────────────────────────────┤
│ 📁 A001: 快樂幼兒園小班      │
│    學生數：25 人             │
│    [查看排行] [匯出] [刪除]  │
│                              │
│ 📁 B002: 陽光幼兒園中班      │
│    學生數：30 人             │
│    [查看排行] [匯出] [刪除]  │
│                              │
│ [➕ 新增班級]               │
│ [📥 匯入班級資料]           │
└──────────────────────────────┘
```

#### 全球排行榜（Firestore，選擇性）

**上傳控制**：

```
預設：關閉（不自動上傳）

設定頁面：
┌──────────────────────────────┐
│       ⚙️ 設定                │
├──────────────────────────────┤
│ 排行榜設定                   │
│                              │
│ 上傳到全球排行榜             │
│ [━━━━━○] OFF ← 開關         │
│                              │
│ 說明：                       │
│ • 關閉：僅儲存在本地班級     │
│ • 開啟：自動上傳到全球排行榜 │
│ • 僅個人可選擇，教師端不可   │
│                              │
│ [儲存設定]                   │
└──────────────────────────────┘

遊戲結束提示：
┌──────────────────────────────┐
│ ✅ 遊戲完成！                │
├──────────────────────────────┤
│ 你的成績：15分  ⭐×10        │
│ 已儲存到本地班級排行榜 ✓     │
│                              │
│ ─────────────────────        │
│ 上傳到全球排行榜？           │
│                              │
│ 目前設定：[━━━━━○] OFF      │
│                              │
│ [開啟並上傳] [保持關閉]      │
│ ☐ 記住我的選擇               │
└──────────────────────────────┘
```

**隱私保護**：

```
✅ 全球排行榜不顯示班級代碼
✅ 僅顯示暱稱 + 分數
✅ 個人可選擇上傳
❌ 教師端不可上傳全班資料
```

---

### 3.5 徽章系統（15個）

#### 基礎徽章（4個）

| 徽章 | 名稱       | 條件      |
| ---- | ---------- | --------- |
| 🧀🏆 | 起司王     | 完成場地A |
| 🧑🎖️ | 村莊探險家 | 完成場地B |
| 🐟🌊 | 海洋冒險者 | 完成場地C |
| 🌙👑 | 晝夜大師   | 完成場地D |

#### 進階徽章（6個）

| 徽章 | 名稱       | 條件            |
| ---- | ---------- | --------------- |
| 🧠⭐ | 記憶之星   | 場地B答對≥8題   |
| 🎯✨ | 彈性天才   | 場地C答對≥8題   |
| ⚡👑 | 速度之王   | 平均反應<2秒    |
| 💯🏅 | 完美主義者 | 任一場地全對    |
| 🔥💪 | 連勝高手   | 連續5題答對     |
| 📈🚀 | 進步之星   | 分數提升2分以上 |

#### 隱藏徽章（5個）

| 徽章 | 名稱       | 條件                 | 提示            |
| ---- | ---------- | -------------------- | --------------- |
| 🎂🎉 | 生日快樂   | 生日當天遊玩         | ???             |
| 🌟🌈 | 七彩收藏家 | 獲得7個不同徽章      | 收集更多徽章... |
| 🦸‍♂️⚔️ | 不屈勇士   | 失敗後立刻重試並通過 | 跌倒了要...     |
| 🌅☀️ | 早起鳥兒   | 上午8點前遊玩        | 早起的鳥兒...   |
| 🎮🕹️ | 遊戲達人   | 累積遊玩10次         | 持續練習...     |

---

### 3.6 等級系統

```
Level 1 (0-10星)   → 🥚 蛋寶寶
Level 2 (11-20星)  → 🐣 破殼雞
Level 3 (21-40星)  → 🐥 小雞仔
Level 4 (41-60星)  → 🐓 雞大王
Level 5 (61+星)    → 🦅 金鷹王者

顯示介面：
┌────────────────────────────┐
│   你的成長階段               │
│                            │
│        🐣                  │
│     破殼雞                  │
│                            │
│  累積星星：15 顆            │
│                            │
│  [▓▓▓▓▓▓░░░░]             │
│  距離下一階段：還差 6 顆星  │
└────────────────────────────┘
```

---

### 3.7 關卡系統

```
每個場地（A/B/C/D）：
  ├─ 正式模式（10題）
  └─ 挑戰模式（15題，需解鎖）

解鎖機制：
  ✅ 場地依序解鎖（完成A才能玩B）
  ✅ 挑戰模式：正式模式達標後解鎖
  ✅ 教師用 ?unlock=all 解鎖全部

重試機制：
  ✅ 無限免費重試
  ✅ 可重複挑戰刷新紀錄
```

---

## 四、多感官設計（聲音系統）

**詳細內容請參考：《聲音設計：多感官輸入原則》文件**

### 4.1 核心原則

```
✅ 「多一個感官輸入，多一個理解機會」
✅ 視覺為主（必要），聽覺為輔（增強）
✅ 無聲音 100% 可玩，有聲音體驗更佳
```

### 4.2 聲音應用場景

```
1. 語音指導：規則說明
2. 即時回饋音效：答對/答錯/徽章/升級
3. 背景音樂：各場地主題
4. 刺激音效：題目出現提示
5. 倒數音效：3-2-1-開始
```

### 4.3 音效開關

```
分類控制：
  [━━━●━] 語音指導
  [━━━●━] 回饋音效
  [━━━●━] 背景音樂
  [━━━●━] 刺激音效

快速切換：
  🔊 / 🔇（右上角）
```

---

## 五、技術架構

### 5.1 前端技術

```
✅ HTML5 + CSS3 + Vanilla JavaScript
✅ HTML5 Drag & Drop API（積木式選擇）
✅ Web Audio API（聲音系統）
✅ html2canvas（截圖功能）
✅ qrcode.js（QR Code 生成）
✅ Chart.js 4.4.1（資料分析圖表）          ← v2.2 新增
✅ PapaParse 5.4.1（CSV 解析）              ← v2.2 新增
✅ html2pdf.js 0.10.1（PDF 匯出）           ← v2.2 新增
```

### 5.2 後端服務（Firebase）

```
✅ Realtime Database（多人即時同步）
✅ Firestore（單人成績儲存，選擇性）
✅ Authentication（匿名登入）
✅ Hosting（部署）
✅ Storage（音效檔案）
```

### 5.3 資料儲存層次

```
Layer 1: localStorage（本地，永遠優先）
  ├─ 玩家設定（暱稱、偏好）
  ├─ 本地班級排行榜
  ├─ 徽章收藏
  ├─ 關卡進度
  ├─ 等級資訊
  └─ 聲音設定

Layer 2: Realtime Database（多人即時）
  └─ 房間資料（遊戲結束後1小時刪除）

Layer 3: Firestore（選擇性，全球排行榜）
  └─ 分數資料（使用者主動上傳時）
```

---

## 六、檔案結構規劃

> ⭐ v2.3 更新：反映 P0-P4 重構後的實際檔案結構

```
project/
├── index.html                       # 起始頁面（模式選擇）
├── privacy.html                     # 隱私權政策
├── settings/
│   └── index.html                   # 全域設定（音量/題數/配色）
├── multiplayer/
│   ├── index.html                   # 多人模式入口
│   ├── room-create.html             # 建立房間
│   ├── room-join.html               # 加入房間
│   ├── room-lobby.html              # 房間大廳（等待室）
│   ├── game.html                    # 遊戲進行
│   └── result.html                  # 成績結果
├── singleplayer/
│   ├── adventure-map.html           # 探險地圖頁面
│   ├── free-select.html             # 自由選擇頁面
│   ├── game.html                    # 遊戲進行
│   ├── result.html                  # 結算頁面（雙模式 + 分析報告）
│   ├── stats.html                   # 統計數據頁面
│   ├── pet.html                     # 寵物頁面
│   ├── sticker-book.html            # 貼紙簿
│   └── avatar-shop.html             # 頭像商店
├── leaderboard/
│   ├── index.html                   # 排行榜入口
│   ├── class.html                   # 班級排行榜（+ CSV 報告）
│   └── world.html                   # 世界排行榜
├── management/
│   └── index.html                   # 教師管理後台（班級看板 CRUD）
├── shared/
│   ├── working-memory.html          # WM 測驗模板
│   └── combo-transition.html        # 組合過場模板
│
├── js/
│   ├── firebase-config.js           # Firebase compat SDK 設定
│   ├── firebase-bundle.js           # Firebase v10 modular SDK（Vite IIFE）
│   ├── game-config.js               # 遊戲常數 + GameConstants (SoT)
│   ├── adventure-maps-config.js     # 探險地圖配置（2 地圖 × 6 探險點）
│   ├── svg-assets.js                # SVG 刺激物資源（9 組）
│   ├── sound-config.js              # 音效配置
│   ├── stimuli-config.js            # 刺激物配置
│   ├── game-logic.js                # 舊版遊戲邏輯（保留相容）
│   ├── game-logic-wm.js             # 舊版 WM 邏輯（保留相容）
│   ├── adaptive/
│   │   ├── difficulty-provider.js   # 難度參數供應器（ISI/刺激時間）
│   │   └── simple-adaptive-engine.js # 5 級自適應難度引擎
│   ├── game/
│   │   ├── rule-engine.js           # 規則引擎
│   │   └── stimulus-renderer.js     # 刺激物渲染器
│   ├── utils/
│   │   ├── room-code.js             # 房間代碼生成/驗證
│   │   ├── constants.js             # 全域常數擴充
│   │   ├── storage.js               # localStorage 封裝
│   │   ├── score-calculator.js      # 規則分數 + WM 分數 + 星星計算
│   │   ├── level-calculator.js      # 等級系統（5 階）
│   │   ├── badge-checker.js         # 徽章系統（18 枚）
│   │   └── question-generator.js    # 題目序列生成（含 WM 參數）
│   ├── multiplayer/                   # ⭐ v2.3 P0-P4 重構完成
│   │   ├── game-controller.js       # MP 遊戲控制器（~830 行，對齊 SP）
│   │   ├── multiplayer-bridge.js    # 多人模式橋接層
│   │   ├── game-sync.js             # Firebase RTDB 即時同步
│   │   ├── room-manager.js          # 房間 CRUD + joinRoom
│   │   ├── room-create-controller.js # 建立房間 UI 控制器
│   │   ├── room-join-controller.js  # 加入房間 UI 控制器
│   │   ├── room-lobby-controller.js # 房間大廳 UI 控制器
│   │   └── result-controller.js     # MP 結果頁控制器
│   ├── singleplayer/
│   │   ├── game-controller.js       # SP 遊戲控制器（~915 行）
│   │   ├── progress-tracker.js      # 進度追蹤器
│   │   ├── mode-controller.js       # 模式控制器（session + 導航）
│   │   ├── result-controller.js     # SP 結果頁控制器
│   │   ├── adventure-map-controller.js # 探險地圖控制器
│   │   ├── free-select-controller.js # 自由選擇控制器
│   │   ├── settings-controller.js   # 設定頁控制器
│   │   ├── stats-controller.js      # 統計頁控制器
│   │   ├── pet-controller.js        # 寵物頁控制器
│   │   ├── sticker-book-controller.js # 貼紙簿控制器
│   │   └── avatar-shop-controller.js # 頭像商店控制器
│   ├── shared/                        # ⭐ v2.3 新增共用模組
│   │   ├── combo-selector.js        # 場地×規則 Stage 註冊表（SoT）
│   │   ├── trial-renderer.js        # 試驗渲染器（SP/MP 共用）
│   │   ├── result-upload.js         # 排行榜上傳（班級+世界）
│   │   ├── csv-report.js            # 分析報告共用模組（~1230 行）
│   │   ├── audio-player.js          # 音效系統
│   │   ├── countdown.js             # 3-2-1 倒數動畫
│   │   ├── feedback-overlay.js      # 即時回饋覆蓋層
│   │   ├── working-memory.js        # 工作記憶測驗
│   │   ├── completion-notify.js     # 完成通知 toast
│   │   ├── game-session-builder.js  # 遊戲組合構建器
│   │   ├── focus-trap.js            # 焦點陷阱（無障礙）
│   │   ├── landscape-hint.js        # 橫屏提示
│   │   ├── navbar.js                # 共用導航列
│   │   ├── ranking-renderer.js      # 排行榜渲染器
│   │   ├── leaderboard-writer.js    # 排行榜寫入器
│   │   ├── firestore-leaderboard.js # Firestore 排行榜 API
│   │   ├── class-leaderboard-controller.js # 班級排行榜控制器
│   │   ├── world-leaderboard-controller.js # 世界排行榜控制器
│   │   └── management-controller.js # 管理後台控制器
│   └── shop/
│       ├── avatar-config.js         # 頭像配置
│       ├── avatar-manager.js        # 頭像管理器
│       ├── pet-config.js            # 寵物配置
│       ├── pet-manager.js           # 寵物管理器
│       ├── sticker-config.js        # 貼紙配置
│       └── sticker-manager.js       # 貼紙管理器
│
├── css/
│   ├── main.css                     # 主樣式
│   ├── components/                  # 元件樣式
│   └── themes/                      # 主題樣式
│
├── audio/
│   ├── bgm/                         # 背景音樂
│   ├── sfx/                         # 音效
│   └── voice/                       # 語音指導
│
├── firebase.json                    # Firebase 設定
└── database.rules.json              # Firebase RTDB 規則
```

---

## 七、開發時程（實際進度）

### Phase 0 — 核心配置與資料層（✅ 2026/02/13 完成）

```
✅ js/game-config.js          遊戲常數（計時、計分、遊戲場定義）
✅ js/adventure-maps-config.js 探險地圖配置（2 地圖 × 6 探險點）
✅ js/svg-assets.js            SVG 刺激物資源（9 組）
✅ js/utils/constants.js       全域常數
```

### Phase 1 — 工具模組（✅ 2026/02/13 完成）

```
✅ js/utils/storage.js         localStorage 封裝（玩家、探險進度、排行）
✅ js/utils/score-calculator.js 規則分數 + WM 分數 + 星星計算
✅ js/utils/question-generator.js 題目序列生成（簡單/混合/練習/WM 參數）
```

### Phase 2 — 多人模式核心（⏸ 部分完成，暫擱）

```
✅ Firebase 專案建立（efgame-634af）
✅ 多人遊戲 MVP（room-join, waiting-room, game, result）
⏸ 多人模式重構（待後續 Phase 完善）
```

### Phase 3 — 共用 UI 元件（✅ 2026/02/13 完成）

```
✅ js/shared/audio-player.js       音效系統（3 級 SFX + 4 級語音 fallback）
✅ js/shared/countdown.js          3-2-1 倒數動畫
✅ js/shared/feedback-overlay.js   即時回饋覆蓋層（Hit/CR/Miss/FA）
✅ js/shared/working-memory.js     工作記憶測驗元件
✅ js/shared/completion-notify.js  完成通知 toast
✅ js/shared/game-session-builder.js 遊戲組合構建器
✅ shared/working-memory.html      WM 測驗模板
✅ shared/combo-transition.html    組合過場模板
✅ css/themes/base.css             CSS 設計 Token
✅ css/main.css                    共用樣式（618 行）
```

### Phase 4 — 單人模式（✅ 2026/02/14 完成）

```
Step 0  ✅ js/utils/level-calculator.js       等級系統（5 階：🥚→🐣→🐥→🐓→🦅）
Step 1  ✅ js/utils/badge-checker.js           徽章系統（18 枚）
Step 2  ✅ js/singleplayer/progress-tracker.js 進度追蹤器
Step 3  ✅ js/singleplayer/mode-controller.js  模式控制器（session + 導航）
Step 4  ✅ singleplayer/adventure-map.html     探險地圖頁面
Step 5  ✅ singleplayer/free-select.html       自由選擇頁面
Step 6  ✅ singleplayer/game.html              遊戲頁面（模組化重寫）
Step 7  ✅ singleplayer/result.html             結算頁面（雙模式）
Step 8  ✅ 整合測試（發現並修復 3 個 bug）
Step 9  ✅ 需求文件更新
額外    ✅ index.html 單人模式入口更新（→ adventure-map.html）

--- 以下為 Phase 4 後續補充（2026/02/14）---
Step 5-0  ✅ 清理（zombie refs、Firebase SDK 統一 9.22.0、archive 8 檔）
Step 10 ✅ js/shared/csv-report.js             CSV 分析報告共用模組（v1.2.0, ~1230 行）
Step 11 ✅ css/components/csv-report.css        報告元件樣式（BEM + print + dark）
Step 12 ✅ result.html 整合報告                按鈕 + _convertTrials + PDF + 截圖
Step 13 ✅ leaderboard/class.html 整合報告      CSV 上傳 + 報告 + PDF + 截圖
Step 14 ✅ leaderboard/live.html 新頁面         即時排行 + 報告雙面板
Step 15 ✅ 低耦合重構                          constants.js → Single Source of Truth
```

### Phase 5 — 多人模式重構（✅ 2026/02/18 完成）

```
⭐ v2.3 新增 — P0-P4 重構 + Bug 修復（共 11 項）

--- P0：共用模組提取 ---
P0-a  ✅ js/shared/result-upload.js     排行榜上傳共用模組
P0-b  ✅ js/shared/combo-selector.js    場地×規則 Stage 註冊表
P0-c  ✅ js/utils/score-calculator.js    計分模組整合

--- P1：試驗資料累積 ---
P1    ✅ trialDetails 儲存 + _allTrialResults 跨 combo 累積

--- P2：試驗渲染器提取 ---
P2    ✅ js/shared/trial-renderer.js     SP/MP 共用刺激物渲染

--- P4：MP game-controller 功能對齊 SP（11 子任務）---
P4-b  ✅ 中文化文字
P4-c  ✅ _boxHTML 規則框
P4-d  ✅ recordTrial 5 參數格式
P4-e  ✅ Mixed Rule 雙層顯示
P4-f  ✅ onPress guard
P4-g  ✅ 題目生成 guard
P4-h  ✅ pointerdown 事件
P4-i  ✅ resumeAudioContext
P4-k  ✅ Combo 過場動畫
P4-l  ✅ WM 工作記憶測驗
P4-j  ✅ 難度指示器 badge

--- Bug 修復（P4 後掃描發現）---
Bug-1  ✅ room-create select value/label 錯配（題數/倒數秒數）
Bug-2  ✅ combo mapping 遺漏 hasWM/questions/stageId
Bug-3  ✅ MP 題目公平性（優先使用 Firebase 預生成題目）
Bug-4  ✅ joinRoom displaySettings null guard
Bug-5  ✅ recordTrial/recordAnswer 缺少場地資訊
Bug-6  ✅ recordFinalScore 缺少 avgRT/comboScores
Bug-7  ✅ SP recordTrial 加入 fieldId/ruleId
Bug-8  ✅ MP result avgRT fallback
Bug-9  ✅ management/index.html 缺少 </div> 閉合
Bug-10 ✅ room-lobby clipboard API fallback
```

### Phase 6 — 待定（⬜ 尚未開始）

```
可能方向（待確認）：
  ⬜ Stage E/F（mixed + WM）啟用
  ⬜ 音效/語音資源完整化
  ⬜ 完整端對端測試
  ⬜ Firebase 安全規則強化
  ⬜ 效能最佳化
```

---

## 八、關鍵設計決策總覽

### 8.1 本次對話確認的核心設計 ⭐

| 項目         | 決策                | 理由                   |
| ------------ | ------------------- | ---------------------- |
| **題目切換** | 立即（0秒）         | 提升遊戲節奏，減少等待 |
| **即時回饋** | 原畫面疊加（0.3秒） | 減少畫面切換感，更流暢 |
| **完成通知** | 僅場地完成時        | 避免過於頻繁，保持專注 |
| **題目同步** | 順序一致，進度獨立  | 公平競賽，各自節奏     |
| **場地切換** | 各自開始            | 尊重個人準備時間       |
| **遊戲開始** | 僅首次一起倒數      | 儀式感 + 公平起跑      |

### 8.2 所有設計決策總覽

| 項目         | 決策           | 理由             |
| ------------ | -------------- | ---------------- |
| 年齡層       | 3-6歲學齡前    | 口試委員建議     |
| 模式優先順序 | 多人→單人      | 使用者指定       |
| 回合概念     | 改為「遊戲場」 | 更彈性、更直覺   |
| 遊戲場選擇   | 積木式拖曳     | 符合幼教直覺操作 |
| 房間代碼     | 5位英數字      | 代碼=短網址ID    |
| 班級排行榜   | 本地單機版     | 隱私+離線        |
| 全球排行榜   | 開關式選擇     | 使用者自主       |
| 暗星顯示     | 不顯示         | 減少挫折感       |
| 徽章數量     | 15個           | 混合難度         |
| 重試機制     | 無限免費       | 鼓勵練習         |

---

## 九、待辦事項檢查表

### ✅ 需求確認

- [x] 年齡層確認（3-6歲）
- [x] 遊戲模式（多人優先）
- [x] 題目切換機制（立即切換）
- [x] 即時回饋設計（原畫面疊加）
- [x] 完成通知時機（場地完成時）
- [x] 題目同步方式（順序一致，進度獨立）
- [x] 場地切換流程（各自開始）
- [x] 倒數機制（首次一起，之後各自）
- [x] 加權計分系統（5種可疊加）
- [x] 排行榜雙軌制（本地+全球）

### ✅ 基礎建設（Phase 0-1）

- [x] Firebase 專案建立（efgame-634af）
- [x] 遊戲配置系統（game-config, adventure-maps-config, svg-assets）
- [x] 資料儲存層（storage.js — localStorage 封裝）
- [x] 計分系統（score-calculator.js）
- [x] 題目生成系統（question-generator.js）

### ✅ 共用元件（Phase 3）

- [x] 音效系統（audio-player.js）
- [x] 倒數動畫（countdown.js）
- [x] 即時回饋（feedback-overlay.js）
- [x] 工作記憶測驗（working-memory.js + 模板）
- [x] 完成通知（completion-notify.js）
- [x] 遊戲組合構建器（game-session-builder.js）
- [x] CSS 設計系統（base.css + main.css）

### ✅ 單人模式（Phase 4）

- [x] 等級系統（level-calculator.js — 5 階段）
- [x] 徽章系統（badge-checker.js — 18 枚）
- [x] 進度追蹤器（progress-tracker.js）
- [x] 模式控制器（mode-controller.js）
- [x] 探險地圖頁面（adventure-map.html）
- [x] 自由選擇頁面（free-select.html）
- [x] 遊戲頁面模組化重寫（game.html）
- [x] 結算頁面雙模式（result.html）
- [x] 整合測試與 bug 修復（3 項）
- [x] index.html 入口更新

### ✅ 分析報告 + 低耦合重構（Phase 4 後續）

- [x] 分析報告共用模組（csv-report.js — 圖表 + 表格 + PDF + 截圖）
- [x] 報告樣式（csv-report.css — BEM + print + dark）
- [x] result.html 整合報告功能
- [x] leaderboard/class.html 整合報告功能
- [x] leaderboard/live.html 即時排行看板（新頁面）
- [x] 低耦合重構（GameConstants Single Source of Truth）
- [x] zombie refs 清理 + Firebase SDK 統一 + archive 8 檔

### ✅ 多人模式重構（Phase 5）⭐ v2.3

- [x] P0-P4 SP/MP 功能對齊（共用模組提取 + MP 功能完善）
- [x] Bug 修復（11 項 — select 錯配、hasWM、題目公平性、null guard 等）
- [x] SP/MP trial record 格式統一（fieldId/ruleId/stageId）
- [x] MP 資料鏈完整性（room-create → Firebase → game → result）
- [x] 管理後台基礎功能（班級看板 CRUD）
- [x] 排行榜功能（班級 + 世界 + 即時排行）

### ⏳ 待執行

- [ ] Stage E/F（mixed + WM）啟用
- [ ] 音效/語音資源製作
- [ ] 完整端對端測試
- [ ] Firebase 安全規則強化
- [ ] Firebase 部署最終版

---

## 十、文件版本紀錄

### v1.0（2026/02/06）

- 初版完成

### v2.0（2026/02/08）- 需求定稿

- ✅ 修正題目切換機制（3秒 → 0秒）
- ✅ 修正即時回饋設計（獨立畫面 → 原畫面疊加）
- ✅ 修正完成通知時機（每題 → 場地完成時）
- ✅ 確認題目同步方式（順序一致，進度獨立）
- ✅ 確認場地切換流程（各自開始）
- ✅ 確認倒數機制（首次一起，之後各自）
- ✅ 完善加權計算系統
- ✅ 完善 Firebase 資料結構

### v2.1（2026/02/14）- Phase 4 完成更新

- ✅ 新增 §11 Phase 4 單人模式完成紀錄
- ✅ 重寫 §7 開發時程（原始計畫 → 實際 Phase 制進度）
- ✅ 更新 §9 待辦事項（反映 Phase 0-4 已完成項目）
- ✅ 更新 §6 檔案結構（singleplayer/ 新增 4 頁面）
- ✅ 更新統計總覽與準備狀態

### v2.2（2026/02/14）- 分析報告 + 低耦合重構

- ✅ 新增 §2.10 輸出功能 3-5 項（分析報告、PDF 匯出、截圖）
- ✅ 更新 §5.1 前端技術（新增 Chart.js、PapaParse、html2pdf.js）
- ✅ 更新 §7 Phase 4 步驟清單（Step 10–15 + Step 5-0）
- ✅ 新增 §11.8 csv-report.js 共用模組紀錄
- ✅ 新增 §11.9 低耦合重構紀錄（GameConstants Single Source of Truth）
- ✅ 更新統計總覽

### v2.3（2026/02/18）- Phase 5 MP 重構 + 品質提升

- ✅ Phase 5 完成：P0-P4 SP/MP 功能對齊（5 步驟 + 11 Bug 修復）
- ✅ 新增 §7 Phase 5 完成紀錄（MP 重構 + Bug 修復清單）
- ✅ 完整重寫 §6 檔案結構（反映 66 JS + 23 HTML 實際狀態）
- ✅ 更新 §9 待辦事項（MP 重構 ✅，新增 Phase 6 待辦）
- ✅ 更新遊戲設定範圍（題數 3/6/12/24、倒數 0/3/5/10）
- ✅ 更新 RTDB schema 欄位描述
- ✅ 更新統計總覽、準備狀態、頁面導航

---

## 📊 統計總覽

```
總確認項目：60+
核心修正項目：6個 ⭐
已完成 Phase：0, 1, 3, 4, 5（Phase 2 已整合入 Phase 5）
JS 模組數量：66 個（7 目錄：adaptive / game / multiplayer / shared / shop / singleplayer / utils）
HTML 頁面數量：23 個（multiplayer 6 / singleplayer 8 / leaderboard 3 / management 1 / settings 1 / shared 2 / root 2）
CSS 設計 Token：30+ 變數
CSS 元件樣式：csv-report.css（BEM + print + dark）
CDN 依賴：Chart.js 4.4.1 / PapaParse 5.4.1 / html2pdf.js 0.10.1
Firebase 服務：Hosting + Realtime Database + Firestore（世界排行榜）
儲存層次：3 層（sessionStorage / localStorage / Firebase）
加權獎勵種類：5 種（可疊加）
徽章總數：18 個（5 基礎 + 5 進階 + 8 特殊）
等級階段：5 個（🥚→🐣→🐥→🐓→🦅）
共用常數：6 組（CSV_FIELDS / ROUND / REPORT_META / FILE_NAMING 等）
共用模組（js/shared/）：17 個（combo-selector / trial-renderer / result-upload 等）
```

---

## 🚀 準備狀態

### 當前狀態（2026/02/18 更新）

✅ 所有需求 100% 確認完畢  
✅ Phase 0-1：核心配置與工具模組 — 完成  
✅ Phase 3：共用 UI 元件 — 完成  
✅ Phase 4：單人模式全流程 — 完成（含整合測試）  
✅ Phase 4 後續：分析報告模組 + PDF/截圖匯出 + 低耦合重構 — 完成  
✅ Phase 5：多人模式重構 — 完成（P0-P4 對齊 + 11 Bug 修復）  
⬜ Phase 6+：待確認方向（Stage E/F / 音效 / 端對端測試）

### 文件用途

```
✅ 可直接複製到新對話使用
✅ 作為開發參考文件
✅ 作為需求確認紀錄
✅ 作為 Phase 完成紀錄（§7 / §11）
```

---

**文件完成日期**：2026年2月8日（初版）/ 2026年2月18日（v2.3 更新）  
**文件版本**：v2.3  
**文件作者**：小摩研究助理

---

## 📝 附註

本文件為「3-6歲聽障學齡前幼兒執行功能訓練遊戲」專案的完整需求統整文件，包含多人模式（Kahoot 風格）與單人模式的所有設計細節。

**重要提醒**：

1. 本文件已確認所有核心設計與細節
2. 所有標註 ⭐ 的項目為 2026/02/08 對話中修正的關鍵設計
3. Firebase 專案已建立（efgame-634af），Hosting 已部署
4. 單人模式（Phase 4）已完整實作並通過整合測試
5. 後續開發不可擅自切換版本，需經使用者同意

**下一步行動**：

- Phase 5 方向待使用者確認（多人重構 / 管理後台 / 排行榜 / 音效資源 / 其他）
- 若有需要確認的細節，請提出

---

## 十一、Phase 4「單人模式」實作完成紀錄

**完成日期**：2026/02/14  
**實作範圍**：Phase 4 全 10 步驟（Step 0–9）  
**對應章節**：§3（單人模式）

### 11.1 新增檔案清單

| #   | 檔案路徑                              | 說明                                                                                      | 行數  |
| --- | ------------------------------------- | ----------------------------------------------------------------------------------------- | ----- |
| 1   | `js/utils/level-calculator.js`        | 等級系統：5 階段（🥚→🐣→🐥→🐓→🦅），calculateLevel/detectLevelUp/getProgressToNextLevel   | ~174  |
| 2   | `js/utils/badge-checker.js`           | 徽章系統：18 枚（5 基礎 + 5 進階 + 8 特殊），checkAllBadges/updateBadgeCounters           | ~320  |
| 3   | `js/singleplayer/progress-tracker.js` | 進度追蹤器：processAdventureResult/processFreeSelectResult，整合 score→stars→level→badges | ~499  |
| 4   | `js/singleplayer/mode-controller.js`  | 模式控制器：session 管理、頁面導航、雙模式路由                                            | ~369  |
| 5   | `singleplayer/adventure-map.html`     | 探險地圖頁面：SVG 背景、探險點渲染、Popup、地圖分頁                                       | ~400  |
| 6   | `singleplayer/free-select.html`       | 自由選擇頁面：遊戲場 × 規則 × WM combo 構建器                                             | ~360  |
| 7   | `singleplayer/game.html`              | 遊戲頁面（模組化重寫）：Go/No-Go 試驗迴圈、WM 整合、雙模式支援                            | ~1162 |
| 8   | `singleplayer/result.html`            | 結算頁面（模組化重寫）：雙模式結算、星星/徽章/等級動畫                                    | ~830  |

### 11.2 備份檔案

| 原檔                                     | 備份                                  |
| ---------------------------------------- | ------------------------------------- |
| `singleplayer/game.html`（v14 monolith） | `singleplayer/game-v14-backup.html`   |
| `singleplayer/result.html`（v14）        | `singleplayer/result-v14-backup.html` |

### 11.3 完整頁面導航流程（v2.2 更新）

```
index.html
  ├─ 單人模式 → singleplayer/adventure-map.html
  │                  ├─ 開始探險點 → game.html?mode=adventure → result.html?mode=adventure
  │                  │                                            ├─ ➡️ 下一關 → adventure-map.html
  │                  │                                            ├─ 🔄 再試一次 → game.html（retry）
  │                  │                                            ├─ 🗺️ 回到地圖 → adventure-map.html
  │                  │                                            └─ 📊 分析報告 → csv-report 模組（即時生成）
  │                  │                                                 ├─ 📄 匯出 PDF
  │                  │                                                 └─ 📸 截圖 PNG
  │                  │
  │                  └─ 自由選擇（解鎖後）→ free-select.html
  │                      └─ 開始遊戲 → game.html?mode=free-select → result.html?mode=free-select
  │                                    （多 combo 循環 + 過場）       ├─ 🎯 再選一次 → free-select.html
  │                                                                   └─ 🗺️ 回到地圖 → adventure-map.html
  │
  ├─ 多人模式 → multiplayer/index.html
  │                  ├─ 建立房間 → room-create.html → room-lobby.html → game.html → result.html
  │                  └─ 加入房間 → room-join.html → room-lobby.html → game.html → result.html
  │
  └─ 排行榜 / 報告
       ├─ leaderboard/index.html     排行榜入口
       ├─ leaderboard/class.html     班級排行榜（CSV 上傳 + 報告 + PDF + 截圖）
       └─ leaderboard/world.html     世界排行榜（Firestore）
```

### 11.4 模組依賴鏈（script 載入順序）v2.2 更新

```
game-config.js                      ← GameConstants (Single Source of Truth)
  ↓
adventure-maps-config.js
  ↓
svg-assets.js
  ↓
storage.js
  ↓
score-calculator.js → level-calculator.js → badge-checker.js
  ↓
question-generator.js
  ↓
audio-player.js → countdown.js → feedback-overlay.js → working-memory.js
  ↓
completion-notify.js → game-session-builder.js
  ↓
progress-tracker.js → mode-controller.js

--- 報告模組（result.html / class.html / live.html 載入）---
Chart.js 4.4.1 (CDN)
  ↓
PapaParse 5.4.1 (CDN)
  ↓
html2pdf.js 0.10.1 (CDN)
  ↓
game-config.js                      ← GameConstants || fallback
  ↓
js/shared/csv-report.js             ← 報告生成 + PDF + 截圖
```

### 11.5 數據流（session 機制）

| Key                                         | 說明                                                   |
| ------------------------------------------- | ------------------------------------------------------ |
| `efgame-current-session`（sessionStorage）  | 遊戲中 session 資料（mode, field, rule, combos, etc.） |
| `efgame-result-data`（sessionStorage）      | 結算頁資料（comboResult/allComboResults）              |
| `efgame-adventure-progress`（localStorage） | 探險地圖持久進度                                       |
| `efgame-player-profile`（localStorage）     | 玩家檔案（totalStars, level, badges）                  |
| `efgame-badge-counters`（localStorage）     | 徽章計數器（累計數據）                                 |

### 11.6 整合測試結果

**已修復的 Bug（3 項）**：

1. ~~`game.html` 自由選擇模式 `hasWM` 缺少 `combo.hasWM` fallback~~
2. ~~`result.html` 使用 `level.newLevel`（數字）而非 `level.newLevelDef`（物件）~~
3. ~~`result.html` 進度條屬性名稱不匹配（`isMax` → `isMaxLevel` 等）~~

**驗證通過**：

- ✅ 四頁面 script 載入順序正確
- ✅ ModeController.PAGES 與實際檔案完全匹配
- ✅ 所有跨模組 API 呼叫簽章一致
- ✅ 探險/自由選擇雙模式數據流完整
- ✅ 無缺失依賴

### 11.7 後續開發注意事項

- `svg-assets.js` 使用 `const` 宣告，未明確 `window.SVG_ASSETS = SVG_ASSETS`（目前運作正常，因 `const` 在全域 scope 可存取）
- `game-session-builder.js` 在 game.html 中載入但未直接使用（保留供未來擴充）
- 橫屏處理延後至 Phase 7

### 11.8 csv-report.js 共用模組紀錄 ⭐ v2.2 新增

**建立日期**：2026/02/14  
**版本**：v1.2.0（~1230 行）  
**路徑**：`js/shared/csv-report.js`  
**樣式**：`css/components/csv-report.css`（BEM + print + dark mode）

| 功能區塊 | 方法 / 類別                                      | 說明                                          |
| -------- | ------------------------------------------------ | --------------------------------------------- |
| 初始化   | `CsvReportModule.init(container, options)`       | 掛載報告 UI 到指定容器                        |
| 載入資料 | `.loadFromTrials(trials)` / `.loadFromCsv(file)` | 從逐題資料或 CSV 檔案載入                     |
| 圖表渲染 | `.renderCharts()`                                | Chart.js 圖表：RT 趨勢、各回合正確率、RT 比較 |
| WM 專區  | `.renderWmSection()`                             | 工作記憶測試詳細結果 + 圖表                   |
| PDF 匯出 | `.exportPdf()`                                   | html2pdf.js → A4 PDF，含封面 + 分頁控制       |
| 截圖匯出 | `.exportScreenshot()`                            | html2canvas → PNG Blob → 自動下載             |
| CSV 匯出 | `.exportCsv()`                                   | PapaParse → UTF-8 BOM CSV                     |

**使用頁面**：

| 頁面                       | 資料來源                                 | 整合方式                    |
| -------------------------- | ---------------------------------------- | --------------------------- |
| `singleplayer/result.html` | `_convertTrials()` 轉換遊戲 trialDetails | 結算後按「📊 查看分析報告」 |
| `leaderboard/class.html`   | CSV 檔案上傳 → PapaParse                 | 上傳後自動生成報告          |
| `leaderboard/live.html`    | Firebase Realtime Database               | 即時排行 + 報告雙面板       |

**CDN 依賴**：

```html
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
```

### 11.9 低耦合重構紀錄（GameConstants Single Source of Truth）⭐ v2.2 新增

**執行日期**：2026/02/14  
**目標**：消除 CSV 欄位名稱、回合 ID、應用程式 metadata 的硬編碼重複  
**規範文件**：《開發規範與工具》Part 3 架構設計原則

**常數集中檔案**：`js/game-config.js` 內 `window.GameConstants`

| 常數組                               | 用途                     | 消費者                       |
| ------------------------------------ | ------------------------ | ---------------------------- |
| `CSV_FIELDS`                         | CSV 欄位中文名稱         | csv-report.js, result.html   |
| `CSV_FIELD_ORDER`                    | 欄位輸出順序             | csv-report.js, game-logic.js |
| `CSV_VALUES`                         | 預設值（如預設回合名稱） | csv-report.js                |
| `REGULAR_ROUND_IDS` / `WM_ROUND_IDS` | 一般/WM 回合 ID 列表     | csv-report.js, result.html   |
| `ROUND_DISPLAY_NAMES`                | 回合顯示名稱（含 emoji） | csv-report.js                |
| `ROUND_SHORT_LABELS`                 | 圖表用短標籤             | csv-report.js                |
| `ROUND_CHART_COLORS`                 | 圖表顏色配置             | csv-report.js                |
| `REPORT_META`                        | 應用程式名稱/副標題/版權 | csv-report.js（PDF 封面）    |
| `CSV_FILE_NAMING`                    | 檔名前綴/後綴/副檔名     | csv-report.js                |
| `CSV_FILENAME_REGEX`                 | 自動匹配的檔名正規式     | csv-report.js                |

**防禦性 fallback 模式**（所有消費者統一）：

```javascript
const C = window.GameConstants || {};
const fields = C.CSV_FIELDS || { rank: "排名", nickname: "暱稱" };
```

**重構影響範圍**：

| 檔案                       | 修改內容                                       |
| -------------------------- | ---------------------------------------------- |
| `js/game-config.js`        | 新增 GameConstants 物件（~120 行）             |
| `js/shared/csv-report.js`  | 硬編碼 → `GameConstants.XXX \|\| fallback`     |
| `singleplayer/result.html` | `_convertTrials()` 欄位名稱 → GameConstants    |
| `js/game-logic.js`         | `exportData()` 欄位名稱 → GameConstants        |
| 5 個 HTML 頁面             | 確認 `<script src="js/game-config.js">` 已載入 |

---

**END OF DOCUMENT**
